<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analyticsã€Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  

  <!-- Baidu Tongji -->
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="javascript java php emacs spring linux"/>
  <link rel="shortcut icon" href="/img/avatar/favicon.png"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://onote.doopp.com/cn/18.spring-security/">
  <title>
    
      SpringSecurity æ€»ç»“ - koocyton`s blog
    
  </title>
<meta name="generator" content="Hexo 5.4.2"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--dark">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode">î†¬</i>
  <i class="mdui-icon material-icons dark-mode">î§</i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'dark';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3å¤©è¿‡æœŸ
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">ä¸€æ´¼ç»¿åœ°</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">é¦–é¡µ</a>
          </li>

          
          
          <li>
            <a href="/categories/">
              
              åˆ†ç±»
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/about/">
              
              å…³äº
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              å½’æ¡£
              
              
            </a>
          </li>
          
          
          
          
          
          <li>
            <a href="/tags/">
              
              æ ‡ç­¾
              
              
            </a>
          </li>
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>æœç´¢</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-headerã€signatureã€wordcountã€busuanziã€waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/larsonist.jpg');
      --intro-header-background-image-url-page: url('//img/larsonist.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/larsonist.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/larsonist.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/larsonist.jpg'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#flutter" title="flutter">flutter</a>
              
              <a class="tag" href="/tags/#app" title="app">app</a>
              
            </div>
            <h1>SpringSecurity æ€»ç»“</h1>
            <h2 class="subheading"></h2>
            <span class="meta">
              Posted by koocyton on
              2024-03-28
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">149</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">33.5k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- ä¸è’œå­ç»Ÿè®¡ start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- ä¸è’œå­ç»Ÿè®¡ end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pagerã€
	tipã€
	socialshareã€
	gitalkã€gitmentã€disqus-commentã€
	Catalogã€
	Sidebarã€
	Featured-Tagsã€
	Friends Blogã€
	anchorjsã€
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="ç¬¬ä¸€ç« -æƒé™ç®¡ç†">ç¬¬ä¸€ç«  æƒé™ç®¡ç†</h2>
<ul>
<li>æƒé™ç®¡ç†</li>
<li>SpringSecurity ç®€ä»‹</li>
<li>æ•´ä½“æ¶æ„</li>
</ul>
<h3 id="æƒé™ç®¡ç†ï¼š">æƒé™ç®¡ç†ï¼š</h3>
<pre><code>å®ç°: &quot;å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶&quot;(èº«ä»½è®¤è¯) ï¼Œ æŒ‰ç…§ &quot;å®‰å…¨è§„åˆ™&quot;æˆ–è€… &quot;å®‰å…¨ç­–ç•¥&quot; (å¯¹å·²ç»è®¤è¯çš„ç”¨æˆ·è¿›è¡Œæˆæƒ)  æ§åˆ¶ï¼Œç”¨æˆ·å¯ä»¥è®¿é—®ï¼Œè€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚

æƒé™ç®¡ç†åŒ…æ‹¬ç”¨&quot;æˆ·èº«ä»½è®¤è¯&quot;å’Œ&quot;æˆæƒ&quot;ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°&quot;è®¤è¯æˆæƒ&quot;ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºï¼Œé¦–å…ˆè¦å¯¹ç”¨æˆ·è¿›è¡Œä¸€ä¸ªèº«ä»½çš„è®¤è¯ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„æƒé™ã€‚æ‰èƒ½è¿›è¡Œè®¿é—®ã€‚

è®¤è¯: å°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚
æˆæƒ: åŠè®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°ï¼Ÿèƒ½è®¿é—®å“ªäº›èµ„æºï¼Ÿ
</code></pre>
<p>æ•´ä½“æ¶æ„:</p>
<pre><code>åœ¨SpringSecurityä¸­è®¤è¯(Authentication)å’Œæˆæƒ(Authorization)æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼éƒ½ä¸ä¼šå½±å“æˆæƒã€‚
</code></pre>
<p><img src="001.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="è®¤è¯ç®¡ç†æµç¨‹">è®¤è¯ç®¡ç†æµç¨‹</h4>
<pre><code>AuthenticationMagger æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªAuthenticateæ–¹æ³•è¿›è¡Œè®¤è¯è€Œè¿™ä¸ªæ¥å£çš„ä¸»è¦å®ç°ç±»ä¸º: &quot;ProvideManager&quot;,è€Œåœ¨ProvideManagerå½“ä¸­ç®¡ç†äº†å¤šï¼š&quot;Authenticationprovider&quot; å®ä¾‹ï¼Œä¸€ä¸ªè¿™æ ·çš„å®åŠ›å°±æ˜¯ä¸€å¥—å®Œæ•´çš„è®¤è¯æµç¨‹ã€‚

1.AuthenticationMaggerä¸»è¦ç”¨æ¥åšè®¤è¯ï¼Œè®¤è¯æˆåŠŸä¹‹åä¼šå°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ° &quot;Authentication&quot; ä¸­ï¼Œ &quot;Authentication&quot; ä¸­ä¼šä¿å­˜å½“å‰çº¿ç¨‹:&quot;Threadlocal&quot; çš„å˜é‡
&quot;SecurityContextHolder&quot; ä¸­ï¼Œåœ¨å®é™…ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚ç»“æŸåï¼Œè¿™ä¸ªSecurityContextHolderä¼šéšç€å½“å‰çš„è¯·æ±‚è€Œæ¸…ç©ºã€‚ç­‰ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šæŠŠç­›é€‰ä¸­çš„è®¤è¯ä¿¡æ¯æ”¾åˆ°ï¼š&quot;SecurityContextHolder&quot; ä¸­å½“æˆ‘ä»¬åœ¨&quot;controller&quot;, &quot;service&quot;å±‚ä¸­è¦è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨&quot;SecurityContextHolder&quot;ä¸­è·å–ã€‚

2.å…¶å®çœŸæ­£ä¿å­˜ç”¨æˆ·ä¿¡æ¯è¿˜æ˜¯: &quot;Authentication&quot;è¿™ä¸ªç±»(å®ƒçš„å®ç°ç±»)æ¥ä¿å­˜çš„ã€‚æ¯”å¦‚å‰ç«¯å‘èµ·äº†ä¸€ä¸ªè®¤è¯ï¼Œè®¤è¯æˆåŠŸä¹‹åä¼šæŠŠç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åˆ°&quot;Authentication&quot;ä¸­ï¼Œåœ¨JAVA Webç¯å¢ƒå½“ä¸­ï¼Œ&quot;Authentication&quot;å¯¹è±¡è¦æ°¸ä¹…ä¿å­˜ä¸‹æ¥,è€Œåœ¨ä»¥å¾€å½“ä¸­ä¼šæŠŠ&quot;Authentication&quot;ä¿å­˜åœ¨&quot;Session&quot;å½“ä¸­ã€‚è€Œåœ¨&quot;Security&quot;å½“ä¸­ä¹Ÿæ˜¯ä¿å­˜åœ¨&quot;Session&quot;å½“ä¸­ï¼Œä½†æ˜¯ä¸ºäº†æ—¥åè®©æˆ‘ä»¬å†ä¸€æ¬¡è·å–&quot;Authentication&quot;è¿™ä¸ªä¿¡æ¯(ç”¨æˆ·ä¿¡æ¯æ—¶)èƒ½æ›´åŠ çš„æ–¹ä¾¿ï¼Œä»–åˆæŠŠè¿™ä¸ª&quot;Session&quot;åšäº†è¿›ä¸€æ­¥çš„å¤„ç†ã€‚
ä»–åˆè®¾è®¡äº†ä¸€ä¸ª&quot;Security ContextHolder&quot;ç±»ï¼Œå®ƒæ˜¯ç”¨æ¥è·å–ç”¨æˆ·çš„ä¿¡æ¯ã€‚è€Œä¸æ˜¯ä»£ç†ä»–&quot;Authentication&quot;,å®ƒåªæ˜¯ç”¨æ¥è·å–çš„ä¸€ç§é€”å¾„ã€‚è€Œ&quot;Authentication&quot;æ˜¯çœŸæ­£ç”¨æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ã€‚

å°±æ˜¯å½“æˆ‘ä»¬å‘èµ·ä¸€ä¸ªè¯·æ±‚åï¼Œç»è¿‡è®¤è¯æˆåŠŸä¹‹åè¿”å›ä¸€ä¸ª&quot;Authentication&quot;ç±»ã€‚è¿™ä¸ªç±»ä¿å­˜æˆ‘ä»¬ç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¼šå°†è¿™ä¸ªç±»æ”¾åœ¨ä¸€ä¸ªæœ¬åœ°çš„çº¿ç¨‹&quot;Threadlocal&quot; çš„å˜é‡
&quot;SecurityContextHolder&quot; è¿™ä¸ªç±»å½“ä¸­ï¼Œå½“ç™»å½•æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬çš„è¯·æ±‚è¦å“åº”ã€‚å“åº”ä¹‹åæ„å‘³ç€è®¤è¯ã€‚è¿™æ¬¡è¯·æ±‚è¦ç»“æŸäº†ï¼Œç»“æŸçš„æ—¶å€™,å³å½“å‰å“åº”çš„æ—¶å€™ï¼Œä»–ä¼šæŠŠ&quot;SecurityContextHolder&quot;ä¸­çš„&quot;Authentication&quot;è¿™ä¸ªç±»å–å‡ºæ¥ã€‚æ”¾åˆ°æˆ‘ä»¬å¯¹åº”çš„&quot;Session&quot;é‡Œé¢ä¿å­˜ä¸‹æ¥,è€Œå½“å‰åˆ°&quot;SecurityContextHolder&quot;ä¼šéšç€æœ¬åœ°è¯·æ±‚ç»“æŸè€Œç»“æŸäº†ã€‚

ä»¥åæ¯å½“æœ‰è¯·æ±‚æ¥çš„æ—¶å€™ï¼Œéƒ½ä¼šæºå¸¦ä¸€ä¸ª&quot;sessionID&quot;,æˆ‘ä»¬æºå¸¦çš„session IDä¼šå¯¹åº”æœåŠ¡å™¨ç«¯æ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„sessionã€‚åŒæ—¶çœ‹åˆ°sessioné‡Œé¢æœ‰Authenticationè¿™ä¸ªç±»å°±è¯´æ˜å·²ç»è®¤è¯äº†ã€‚Securityä¼šä»ç­›é€‰ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°SecurityContextHolderä¸­ã€‚æ–¹ä¾¿åœ¨è¯·æ±‚åç»­å¤„ç†è¿‡ç¨‹å½“ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸçš„æ—¶å€™å°†SecurityContextHolderä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ°&quot;Session&quot;å½“ä¸­ã€‚ç„¶åå°†&quot;SecurityContextHolder&quot;ä¸­çš„æ•°æ®æ¸…ç©ºã€‚
</code></pre>
<h3 id="æƒé™ç®¡ç†">æƒé™ç®¡ç†</h3>
<p>åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°<code>å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶</code>ï¼ŒæŒ‰ç…§<code>å®‰å…¨è§„åˆ™</code>æˆ–è€…<code>å®‰å…¨ç­–ç•¥</code>æ§åˆ¶ç”¨æˆ·<code>å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æº</code>ã€‚</p>
<p>æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>æˆæƒ</strong>ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°<strong>è®¤è¯æˆæƒ</strong>ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81&amp;spm=1001.2101.3001.7020">èº«ä»½è®¤è¯</a>ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„è®¿é—®æƒé™æ–¹å¯è®¿é—®ã€‚</p>
<h4 id="è®¤è¯">è®¤è¯</h4>
<p><strong><code>èº«ä»½è®¤è¯</code></strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚æœ€å¸¸ç”¨çš„ç®€å•èº«ä»½è®¤è¯æ–¹å¼æ˜¯ç³»ç»Ÿé€šè¿‡æ ¸å¯¹ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œçœ‹å…¶æ˜¯å¦ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„è¯¥ç”¨æˆ·çš„ç”¨æˆ·åå’Œå£ä»¤ä¸€è‡´ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚å¯¹äºé‡‡ç”¨<a target="_blank" rel="noopener" href="http://baike.baidu.com/view/5628.htm">æŒ‡çº¹</a>ç­‰ç³»ç»Ÿï¼Œåˆ™å‡ºç¤ºæŒ‡çº¹ï¼›å¯¹äºç¡¬ä»¶Keyç­‰åˆ·å¡ç³»ç»Ÿï¼Œåˆ™éœ€è¦åˆ·å¡ã€‚</p>
<h4 id="æˆæƒ">æˆæƒ</h4>
<p><strong><code>æˆæƒ</code></strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ä¸»ä½“è¿›è¡Œèº«ä»½è®¤è¯åéœ€è¦åˆ†é…æƒé™æ–¹å¯è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œå¯¹äºæŸäº›èµ„æºæ²¡æœ‰æƒé™æ˜¯æ— æ³•è®¿é—®çš„</p>
<h4 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h4>
<p>å’Œå…¶ä»–é¢†åŸŸä¸åŒï¼Œåœ¨ Java ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œå®‰å…¨ç®¡ç†æ¡†æ¶éå¸¸å°‘ï¼Œç›®å‰æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ï¼š</p>
<ul>
<li>Shiro
<ul>
<li>Shiro æœ¬èº«æ˜¯ä¸€ä¸ªè€ç‰Œçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œæœ‰ç€ä¼—å¤šçš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚è½»é‡ã€ç®€å•ã€æ˜“äºé›†æˆã€å¯ä»¥åœ¨JavaSEç¯å¢ƒä¸­ä½¿ç”¨ç­‰ã€‚ä¸è¿‡ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼ŒShiro å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ï¼Œåœ¨å¾®æœåŠ¡é¢å‰å’Œæ‰©å±•æ–¹é¢ï¼Œæ— æ³•å……åˆ†å±•ç¤ºè‡ªå·±çš„ä¼˜åŠ¿ã€‚</li>
</ul>
</li>
<li>å¼€å‘è€…è‡ªå®šä¹‰
<ul>
<li>ä¹Ÿæœ‰å¾ˆå¤šå…¬å¸é€‰æ‹©è‡ªå®šä¹‰æƒé™ï¼Œå³è‡ªå·±å¼€å‘æƒé™ç®¡ç†ã€‚ä½†æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯ç™»å½•å’Œæƒé™æ§åˆ¶è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ç§å„æ ·å¯èƒ½å­˜åœ¨çš„ç½‘ç»œæ”¿å‡»ä»¥åŠé˜²å½»ç­–ç•¥ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œå¼€å‘è€…ç™½å·±å®ç°å®‰å…¨ç®¡ç†ä¹Ÿå¹¶éæ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œåªæœ‰å¤§å…¬å¸æ‰æœ‰è¶³å¤Ÿçš„äººåŠ›ç‰©åŠ›å»æ”¯æŒè¿™ä»¶äº‹æƒ…ã€‚</li>
</ul>
</li>
<li>Spring Security
<ul>
<li>Spring Security,ä½œä¸ºspring å®¶æ—çš„ä¸€å‘˜ï¼Œåœ¨å’Œ Spring å®¶æ—çš„å…¶ä»–æˆå‘˜å¦‚ Spring Boot Spring Clondç­‰è¿›è¡Œæ•´åˆæ—¶ï¼Œå…·æœ‰å…¶ä»–æ¡†æ¶æ— å¯æ¯”æ‹Ÿçš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¯¹ OAuth2 æœ‰ç€è‰¯å¥½çš„æ”¯æŒï¼Œå†åŠ ä¸ŠSpring Cloudå¯¹ Spring Securityçš„ä¸æ–­åŠ æŒï¼ˆå¦‚æ¨å‡º Spring Cloud Security )ï¼Œè®© Spring Securiy ä¸çŸ¥ä¸è§‰ä¸­æˆä¸ºå¾®æœåŠ¡é¡¹ç›®çš„é¦–é€‰å®‰å…¨ç®¡ç†æ–¹æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<h4 id="å®˜æ–¹å®šä¹‰">å®˜æ–¹å®šä¹‰</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li>
</ul>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
<p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚å®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªé¢å‘Javaåº”ç”¨ç¨‹åºæä¾›èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§çš„æ¡†æ¶ã€‚ä¸æ‰€æœ‰Springé¡¹ç›®ä¸€æ ·ï¼ŒSpring Securityçš„çœŸæ­£å¨åŠ›åœ¨äºå®ƒå¯ä»¥è½»æ¾åœ°æ‰©å±•ä»¥æ»¡è¶³å®šåˆ¶éœ€æ±‚ã€‚</p>
<ul>
<li>æ€»ç»“</li>
</ul>
<blockquote>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„<code>èº«ä»½éªŒè¯</code>å’Œ<code>è®¿é—®æ§åˆ¶</code>çš„æ¡†æ¶ã€‚æˆ–è€…è¯´ç”¨æ¥å®ç°ç³»ç»Ÿä¸­æƒé™ç®¡ç†çš„æ¡†æ¶ã€‚</p>
</blockquote>
<h4 id="å†å²">å†å²</h4>
<p>Spring Security æœ€æ—©å« Acegi Securityï¼Œ è¿™ä¸ªåç§°å¹¶ä¸æ˜¯è¯´å®ƒå’Œ Spring å°±æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¾ç„¶æ˜¯ä¸ºSpring æ¡†æ¶æä¾›å®‰å…¨æ”¯æŒçš„ã€‚Acegi Security åŸºäº Springï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸ºé¡¹ç›®å»ºç«‹ä¸°å¯Œçš„è§’è‰²ä¸<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F&amp;spm=1001.2101.3001.7020">æƒé™ç®¡ç†ç³»ç»Ÿ</a>ã€‚Acegi security è™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„åˆ™æ˜¯å®ƒè‡ƒè‚¿çƒ¦ççš„é…ç½®è¿™ä¸€é—®é¢˜æœ€ç»ˆä¹Ÿé—ä¼ ç»™äº† Spring Securityã€‚</p>
<p>â€‹ Acegi Security æœ€ç»ˆè¢«å¹¶å…¥ Spring Security é¡¹ç›®ä¸­ï¼Œå¹¶äº 2008 å¹´4æœˆå‘å¸ƒäº†æ”¹ååçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Spring Security 2.0.0ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Security çš„æœ€æ–°ç‰ˆæœ¬å·±ç»åˆ°äº† 5.6.1ã€‚å’Œ Shiro ç›¸æ¯”ï¼ŒSpring Securityé‡é‡çº§å¹¶ä¸”é…ç½®çƒ¦çï¼Œç›´è‡³ä»Šå¤©ï¼Œä¾ç„¶æœ‰äººä»¥æ­¤ä¸ºç†ç”±è€Œæ‹’ç»äº†è§£ Spring Securityã€‚å…¶å®ï¼Œè‡ªä» Spring Boot æ¨å‡ºåï¼Œå°±å½»åº•é¢ è¦†äº†ä¼ ç»Ÿäº† JavaEE å¼€å‘ï¼Œè‡ªåŠ¨åŒ–é…ç½®è®©è®¸å¤šäº‹æƒ…å˜å¾—éå¸¸å®¹æ˜“ï¼ŒåŒ…æ‹¬ Spring Security çš„é…ç½®ã€‚åœ¨ä¸€ä¸ª Spring Boot é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–é…ç½®ï¼Œé¡¹ç›®çš„æ‰€æœ‰æ¥å£å°±ä¼šè¢«è‡ªåŠ¨ä¿æŠ¤èµ·æ¥äº†ã€‚åœ¨ Spring Cloudä¸­ï¼Œå¾ˆå¤šæ¶‰åŠå®‰å…¨ç®¡ç†çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Spring Security ä¾èµ–ä¸¤è¡Œé…ç½®å°±èƒ½æå®šï¼Œåœ¨å’Œ Spring å®¶æ—çš„äº§å“ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒSpring Security çš„ä¼˜åŠ¿å°±éå¸¸æ˜æ˜¾äº†ã€‚</p>
<p>â€‹ å› æ­¤ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼Œæˆ‘ä»¬ä¸éœ€è¦çº ç»“è¦ä¸è¦å­¦ä¹  Spring Securityï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•å¿«é€ŸæŒæ¡Spring Securityï¼Œ å¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ Spring Security å®ç°æˆ‘ä»¬å¾®æœåŠ¡çš„å®‰å…¨ç®¡ç†ã€‚</p>
<h3 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</h3>
<p>åœ¨çš„æ¶æ„è®¾è®¡ä¸­ï¼Œ**<code>è®¤è¯</code><strong>å’Œ</strong><code>æˆæƒ</code>** æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼ã€‚éƒ½ä¸ä¼šå½±å“æˆæƒï¼Œè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å­˜åœ¨ï¼Œè¿™ç§ç‹¬ç«‹å¸¦æ¥çš„å¥½å¤„ä¹‹ä¸€ï¼Œå°±æ˜¯å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ•´åˆä¸€äº›å¤–éƒ¨çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p><img src="002.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="è®¤è¯-2">è®¤è¯</h4>
<h5 id="AuthenticationManager">AuthenticationManager</h5>
<p>åœ¨Spring Securityä¸­è®¤è¯æ˜¯ç”±<code>AuthenticationManager</code>æ¥å£æ¥è´Ÿè´£çš„ï¼Œæ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="003.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code>public interface AuthenticationManager &#123; 
	Authentication authenticate(Authentication authentication) 
  														throws AuthenticationException;
&#125;
</code></pre>
<ul>
<li>è¿”å› Authentication è¡¨ç¤ºè®¤è¯æˆåŠŸ</li>
<li>è¿”å› AuthenticationException å¼‚å¸¸ï¼Œè¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚</li>
</ul>
<p>AuthenticationManager ä¸»è¦å®ç°ç±»ä¸º ProviderManagerï¼Œåœ¨ ProviderManager ä¸­ç®¡ç†äº†ä¼—å¤š AuthenticationProvider å®ä¾‹ã€‚åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯æµç¨‹ä¸­ï¼ŒSpring Security å…è®¸å­˜åœ¨å¤šä¸ª AuthenticationProvider ï¼Œç”¨æ¥å®ç°å¤šç§è®¤è¯æ–¹å¼ï¼Œè¿™äº› AuthenticationProvider éƒ½æ˜¯ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†çš„ã€‚</p>
<p><img src="004.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5 id="Authentication">Authentication</h5>
<p>è®¤è¯ä»¥åŠè®¤è¯æˆåŠŸçš„ä¿¡æ¯ä¸»è¦æ˜¯ç”± Authentication çš„å®ç°ç±»è¿›è¡Œä¿å­˜çš„ï¼Œå…¶æ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="005.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code>public interface Authentication extends Principal, Serializable &#123;
	Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
	Object getCredentials();
	Object getDetails();
	Object getPrincipal();
	boolean isAuthenticated();
	void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;
&#125;
</code></pre>
<ul>
<li>getAuthorities è·å–ç”¨æˆ·æƒé™ä¿¡æ¯</li>
<li>getCredentials è·å–ç”¨æˆ·å‡­è¯ä¿¡æ¯ï¼Œä¸€èˆ¬æŒ‡å¯†ç </li>
<li>getDetails è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</li>
<li>getPrincipal è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œç”¨æˆ·åã€ç”¨æˆ·å¯¹è±¡ç­‰</li>
<li>isAuthenticated ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸ</li>
</ul>
<h5 id="SecurityContextHolder">SecurityContextHolder</h5>
<p>SecurityContextHolder ç”¨æ¥è·å–ç™»å½•ä¹‹åç”¨æˆ·ä¿¡æ¯ã€‚Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ° SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°† Security SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚è¿™ä¸€ç­–ç•¥éå¸¸æ–¹ä¾¿ç”¨æˆ·åœ¨ Controllerã€Service å±‚ä»¥åŠä»»ä½•ä»£ç ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·æ•°æ®ã€‚</p>
<h4 id="æˆæƒ-2">æˆæƒ</h4>
<p>å½“å®Œæˆè®¤è¯åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆæƒäº†ã€‚åœ¨ Spring Security çš„æˆæƒä½“ç³»ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ¥å£ï¼Œ</p>
<h5 id="AccessDecisionManager">AccessDecisionManager</h5>
<blockquote>
<p>AccessDecisionManager (è®¿é—®å†³ç­–ç®¡ç†å™¨)ï¼Œç”¨æ¥å†³å®šæ­¤æ¬¡è®¿é—®æ˜¯å¦è¢«å…è®¸ã€‚</p>
</blockquote>
<p><img src="006.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5 id="AccessDecisionVoter">AccessDecisionVoter</h5>
<blockquote>
<p>AccessDecisionVoter (è®¿é—®å†³å®šæŠ•ç¥¨å™¨)ï¼ŒæŠ•ç¥¨å™¨ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡åº”æœ‰çš„è§’è‰²ï¼Œè¿›è€ŒæŠ•å‡ºèµæˆã€åå¯¹æˆ–è€…å¼ƒæƒç¥¨ã€‚</p>
</blockquote>
<p><img src="007.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>AccesDecisionVoter å’Œ AccessDecisionManager éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</p>
<h5 id="ConfigAttribute">ConfigAttribute</h5>
<blockquote>
<p>ConfigAttributeï¼Œç”¨æ¥ä¿å­˜æˆæƒæ—¶çš„è§’è‰²ä¿¡æ¯</p>
</blockquote>
<p><img src="008.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ª<br>
èµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</p>
<h2 id="ç¬¬äºŒç« -ç¯å¢ƒæ­å»º">ç¬¬äºŒç«  ç¯å¢ƒæ­å»º</h2>
<ul>
<li>ç¯å¢ƒæ­å»º</li>
<li>è‡ªåŠ¨é…ç½®ç»†èŠ‚</li>
</ul>
<h3 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h3>
<ul>
<li>spring boot</li>
<li>spring security
<ul>
<li>è®¤è¯: åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç³»ç»Ÿåˆæ³•ç”¨æˆ·è¿‡ç¨‹</li>
<li>æˆæƒ: åˆ¤æ–­ç³»ç»Ÿå†…ç”¨æˆ·å¯ä»¥è®¿é—®æˆ–å…·æœ‰è®¿é—®é‚£äº›èµ„æºæƒé™è¿‡ç¨‹</li>
</ul>
</li>
</ul>
<h4 id="åˆ›å»ºé¡¹ç›®">åˆ›å»ºé¡¹ç›®</h4>
<pre><code># 1.åˆ›å»º springboot åº”ç”¨
</code></pre>
<p><img src="009.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code># 2.åˆ›å»º controller


@RestController
public class HelloController &#123;
    @RequestMapping(&quot;/hello&quot;)
    public String hello() &#123;
        System.out.println(&quot;hello security&quot;);
        return &quot;hello security&quot;;
    &#125;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/188f587db6c74edfbf3fd40b066dcaa9.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code># 3.å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•
- http://localhost:8080/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/75027cfb5d1e492badae5fdbb9531481.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="æ•´åˆ-Spring-Security">æ•´åˆ Spring Security</h4>
<pre><code># 1.å¼•å…¥spring securityç›¸å…³ä¾èµ–


&lt;!--å¼•å…¥spring securityä¾èµ–--&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;


# 2.å†æ¬¡å¯åŠ¨é¡¹ç›®
- 1.å¯åŠ¨å®Œæˆåæ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªå¯†ç 
- 2.è®¿é—® hello å‘ç°ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/dabc01844d6846e98f5c6ecdf57bc9b9.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/81203d61e94448f6930b9f92eba8c3ed.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code># 3.ç™»å½•ç³»ç»Ÿ
- é»˜è®¤ç”¨æˆ·åä¸º: user
- é»˜è®¤å¯†ç ä¸º:  æ§åˆ¶å°æ‰“å°çš„ uuid
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/96e96ba5ee044e55b0e0095c42a127db.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/0ecce4cd60cf483fb8ff6649bbde970a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>è¿™å°±æ˜¯ Spring Security çš„å¼ºå¤§ä¹‹å¤„ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œæ‰€æœ‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨ä¿æŠ¤èµ·æ¥ï¼</strong></p>
<p>æ€è€ƒğŸ¤”?</p>
<ul>
<li>
<p>ä¸ºä»€ä¹ˆå¼•å…¥ Spring Security ä¹‹å<code>æ²¡æœ‰ä»»ä½•é…ç½®æ‰€æœ‰è¯·æ±‚å°±è¦è®¤è¯</code>å‘¢?</p>
</li>
<li>
<p>åœ¨é¡¹ç›®ä¸­æ˜æ˜æ²¡æœ‰ç™»å½•ç•Œé¢ï¼Œ<code>ç™»å½•ç•Œé¢</code>æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>user</code> å’Œ <code>æ§åˆ¶å°å¯†ç </code> èƒ½ç™»é™†ï¼Œç™»å½•æ—¶éªŒè¯æ•°æ®æºå­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
</li>
</ul>
<h4 id="å®ç°åŸç†">å®ç°åŸç†</h4>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture</a></p>
<p>è™½ç„¶å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œå°±å¯ä»¥è®© Spring Security å¯¹åº”ç”¨è¿›è¡Œä¿æŠ¤ã€‚Spring Security åˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ Spring Security ä¸­ <code>è®¤è¯ã€æˆæƒ</code> ç­‰åŠŸèƒ½éƒ½æ˜¯åŸºäº<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">è¿‡æ»¤å™¨</a>å®Œæˆçš„ã€‚</p>
<p>[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ <img src="https://img-blog.csdnimg.cn/7a489514ce50453f95ba677a38c5bdef.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/405cad31711643a6b3e7809eb8a97bb5.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤è¿‡æ»¤å™¨å¹¶ä¸æ˜¯ç›´æ¥æ”¾åœ¨ Web é¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<br>
FlterChainProxy æ¥ç»Ÿä¸€ç®¡ç†ã€‚Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾é€šè¿‡ FilterChainProxy åµŒå…¥åˆ° Webé¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ã€‚FilterChainProxy ä½œä¸ºä¸€ä¸ªé¡¶å±‚çš„ç®¡ç†è€…ï¼Œå°†ç»Ÿä¸€ç®¡ç† Security Filterã€‚FilterChainProxy æœ¬èº«æ˜¯é€šè¿‡ Spring æ¡†æ¶æä¾›çš„ DelegatingFilterProxy æ•´åˆåˆ°åŸç”Ÿçš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p>
<h4 id="Security-Filters">Security Filters</h4>
<p>é‚£ä¹ˆåœ¨ Spring Security ä¸­ç»™æˆ‘ä»¬æä¾›é‚£äº›è¿‡æ»¤å™¨? é»˜è®¤æƒ…å†µä¸‹é‚£äº›è¿‡æ»¤å™¨ä¼šè¢«åŠ è½½å‘¢ï¼Ÿ</p>
<p>è¿‡æ»¤å™¨</p>
<p>è¿‡æ»¤å™¨ä½œç”¨</p>
<p>é»˜è®¤æ˜¯å¦åŠ è½½</p>
<p>ChannelProcessingFilter</p>
<p>è¿‡æ»¤è¯·æ±‚åè®® HTTP ã€HTTPS</p>
<p>NO</p>
<p><code>WebAsyncManagerIntegrationFilter</code></p>
<p>å°† WebAsyncManger ä¸ SpringSecurity ä¸Šä¸‹æ–‡è¿›è¡Œé›†æˆ</p>
<p>YES</p>
<p><code>SecurityContextPersistenceFilter</code></p>
<p>åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰,å°†å®‰å…¨ä¿¡æ¯åŠ è½½åˆ° SecurityContextHolder ä¸­</p>
<p>YES</p>
<p><code>HeaderWriterFilter</code></p>
<p>å¤„ç†å¤´ä¿¡æ¯åŠ å…¥å“åº”ä¸­</p>
<p>YES</p>
<p>CorsFilter</p>
<p>å¤„ç†è·¨åŸŸé—®é¢˜</p>
<p>NO</p>
<p><code>CsrfFilter</code></p>
<p>å¤„ç† CSRF æ”»å‡»</p>
<p>YES</p>
<p><code>LogoutFilter</code></p>
<p>å¤„ç†æ³¨é”€ç™»å½•</p>
<p>YES</p>
<p>OAuth2AuthorizationRequestRedirectFilter</p>
<p>å¤„ç† OAuth2 è®¤è¯é‡å®šå‘</p>
<p>NO</p>
<p>Saml2WebSsoAuthenticationRequestFilter</p>
<p>å¤„ç† SAML è®¤è¯</p>
<p>NO</p>
<p>X509AuthenticationFilter</p>
<p>å¤„ç† X509 è®¤è¯</p>
<p>NO</p>
<p>AbstractPreAuthenticatedProcessingFilter</p>
<p>å¤„ç†é¢„è®¤è¯é—®é¢˜</p>
<p>NO</p>
<p>CasAuthenticationFilter</p>
<p>å¤„ç† CAS å•ç‚¹ç™»å½•</p>
<p>NO</p>
<p><code>OAuth2LoginAuthenticationFilter</code></p>
<p>å¤„ç† OAuth2 è®¤è¯</p>
<p>NO</p>
<p>Saml2WebSsoAuthenticationFilter</p>
<p>å¤„ç† SAML è®¤è¯</p>
<p>NO</p>
<p><code>UsernamePasswordAuthenticationFilter</code></p>
<p>å¤„ç†è¡¨å•ç™»å½•</p>
<p>YES</p>
<p>OpenIDAuthenticationFilter</p>
<p>å¤„ç† OpenID è®¤è¯</p>
<p>NO</p>
<p><code>DefaultLoginPageGeneratingFilter</code></p>
<p>é…ç½®é»˜è®¤ç™»å½•é¡µé¢</p>
<p>YES</p>
<p><code>DefaultLogoutPageGeneratingFilter</code></p>
<p>é…ç½®é»˜è®¤æ³¨é”€é¡µé¢</p>
<p>YES</p>
<p>ConcurrentSessionFilter</p>
<p>å¤„ç† Session æœ‰æ•ˆæœŸ</p>
<p>NO</p>
<p>DigestAuthenticationFilter</p>
<p>å¤„ç† HTTP æ‘˜è¦è®¤è¯</p>
<p>NO</p>
<p>BearerTokenAuthenticationFilter</p>
<p>å¤„ç† OAuth2 è®¤è¯çš„ Access Token</p>
<p>NO</p>
<p><code>BasicAuthenticationFilter</code></p>
<p>å¤„ç† HttpBasic ç™»å½•</p>
<p>YES</p>
<p><code>RequestCacheAwareFilter</code></p>
<p>å¤„ç†è¯·æ±‚ç¼“å­˜</p>
<p>YES</p>
<p><code>SecurityContextHolder&lt;br /&gt;AwareRequestFilter</code></p>
<p>åŒ…è£…åŸå§‹è¯·æ±‚</p>
<p>YES</p>
<p>JaasApiIntegrationFilter</p>
<p>å¤„ç† JAAS è®¤è¯</p>
<p>NO</p>
<p><code>RememberMeAuthenticationFilter</code></p>
<p>å¤„ç† RememberMe ç™»å½•</p>
<p>NO</p>
<p><code>AnonymousAuthenticationFilter</code></p>
<p>é…ç½®åŒ¿åè®¤è¯</p>
<p>YES</p>
<p><code>OAuth2AuthorizationCodeGrantFilter</code></p>
<p>å¤„ç†OAuth2è®¤è¯ä¸­æˆæƒç </p>
<p>NO</p>
<p><code>SessionManagementFilter</code></p>
<p>å¤„ç† session å¹¶å‘é—®é¢˜</p>
<p>YES</p>
<p><code>ExceptionTranslationFilter</code></p>
<p>å¤„ç†è®¤è¯/æˆæƒä¸­çš„å¼‚å¸¸</p>
<p>YES</p>
<p><code>FilterSecurityInterceptor</code></p>
<p>å¤„ç†æˆæƒç›¸å…³</p>
<p>YES</p>
<p>SwitchUserFilter</p>
<p>å¤„ç†è´¦æˆ·åˆ‡æ¢</p>
<p>NO</p>
<p>å¯ä»¥çœ‹å‡ºï¼ŒSpring Security æä¾›äº† 30 å¤šä¸ªè¿‡æ»¤å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹Spring Boot åœ¨å¯¹ Spring Security è¿›å…¥è‡ªåŠ¨åŒ–é…ç½®æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º SpringSecurityFilerChain çš„è¿‡æ»¤å™¨ï¼Œå¹¶æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨å°†è´Ÿè´£æ‰€æœ‰çš„å®‰å…¨ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€æˆæƒã€é‡å®šå‘åˆ°ç™»å½•é¡µé¢ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒWebSecurityConfigurationçš„æºç :</p>
<p><img src="https://img-blog.csdnimg.cn/7a8bd8ca1df34aefab8b2c696e16da20.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/3b15a04b350d40fba9930230458eacfa.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="SpringBootWebSecurityConfiguration">SpringBootWebSecurityConfiguration</h4>
<p>è¿™ä¸ªç±»æ˜¯ spring boot è‡ªåŠ¨é…ç½®ç±»ï¼Œé€šè¿‡è¿™ä¸ªæºç å¾—çŸ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæƒé™æ§åˆ¶:</p>
<pre><code>@Configuration(proxyBeanMethods = false)
@ConditionalOnDefaultWebSecurity
@ConditionalOnWebApplication(type = Type.SERVLET)
class SpringBootWebSecurityConfiguration &#123;
	@Bean
	@Order(SecurityProperties.BASIC_AUTH_ORDER)
	SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) 
    throws Exception &#123;
			http.authorizeRequests().anyRequest()
      .authenticated().and().formLogin().and().httpBasic();
		return http.build();
	&#125;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/0871a9f0be0847199b1c080aac5301ee.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼•å…¥ Spring Security ä¸­æ²¡æœ‰ä»»ä½•é…ç½®æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¼šè¢«æ‹¦æˆªçš„åŸå› ï¼</strong></p>
<p>é€šè¿‡ä¸Šé¢å¯¹è‡ªåŠ¨é…ç½®åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºé»˜è®¤ç”Ÿæ•ˆæ¡ä»¶ä¸º:</p>
<pre><code>class DefaultWebSecurityCondition extends AllNestedConditions &#123;

	DefaultWebSecurityCondition() &#123;
		super(ConfigurationPhase.REGISTER_BEAN);
	&#125;

	@ConditionalOnClass(&#123; SecurityFilterChain.class, HttpSecurity.class &#125;)
	static class Classes &#123;

	&#125;

	@ConditionalOnMissingBean(&#123; WebSecurityConfigurerAdapter.class, SecurityFilterChain.class &#125;)
	static class Beans &#123;

	&#125;

&#125;
</code></pre>
<ul>
<li>æ¡ä»¶ä¸€ classpathä¸­å­˜åœ¨ SecurityFilterChain.class, HttpSecurity.class</li>
<li>æ¡ä»¶äºŒ æ²¡æœ‰è‡ªå®šä¹‰ WebSecurityConfigurerAdapter.class, SecurityFilterChain.class</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„ã€‚WebSecurityConfigurerAdapter è¿™ä¸ªç±»æå…¶é‡è¦ï¼ŒSpring Security æ ¸å¿ƒé…ç½®éƒ½åœ¨è¿™ä¸ªç±»ä¸­:</p>
<p><img src="https://img-blog.csdnimg.cn/da9365cddcc34a67a6cf8beb6f12432e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¦‚æœè¦å¯¹ Spring Security è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œå°±è¦è‡ªå®šä¹‰è¿™ä¸ªç±»å®ä¾‹ï¼Œé€šè¿‡è¦†ç›–ç±»ä¸­æ–¹æ³•è¾¾åˆ°ä¿®æ”¹é»˜è®¤é…ç½®çš„ç›®çš„ã€‚</p>
<h4 id="æµç¨‹åˆ†æ">æµç¨‹åˆ†æ</h4>
<p><img src="https://img-blog.csdnimg.cn/9ab16c43eb4e484fb5f3e302c852f8c3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>è¯·æ±‚ /hello æ¥å£ï¼Œåœ¨å¼•å…¥ spring security ä¹‹åä¼šå…ˆç»è¿‡ä¸€äº›åˆ—è¿‡æ»¤å™¨</li>
<li>åœ¨è¯·æ±‚åˆ°è¾¾ FilterSecurityInterceptoræ—¶ï¼Œå‘ç°è¯·æ±‚å¹¶æœªè®¤è¯ã€‚è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¹¶æŠ›å‡º AccessDeniedException å¼‚å¸¸ã€‚</li>
<li>æŠ›å‡º AccessDeniedException çš„å¼‚å¸¸ä¼šè¢« ExceptionTranslationFilter æ•è·ï¼Œè¿™ä¸ª Filter ä¸­ä¼šè°ƒç”¨ LoginUrlAuthenticationEntryPoint#commence æ–¹æ³•ç»™å®¢æˆ·ç«¯è¿”å› 302ï¼Œè¦æ±‚å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘åˆ° /login é¡µé¢ã€‚</li>
<li>å®¢æˆ·ç«¯å‘é€ /login è¯·æ±‚ã€‚</li>
<li>/login è¯·æ±‚ä¼šå†æ¬¡è¢«æ‹¦æˆªå™¨ä¸­ DefaultLoginPageGeneratingFilter æ‹¦æˆªåˆ°ï¼Œå¹¶åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›ç”Ÿæˆç™»å½•é¡µé¢ã€‚</li>
</ol>
<p><strong>å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Security é»˜è®¤è¿‡æ»¤å™¨ä¸­ç”Ÿæˆäº†ç™»å½•é¡µé¢ï¼Œå¹¶è¿”å›ï¼</strong></p>
<h4 id="é»˜è®¤ç”¨æˆ·ç”Ÿæˆ">é»˜è®¤ç”¨æˆ·ç”Ÿæˆ</h4>
<ol>
<li>æŸ¥çœ‹ SpringBootWebSecurityConfiguration#defaultSecurityFilterChain æ–¹æ³•è¡¨å•ç™»å½•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/d8a108d9c3a549c3949bdb44b37d52a2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="2">
<li>å¤„ç†ç™»å½•ä¸º FormLoginConfigurer ç±»ä¸­ è°ƒç”¨ UsernamePasswordAuthenticationFilterè¿™ä¸ªç±»å®ä¾‹</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/10ac4ef04614482192dbec38983c0c92.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="3">
<li>æŸ¥çœ‹ç±»ä¸­ UsernamePasswordAuthenticationFilter#attempAuthentication æ–¹æ³•å¾—çŸ¥å®é™…è°ƒç”¨ AuthenticationManager ä¸­ authenticate æ–¹æ³•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/0654dc2eae6b43f389e89e434d250ac7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="4">
<li>è°ƒç”¨ ProviderManager ç±»ä¸­æ–¹æ³• authenticate</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/17fa2a0da1f342518e2a3ecec0949785.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="5">
<li>è°ƒç”¨äº† ProviderManager å®ç°ç±»ä¸­ AbstractUserDetailsAuthenticationProviderç±»ä¸­æ–¹æ³•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/1d6c8da290b446a8b217ccfb57399b96.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="6">
<li>æœ€ç»ˆè°ƒç”¨å®ç°ç±» DaoAuthenticationProvider ç±»ä¸­æ–¹æ³•æ¯”è¾ƒ</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/5ee9397c175949d19f1f3aa2c174f38c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/2c468bec265f413784cb93398eb812ee.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>çœ‹åˆ°è¿™é‡Œå°±çŸ¥é“é»˜è®¤å®ç°æ˜¯åŸºäº InMemoryUserDetailsManager è¿™ä¸ªç±»,ä¹Ÿå°±æ˜¯å†…å­˜çš„å®ç°!</strong></p>
<h4 id="UserDetailService">UserDetailService</h4>
<p>é€šè¿‡åˆšæ‰æºç åˆ†æä¹Ÿèƒ½å¾—çŸ¥ UserDetailService æ˜¯é¡¶å±‚çˆ¶æ¥å£ï¼Œæ¥å£ä¸­ loadUserByUserName æ–¹æ³•æ˜¯ç”¨æ¥åœ¨è®¤è¯æ—¶è¿›è¡Œç”¨æˆ·åè®¤è¯æ–¹æ³•ï¼Œé»˜è®¤å®ç°ä½¿ç”¨æ˜¯å†…å­˜å®ç°ï¼Œ<strong>å¦‚æœæƒ³è¦ä¿®æ”¹æ•°æ®åº“å®ç°æˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰ UserDetailService å®ç°ï¼Œæœ€ç»ˆè¿”å› UserDetails å®ä¾‹å³å¯ã€‚</strong></p>
<pre><code>public interface UserDetailsService &#123;
	UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/80ca5da0a9704e62926d9a2be6aa9257.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="UserDetailServiceAutoConfigutation">UserDetailServiceAutoConfigutation</h4>
<p>è¿™ä¸ªæºç éå¸¸å¤šï¼Œè¿™é‡Œæ¢³ç†äº†å…³é”®éƒ¨åˆ†ï¼š</p>
<pre><code>@Configuration(proxyBeanMethods = false)
@ConditionalOnClass(AuthenticationManager.class)
@ConditionalOnBean(ObjectPostProcessor.class)
@ConditionalOnMissingBean(
		value = &#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,
				AuthenticationManagerResolver.class &#125;,
		type = &#123; &quot;org.springframework.security.oauth2.jwt.JwtDecoder&quot;,
				&quot;org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector&quot;,
				&quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot; &#125;)
public class UserDetailsServiceAutoConfiguration &#123;
  //....
  @Bean
	@Lazy
	public InMemoryUserDetailsManager inMemoryUserDetailsManager(SecurityProperties properties,
			ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder) &#123;
		SecurityProperties.User user = properties.getUser();
		List&lt;String&gt; roles = user.getRoles();
		return new InMemoryUserDetailsManager(
				User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))
						.roles(StringUtils.toStringArray(roles)).build());
	&#125;
  //...
&#125;
</code></pre>
<p><strong>ç»“è®º</strong></p>
<ol>
<li>ä»è‡ªåŠ¨é…ç½®æºç ä¸­å¾—çŸ¥å½“ classpath ä¸‹å­˜åœ¨ AuthenticationManager ç±»</li>
<li>å½“å‰é¡¹ç›®ä¸­ï¼Œç³»ç»Ÿæ²¡æœ‰æä¾› AuthenticationManager.classã€ AuthenticationProvider.classã€UserDetailsService.classã€<br>
AuthenticationManagerResolver.classã€å®ä¾‹</li>
</ol>
<p><strong>é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæ»¡è¶³ï¼Œæ­¤æ—¶Spring Securityä¼šæä¾›ä¸€ä¸ª InMemoryUserDetailManager å®ä¾‹</strong></p>
<p><img src="https://img-blog.csdnimg.cn/7d821d0b0b0147de96c8d17e1ffcccb3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code>@ConfigurationProperties(prefix = &quot;spring.security&quot;)
public class SecurityProperties &#123;
	private final User user = new User();
	public User getUser() &#123;
		return this.user;
  &#125;
  //....
	public static class User &#123;
		private String name = &quot;user&quot;;
		private String password = UUID.randomUUID().toString();
		private List&lt;String&gt; roles = new ArrayList&lt;&gt;();
		private boolean passwordGenerated = true;
		//get set ...
	&#125;
&#125;
</code></pre>
<p><strong>è¿™å°±æ˜¯é»˜è®¤ç”Ÿæˆ user ä»¥åŠ uuid å¯†ç è¿‡ç¨‹! å¦å¤–çœ‹æ˜ç™½æºç ä¹‹åï¼Œå°±çŸ¥é“åªè¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®å¯ä»¥å¯¹å†…å­˜ä¸­ç”¨æˆ·å’Œå¯†ç è¿›è¡Œè¦†ç›–ã€‚</strong></p>
<pre><code>spring.security.user.name=root
spring.security.user.password=root
spring.security.user.roles=admin,users
</code></pre>
<h4 id="æ€»ç»“">æ€»ç»“</h4>
<ul>
<li>AuthenticationManagerã€ProviderMangerã€ä»¥åŠ AuthenticationProvider å…³ç³»</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/f2460dac16ae4274b53b0f3502e49c0e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p><strong>WebSecurityConfigurerAdapter</strong> æ‰©å±• Spring Security æ‰€æœ‰é»˜è®¤é…ç½®</p>
<p><img src="https://img-blog.csdnimg.cn/231468040ea54adf8de0519220fd2527.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
<li>
<p><strong>UserDetailService</strong> ç”¨æ¥ä¿®æ”¹é»˜è®¤è®¤è¯çš„æ•°æ®æºä¿¡æ¯</p>
<p><img src="https://img-blog.csdnimg.cn/a8db57ea05f046fe8dbbc2bb1cf23c6c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
</ul>
<h2 id="ç¬¬ä¸‰ç« -è®¤è¯åŸç†-è‡ªå®šä¹‰è®¤è¯">ç¬¬ä¸‰ç«  è®¤è¯åŸç†&amp;è‡ªå®šä¹‰è®¤è¯</h2>
<ul>
<li>è®¤è¯é…ç½®</li>
<li>è¡¨å•è®¤è¯</li>
<li>æ³¨é”€ç™»å½•</li>
<li>å‰åç«¯åˆ†ç¦»è®¤è¯</li>
<li>æ·»åŠ éªŒè¯ç </li>
</ul>
<h3 id="è‡ªå®šä¹‰è®¤è¯">è‡ªå®šä¹‰è®¤è¯</h3>
<h4 id="è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™">è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™</h4>
<ul>
<li>/index å…¬å…±èµ„æº</li>
<li>/hello â€¦ å—ä¿æŠ¤èµ„æº æƒé™ç®¡ç†</li>
</ul>
<p>åœ¨é¡¹ç›®ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å°±å¯ä»¥å®ç°å¯¹èµ„æºæƒé™è§„åˆ™è®¾å®š:</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
                .mvcMatchers(&quot;/index&quot;).permitAll()
                .anyRequest().authenticated()
                .and().formLogin();
    &#125;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/72cff20e628945c68b6335b660adf5a2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code># è¯´æ˜
- permitAll() ä»£è¡¨æ”¾è¡Œè¯¥èµ„æº,è¯¥èµ„æºä¸ºå…¬å…±èµ„æº æ— éœ€è®¤è¯å’Œæˆæƒå¯ä»¥ç›´æ¥è®¿é—®
- anyRequest().authenticated() ä»£è¡¨æ‰€æœ‰è¯·æ±‚,å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®
- formLogin() ä»£è¡¨å¼€å¯è¡¨å•è®¤è¯
## æ³¨æ„: æ”¾è¡Œèµ„æºå¿…é¡»æ”¾åœ¨æ‰€æœ‰è®¤è¯è¯·æ±‚ä¹‹å‰!
</code></pre>
<h4 id="è‡ªå®šä¹‰ç™»å½•ç•Œé¢">è‡ªå®šä¹‰ç™»å½•ç•Œé¢</h4>
<ul>
<li>
<p>å¼•å…¥æ¨¡æ¿ä¾èµ–</p>
<pre><code>&lt;!--thymeleaf--&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>å®šä¹‰ç™»å½•é¡µé¢ controller</p>
<pre><code>@Controller
public class LoginController &#123;

    @RequestMapping(&quot;/login.html&quot;)
    public String login() &#123;
        return &quot;login&quot;;
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åœ¨ templates ä¸­å®šä¹‰ç™»å½•ç•Œé¢</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;https://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;ç™»å½•&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;ç”¨æˆ·ç™»å½•&lt;/h1&gt;
&lt;form method=&quot;post&quot; th:action=&quot;@&#123;/doLogin&#125;&quot;&gt;
    ç”¨æˆ·å:&lt;input name=&quot;uname&quot; type=&quot;text&quot;/&gt;&lt;br&gt;
    å¯†ç :&lt;input name=&quot;passwd&quot; type=&quot;password&quot;/&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;ç™»å½•&quot;/&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong></p>
<ul>
<li>ç™»å½•è¡¨å• method å¿…é¡»ä¸º <code>post</code>ï¼Œaction çš„è¯·æ±‚è·¯å¾„ä¸º <code>/doLogin</code></li>
<li>ç”¨æˆ·åçš„ name å±æ€§ä¸º <code>uname</code></li>
<li>å¯†ç çš„ name å±æ€§ä¸º <code>passwd</code></li>
</ul>
</li>
<li>
<p>é…ç½® Spring Security é…ç½®ç±»</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
         http.authorizeHttpRequests()
                .mvcMatchers(&quot;/login.html&quot;).permitAll()
                .mvcMatchers(&quot;/index&quot;).permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .loginPage(&quot;/login.html&quot;)
                .loginProcessingUrl(&quot;/doLogin&quot;)
                .usernameParameter(&quot;uname&quot;)
                .passwordParameter(&quot;passwd&quot;)
                .successForwardUrl(&quot;/index&quot;) 		 //forward è·³è½¬           æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„
                //.defaultSuccessUrl(&quot;/index&quot;)   //redirect é‡å®šå‘    æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„
                .failureUrl(&quot;/login.html&quot;)
                .and()
                .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
    &#125;
&#125;
</code></pre>
<ul>
<li>successForwardUrl ã€defaultSuccessUrl è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å®ç°æˆåŠŸä¹‹åè·³è½¬
<ul>
<li>successForwardUrl é»˜è®¤ä½¿ç”¨ <code>forward</code> è·³è½¬ <code>æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</code></li>
<li>defaultSuccessUrl é»˜è®¤ä½¿ç”¨ <code>redirect</code> è·³è½¬ <code>æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„,å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†">è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†</h4>
<p>æœ‰æ—¶å€™é¡µé¢è·³è½¬å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬ï¼Œç‰¹åˆ«æ˜¯åœ¨å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­å°±ä¸éœ€è¦æˆåŠŸä¹‹åè·³è½¬é¡µé¢ã€‚åªéœ€è¦ç»™å‰ç«¯è¿”å›ä¸€ä¸ª JSON é€šçŸ¥ç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ä¸å¦ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>AuthenticationSucccessHandler</code> å®ç°</p>
<pre><code>public interface AuthenticationSuccessHandler &#123;

	/**
	 * Called when a user has been successfully authenticated.
	 * @param request the request which caused the successful authentication
	 * @param response the response
	 * @param authentication the &lt;tt&gt;Authentication&lt;/tt&gt; object which was created during
	 * the authentication process.
	 */
	void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,
			Authentication authentication) throws IOException, ServletException;
&#125;
</code></pre>
<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•æˆåŠŸä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°successForwardUrlã€defaultSuccessUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„</strong></p>
<p><img src="https://img-blog.csdnimg.cn/dfdb733c9d5848cf8c77f15a3bf523b2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>è‡ªå®šä¹‰ AuthenticationSuccessHandler å®ç°</p>
<p>public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler {<br>
@Override<br>
public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {<br>
Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();<br>
result.put(â€œmsgâ€, â€œç™»å½•æˆåŠŸâ€);<br>
result.put(â€œstatusâ€, 200);<br>
response.setContentType(â€œapplication/json;charset=UTF-8â€);<br>
String s = new ObjectMapper().writeValueAsString(result);<br>
response.getWriter().println(s);<br>
}<br>
}</p>
</li>
<li>
<p>é…ç½® AuthenticationSuccessHandler</p>
<p>@Configuration<br>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {<br>
@Override<br>
protected void configure(HttpSecurity http) throws Exception {<br>
http.authorizeHttpRequests()<br>
//â€¦<br>
.and()<br>
.formLogin()<br>
//â€¦<br>
.successHandler(new MyAuthenticationSuccessHandler())<br>
.failureUrl(â€œ/login.htmlâ€)<br>
.and()<br>
.csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF<br>
}<br>
}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/83bfa0f3d210411a9640c0e951f2737e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯">æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯</h4>
<p>ä¸ºäº†èƒ½æ›´ç›´è§‚åœ¨ç™»å½•é¡µé¢çœ‹åˆ°å¼‚å¸¸é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ç™»å½•é¡µé¢ä¸­ç›´æ¥è·å–å¼‚å¸¸ä¿¡æ¯ã€‚Spring Security åœ¨ç™»å½•å¤±è´¥ä¹‹åä¼šå°†å¼‚å¸¸ä¿¡æ¯å­˜å‚¨åˆ° <code>request</code> ã€<code>session</code>ä½œç”¨åŸŸä¸­ key ä¸º <code>SPRING_SECURITY_LAST_EXCEPTION</code> å‘½åå±æ€§ä¸­ï¼Œæºç å¯ä»¥å‚è€ƒ SimpleUrlAuthenticationFailureHandler ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/b4a4cbb8d0424327be5bda9ec060712a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;https://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;ç™»å½•&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  ....
  &lt;div th:text=&quot;$&#123;SPRING_SECURITY_LAST_EXCEPTION&#125;&quot;&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
</li>
<li>
<p>é…ç½®</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
              	//..
                .and()
                .formLogin()
                //....
                //.failureUrl(&quot;/login.html&quot;)
                .failureForwardUrl(&quot;/login.html&quot;)
                .and()
                .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
    &#125;
&#125;
</code></pre>
<ul>
<li>failureUrlã€failureForwardUrl å…³ç³»ç±»ä¼¼äºä¹‹å‰æåˆ°çš„ successForwardUrl ã€defaultSuccessUrl æ–¹æ³•
<ul>
<li>failureUrl å¤±è´¥ä»¥åçš„é‡å®šå‘è·³è½¬</li>
<li>failureForwardUrl å¤±è´¥ä»¥åçš„ forward è·³è½¬ <code>æ³¨æ„:å› æ­¤è·å– request ä¸­å¼‚å¸¸ä¿¡æ¯,è¿™é‡Œåªèƒ½ä½¿ç”¨failureForwardUrl</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†">è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†</h4>
<p>å’Œè‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†ä¸€æ ·ï¼ŒSpring Security åŒæ ·ä¸ºå‰åç«¯åˆ†ç¦»å¼€å‘æä¾›äº†ç™»å½•å¤±è´¥çš„å¤„ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯ AuthenticationFailureHandlerï¼Œæºç ä¸ºï¼š</p>
<pre><code>public interface AuthenticationFailureHandler &#123;

	/**
	 * Called when an authentication attempt fails.
	 * @param request the request during which the authentication attempt occurred.
	 * @param response the response.
	 * @param exception the exception which was thrown to reject the authentication
	 * request.
	 */
	void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,
			AuthenticationException exception) throws IOException, ServletException;

&#125;
</code></pre>
<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•å¤±è´¥ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°failureUrlã€failureForwardUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„ã€‚</strong></p>
<p><img src="https://img-blog.csdnimg.cn/b91d2a8da698449ea437ebe7d8380bd2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>è‡ªå®šä¹‰ AuthenticationFailureHandler å®ç°</p>
<p>public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler {</p>
<pre><code>@Override
public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException &#123;
    Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
    result.put(&quot;msg&quot;, &quot;ç™»å½•å¤±è´¥: &quot;+exception.getMessage());
    result.put(&quot;status&quot;, 500);
    response.setContentType(&quot;application/json;charset=UTF-8&quot;);
    String s = new ObjectMapper().writeValueAsString(result);
    response.getWriter().println(s);
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½® AuthenticationFailureHandler</p>
<p>@Configuration<br>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {</p>
<pre><code>@Override
protected void configure(HttpSecurity http) throws Exception &#123;
    http.authorizeHttpRequests()
              //...
            .and()
            .formLogin()
           	//..
            .failureHandler(new MyAuthenticationFailureHandler())
            .and()
            .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
&#125;
</code></pre>
<p>}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/3618b3d992f54e65be2cfd27a5ec3e9a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="æ³¨é”€ç™»å½•">æ³¨é”€ç™»å½•</h4>
<p>Spring Security ä¸­ä¹Ÿæä¾›äº†é»˜è®¤çš„æ³¨é”€ç™»å½•é…ç½®ï¼Œåœ¨å¼€å‘æ—¶ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±éœ€æ±‚å¯¹æ³¨é”€è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚</p>
<ul>
<li>
<p>å¼€å¯æ³¨é”€ç™»å½•<code>é»˜è®¤å¼€å¯</code></p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
                //...
                .and()
                .formLogin()
                //...
                .and()
                .logout()
                .logoutUrl(&quot;/logout&quot;)
                .invalidateHttpSession(true)
                .clearAuthentication(true)
                .logoutSuccessUrl(&quot;/login.html&quot;)
                .and()
                .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
    &#125;
&#125;
</code></pre>
<ul>
<li>é€šè¿‡ logout() æ–¹æ³•å¼€å¯æ³¨é”€é…ç½®</li>
<li>logoutUrl æŒ‡å®šé€€å‡ºç™»å½•è¯·æ±‚åœ°å€ï¼Œé»˜è®¤æ˜¯ GET è¯·æ±‚ï¼Œè·¯å¾„ä¸º <code>/logout</code></li>
<li>invalidateHttpSession é€€å‡ºæ—¶æ˜¯å¦æ˜¯ session å¤±æ•ˆï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>clearAuthentication é€€å‡ºæ—¶æ˜¯å¦æ¸…é™¤è®¤è¯ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>logoutSuccessUrl é€€å‡ºç™»å½•æ—¶è·³è½¬åœ°å€</li>
</ul>
</li>
<li>
<p>é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•è¯·æ±‚</p>
<p>å¦‚æœé¡¹ç›®ä¸­æœ‰éœ€è¦ï¼Œå¼€å‘è€…è¿˜å¯ä»¥é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•çš„è¯·æ±‚ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‡å®šè¯·æ±‚çš„æ–¹æ³•ï¼š</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
		@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
                //...
                .and()
                .formLogin()
                //...
                .and()
                .logout()
                .logoutRequestMatcher(new OrRequestMatcher(
                        new AntPathRequestMatcher(&quot;/logout1&quot;,&quot;GET&quot;),
                        new AntPathRequestMatcher(&quot;/logout&quot;,&quot;GET&quot;)
                ))
                .invalidateHttpSession(true)
                .clearAuthentication(true)
                .logoutSuccessUrl(&quot;/login.html&quot;)
                .and()
                .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>å‰åç«¯åˆ†ç¦»æ³¨é”€ç™»å½•é…ç½®</p>
<p>å¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œæ³¨é”€æˆåŠŸä¹‹åå°±ä¸éœ€è¦é¡µé¢è·³è½¬äº†ï¼Œåªéœ€è¦å°†æ³¨é”€æˆåŠŸçš„ä¿¡æ¯è¿”å›å‰ç«¯å³å¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ LogoutSuccessHandler å®ç°æ¥è¿”å›æ³¨é”€ä¹‹åä¿¡æ¯ï¼š</p>
<pre><code>public class MyLogoutSuccessHandler implements LogoutSuccessHandler &#123;
    @Override
    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;
        Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
        result.put(&quot;msg&quot;, &quot;æ³¨é”€æˆåŠŸ&quot;);
        result.put(&quot;status&quot;, 200);
        response.setContentType(&quot;application/json;charset=UTF-8&quot;);
        String s = new ObjectMapper().writeValueAsString(result);
        response.getWriter().println(s);
    &#125;
&#125;


@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
          			//....
                .and()
                .formLogin()
 								//...
                .and()
                .logout()
                //.logoutUrl(&quot;/logout&quot;)
                .logoutRequestMatcher(new OrRequestMatcher(
                        new AntPathRequestMatcher(&quot;/logout1&quot;,&quot;GET&quot;),
                        new AntPathRequestMatcher(&quot;/logout&quot;,&quot;GET&quot;)
                ))
                .invalidateHttpSession(true)
                .clearAuthentication(true)
                //.logoutSuccessUrl(&quot;/login.html&quot;)
                .logoutSuccessHandler(new MyLogoutSuccessHandler())
                .and()
                .csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
    &#125;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/97ccf280380d40b1b67ed79ea603a556.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
</ul>
<h4 id="ç™»å½•ç”¨æˆ·æ•°æ®è·å–">ç™»å½•ç”¨æˆ·æ•°æ®è·å–</h4>
<h5 id="SecurityContextHolder-2">SecurityContextHolder</h5>
<p>â€‹ Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚</p>
<p>â€‹ SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ°SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°†SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚</p>
<p>â€‹ å®é™…ä¸Š SecurityContextHolder ä¸­å­˜å‚¨æ˜¯ SecurityContextï¼Œåœ¨ SecurityContext ä¸­å­˜å‚¨æ˜¯ Authenticationã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/734efa4d48e14648a8a73755b1121b38.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>è¿™ç§è®¾è®¡æ˜¯å…¸å‹çš„ç­–ç•¥è®¾è®¡æ¨¡å¼:</p>
<pre><code>public class SecurityContextHolder &#123;
	public static final String MODE_THREADLOCAL = &quot;MODE_THREADLOCAL&quot;;
	public static final String MODE_INHERITABLETHREADLOCAL = &quot;MODE_INHERITABLETHREADLOCAL&quot;;
	public static final String MODE_GLOBAL = &quot;MODE_GLOBAL&quot;;
	private static final String MODE_PRE_INITIALIZED = &quot;MODE_PRE_INITIALIZED&quot;;
	private static SecurityContextHolderStrategy strategy;
  //....
	private static void initializeStrategy() &#123;
		if (MODE_PRE_INITIALIZED.equals(strategyName)) &#123;
			Assert.state(strategy != null, &quot;When using &quot; + MODE_PRE_INITIALIZED
					+ &quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;);
			return;
		&#125;
		if (!StringUtils.hasText(strategyName)) &#123;
			// Set default
			strategyName = MODE_THREADLOCAL;
		&#125;
		if (strategyName.equals(MODE_THREADLOCAL)) &#123;
			strategy = new ThreadLocalSecurityContextHolderStrategy();
			return;
		&#125;
		if (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;
			strategy = new InheritableThreadLocalSecurityContextHolderStrategy();
			return;
		&#125;
		if (strategyName.equals(MODE_GLOBAL)) &#123;
			strategy = new GlobalSecurityContextHolderStrategy();
			return;
		&#125;
    //.....
  &#125;
&#125;
</code></pre>
<ol>
<li><code>MODE THREADLOCAL</code>ï¼šè¿™ç§å­˜æ”¾ç­–ç•¥æ˜¯å°† SecurityContext å­˜æ”¾åœ¨ ThreadLocalä¸­ï¼Œå¤§å®¶çŸ¥é“ Threadlocal çš„ç‰¹ç‚¹æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å°±è¦åœ¨å“ªä¸ªçº¿ç¨‹ä¸­è¯»å–ï¼Œè¿™å…¶å®éå¸¸é€‚åˆ web åº”ç”¨ï¼Œå› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚æ— è®ºç»è¿‡å¤šå°‘ Filter åˆ°è¾¾ Servletï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†çš„ã€‚è¿™ä¹Ÿæ˜¯ SecurityContextHolder çš„é»˜è®¤å­˜å‚¨ç­–ç•¥ï¼Œè¿™ç§å­˜å‚¨ç­–ç•¥æ„å‘³ç€å¦‚æœåœ¨å…·ä½“çš„ä¸šåŠ¡å¤„ç†ä»£ç ä¸­ï¼Œå¼€å¯äº†å­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­å»è·å–ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œå°±ä¼šè·å–ä¸åˆ°ã€‚</li>
<li><code>MODE INHERITABLETHREADLOCAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¦‚æœå¸Œæœ›åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½å¤Ÿè·å–åˆ°ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ç§å­˜å‚¨æ¨¡å¼ã€‚</li>
<li><code>MODE GLOBAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼å®é™…ä¸Šæ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªé™æ€å˜é‡ä¸­ï¼Œåœ¨ JavaWebå¼€å‘ä¸­ï¼Œè¿™ç§æ¨¡å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li>
</ol>
<h5 id="SecurityContextHolderStrategy">SecurityContextHolderStrategy</h5>
<p>é€šè¿‡ SecurityContextHolder å¯ä»¥å¾—çŸ¥ï¼ŒSecurityContextHolderStrategy æ¥å£ç”¨æ¥å®šä¹‰å­˜å‚¨ç­–ç•¥æ–¹æ³•</p>
<pre><code>public interface SecurityContextHolderStrategy &#123;
	void clearContext();
	SecurityContext getContext();
	void setContext(SecurityContext context);
	SecurityContext createEmptyContext();
&#125;
</code></pre>
<p>æ¥å£ä¸­ä¸€å…±å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>clearContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥æ¸…é™¤å­˜å‚¨çš„ SecurityContextå¯¹è±¡ã€‚</li>
<li><code>getContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è·å–å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>setContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>create Empty Context</code>ï¼šè¯¥æ–¹æ³•åˆ™ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ SecurityContext å¯¹è±¡ã€‚</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/3dfa8a08875e4d29a13af810a425a22f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªå®ç°ç±»å¯¹åº”ä¸€ç§ç­–ç•¥çš„å®ç°ã€‚</p>
<h5 id="ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®">ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®</h5>
<pre><code>@RestController
public class HelloController &#123;
    @RequestMapping(&quot;/hello&quot;)
    public String hello() &#123;
      Authentication authentication = SecurityContextHolder
        .getContext().getAuthentication();
      User principal = (User) authentication.getPrincipal();
      System.out.println(&quot;èº«ä»½ :&quot;+principal.getUsername());
      System.out.println(&quot;å‡­è¯ :&quot;+authentication.getCredentials());
      System.out.println(&quot;æƒé™ :&quot;+authentication.getAuthorities());
      return &quot;hello security&quot;;
    &#125;
&#125;
</code></pre>
<h5 id="å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®">å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®</h5>
<pre><code>@RestController
public class HelloController &#123;
    @RequestMapping(&quot;/hello&quot;)
    public String hello() &#123;
      new Thread(()-&gt;&#123;
        Authentication authentication = SecurityContextHolder
          .getContext().getAuthentication();
        User principal = (User) authentication.getPrincipal();
        System.out.println(&quot;èº«ä»½ :&quot;+principal.getUsername());
        System.out.println(&quot;å‡­è¯ :&quot;+authentication.getCredentials());
        System.out.println(&quot;æƒé™ :&quot;+authentication.getAuthorities());
      &#125;).start();
      return &quot;hello security&quot;;
    &#125;
&#125;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/e318a71b80db4cfabdf1d95bce5a033e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>å¯ä»¥çœ‹åˆ°é»˜è®¤ç­–ç•¥ï¼Œæ˜¯æ— æ³•åœ¨å­çº¿ç¨‹ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦åœ¨å­çº¿ç¨‹ä¸­è·å–å¿…é¡»ä½¿ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥æ˜¯é€šè¿‡ System.getProperty åŠ è½½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  VM Options å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚</strong></p>
<pre><code>-Dspring.security.strategy=MODE_INHERITABLETHREADLOCAL
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/94ffd4b1f72e4ac8a71ed95a1992881c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5 id="é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯">é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯</h5>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
  &lt;artifactId&gt;thymeleaf-extras-springsecurity5&lt;/artifactId&gt;
  &lt;version&gt;3.0.4.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>é¡µé¢åŠ å…¥å‘½åç©ºé—´</p>
<pre><code>&lt;html lang=&quot;en&quot; xmlns:th=&quot;https://www.thymeleaf.org&quot; 
xmlns:sec=&quot;http://www.thymeleaf.org/extras/spring-security&quot;&gt;
</code></pre>
</li>
<li>
<p>é¡µé¢ä¸­ä½¿ç”¨</p>
<pre><code>&lt;!--è·å–è®¤è¯ç”¨æˆ·å--&gt;
&lt;ul&gt;
  &lt;li sec:authentication=&quot;principal.username&quot;&gt;&lt;/li&gt;
  &lt;li sec:authentication=&quot;principal.authorities&quot;&gt;&lt;/li&gt;
  &lt;li sec:authentication=&quot;principal.accountNonExpired&quot;&gt;&lt;/li&gt;
  &lt;li sec:authentication=&quot;principal.accountNonLocked&quot;&gt;&lt;/li&gt;
  &lt;li sec:authentication=&quot;principal.credentialsNonExpired&quot;&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
</li>
</ul>
<h4 id="è‡ªå®šä¹‰è®¤è¯æ•°æ®æº">è‡ªå®šä¹‰è®¤è¯æ•°æ®æº</h4>
<h5 id="è®¤è¯æµç¨‹åˆ†æ">è®¤è¯æµç¨‹åˆ†æ</h5>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/c7ea96e8232c42a6bc2871ac2f6cb27c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>å‘èµ·è®¤è¯è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦ç”¨æˆ·åã€å¯†ç ï¼Œè¯¥è¯·æ±‚ä¼šè¢«<code>UsernamePasswordAuthenticationFilter</code> æ‹¦æˆª</li>
<li>åœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸­å°†è¯·æ±‚ä¸­ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…ä¸º<code>Authentication</code>å¯¹è±¡ï¼Œå¹¶äº¤ç»™<code>AuthenticationManager</code> è¿›è¡Œè®¤è¯</li>
<li>è®¤è¯æˆåŠŸï¼Œå°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ° SecurityContextHodler ä»¥åŠè°ƒç”¨è®°ä½æˆ‘ç­‰ï¼Œå¹¶å›è°ƒ <code>AuthenticationSuccessHandler</code> å¤„ç†</li>
<li>è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ SecurityContextHodler ä»¥åŠ è®°ä½æˆ‘ä¸­ä¿¡æ¯ï¼Œå›è°ƒ <code>AuthenticationFailureHandler</code> å¤„ç†</li>
</ul>
<h5 id="ä¸‰è€…å…³ç³»">ä¸‰è€…å…³ç³»</h5>
<p>ä»ä¸Šé¢åˆ†æä¸­å¾—çŸ¥ï¼ŒAuthenticationManager æ˜¯è®¤è¯çš„æ ¸å¿ƒç±»ï¼Œä½†å®é™…ä¸Šåœ¨åº•å±‚çœŸæ­£è®¤è¯æ—¶è¿˜ç¦»ä¸å¼€ ProviderManager ä»¥åŠ AuthenticationProvider ã€‚ä»–ä»¬ä¸‰è€…å…³ç³»æ˜¯æ ·çš„å‘¢ï¼Ÿ</p>
<ul>
<li><code>AuthenticationManager</code> æ˜¯ä¸€ä¸ªè®¤è¯ç®¡ç†å™¨ï¼Œå®ƒå®šä¹‰äº† Spring Security è¿‡æ»¤å™¨è¦æ‰§è¡Œè®¤è¯æ“ä½œã€‚</li>
<li><code>ProviderManager</code> AuthenticationManageræ¥å£çš„å®ç°ç±»ã€‚Spring Security è®¤è¯æ—¶é»˜è®¤ä½¿ç”¨å°±æ˜¯ ProviderManagerã€‚</li>
<li><code>AuthenticationProvider</code> å°±æ˜¯é’ˆå¯¹ä¸åŒçš„èº«ä»½ç±»å‹æ‰§è¡Œçš„å…·ä½“çš„èº«ä»½è®¤è¯ã€‚</li>
</ul>
<p><strong>AuthenticationManager ä¸ ProviderManager</strong></p>
<p><img src="https://img-blog.csdnimg.cn/f4cca81c77084d5eabae2f05cd41c27b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>â€‹ ProviderManager æ˜¯ AuthenticationManager çš„å”¯ä¸€å®ç°ï¼Œä¹Ÿæ˜¯ Spring Security é»˜è®¤ä½¿ç”¨å®ç°ã€‚ä»è¿™é‡Œä¸éš¾çœ‹å‡ºé»˜è®¤æƒ…å†µä¸‹AuthenticationManager å°±æ˜¯ä¸€ä¸ªProviderManagerã€‚</p>
<p><strong>ProviderManager ä¸ AuthenticationProvider</strong></p>
<p>æ‘˜è‡ªå®˜æ–¹: <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/d5582ca2d98a4145b3b0ececd4a7f32c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>â€‹ åœ¨ Spring Seourity ä¸­ï¼Œå…è®¸ç³»ç»ŸåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¾‹å¦‚åŒæ—¶æ”¯æŒç”¨æˆ·å/å¯†ç è®¤è¯ã€ReremberMe è®¤è¯ã€æ‰‹æœºå·ç åŠ¨æ€è®¤è¯ç­‰ï¼Œè€Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”äº†ä¸åŒçš„ AuthenticationProviderï¼Œæ‰€ä»¥ä¸€ä¸ªå®Œæ•´çš„è®¤è¯æµç¨‹å¯èƒ½ç”±å¤šä¸ª AuthenticationProvider æ¥æä¾›ã€‚</p>
<p>â€‹ å¤šä¸ª AuthenticationProvider å°†ç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°†ç”± ProviderManager ä»£ç†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ProviderManager ä¸­å­˜åœ¨ä¸€ä¸ª AuthenticationProvider åˆ—è¡¨ï¼Œåœ¨Provider Manager ä¸­éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ª AuthenticationProvider å»æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œæœ€ç»ˆå¾—åˆ°è®¤è¯ç»“æœã€‚</p>
<p>â€‹ ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥å†é…ç½®ä¸€ä¸ª AuthenticationManager ä½œä¸º parentï¼Œè¿™æ ·å½“ProviderManager è®¤è¯å¤±è´¥ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ° parent ä¸­å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ç†è®ºä¸Šæ¥è¯´ï¼ŒProviderManager çš„ parent å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„ AuthenticationManagerï¼Œä½†æ˜¯é€šå¸¸éƒ½æ˜¯ç”±<br>
ProviderManager æ¥æ‰®æ¼” parent çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯ ProviderManager æ˜¯ ProviderManager çš„ parentã€‚</p>
<p>â€‹ ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ªProviderManager å…±ç”¨åŒä¸€ä¸ª parentã€‚æœ‰æ—¶ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰å—ä¿æŠ¤èµ„æºçš„é€»è¾‘ç»„ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰ç¬¦åˆè·¯å¾„æ¨¡å¼çš„ç½‘ç»œèµ„æºï¼Œå¦‚/api/**ï¼‰ï¼Œæ¯ä¸ªç»„å¯ä»¥æœ‰è‡ªå·±çš„ä¸“ç”¨ AuthenticationManagerã€‚é€šå¸¸ï¼Œæ¯ä¸ªç»„éƒ½æ˜¯ä¸€ä¸ªProviderManagerï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªçˆ¶çº§ã€‚ç„¶åï¼Œçˆ¶çº§æ˜¯ä¸€ç§ <code>å…¨å±€</code>èµ„æºï¼Œä½œä¸ºæ‰€æœ‰æä¾›è€…çš„åå¤‡èµ„æºã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç»˜å‡ºæ–°çš„ AuthenticationManagerã€ProvideManager å’Œ AuthentictionProvider å…³ç³»</p>
<p>æ‘˜è‡ªå®˜ç½‘: <a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<p><img src="https://img-blog.csdnimg.cn/2851bb1a5ed7441484b378f24037322a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¼„æ¸…æ¥šè®¤è¯åŸç†ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“è®¤è¯æ—¶æ•°æ®æºçš„è·å–ã€‚<code>é»˜è®¤æƒ…å†µä¸‹ AuthenticationProvider æ˜¯ç”± DaoAuthenticationProvider ç±»æ¥å®ç°è®¤è¯çš„ï¼Œåœ¨DaoAuthenticationProvider è®¤è¯æ—¶åˆé€šè¿‡ UserDetailsServiceï¼ˆæ˜¯ä¸€ä¸ªæ¥å£ï¼‰ å®Œæˆæ•°æ®æºçš„æ ¡éªŒã€‚</code>ä»–ä»¬ä¹‹é—´è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/1024f0b723884133a8349e978040435f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>æ€»ç»“: AuthenticationManager æ˜¯è®¤è¯ç®¡ç†å™¨ï¼Œåœ¨ Spring Security ä¸­æœ‰å…¨å±€AuthenticationManagerï¼Œä¹Ÿå¯ä»¥æœ‰å±€éƒ¨AuthenticationManagerã€‚å…¨å±€çš„AuthenticationManagerç”¨æ¥å¯¹å…¨å±€è®¤è¯è¿›è¡Œå¤„ç†ï¼Œå±€éƒ¨çš„AuthenticationManagerç”¨æ¥å¯¹æŸäº›ç‰¹æ®Šèµ„æºè®¤è¯å¤„ç†ã€‚å½“ç„¶æ— è®ºæ˜¯å…¨å±€è®¤è¯ç®¡ç†å™¨è¿˜æ˜¯å±€éƒ¨è®¤è¯ç®¡ç†å™¨éƒ½æ˜¯ç”± ProviderManger è¿›è¡Œå®ç°ã€‚ æ¯ä¸€ä¸ªProviderMangerä¸­éƒ½ä»£ç†ä¸€ä¸ªAuthenticationProviderçš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå®ç°ä»£è¡¨ä¸€ç§èº«ä»½è®¤è¯æ–¹å¼ã€‚è®¤è¯æ—¶åº•å±‚æ•°æ®æºéœ€è¦è°ƒç”¨ UserDetailService æ¥å®ç°ã€‚</strong></p>
<h5 id="é…ç½®å…¨å±€-AuthenticationManager">é…ç½®å…¨å±€ AuthenticationManager</h5>
<p><a target="_blank" rel="noopener" href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<ul>
<li>
<p>é»˜è®¤çš„å…¨å±€ AuthenticationManager</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
  @Autowired
  public void initialize(AuthenticationManagerBuilder builder) &#123;
    //builder..
  &#125;
&#125;
</code></pre>
<ul>
<li>springboot å¯¹ security è¿›è¡Œè‡ªåŠ¨é…ç½®æ—¶è‡ªåŠ¨åœ¨å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªå…¨å±€AuthenticationManager</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager é»˜è®¤æ‰¾å½“å‰é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰ UserDetailService å®ä¾‹ è‡ªåŠ¨å°†å½“å‰é¡¹ç›® UserDetailService å®ä¾‹è®¾ç½®ä¸ºæ•°æ®æº</li>
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager åœ¨å·¥å‚ä¸­ä½¿ç”¨æ—¶ç›´æ¥åœ¨ä»£ç ä¸­æ³¨å…¥å³å¯</li>
</ol>
</li>
<li>
<p>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
  @Override
  public void configure(AuthenticationManagerBuilder builder) &#123;
  	//builder ....
  &#125;
&#125;
</code></pre>
<ul>
<li>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° å°±å›å°†å·¥å‚ä¸­è‡ªåŠ¨é…ç½®AuthenticationManager è¿›è¡Œè¦†ç›–</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° éœ€è¦åœ¨å®ç°ä¸­æŒ‡å®šè®¤è¯æ•°æ®æºå¯¹è±¡ UserDetaiService å®ä¾‹</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° è¿™ç§æ–¹å¼åˆ›å»ºAuthenticationManagerå¯¹è±¡å·¥å‚å†…éƒ¨æœ¬åœ°ä¸€ä¸ª AuthenticationManager å¯¹è±¡ ä¸å…è®¸åœ¨å…¶ä»–è‡ªå®šä¹‰ç»„ä»¶ä¸­è¿›è¡Œæ³¨å…¥</li>
</ol>
</li>
<li>
<p>ç”¨æ¥åœ¨å·¥å‚ä¸­æš´éœ²è‡ªå®šä¹‰AuthenticationManager å®ä¾‹</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
  
    //1.è‡ªå®šä¹‰AuthenticationManager  æ¨è  å¹¶æ²¡æœ‰åœ¨å·¥å‚ä¸­æš´éœ²å‡ºæ¥
    @Override
    public void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        System.out.println(&quot;è‡ªå®šä¹‰AuthenticationManager: &quot; + builder);
        builder.userDetailsService(userDetailsService());
    &#125;

    //ä½œç”¨: ç”¨æ¥å°†è‡ªå®šä¹‰AuthenticationManageråœ¨å·¥å‚ä¸­è¿›è¡Œæš´éœ²,å¯ä»¥åœ¨ä»»ä½•ä½ç½®æ³¨å…¥
    @Override
    @Bean
    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
        return super.authenticationManagerBean();
    &#125;
&#125;
</code></pre>
</li>
</ul>
<h5 id="è‡ªå®šä¹‰å†…å­˜æ•°æ®æº">è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</h5>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;

    @Bean
    public UserDetailsService userDetailsService()&#123;
        InMemoryUserDetailsManager inMemoryUserDetailsManager
                = new InMemoryUserDetailsManager();
        UserDetails u1 = User.withUsername(&quot;zhangs&quot;)
                .password(&quot;&#123;noop&#125;111&quot;).roles(&quot;USER&quot;).build();
        inMemoryUserDetailsManager.createUser(u1);
        return inMemoryUserDetailsManager;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) 
      throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;  	
&#125;
</code></pre>
<h5 id="è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº">è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº</h5>
<ul>
<li>
<p>è®¾è®¡è¡¨ç»“æ„</p>
<pre><code>-- ç”¨æˆ·è¡¨
CREATE TABLE `user`
(
    `id`                    int(11) NOT NULL AUTO_INCREMENT,
    `username`              varchar(32)  DEFAULT NULL,
    `password`              varchar(255) DEFAULT NULL,
    `enabled`               tinyint(1) DEFAULT NULL,
    `accountNonExpired`     tinyint(1) DEFAULT NULL,
    `accountNonLocked`      tinyint(1) DEFAULT NULL,
    `credentialsNonExpired` tinyint(1) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
-- è§’è‰²è¡¨
CREATE TABLE `role`
(
    `id`      int(11) NOT NULL AUTO_INCREMENT,
    `name`    varchar(32) DEFAULT NULL,
    `name_zh` varchar(32) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE `user_role`
(
    `id`  int(11) NOT NULL AUTO_INCREMENT,
    `uid` int(11) DEFAULT NULL,
    `rid` int(11) DEFAULT NULL,
    PRIMARY KEY (`id`),
    KEY   `uid` (`uid`),
    KEY   `rid` (`rid`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
</code></pre>
</li>
<li>
<p>æ’å…¥æµ‹è¯•æ•°æ®</p>
<pre><code>-- æ’å…¥ç”¨æˆ·æ•°æ®
BEGIN;
  INSERT INTO `user`
  VALUES (1, 'root', '&#123;noop&#125;123', 1, 1, 1, 1);
  INSERT INTO `user`
  VALUES (2, 'admin', '&#123;noop&#125;123', 1, 1, 1, 1);
  INSERT INTO `user`
  VALUES (3, 'blr', '&#123;noop&#125;123', 1, 1, 1, 1);
COMMIT;
-- æ’å…¥è§’è‰²æ•°æ®
BEGIN;
  INSERT INTO `role`
  VALUES (1, 'ROLE_product', 'å•†å“ç®¡ç†å‘˜');
  INSERT INTO `role`
  VALUES (2, 'ROLE_admin', 'ç³»ç»Ÿç®¡ç†å‘˜');
  INSERT INTO `role`
  VALUES (3, 'ROLE_user', 'ç”¨æˆ·ç®¡ç†å‘˜');
COMMIT;
-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®
BEGIN;
  INSERT INTO `user_role`
  VALUES (1, 1, 1);
  INSERT INTO `user_role`
  VALUES (2, 1, 2);
  INSERT INTO `user_role`
  VALUES (3, 2, 2);
  INSERT INTO `user_role`
  VALUES (4, 3, 3);
COMMIT;
</code></pre>
</li>
<li>
<p>é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
  &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
  &lt;version&gt;2.2.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.38&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
  &lt;artifactId&gt;druid&lt;/artifactId&gt;
  &lt;version&gt;1.2.7&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>é…ç½® springboot é…ç½®æ–‡ä»¶</p>
<pre><code># datasource
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;useSSL=false
spring.datasource.username=root
spring.datasource.password=root

# mybatis
mybatis.mapper-locations=classpath:com/baizhi/mapper/*.xml
mybatis.type-aliases-package=com.baizhi.entity

# log
logging.level.com.baizhi=debug
</code></pre>
</li>
<li>
<p>åˆ›å»º entity</p>
<ul>
<li>
<p>åˆ›å»º user å¯¹è±¡</p>
<pre><code>public class User  implements UserDetails &#123;
    private Integer id;
    private String username;
    private String password;
    private Boolean enabled;
    private Boolean accountNonExpired;
    private Boolean accountNonLocked;
    private Boolean credentialsNonExpired;
    private List&lt;Role&gt; roles = new ArrayList&lt;&gt;();

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;
        List&lt;GrantedAuthority&gt; grantedAuthorities = new ArrayList&lt;&gt;();
        roles.forEach(role-&gt;grantedAuthorities.add(new SimpleGrantedAuthority(role.getName())));
        return grantedAuthorities;
    &#125;

    @Override
    public String getPassword() &#123;
        return password;
    &#125;

    @Override
    public String getUsername() &#123;
        return username;
    &#125;

    @Override
    public boolean isAccountNonExpired() &#123;
        return accountNonExpired;
    &#125;

    @Override
    public boolean isAccountNonLocked() &#123;
        return accountNonLocked;
    &#125;

    @Override
    public boolean isCredentialsNonExpired() &#123;
        return credentialsNonExpired;
    &#125;

    @Override
    public boolean isEnabled() &#123;
        return enabled;
    &#125;
		//get/set....
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º role å¯¹è±¡</p>
<pre><code>public class Role &#123;
    private Integer id;
    private String name;
    private String nameZh;
  	//get set..
&#125;
</code></pre>
</li>
</ul>
</li>
<li>
<p>åˆ›å»º UserDao æ¥å£</p>
<pre><code>@Mapper
public interface UserDao &#123;
    //æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
    User loadUserByUsername(String username);
  	
  	//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢è§’è‰²
  	List&lt;Role&gt; getRolesByUid(Integer uid);
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º UserMapper å®ç°</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;com.baizhi.dao.UserDao&quot;&gt;
    &lt;!--æŸ¥è¯¢å•ä¸ª--&gt;
    &lt;select id=&quot;loadUserByUsername&quot; resultType=&quot;User&quot;&gt;
        select id,
               username,
               password,
               enabled,
               accountNonExpired,
               accountNonLocked,
               credentialsNonExpired
        from user
        where username = #&#123;username&#125;
    &lt;/select&gt;

    &lt;!--æŸ¥è¯¢æŒ‡å®šè¡Œæ•°æ®--&gt;
    &lt;select id=&quot;getRolesByUid&quot; resultType=&quot;Role&quot;&gt;
        select r.id,
               r.name,
               r.name_zh nameZh
        from role r,
             user_role ur
        where r.id = ur.rid
          and ur.uid = #&#123;uid&#125;
    &lt;/select&gt;
&lt;/mapper&gt;
</code></pre>
</li>
<li>
<p>åˆ›å»º UserDetailService å®ä¾‹</p>
<pre><code>@Component
public class MyUserDetailService implements UserDetailsService &#123;

    private  final UserDao userDao;

    @Autowired
    public MyUserDetailService(UserDao userDao) &#123;
        this.userDao = userDao;
    &#125;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        User user = userDao.loadUserByUsername(username);
        if(ObjectUtils.isEmpty(user))throw new RuntimeException(&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;);
        user.setRoles(userDao.getRolesByUid(user.getId()));
        return user;
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>é…ç½® authenticationManager ä½¿ç”¨è‡ªå®šä¹‰UserDetailService</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;
  
    private final UserDetailsService userDetailsService;

    @Autowired
    public WebSecurityConfigurer(UserDetailsService userDetailsService) &#123;
        this.userDetailsService = userDetailsService;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        builder.userDetailsService(userDetailsService);
    &#125;
  
  	
  	@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
      //web security..
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>å¯åŠ¨æµ‹è¯•å³å¯</p>
</li>
</ul>
<hr>
<h4 id="æ·»åŠ è®¤è¯éªŒè¯ç ">æ·»åŠ è®¤è¯éªŒè¯ç </h4>
<h5 id="é…ç½®éªŒè¯ç ">é…ç½®éªŒè¯ç </h5>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;
  &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;
  &lt;version&gt;2.3.2&lt;/version&gt;
&lt;/dependency&gt;


@Configuration
public class KaptchaConfig &#123;
    @Bean
    public Producer kaptcha() &#123;
        Properties properties = new Properties();
        properties.setProperty(&quot;kaptcha.image.width&quot;, &quot;150&quot;);
        properties.setProperty(&quot;kaptcha.image.height&quot;, &quot;50&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.char.string&quot;, &quot;0123456789&quot;);
        properties.setProperty(&quot;kaptcha.textproducer.char.length&quot;, &quot;4&quot;);
        Config config = new Config(properties);
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        defaultKaptcha.setConfig(config);
        return defaultKaptcha;
    &#125;
&#125;
</code></pre>
<h5 id="ä¼ ç»Ÿ-web-å¼€å‘">ä¼ ç»Ÿ web å¼€å‘</h5>
<ul>
<li>
<p>ç”ŸæˆéªŒè¯ç  controller</p>
<pre><code>@Controller
public class KaptchaController &#123;
    private final Producer producer;

    @Autowired
    public KaptchaController(Producer producer) &#123;
        this.producer = producer;
    &#125;

    @GetMapping(&quot;/vc.jpg&quot;)
    public void getVerifyCode(HttpServletResponse response, HttpSession session) throws IOException &#123;
        response.setContentType(&quot;image/png&quot;);
        String code = producer.createText();
        session.setAttribute(&quot;kaptcha&quot;, code);//å¯ä»¥æ›´æ¢æˆ redis å®ç°
        BufferedImage bi = producer.createImage(code);
        ServletOutputStream os = response.getOutputStream();
        ImageIO.write(bi, &quot;jpg&quot;, os);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<pre><code>public class KaptchaNotMatchException extends AuthenticationException &#123;

    public KaptchaNotMatchException(String msg) &#123;
        super(msg);
    &#125;

    public KaptchaNotMatchException(String msg, Throwable cause) &#123;
        super(msg, cause);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰filteréªŒè¯éªŒè¯ç </p>
<pre><code>public class KaptchaFilter extends UsernamePasswordAuthenticationFilter &#123;

    public static final String KAPTCHA_KEY = &quot;kaptcha&quot;;//é»˜è®¤å€¼
    private String kaptcha = KAPTCHA_KEY;

    public String getKaptcha() &#123;
        return kaptcha;
    &#125;

    public void setKaptcha(String kaptcha) &#123;
        this.kaptcha = kaptcha;
    &#125;

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123;
        //1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼
        if (request.getMethod().equals(&quot;POST&quot;)) &#123;
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        &#125;
        //2.è·å–éªŒè¯ç 
        String kaptcha = request.getParameter(getKaptcha());
        String sessionKaptcha = (String) request.getSession().getAttribute(&quot;kaptcha&quot;);
        if (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionKaptcha) &amp;&amp;
                kaptcha.equalsIgnoreCase(sessionKaptcha)) &#123;
            return super.attemptAuthentication(request, response);
        &#125;
        throw new KaptchaNotMatchException(&quot;éªŒè¯ç è¾“å…¥é”™è¯¯!&quot;);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>æ”¾è¡Œä»¥åŠé…ç½®éªŒè¯ç  filter</p>
<pre><code>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;

    private final UserDetailsService userDetailsService;

    @Autowired
    public WebSecurityConfigurer(UserDetailsService userDetailsService) &#123;
        this.userDetailsService = userDetailsService;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        builder.userDetailsService(userDetailsService);
    &#125;

    @Override
    @Bean
    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
        return super.authenticationManagerBean();
    &#125;

    @Bean
    public KaptchaFilter kaptchaFilter() throws Exception &#123;
        KaptchaFilter kaptchaFilter = new KaptchaFilter();
        //æŒ‡å®šæ¥æ”¶éªŒè¯ç è¯·æ±‚å‚æ•°å
        kaptchaFilter.setKaptcha(&quot;kaptcha&quot;);
        //æŒ‡å®šè®¤è¯ç®¡ç†å™¨
        kaptchaFilter.setAuthenticationManager(authenticationManagerBean());
        //æŒ‡å®šè®¤è¯æˆåŠŸå’Œå¤±è´¥å¤„ç†
        kaptchaFilter.setAuthenticationSuccessHandler(new MyAuthenticationSuccessHandler());
        kaptchaFilter.setAuthenticationFailureHandler(new MyAuthenticationFailureHandler());
        //æŒ‡å®šå¤„ç†ç™»å½•
        kaptchaFilter.setFilterProcessesUrl(&quot;/doLogin&quot;);
        kaptchaFilter.setUsernameParameter(&quot;uname&quot;);
        kaptchaFilter.setPasswordParameter(&quot;passwd&quot;);
        return kaptchaFilter;
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
                .mvcMatchers(&quot;/vc.jpg&quot;).permitAll()
                .mvcMatchers(&quot;/login.html&quot;).permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .loginPage(&quot;/login.html&quot;)
              	...
        http.addFilterAt(kaptchaFilter(), UsernamePasswordAuthenticationFilter.class);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>ç™»å½•é¡µé¢æ·»åŠ éªŒè¯ç </p>
<pre><code>&lt;form method=&quot;post&quot; th:action=&quot;@&#123;/doLogin&#125;&quot;&gt;
    ç”¨æˆ·å:&lt;input name=&quot;uname&quot; type=&quot;text&quot;/&gt;&lt;br&gt;
    å¯†ç :&lt;input name=&quot;passwd&quot; type=&quot;password&quot;/&gt;&lt;br&gt;
    éªŒè¯ç : &lt;input name=&quot;kaptcha&quot; type=&quot;text&quot;/&gt; &lt;img alt=&quot;&quot; th:src=&quot;@&#123;/vc.jpg&#125;&quot;&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;ç™»å½•&quot;/&gt;
&lt;/form&gt;
</code></pre>
</li>
</ul>
<h5 id="å‰åç«¯åˆ†ç¦»å¼€å‘">å‰åç«¯åˆ†ç¦»å¼€å‘</h5>
<ul>
<li>
<p>ç”ŸæˆéªŒè¯ç  controller</p>
<pre><code>@RestController
public class KaptchaController &#123;
    private final Producer producer;

    @Autowired
    public KaptchaController(Producer producer) &#123;
        this.producer = producer;
    &#125;

    @GetMapping(&quot;/vc.png&quot;)
    public String getVerifyCode(HttpSession session) throws IOException &#123;
        //1.ç”ŸæˆéªŒè¯ç 
        String code = producer.createText();
        session.setAttribute(&quot;kaptcha&quot;, code);//å¯ä»¥æ›´æ¢æˆ redis å®ç°
        BufferedImage bi = producer.createImage(code);
        //2.å†™å…¥å†…å­˜
        FastByteArrayOutputStream fos = new FastByteArrayOutputStream();
        ImageIO.write(bi, &quot;png&quot;, fos);
        //3.ç”Ÿæˆ base64
        return Base64.encodeBase64String(fos.toByteArray());
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>å®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<pre><code>public class KaptchaNotMatchException extends AuthenticationException &#123;

    public KaptchaNotMatchException(String msg) &#123;
        super(msg);
    &#125;

    public KaptchaNotMatchException(String msg, Throwable cause) &#123;
        super(msg, cause);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åœ¨è‡ªå®šä¹‰LoginKaptchaFilterä¸­åŠ å…¥éªŒè¯ç éªŒè¯</p>
<pre><code>//è‡ªå®šä¹‰ filter
public class LoginKaptchaFilter extends UsernamePasswordAuthenticationFilter &#123;

    public static final String FORM_KAPTCHA_KEY = &quot;kaptcha&quot;;

    private String kaptchaParameter = FORM_KAPTCHA_KEY;

    public String getKaptchaParameter() &#123;
        return kaptchaParameter;
    &#125;

    public void setKaptchaParameter(String kaptchaParameter) &#123;
        this.kaptchaParameter = kaptchaParameter;
    &#125;

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123;
        if (!request.getMethod().equals(&quot;POST&quot;)) &#123;
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        &#125;
        try &#123;
            //1.è·å–è¯·æ±‚æ•°æ®
            Map&lt;String, String&gt; userInfo = new ObjectMapper().readValue(request.getInputStream(), Map.class);
            String kaptcha = userInfo.get(getKaptchaParameter());//ç”¨æ¥è·å–æ•°æ®ä¸­éªŒè¯ç 
            String username = userInfo.get(getUsernameParameter());//ç”¨æ¥æ¥æ”¶ç”¨æˆ·å
            String password = userInfo.get(getPasswordParameter());//ç”¨æ¥æ¥æ”¶å¯†ç 
            //2.è·å– session ä¸­éªŒè¯ç 
            String sessionVerifyCode = (String) request.getSession().getAttribute(&quot;kaptcha&quot;);
            if (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionVerifyCode) &amp;&amp;
                    kaptcha.equalsIgnoreCase(sessionVerifyCode)) &#123;
                //3.è·å–ç”¨æˆ·å å’Œå¯†ç è®¤è¯
                UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
                setDetails(request, authRequest);
                return this.getAuthenticationManager().authenticate(authRequest);
            &#125;
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
        throw new KaptchaNotMatchException(&quot;éªŒè¯ç ä¸åŒ¹é…!&quot;);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>é…ç½®</p>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;

    //è‡ªå®šä¹‰å†…å­˜æ•°æ®æº
    @Bean
    public UserDetailsService userDetailsService() &#123;
        InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
        inMemoryUserDetailsManager.createUser(User.withUsername(&quot;root&quot;).password(&quot;&#123;noop&#125;123&quot;).roles(&quot;admin&quot;).build());
        return inMemoryUserDetailsManager;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;

    @Override
    @Bean
    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
        return super.authenticationManagerBean();
    &#125;

    //é…ç½®
    @Bean
    public LoginKaptchaFilter loginKaptchaFilter() throws Exception &#123;
        LoginKaptchaFilter loginKaptchaFilter = new LoginKaptchaFilter();
        //1.è®¤è¯ url
        loginKaptchaFilter.setFilterProcessesUrl(&quot;/doLogin&quot;);
        //2.è®¤è¯ æ¥æ”¶å‚æ•°
        loginKaptchaFilter.setUsernameParameter(&quot;uname&quot;);
        loginKaptchaFilter.setPasswordParameter(&quot;passwd&quot;);
        loginKaptchaFilter.setKaptchaParameter(&quot;kaptcha&quot;);
        //3.æŒ‡å®šè®¤è¯ç®¡ç†å™¨
        loginKaptchaFilter.setAuthenticationManager(authenticationManagerBean());
        //4.æŒ‡å®šæˆåŠŸæ—¶å¤„ç†
        loginKaptchaFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;
            Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
            result.put(&quot;msg&quot;, &quot;ç™»å½•æˆåŠŸ&quot;);
            result.put(&quot;ç”¨æˆ·ä¿¡æ¯&quot;, authentication.getPrincipal());
            resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
            resp.setStatus(HttpStatus.OK.value());
            String s = new ObjectMapper().writeValueAsString(result);
            resp.getWriter().println(s);
        &#125;);
        //5.è®¤è¯å¤±è´¥å¤„ç†
        loginKaptchaFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;
            Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
            result.put(&quot;msg&quot;, &quot;ç™»å½•å¤±è´¥: &quot; + ex.getMessage());
            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
            resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
            String s = new ObjectMapper().writeValueAsString(result);
            resp.getWriter().println(s);
        &#125;);
        return loginKaptchaFilter;
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .mvcMatchers(&quot;/vc.jpg&quot;).permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .exceptionHandling()
                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;
                    resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());
                    resp.getWriter().println(&quot;å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®!&quot;);
                &#125;)
                .and()
                .logout()
                .and()
                .csrf().disable();

        http.addFilterAt(loginKaptchaFilter(), UsernamePasswordAuthenticationFilter.class);
    &#125;
</code></pre>
</li>
<li>
<p>æµ‹è¯•éªŒè¯</p>
</li>
</ul>
<h2 id="ç¬¬å››ç« -å¯†ç åŠ å¯†">ç¬¬å››ç«  å¯†ç åŠ å¯†</h2>
<ul>
<li>å¯†ç ä¸ºä»€ä¹ˆè¦åŠ å¯†</li>
<li>å¸¸è§åŠ å¯†çš„è§£å†³æ–¹æ¡ˆ</li>
<li>PasswordEncoder è¯¦è§£</li>
<li>ä¼˜é›…ä½¿ç”¨åŠ å¯†</li>
</ul>
<h3 id="ç®€ä»‹-2">ç®€ä»‹</h3>
<h4 id="åŠ å¯†æ„ä¹‰">åŠ å¯†æ„ä¹‰</h4>
<p>â€‹ 2011 å¹´12æœˆ21 æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å«600ä¸‡ä¸ª CSDN ç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”Ÿå CSDN åœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºäº†å£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“ç³»2009 å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„æ¼ï¼Œå·²ç»å‘è­¦æ–¹æŠ¥<br>
æ¡ˆï¼Œååˆåœ¨å®˜ç½‘å‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äº CSDN æŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„æ¼å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚ç”±äºæœ‰äº†è¿™ä¹ˆå¤šå‰è½¦ä¹‹é‰´ï¼Œæˆ‘ä»¬ç°åœ¨åšç³»ç»Ÿæ—¶ï¼Œå¯†ç éƒ½è¦åŠ å¯†å¤„ç†ã€‚</p>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œå‡¡æ˜¯æ¶‰åŠå¯†ç çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨æ˜æ–‡å­˜å‚¨ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™è‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥æé«˜çš„å®‰å…¨é£é™©ã€‚åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¯†ç ä¸ä»…éœ€è¦åŠ å¯†ï¼Œè¿˜éœ€è¦åŠ <code>ç›</code>ï¼Œæœ€å¤§ç¨‹åº¦åœ°ä¿è¯å¯†ç å®‰å…¨ã€‚</p>
<h4 id="å¸¸è§æ–¹æ¡ˆ">å¸¸è§æ–¹æ¡ˆ</h4>
<h5 id="Hash-ç®—æ³•">Hash ç®—æ³•</h5>
<p>â€‹ æœ€æ—©æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼ SHA-256 ã€SHA-512 ã€MD5ç­‰è¿™æ ·çš„å•å‘ Hash ç®—æ³•ã€‚ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œä¿å­˜åœ¨æ•°æ®åº“ä¸­ä¸å†æ˜¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œè€Œæ˜¯ç»è¿‡ SHA-256 åŠ å¯†è®¡ç®—çš„ä¸€ä¸ªå­—è¡Œä¸²ï¼Œå½“ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç ç”¨ SHA-256 è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆä¹‹åï¼Œå†å’Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œè¿›è€Œç¡®å®šç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœç³»ç»Ÿé­é‡æ”»å‡»ï¼Œæœ€å¤šä¹Ÿåªæ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†æ–‡è¢«æ³„æ¼ã€‚</p>
<p>â€‹ è¿™æ ·å°±ç»å¯¹å®‰å…¨äº†å—ï¼Ÿç”±äºå½©è™¹è¡¨è¿™ç§æ”»å‡»æ–¹å¼çš„å­˜åœ¨ä»¥åŠéšç€è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•ï¼Œæ¯ç§’æ‰§è¡Œæ•°åäº¿æ¬¡ HASHè®¡ç®—å·±ç»å˜å¾—è½»è½»æ¾æ¾ï¼Œè¿™æ„å‘³ç€å³ä½¿ç»™å¯†ç åŠ å¯†åŠ ç›ä¹Ÿä¸å†å®‰å…¨ã€‚</p>
<p>å‚è€ƒ: <a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin">[å½©è™¹è¡¨]</a></p>
<h5 id="å•å‘è‡ªé€‚åº”å‡½æ•°">å•å‘è‡ªé€‚åº”å‡½æ•°</h5>
<p>åœ¨Spring Security ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯ç”¨ä¸€ç§è‡ªé€‚åº”å•å‘å‡½æ•° (Adaptive One-way Functions)æ¥å¤„ç†å¯†ç é—®é¢˜ï¼Œè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åœ¨è¿›è¡Œå¯†ç åŒ¹é…æ—¶ï¼Œä¼šæœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼ˆä¾‹å¦‚CPUã€å†…å­˜ç­‰ï¼‰ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ¶æ„ç”¨æˆ·æ”»å‡»ç³»ç»Ÿçš„éš¾åº¦ã€‚åœ¨Spring Securiy ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ bcryptã€PBKDF2ã€sCrypt ä»¥åŠ argon2 æ¥ä½“éªŒè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åŠ å¯†ã€‚ç”±äºè‡ªé€‚åº”å•å‘å‡½æ•°æœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼Œå› æ­¤æ¯ä¸ªç™»å½•è®¤è¯è¯·æ±‚éƒ½ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä½†æ˜¯ Spring Secuity ä¸ä¼šé‡‡å–ä»»ä½•æªæ–½æ¥æé«˜å¯†ç éªŒè¯é€Ÿåº¦ï¼Œå› ä¸ºå®ƒæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
<p>å‚è€ƒ 1: <a target="_blank" rel="noopener" href="https://byronhe.gitbooks.io/libsodium/content/password_hashing/">https://byronhe.gitbooks.io/libsodium/content/password_hashing/</a></p>
<p>å‚è€ƒ 2: <a target="_blank" rel="noopener" href="https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md">https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md</a></p>
<ul>
<li>
<p>BCryptPasswordEncoder</p>
<p>BCryptPasswordEncoder ä½¿ç”¨ bcrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œä¸ºäº†æé«˜å¯†ç çš„å®‰å…¨æ€§ï¼Œbcryptç®—æ³•æ•…æ„é™ä½è¿è¡Œé€Ÿåº¦ï¼Œä»¥å¢å¼ºå¯†ç ç ´è§£çš„éš¾åº¦ã€‚åŒæ—¶ BCryptP asswordEncoder â€œä¸ºè‡ªå·±å¸¦ç›â€å¼€å‘è€…ä¸éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªâ€œç›â€ å­—æ®µï¼Œä½¿ç”¨ BCryptPasswordEncoder åŠ å¯†åçš„å­—ç¬¦ä¸²å°±å·²ç»â€œå¸¦ç›â€äº†ï¼Œå³ä½¿ç›¸åŒçš„æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„åŠ å¯†å­—ç¬¦ä¸²éƒ½ä¸ç›¸åŒã€‚</p>
</li>
<li>
<p>Argon2PasswordEncoder</p>
<p>Argon2PasswordEncoder ä½¿ç”¨ Argon2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼ŒArgon2 æ›¾åœ¨ Password Hashing Competition ç«èµ›ä¸­è·èƒœã€‚ä¸ºäº†è§£å†³åœ¨å®šåˆ¶ç¡¬ä»¶ä¸Šå¯†ç å®¹æ˜“è¢«ç ´è§£çš„é—®é¢˜ï¼ŒArgon2ä¹Ÿæ˜¯æ•…æ„é™ä½è¿ç®—é€Ÿåº¦ï¼ŒåŒæ—¶éœ€è¦å¤§é‡å†…å­˜ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
</li>
<li>
<p>Pbkdf2PasswordEncoder</p>
<p>Pbkdf2PasswordEncoder ä½¿ç”¨ PBKDF2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢å‡ ç§ç±»ä¼¼ï¼ŒPBKDF2</p>
<p>ç®—æ³•ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œå½“éœ€è¦ FIPS (Federal Information Processing Standard,ç¾å›½è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ï¼‰è®¤è¯æ—¶ï¼ŒPBKDF2 ç®—æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
</li>
<li>
<p>SCryptPasswordEncoder</p>
<p>SCryptPasswordEncoder ä½¿ç”¨scrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢çš„å‡ ç§ç±»ä¼¼ï¼Œserypt ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œè€Œä¸”éœ€è¦å¤§é‡å†…å­˜ã€‚</p>
</li>
</ul>
<h3 id="PasswordEncoder">PasswordEncoder</h3>
<p>é€šè¿‡å¯¹è®¤è¯æµç¨‹æºç åˆ†æå¾—çŸ¥ï¼Œå®é™…å¯†ç æ¯”è¾ƒæ˜¯ç”±PasswordEncoderå®Œæˆçš„ï¼Œå› æ­¤åªéœ€è¦ä½¿ç”¨PasswordEncoder ä¸åŒå®ç°å°±å¯ä»¥å®ç°ä¸åŒæ–¹å¼åŠ å¯†ã€‚</p>
<pre><code>public interface PasswordEncoder &#123;
	String encode(CharSequence rawPassword);
	boolean matches(CharSequence rawPassword, String encodedPassword);
	default boolean upgradeEncoding(String encodedPassword) &#123;
		return false;
	&#125;
&#125;
</code></pre>
<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<p>é»˜è®¤æä¾›åŠ å¯†ç®—æ³•å¦‚ä¸‹:</p>
<p><img src="https://img-blog.csdnimg.cn/f7d6283f494f4315976a6a5592aed02f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/f858267f116b4980a1feeef9b654c74b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="DelegatingPasswordEncoder">DelegatingPasswordEncoder</h3>
<p>æ ¹æ®ä¸Šé¢ PasswordEncoderçš„ä»‹ç»ï¼Œå¯èƒ½ä¼šä»¥ä¸º Spring security ä¸­é»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆåº”è¯¥æ˜¯å››ç§è‡ªé€‚åº”å•å‘åŠ å¯†å‡½æ•°ä¸­çš„ä¸€ç§ï¼Œå…¶å®ä¸ç„¶ï¼Œåœ¨ spring Security 5.0ä¹‹åï¼Œé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå…¶å®æ˜¯ DelegatingPasswordEncoderã€‚ä»åå­—ä¸Šæ¥çœ‹ï¼ŒDelegatingPaswordEncoder æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œå¹¶éä¸€ç§å…¨æ–°çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼ŒDeleggtinePasswordEncoder ä¸»è¦ç”¨æ¥ä»£ç†ä¸Šé¢ä»‹ç»çš„ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚ä¸ºä»€ä¹ˆé‡‡DelegatingPasswordEncoder è€Œä¸æ˜¯æŸä¸€ä¸ªå…·ä½“åŠ å¯†æ–¹å¼ä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå‘¢ï¼Ÿä¸»è¦è€ƒè™‘äº†å¦‚ä¸‹ä¸¤æ–¹é¢çš„å› ç´ ï¼š</p>
<ul>
<li>
<p>å…¼å®¹æ€§ï¼šä½¿ç”¨ DelegatingPasswrordEncoder å¯ä»¥å¸®åŠ©è®¸å¤šä½¿ç”¨æ—§å¯†ç åŠ å¯†æ–¹å¼çš„ç³»ç»Ÿé¡ºåˆ©è¿ç§»åˆ° Spring security ä¸­ï¼Œå®ƒå…è®¸åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šç§ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚</p>
</li>
<li>
<p>ä¾¿æ·æ€§ï¼šå¯†ç å­˜å‚¨çš„æœ€ä½³æ–¹æ¡ˆä¸å¯èƒ½ä¸€ç›´ä¸å˜ï¼Œå¦‚æœä½¿ç”¨ DelegatingPasswordEncoderä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼Œå½“éœ€è¦ä¿®æ”¹åŠ å¯†æ–¹æ¡ˆæ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¾ˆå°ä¸€éƒ¨åˆ†ä»£ç å°±å¯ä»¥å®ç°ã€‚</p>
</li>
</ul>
<h5 id="DelegatingPasswordEncoderæºç ">DelegatingPasswordEncoderæºç </h5>
<pre><code>public class DelegatingPasswordEncoder implements PasswordEncoder &#123;
  ....
&#125;
</code></pre>
<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<h5 id="PasswordEncoderFactoriesæºç ">PasswordEncoderFactoriesæºç </h5>
<pre><code>public static PasswordEncoder createDelegatingPasswordEncoder() &#123;
		String encodingId = &quot;bcrypt&quot;;
		Map&lt;String, PasswordEncoder&gt; encoders = new HashMap&lt;&gt;();
		encoders.put(encodingId, new BCryptPasswordEncoder());
		encoders.put(&quot;ldap&quot;, new org.springframework.security.crypto.password.LdapShaPasswordEncoder());
		encoders.put(&quot;MD4&quot;, new org.springframework.security.crypto.password.Md4PasswordEncoder());
		encoders.put(&quot;MD5&quot;, new org.springframework.security.crypto.password.MessageDigestPasswordEncoder(&quot;MD5&quot;));
		encoders.put(&quot;noop&quot;, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());
		encoders.put(&quot;pbkdf2&quot;, new Pbkdf2PasswordEncoder());
		encoders.put(&quot;scrypt&quot;, new SCryptPasswordEncoder());
		encoders.put(&quot;SHA-1&quot;, new org.springframework.security.crypto.password.MessageDigestPasswordEncoder(&quot;SHA-1&quot;));
		encoders.put(&quot;SHA-256&quot;,
				new org.springframework.security.crypto.password.MessageDigestPasswordEncoder(&quot;SHA-256&quot;));
		encoders.put(&quot;sha256&quot;, new org.springframework.security.crypto.password.StandardPasswordEncoder());
		encoders.put(&quot;argon2&quot;, new Argon2PasswordEncoder());
		return new DelegatingPasswordEncoder(encodingId, encoders);
	&#125;
</code></pre>
<h3 id="å¦‚ä½•ä½¿ç”¨-PasswordEncoder">å¦‚ä½•ä½¿ç”¨ PasswordEncoder</h3>
<ul>
<li>
<p>æŸ¥çœ‹WebSecurityConfigurerAdapterç±»ä¸­æºç </p>
<p>static class LazyPasswordEncoder implements PasswordEncoder {<br>
private ApplicationContext applicationContext;<br>
private PasswordEncoder passwordEncoder;<br>
LazyPasswordEncoder(ApplicationContext applicationContext) {<br>
this.applicationContext = applicationContext;<br>
}<br>
@Override<br>
public String encode(CharSequence rawPassword) {<br>
return getPasswordEncoder().encode(rawPassword);<br>
}</p>
<pre><code>	@Override
	public boolean matches(CharSequence rawPassword, String encodedPassword) &#123;
		return getPasswordEncoder().matches(rawPassword, encodedPassword);
	&#125;

	@Override
	public boolean upgradeEncoding(String encodedPassword) &#123;
		return getPasswordEncoder().upgradeEncoding(encodedPassword);
	&#125;

	private PasswordEncoder getPasswordEncoder() &#123;
		if (this.passwordEncoder != null) &#123;
			return this.passwordEncoder;
		&#125;
		PasswordEncoder passwordEncoder = getBeanOrNull(PasswordEncoder.class);
		if (passwordEncoder == null) &#123;
			passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();
		&#125;
		this.passwordEncoder = passwordEncoder;
		return passwordEncoder;
	&#125;

	private &lt;T&gt; T getBeanOrNull(Class&lt;T&gt; type) &#123;
		try &#123;
			return this.applicationContext.getBean(type);
		&#125;
		catch (NoSuchBeanDefinitionException ex) &#123;
			return null;
		&#125;
	&#125;

	@Override
	public String toString() &#123;
		return getPasswordEncoder().toString();
	&#125;

&#125;
</code></pre>
</li>
</ul>
<p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¦‚æœåœ¨å·¥å‚ä¸­æŒ‡å®šäº†PasswordEncoderï¼Œå°±ä¼šä½¿ç”¨æŒ‡å®šPasswordEncoderï¼Œå¦åˆ™å°±ä¼šä½¿ç”¨é»˜è®¤DelegatingPasswordEncoderã€‚</p>
<h3 id="å¯†ç åŠ å¯†å®æˆ˜">å¯†ç åŠ å¯†å®æˆ˜</h3>
<ul>
<li>
<p>æµ‹è¯•ç”Ÿæˆçš„å¯†ç </p>
<p>@Test<br>
public void test() {<br>
<a target="_blank" rel="noopener" href="//1.BCryptPasswordEncoder">//1.BCryptPasswordEncoder</a><br>
BCryptPasswordEncoder bCryptPasswordEncoder = new BCryptPasswordEncoder();<br>
System.out.println(bCryptPasswordEncoder.encode(â€œ123â€));</p>
<p><a target="_blank" rel="noopener" href="//2.Pbkdf2PasswordEncoder">//2.Pbkdf2PasswordEncoder</a><br>
Pbkdf2PasswordEncoder pbkdf2PasswordEncoder = new Pbkdf2PasswordEncoder();<br>
System.out.println(pbkdf2PasswordEncoder.encode(â€œ123â€));</p>
<p><a target="_blank" rel="noopener" href="//3.SCryptPasswordEncoder">//3.SCryptPasswordEncoder</a> //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–<br>
SCryptPasswordEncoder sCryptPasswordEncoder = new SCryptPasswordEncoder();<br>
System.out.println(sCryptPasswordEncoder.encode(â€œ123â€));</p>
<p><a target="_blank" rel="noopener" href="//4.Argon2PasswordEncoder">//4.Argon2PasswordEncoder</a> //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–<br>
Argon2PasswordEncoder argon2PasswordEncoder = new Argon2PasswordEncoder();<br>
System.out.println(argon2PasswordEncoder.encode(â€œ123â€));<br>
}</p>
</li>
<li>
<p>ä½¿ç”¨å›ºå®šå¯†ç åŠ å¯†æ–¹æ¡ˆ</p>
<p>@Configuration<br>
public class SecurityConfig extends WebSecurityConfigurerAdapter {<br>
@Bean<br>
public PasswordEncoder BcryptPasswordEncoder() {<br>
return new BCryptPasswordEncoder();<br>
}<br>
@Bean<br>
public UserDetailsService userDetailsService() {<br>
InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();<br>
inMemoryUserDetailsManager.createUser(User.withUsername(â€œrootâ€).password(â€œ$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6aâ€).roles(â€œxxxâ€).build());<br>
return inMemoryUserDetailsManager;<br>
}<br>
}</p>
</li>
<li>
<p>ä½¿ç”¨çµæ´»å¯†ç åŠ å¯†æ–¹æ¡ˆ æ¨è</p>
<p>@Configuration<br>
public class SecurityConfig extends WebSecurityConfigurerAdapter {<br>
@Bean<br>
public UserDetailsService userDetailsService() {<br>
InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();<br>
inMemoryUserDetailsManager.createUser(User.withUsername(â€œrootâ€).password(â€œ{bcrypt}$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6aâ€).roles(â€œxxxâ€).build());<br>
return inMemoryUserDetailsManager;<br>
}<br>
}</p>
</li>
</ul>
<h3 id="å¯†ç è‡ªåŠ¨å‡çº§">å¯†ç è‡ªåŠ¨å‡çº§</h3>
<p>æ¨èä½¿ç”¨DelegatingPasswordEncoder çš„å¦å¤–ä¸€ä¸ªå¥½å¤„å°±æ˜¯è‡ªåŠ¨è¿›è¡Œå¯†ç åŠ å¯†æ–¹æ¡ˆçš„å‡çº§ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨æ•´åˆä¸€äº›è€çš„ç³»ç»Ÿæ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<ul>
<li>
<p>å‡†å¤‡åº“è¡¨</p>
<p>â€“ ç”¨æˆ·è¡¨<br>
CREATE TABLE <code>user</code><br>
(<br>
<code>id</code>                    int(11) NOT NULL AUTO_INCREMENT,<br>
<code>username</code>              varchar(32)  DEFAULT NULL,<br>
<code>password</code>              varchar(255) DEFAULT NULL,<br>
<code>enabled</code>               tinyint(1) DEFAULT NULL,<br>
<code>accountNonExpired</code>     tinyint(1) DEFAULT NULL,<br>
<code>accountNonLocked</code>      tinyint(1) DEFAULT NULL,<br>
<code>credentialsNonExpired</code> tinyint(1) DEFAULT NULL,<br>
PRIMARY KEY (<code>id</code>)<br>
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;<br>
â€“ è§’è‰²è¡¨<br>
CREATE TABLE <code>role</code><br>
(<br>
<code>id</code>      int(11) NOT NULL AUTO_INCREMENT,<br>
<code>name</code>    varchar(32) DEFAULT NULL,<br>
<code>name_zh</code> varchar(32) DEFAULT NULL,<br>
PRIMARY KEY (<code>id</code>)<br>
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;<br>
â€“ ç”¨æˆ·è§’è‰²å…³ç³»è¡¨<br>
CREATE TABLE <code>user_role</code><br>
(<br>
<code>id</code>  int(11) NOT NULL AUTO_INCREMENT,<br>
<code>uid</code> int(11) DEFAULT NULL,<br>
<code>rid</code> int(11) DEFAULT NULL,<br>
PRIMARY KEY (<code>id</code>),<br>
KEY   <code>uid</code> (<code>uid</code>),<br>
KEY   <code>rid</code> (<code>rid</code>)<br>
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</p>
</li>
<li>
<p>æ’å…¥æ•°æ®</p>
<p>â€“ æ’å…¥ç”¨æˆ·æ•°æ®<br>
BEGIN;<br>
INSERT INTO <code>user</code><br>
VALUES (1, â€˜rootâ€™, â€˜{noop}123â€™, 1, 1, 1, 1);<br>
INSERT INTO <code>user</code><br>
VALUES (2, â€˜adminâ€™, â€˜{noop}123â€™, 1, 1, 1, 1);<br>
INSERT INTO <code>user</code><br>
VALUES (3, â€˜blrâ€™, â€˜{noop}123â€™, 1, 1, 1, 1);<br>
COMMIT;<br>
â€“ æ’å…¥è§’è‰²æ•°æ®<br>
BEGIN;<br>
INSERT INTO <code>role</code><br>
VALUES (1, â€˜ROLE_productâ€™, â€˜å•†å“ç®¡ç†å‘˜â€™);<br>
INSERT INTO <code>role</code><br>
VALUES (2, â€˜ROLE_adminâ€™, â€˜ç³»ç»Ÿç®¡ç†å‘˜â€™);<br>
INSERT INTO <code>role</code><br>
VALUES (3, â€˜ROLE_userâ€™, â€˜ç”¨æˆ·ç®¡ç†å‘˜â€™);<br>
COMMIT;<br>
â€“ æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®<br>
BEGIN;<br>
INSERT INTO <code>user_role</code><br>
VALUES (1, 1, 1);<br>
INSERT INTO <code>user_role</code><br>
VALUES (2, 1, 2);<br>
INSERT INTO <code>user_role</code><br>
VALUES (3, 2, 2);<br>
INSERT INTO <code>user_role</code><br>
VALUES (4, 3, 3);<br>
COMMIT;</p>
</li>
<li>
<p>æ•´åˆ mybatis</p>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.38</version>
</dependency>
<dependency>
  <groupId>org.mybatis.spring.boot</groupId>
  <artifactId>mybatis-spring-boot-starter</artifactId>
  <version>2.2.0</version>
</dependency>
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <version>1.2.8</version>
</dependency>
<p>spring.datasource.type=com.alibaba.druid.pool.DruidDataSource<br>
spring.datasource.driver-class-name=com.mysql.jdbc.Driver<br>
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=false<br>
spring.datasource.username=root<br>
spring.datasource.password=root<br>
mybatis.mapper-locations=classpath:/mapper/*.xml<br>
mybatis.type-aliases-package=com.baizhi.entity<br>
logging.level.com.baizhi.dao=debug</p>
</li>
<li>
<p>ç¼–å†™å®ä½“ç±»</p>
<p>public class User implements UserDetails {<br>
private Integer id;<br>
private String username;<br>
private String password;<br>
private Boolean enabled;<br>
private Boolean accountNonExpired;<br>
private Boolean accountNonLocked;<br>
private Boolean credentialsNonExpired;<br>
private List<Role> roles = new ArrayList&lt;&gt;();<br>
@Override<br>
public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {<br>
List<SimpleGrantedAuthority> authorities = new ArrayList&lt;&gt;();<br>
for (Role role : roles) {<br>
authorities.add(new SimpleGrantedAuthority(role.getName()));<br>
}<br>
return authorities;<br>
}</p>
<pre><code>@Override
public String getPassword() &#123;
    return password;
&#125;

public void setPassword(String password) &#123;
    this.password = password;
&#125;

@Override
public String getUsername() &#123;
    return username;
&#125;

public void setUsername(String username) &#123;
    this.username = username;
&#125;

@Override
public boolean isAccountNonExpired() &#123;
    return accountNonExpired;
&#125;

public void setAccountNonExpired(Boolean accountNonExpired) &#123;
    this.accountNonExpired = accountNonExpired;
&#125;

@Override
public boolean isAccountNonLocked() &#123;
    return accountNonLocked;
&#125;

public void setAccountNonLocked(Boolean accountNonLocked) &#123;
    this.accountNonLocked = accountNonLocked;
&#125;

@Override
public boolean isCredentialsNonExpired() &#123;
    return credentialsNonExpired;
&#125;

public void setCredentialsNonExpired(Boolean credentialsNonExpired) &#123;
    this.credentialsNonExpired = credentialsNonExpired;
&#125;

@Override
public boolean isEnabled() &#123;
    return enabled;
&#125;

public void setEnabled(Boolean enabled) &#123;
    this.enabled = enabled;
&#125;

public void setRoles(List&lt;Role&gt; roles) &#123;
    this.roles = roles;
&#125;

public Integer getId() &#123;
    return id;
&#125;

public void setId(Integer id) &#123;
    this.id = id;
&#125;
</code></pre>
<p>}</p>
<p>public class Role {<br>
private Integer id;<br>
private String name;<br>
private String nameZh;</p>
<pre><code>public Integer getId() &#123;
    return id;
&#125;

public void setId(Integer id) &#123;
    this.id = id;
&#125;

public String getName() &#123;
    return name;
&#125;

public void setName(String name) &#123;
    this.name = name;
&#125;

public String getNameZh() &#123;
    return nameZh;
&#125;

public void setNameZh(String nameZh) &#123;
    this.nameZh = nameZh;
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>åˆ›å»ºdao</p>
<p>@Mapper<br>
public interface UserDao {<br>
List<Role> getRolesByUid(Integer uid);<br>
User loadUserByUsername(String username);<br>
Integer updatePassword(@Param(â€œusernameâ€) String username,@Param(â€œpasswordâ€) String password);<br>
}</p>
</li>
<li>
<p>ç¼–å†™ mapper</p>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baizhi.dao.UserDao">
<pre><code>&lt;select id=&quot;loadUserByUsername&quot; resultType=&quot;User&quot;&gt;
    select id,
           username,
           password,
           enabled,
           accountNonExpired,
           accountNonLocked,
           credentialsNonExpired
    from `user`
    where username = #&#123;username&#125;
&lt;/select&gt;


&lt;select id=&quot;getRolesByUid&quot; resultType=&quot;Role&quot;&gt;
    select r.id,
           r.name,
           r.name_zh nameZh
    from `role` r,
         `user_role` ur
    where r.id = ur.rid
      and ur.uid = #&#123;uid&#125;
&lt;/select&gt;

&lt;update id=&quot;updatePassword&quot;&gt;
  update `user` set password=#&#123;password&#125;
  where username=#&#123;username&#125;
&lt;/update&gt;
</code></pre>
</mapper>
</li>
<li>
<p>ç¼–å†™service å®ç°</p>
<p>@Service<br>
public class MyUserDetailService implements UserDetailsService,UserDetailsPasswordService {<br>
private final UserDao userDao;</p>
<pre><code>@Autowired
public MyUserDetailService(UserDao userDao) &#123;
    this.userDao = userDao;
&#125;

@Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
    User user = userDao.loadUserByUsername(username);
    if (ObjectUtils.isEmpty(user)) &#123;
        throw new RuntimeException(&quot;ç”¨æˆ·ä¸å­˜åœ¨!&quot;);
    &#125;
    user.setRoles(userDao.getRolesByUid(user.getId()));
    return user;
&#125;

 @Override
public UserDetails updatePassword(UserDetails user, String newPassword) &#123;
    Integer result = userDao.updatePassword(user.getUsername(), newPassword);
    if (result == 1) &#123;
        ((User) user).setPassword(newPassword);
    &#125;
    return user;
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½®securityconfig</p>
<p>@Configuration<br>
public class SecurityConfig extends WebSecurityConfigurerAdapter {</p>
<pre><code>private final MyUserDetailService myUserDetailService;

@Autowired
public SecurityConfig(MyUserDetailService myUserDetailService) &#123;
    this.myUserDetailService = myUserDetailService;
&#125;
  @Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
    //æŸ¥è¯¢æ•°æ®åº“
    auth.userDetailsService(myUserDetailService);
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>å¯åŠ¨é¡¹ç›®æµ‹è¯•</p>
</li>
</ul>
<h2 id="ç¬¬äº”ç« -RememberMe">ç¬¬äº”ç«  RememberMe</h2>
<ul>
<li>ç®€ä»‹</li>
<li>åŸºæœ¬ä½¿ç”¨</li>
<li>åŸç†åˆ†æ</li>
<li>æŒä¹…åŒ–ä»¤ç‰Œ</li>
</ul>
<h3 id="ç®€ä»‹-3">ç®€ä»‹</h3>
<p>RememberMe è¿™ä¸ªåŠŸèƒ½éå¸¸å¸¸è§ï¼Œä¸‹å›¾å°±æ˜¯QQ é‚®ç®±ç™»å½•æ—¶çš„â€œè®°ä½æˆ‘â€ é€‰é¡¹ã€‚æåˆ° RememberMeï¼Œä¸€äº›åˆå­¦è€…å¾€å¾€ä¼šæœ‰ä¸€äº›è¯¯è§£ï¼Œè®¤ä¸º RememberMe åŠŸèƒ½å°±æ˜¯æŠŠç”¨æˆ·å/å¯†ç ç”¨ Cookie ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡ç™»å½•æ—¶ä¸ç”¨å†æ¬¡è¾“å…¥ç”¨æˆ·å/å¯†ç ã€‚è¿™ä¸ªç†è§£æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ RememberMe æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯çš„è¡Œä¸ºã€‚ä¼ ç»Ÿçš„ç™»å½•æ–¹å¼åŸºäº Sessionä¼šè¯ï¼Œä¸€æ—¦ç”¨æˆ·çš„ä¼šè¯è¶…æ—¶è¿‡æœŸï¼Œå°±è¦å†æ¬¡ç™»å½•ï¼Œè¿™æ ·å¤ªè¿‡äºçƒ¦çã€‚å¦‚æœèƒ½æœ‰ä¸€ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·ä¼šè¯è¿‡æœŸä¹‹åï¼Œè¿˜èƒ½ç»§ç»­ä¿æŒè®¤è¯çŠ¶æ€ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼ŒRememberMe å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€éœ€æ±‚è€Œç”Ÿçš„ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/2696c87cadf84c019a26deeba726a42a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“çš„å®ç°æ€è·¯å°±æ˜¯é€šè¿‡ Cookie æ¥è®°å½•å½“å‰ç”¨æˆ·èº«ä»½ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œä¼šé€šè¿‡ä¸€å®šç®—æ³•ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´æˆ³ç­‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆåï¼Œé€šè¿‡å“åº”å¤´å¸¦å›å‰ç«¯å­˜å‚¨åœ¨cookieä¸­ï¼Œå½“æµè§ˆå™¨ä¼šè¯è¿‡æœŸä¹‹åï¼Œå¦‚æœå†æ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œä¼šè‡ªåŠ¨å°† Cookie ä¸­çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯¹ Cookieä¸­çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒåˆ†æï¼Œè¿›è€Œç¡®å®šå‡ºç”¨æˆ·çš„èº«ä»½ï¼ŒCookieä¸­æ‰€ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œä¾‹å¦‚ä¸‰å¤©ã€ä¸€å‘¨ç­‰ã€‚</p>
<h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3>
<h4 id="å¼€å¯è®°ä½æˆ‘">å¼€å¯è®°ä½æˆ‘</h4>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    //....
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .mvcMatchers(&quot;/login.html&quot;).permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                //...
                .and()
                .rememberMe() //å¼€å¯è®°ä½æˆ‘åŠŸèƒ½
                .and()
                .csrf().disable();
    &#125;
&#125;
</code></pre>
<h4 id="ä½¿ç”¨è®°ä½æˆ‘">ä½¿ç”¨è®°ä½æˆ‘</h4>
<p>å¯ä»¥çœ‹åˆ°ä¸€æ—¦æ‰“å¼€äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œç™»å½•é¡µé¢ä¸­ä¼šå¤šå‡ºä¸€ä¸ª RememberMe é€‰é¡¹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/771334161dd94182b662a35e148f980e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="æµ‹è¯•è®°ä½æˆ‘">æµ‹è¯•è®°ä½æˆ‘</h4>
<p>ç™»å½•æ—¶å‹¾é€‰ RememberMe é€‰é¡¹ï¼Œç„¶åé‡å¯æœåŠ¡ç«¯ä¹‹åï¼Œåœ¨æµ‹è¯•æ¥å£æ˜¯å¦èƒ½å…ç™»å½•è®¿é—®ã€‚</p>
<h3 id="åŸç†åˆ†æ">åŸç†åˆ†æ</h3>
<h4 id="RememberMeAuthenticationFilter">RememberMeAuthenticationFilter</h4>
<p><img src="https://img-blog.csdnimg.cn/be04bd5dccaa4f6cbf4a029bc0665b1d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä»ä¸Šå›¾ä¸­ï¼Œå½“åœ¨SecurityConfigé…ç½®ä¸­å¼€å¯äº†&quot;è®°ä½æˆ‘&quot;åŠŸèƒ½ä¹‹å,åœ¨è¿›è¡Œè®¤è¯æ—¶å¦‚æœå‹¾é€‰äº†&quot;è®°ä½æˆ‘&quot;é€‰é¡¹ï¼Œæ­¤æ—¶æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåˆ†ææ•´ä¸ªç™»å½•è¿‡ç¨‹ã€‚é¦–å…ˆå½“æˆ‘ä»¬ç™»å½•æ—¶ï¼Œåœ¨ç™»å½•è¯·æ±‚ä¸­å¤šäº†ä¸€ä¸ª RememberMe çš„å‚æ•°ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/25ba66d2540944738cb2261c90e4ac28.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨åº”è¯¥å¼€å¯ RememberMeåŠŸèƒ½çš„ã€‚å¦‚æœè‡ªå®šä¹‰ç™»å½•é¡µé¢å¼€å¯ RememberMe åŠŸèƒ½åº”è¯¥å¤šåŠ å…¥ä¸€ä¸ªä¸€æ ·çš„è¯·æ±‚å‚æ•°å°±å¯ä»¥å•¦ã€‚è¯¥è¯·æ±‚ä¼šè¢« <code>RememberMeAuthenticationFilter</code>è¿›è¡Œæ‹¦æˆªç„¶åè‡ªåŠ¨ç™»å½•å…·ä½“å‚è§æºç :</p>
<p><img src="https://img-blog.csdnimg.cn/0c1cf539f5f84ec881cf9ebb752a3b88.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>(1ï¼‰è¯·æ±‚åˆ°è¾¾è¿‡æ»¤å™¨ä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­ SecurityContextHolder ä¸­æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼çš„è¯è¡¨ç¤ºç”¨æˆ·å°šæœªç™»å½•ï¼Œæ­¤æ—¶è°ƒç”¨ autoLogin æ–¹æ³•è¿›è¡Œè‡ªåŠ¨ç™»å½•ã€‚</p>
</li>
<li>
<p>(2ï¼‰å½“è‡ªåŠ¨ç™»å½•æˆåŠŸåè¿”å›çš„rememberMeAuth ä¸ä¸ºnull æ—¶ï¼Œè¡¨ç¤ºè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ­¤æ—¶è°ƒç”¨ authenticate æ–¹æ³•å¯¹ key è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸”å°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ç™»å½•æˆåŠŸå›è°ƒï¼Œå¹¶å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç™»å½•æˆåŠŸçš„å›è°ƒå¹¶ä¸åŒ…å« RememberMeServices ä¸­çš„ 1oginSuccess æ–¹æ³•ã€‚</p>
</li>
<li>
<p>(3ï¼‰å¦‚æœè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œåˆ™è°ƒç”¨ remenberMeServices.loginFailæ–¹æ³•å¤„ç†ç™»å½•å¤±è´¥å›è°ƒã€‚onUnsuccessfulAuthentication å’Œ onSuccessfulAuthentication éƒ½æ˜¯è¯¥è¿‡æ»¤å™¨ä¸­å®šä¹‰çš„ç©ºæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å®ç°è¿™å°±æ˜¯ RememberMeAuthenticationFilter è¿‡æ»¤å™¨æ‰€åšçš„äº‹æƒ…ï¼ŒæˆåŠŸå°† RememberMeServicesçš„æœåŠ¡é›†æˆè¿›æ¥ã€‚</p>
</li>
</ul>
<h4 id="RememberMeServices">RememberMeServices</h4>
<p>è¿™é‡Œä¸€å…±å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>autoLogin æ–¹æ³•å¯ä»¥ä»è¯·æ±‚ä¸­æå–å‡ºéœ€è¦çš„å‚æ•°ï¼Œå®Œæˆè‡ªåŠ¨ç™»å½•åŠŸèƒ½ã€‚</li>
<li>loginFail æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•å¤±è´¥çš„å›è°ƒã€‚</li>
<li>1oginSuccess æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•æˆåŠŸçš„å›è°ƒã€‚</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/81920123faf54476b1457237083d5d63.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="TokenBasedRememberMeServices">TokenBasedRememberMeServices</h4>
<p>åœ¨å¼€å¯è®°ä½æˆ‘åå¦‚æœæ²¡æœ‰åŠ å…¥é¢å¤–é…ç½®é»˜è®¤å®ç°å°±æ˜¯ç”±TokenBasedRememberMeServicesè¿›è¡Œçš„å®ç°ã€‚æŸ¥çœ‹è¿™ä¸ªç±»æºç ä¸­ processAutoLoginCookie æ–¹æ³•å®ç°:</p>
<p><img src="https://img-blog.csdnimg.cn/2c0f1b9d54644970809451c3d244d75b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>processAutoLoginCookie æ–¹æ³•ä¸»è¦ç”¨æ¥éªŒè¯ Cookie ä¸­çš„ä»¤ç‰Œä¿¡æ¯æ˜¯å¦åˆæ³•ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆåˆ¤æ–­ cookieTokens é•¿åº¦æ˜¯å¦ä¸ºäº†ï¼Œä¸ä¸ºäº†è¯´æ˜æ ¼å¼ä¸å¯¹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>ä»cookieTokens æ•°ç»„ä¸­æå–å‡ºç¬¬ 1é¡¹ï¼Œä¹Ÿå°±æ˜¯è¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå·±ç»è¿‡æœŸï¼Œåˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>æ ¹æ®ç”¨æˆ·å ï¼ˆcookieTokens æ•°ç»„çš„ç¬¬ã€‚é¡¹ï¼‰æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·å¯¹è±¡ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ makeTokenSignature æ–¹æ³•ç”Ÿæˆä¸€ä¸ªç­¾åï¼Œç­¾åçš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆå°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ã€ç”¨æˆ·å¯†ç ä»¥åŠ key ç»„æˆä¸€ä¸ªå®‡ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œï¼šâ€éš”å¼€ï¼Œç„¶åé€šè¿‡ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯¥å®‡ç¬¦ä¸²è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å°†åŠ å¯†ç»“æœè½¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚</p>
</li>
<li>
<p>åˆ¤æ–­ç¬¬4 æ­¥ç”Ÿæˆçš„ç­¾åå’Œé€šè¿‡ Cookie ä¼ æ¥çš„ç­¾åæ˜¯å¦ç›¸ç­‰ï¼ˆå³ cookieTokens æ•°ç»„<br>
çš„ç¬¬2é¡¹ï¼‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºä»¤ç‰Œåˆæ³•ï¼Œåˆ™ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œå¦åˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/2588a8e456a348c3a93acf9880acbaf0.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>
<p>åœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œé¦–å…ˆè·å–ç”¨æˆ·ç»å’Œå¯†ç ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·å¯†ç åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåä»successfulAuthenticationå¯¹è±¡ä¸­æ“¦é™¤ï¼Œåˆ™ä»æ•°æ®åº“ä¸­é‡æ–°åŠ è½½å‡ºç”¨æˆ·å¯†ç ã€‚</p>
</li>
<li>
<p>è®¡ç®—å‡ºä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸæ˜¯ä¸¤å‘¨ã€‚</p>
</li>
<li>
<p>æ ¹æ®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€ç”¨æˆ·åä»¥åŠç”¨æˆ·å¯†ç ï¼Œè®¡ç®—å‡ºä¸€ä¸ªç­¾åã€‚</p>
</li>
<li>
<p>è°ƒç”¨ setCookie æ–¹æ³•è®¾ç½® Cookieï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¸€å…±åŒ…å«ä¸‰é¡¹ã€‚ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ä»¥åŠç­¾åï¼Œåœ¨setCookie æ–¹æ³•ä¸­ä¼šå°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œ Base64ç¼–ç åå“åº”ç»™å‰ç«¯ã€‚</p>
</li>
</ol>
<h4 id="æ€»ç»“-2">æ€»ç»“</h4>
<p>å½“ç”¨æˆ·é€šè¿‡ç”¨æˆ·å/å¯†ç çš„å½¢å¼ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç ä»¥åŠä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´è®¡ç®—å‡ºä¸€ä¸ªç­¾åï¼Œè¿™ä¸ªç­¾åä½¿ç”¨ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ç”Ÿæˆï¼Œæ˜¯ä¸å¯é€†çš„ã€‚ç„¶åå†å°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ä»¥åŠç­¾åæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œ:â€ éš”å¼€ï¼Œå¯¹æ‹¼æ¥å¥½çš„å­—ç¬¦ä¸²è¿›è¡ŒBase64 ç¼–ç ï¼Œç„¶åå°†ç¼–ç åçš„ç»“æœè¿”å›åˆ°å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°çš„ä»¤ç‰Œã€‚å½“ä¼šè¯è¿‡æœŸä¹‹åï¼Œè®¿é—®ç³»ç»Ÿèµ„æºæ—¶ä¼šè‡ªåŠ¨æºå¸¦ä¸ŠCookieä¸­çš„ä»¤ç‰Œï¼ŒæœåŠ¡ç«¯æ‹¿åˆ° Cookieä¸­çš„ä»¤ç‰Œåï¼Œå…ˆè¿›è¡Œ Bae64è§£ç ï¼Œè§£ç ååˆ†åˆ«æå–å‡ºä»¤ç‰Œä¸­çš„ä¸‰é¡¹æ•°æ®ï¼šæ¥ç€æ ¹æ®ä»¤ç‰Œä¸­çš„æ•°æ®åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™æ ¹æ®ä»¤ç‰Œä¸­çš„ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼šæ¥ç€å†è®¡ç®—å‡ºä¸€ä¸ªç­¾åå’Œä»¤ç‰Œä¸­çš„ç­¾åè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºä¼šç‰Œæ˜¯åˆæ³•ä»¤ç‰Œï¼Œè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œå¦åˆ™è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/d54cf77d55e14f099f6ac18b4948df82.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/e27232b661c2426a877283f498f580f3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="å†…å­˜ä»¤ç‰Œ">å†…å­˜ä»¤ç‰Œ</h3>
<h4 id="PersistentTokenBasedRememberMeServices">PersistentTokenBasedRememberMeServices</h4>
<p><img src="https://img-blog.csdnimg.cn/91bb878b50e8470b817e9078f30e0de8.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>ä¸åŒäº TokonBasedRemornberMeServices ä¸­çš„ processAutologinCookie æ–¹æ³•ï¼Œè¿™é‡ŒcookieTokens æ•°ç»„çš„é•¿åº¦ä¸º2ï¼Œç¬¬ä¸€é¡¹æ˜¯seriesï¼Œç¬¬äºŒé¡¹æ˜¯ tokenã€‚</li>
<li>ä»cookieTokensæ•°ç»„ä¸­åˆ†åˆ°æå–å‡º series å’Œ tokenï¼ ç„¶åæ ¹æ® series å»å†…å­˜ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ª PersistentRememberMeTokenå¯¹è±¡ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„å¯¹è±¡ä¸ºnullï¼Œè¡¨ç¤ºå†…å­˜ä¸­å¹¶æ²¡æœ‰serieså¯¹åº”çš„å€¼ï¼Œæœ¬æ¬¡è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„ token å’Œä» cookieTokens ä¸­è§£æå‡ºæ¥çš„tokenä¸ç›¸åŒï¼Œè¯´æ˜è‡ªåŠ¨ç™»å½•ä¼šç‰Œå·²ç»æ³„æ¼ï¼ˆæ¶æ„ç”¨æˆ·åˆ©ç”¨ä»¤ç‰Œç™»å½•åï¼Œå†…å­˜ä¸­çš„tokenå˜äº†)ï¼Œæ­¤æ—¶ç§»é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è‡ªåŠ¨ç™»å½•è®°å½•å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>æ ¹æ®æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ç»“æœåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç”Ÿæˆä¸€ä¸ªæ–°çš„ PersistentRememberMeToken å¯¹è±¡ï¼Œç”¨æˆ·åå’Œseries ä¸å˜ï¼Œtoken é‡æ–°<br>
ç”Ÿæˆï¼Œdate ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´ã€‚newToken ç”Ÿæˆåï¼Œæ ¹æ® series å»ä¿®æ”¹å†…å­˜ä¸­çš„ token å’Œ date(å³æ¯æ¬¡è‡ªåŠ¨ç™»å½•åéƒ½ä¼šäº§ç”Ÿæ–°çš„ token å’Œ dateï¼‰</li>
<li>è°ƒç”¨ addCookie æ–¹æ³•æ·»åŠ  Cookieï¼Œ åœ¨addCookie æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢æ‰€è¯´çš„<br>
setCookie æ–¹æ³•ï¼Œä½†æ˜¯è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ•°ç»„å‚æ•°ä¸­åªæœ‰ä¸¤é¡¹ï¼šseries å’Œ tokenï¼ˆå³è¿”å›åˆ°å‰ç«¯çš„ä»¤ç‰Œæ˜¯é€šè¿‡å¯¹ series å’Œ token è¿›è¡Œ Base64 ç¼–ç å¾—åˆ°çš„ï¼‰</li>
<li>æœ€åå°†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡å¹¶è¿”å›ã€‚</li>
</ol>
<h4 id="ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°">ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°</h4>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123; 
@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .rememberMe() //å¼€å¯è®°ä½æˆ‘åŠŸèƒ½
                .rememberMeServices(rememberMeServices())
                .and()
                .csrf().disable();
    &#125;

    @Bean
    public RememberMeServices rememberMeServices() &#123;
        return new PersistentTokenBasedRememberMeServices(
          	   &quot;key&quot;,//å‚æ•° 1: è‡ªå®šä¹‰ä¸€ä¸ªç”Ÿæˆä»¤ç‰Œ key é»˜è®¤ UUID  
               userDetailsService(), //å‚æ•° 2:è®¤è¯æ•°æ®æº  
               new InMemoryTokenRepositoryImpl());//å‚æ•° 3:ä»¤ç‰Œå­˜å‚¨æ–¹å¼
    &#125;
&#125;
</code></pre>
<h3 id="æŒä¹…åŒ–ä»¤ç‰Œ">æŒä¹…åŒ–ä»¤ç‰Œ</h3>
<h4 id="å¼•å…¥ä¾èµ–">å¼•å…¥ä¾èµ–</h4>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
  &lt;artifactId&gt;druid&lt;/artifactId&gt;
  &lt;version&gt;1.2.8&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.38&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
  &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
  &lt;version&gt;2.2.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4 id="é…ç½®æ•°æ®æº">é…ç½®æ•°æ®æº</h4>
<pre><code>spring.thymeleaf.cache=false
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
mybatis.mapper-locations=classpath:mapper/*.xml
mybatis.type-aliases-package=com.entity
</code></pre>
<h4 id="é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ">é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ</h4>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    //...
    @Autowired
    private DataSource dataSource;
    @Bean
    public PersistentTokenRepository persistentTokenRepository()&#123;
        JdbcTokenRepositoryImpl jdbcTokenRepository = new JdbcTokenRepositoryImpl();
        jdbcTokenRepository.setCreateTableOnStartup(false);//åªéœ€è¦æ²¡æœ‰è¡¨æ—¶è®¾ç½®ä¸º true
        jdbcTokenRepository.setDataSource(dataSource);
        return jdbcTokenRepository;
    &#125;
  	//..
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;

        http.authorizeRequests()
                .mvcMatchers(&quot;/login.html&quot;).permitAll()
                .anyRequest().authenticated()
								 //...
                .logout()
                .and()
                .rememberMe() //å¼€å¯è®°ä½æˆ‘åŠŸèƒ½
                .tokenRepository(persistentTokenRepository())
                .and()
                .csrf().disable();
    &#125;
&#125;
</code></pre>
<h4 id="å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“">å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“</h4>
<p><strong><code>æ³¨æ„:å¯åŠ¨é¡¹ç›®ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè¡¨,ç”¨æ¥ä¿å­˜è®°ä½æˆ‘çš„ token ä¿¡æ¯</code></strong></p>
<p><img src="https://img-blog.csdnimg.cn/a1208eccb9374c308694ca2168b80e67.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="å†æ¬¡æµ‹è¯•è®°ä½æˆ‘">å†æ¬¡æµ‹è¯•è®°ä½æˆ‘</h4>
<p>åœ¨æµ‹è¯•å‘ç°å³ä½¿æœåŠ¡å™¨é‡æ–°å¯åŠ¨ï¼Œä¾ç„¶å¯ä»¥è‡ªåŠ¨ç™»å½•ã€‚</p>
<h3 id="è‡ªå®šä¹‰è®°ä½æˆ‘">è‡ªå®šä¹‰è®°ä½æˆ‘</h3>
<h4 id="æŸ¥çœ‹è®°ä½æˆ‘æºç ">æŸ¥çœ‹è®°ä½æˆ‘æºç </h4>
<p>AbstractUserDetailsAuthenticationProviderç±»ä¸­authenticateæ–¹æ³•åœ¨æœ€åè®¤è¯æˆåŠŸä¹‹åå®ç°äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œä½†æ˜¯æŸ¥çœ‹æºç å¾—çŸ¥å¦‚æœå¼€å¯è®°ä½æˆ‘,å¿…é¡»è¿›è¡Œç›¸å…³çš„è®¾ç½®</p>
<p><img src="https://img-blog.csdnimg.cn/d6fb1f17bb9e430eb6fbb64018388130.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/5802dd840c184615900540718845c2da.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/d4c83b75992d4b1ca6bf2ca507bc4edf.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/1f3217c9b8584c77b9780db7c3e45be7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="ä¼ ç»Ÿ-web-å¼€å‘è®°ä½æˆ‘å®ç°">ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°</h4>
<p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¿…é¡»åœ¨è®¤è¯è¯·æ±‚ä¸­åŠ å…¥å‚æ•°remember-meå€¼ä¸º&quot;true,on,yes,1&quot;å…¶ä¸­ä»»æ„ä¸€ä¸ªæ‰å¯ä»¥å®Œæˆè®°ä½æˆ‘åŠŸèƒ½,è¿™ä¸ªæ—¶å€™ä¿®æ”¹è®¤è¯ç•Œé¢:</p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;ç™»å½•&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;ç”¨æˆ·ç™»å½•&lt;/h1&gt;
&lt;form method=&quot;post&quot; th:action=&quot;@&#123;/doLogin&#125;&quot;&gt;
    ç”¨æˆ·å:&lt;input name=&quot;uname&quot; type=&quot;text&quot;/&gt;&lt;br&gt;
    å¯†ç :&lt;input name=&quot;passwd&quot; type=&quot;password&quot;/&gt;&lt;br&gt;
  	è®°ä½æˆ‘: &lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot; value=&quot;on|yes|true|1&quot;/&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;ç™»å½•&quot;/&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>é…ç½®ä¸­å¼€å¯è®°ä½æˆ‘</p>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
		@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .....
                .and()
                .rememberMe() //å¼€å¯è®°ä½æˆ‘
                //.alwaysRemember(true) æ€»æ˜¯è®°ä½æˆ‘
                .and()
                .csrf().disable();
    &#125;
&#125;
</code></pre>
<h4 id="å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°">å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°</h4>
<h5 id="è‡ªå®šä¹‰è®¤è¯ç±»-LoginFilter">è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter</h5>
<pre><code>/**
 * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è®¤è¯ Filter
 */
public class LoginFilter extends UsernamePasswordAuthenticationFilter &#123;

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException &#123;
        System.out.println(&quot;========================================&quot;);
        //1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼è¯·æ±‚
        if (!request.getMethod().equals(&quot;POST&quot;)) &#123;
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        &#125;
        //2.åˆ¤æ–­æ˜¯å¦æ˜¯ json æ ¼å¼è¯·æ±‚ç±»å‹
        if (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123;
            //3.ä» json æ•°æ®ä¸­è·å–ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ &#123;&quot;uname&quot;:&quot;xxx&quot;,&quot;password&quot;:&quot;xxx&quot;,&quot;remember-me&quot;:true&#125;
            try &#123;
                Map&lt;String, String&gt; userInfo = new ObjectMapper().readValue(request.getInputStream(), Map.class);
                String username = userInfo.get(getUsernameParameter());
                String password = userInfo.get(getPasswordParameter());
                String rememberValue = userInfo.get(AbstractRememberMeServices.DEFAULT_PARAMETER);
                if (!ObjectUtils.isEmpty(rememberValue)) &#123;
                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);
                &#125;
                System.out.println(&quot;ç”¨æˆ·å: &quot; + username + &quot; å¯†ç : &quot; + password + &quot; æ˜¯å¦è®°ä½æˆ‘: &quot; + rememberValue);
                UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
                setDetails(request, authRequest);
                return this.getAuthenticationManager().authenticate(authRequest);
            &#125; catch (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        return super.attemptAuthentication(request, response);
    &#125;
&#125;
</code></pre>
<h5 id="è‡ªå®šä¹‰-RememberMeService">è‡ªå®šä¹‰ RememberMeService</h5>
<pre><code>/**
 * è‡ªå®šä¹‰è®°ä½æˆ‘ services å®ç°ç±»
 */
public class MyPersistentTokenBasedRememberMeServices extends PersistentTokenBasedRememberMeServices &#123;
    public MyPersistentTokenBasedRememberMeServices(String key, UserDetailsService userDetailsService, PersistentTokenRepository tokenRepository) &#123;
        super(key, userDetailsService, tokenRepository);
    &#125;
    /**
     * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è·å– remember-me æ–¹å¼
     */
    @Override
    protected boolean rememberMeRequested(HttpServletRequest request, String parameter) &#123;
        String paramValue = request.getAttribute(parameter).toString();
        if (paramValue != null) &#123;
            if (paramValue.equalsIgnoreCase(&quot;true&quot;) || paramValue.equalsIgnoreCase(&quot;on&quot;)
                    || paramValue.equalsIgnoreCase(&quot;yes&quot;) || paramValue.equals(&quot;1&quot;)) &#123;
                return true;
            &#125;
        &#125;
        return false;
    &#125;
&#125;
</code></pre>
<h5 id="é…ç½®è®°ä½æˆ‘">é…ç½®è®°ä½æˆ‘</h5>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Bean
    public UserDetailsService userDetailsService() &#123;
        //.....
        return inMemoryUserDetailsManager;
    &#125;
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;

    @Override
    @Bean
    public AuthenticationManager authenticationManagerBean() throws Exception &#123;
        return super.authenticationManagerBean();
    &#125;

    //è‡ªå®šä¹‰ filter äº¤ç»™å·¥å‚ç®¡ç†
    @Bean
    public LoginFilter loginFilter() throws Exception &#123;
        LoginFilter loginFilter = new LoginFilter();
        loginFilter.setFilterProcessesUrl(&quot;/doLogin&quot;);//æŒ‡å®šè®¤è¯ url
        loginFilter.setUsernameParameter(&quot;uname&quot;);//æŒ‡å®šæ¥æ”¶json ç”¨æˆ·å key
        loginFilter.setPasswordParameter(&quot;passwd&quot;);//æŒ‡å®šæ¥æ”¶ json å¯†ç  key
        loginFilter.setAuthenticationManager(authenticationManagerBean());
        loginFilter.setRememberMeServices(rememberMeServices()); //è®¾ç½®è®¤è¯æˆåŠŸæ—¶ä½¿ç”¨è‡ªå®šä¹‰rememberMeService
        //è®¤è¯æˆåŠŸå¤„ç†
        loginFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;
            Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
            result.put(&quot;msg&quot;, &quot;ç™»å½•æˆåŠŸ&quot;);
            result.put(&quot;ç”¨æˆ·ä¿¡æ¯&quot;, authentication.getPrincipal());
            resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
            resp.setStatus(HttpStatus.OK.value());
            String s = new ObjectMapper().writeValueAsString(result);
            resp.getWriter().println(s);
        &#125;);
        //è®¤è¯å¤±è´¥å¤„ç†
        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;
            Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
            result.put(&quot;msg&quot;, &quot;ç™»å½•å¤±è´¥: &quot; + ex.getMessage());
            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());
            resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
            String s = new ObjectMapper().writeValueAsString(result);
            resp.getWriter().println(s);
        &#125;);
        return loginFilter;
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeHttpRequests()
                .anyRequest().authenticated()//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯
                .and()
                .formLogin()
                .and()
                .rememberMe() //å¼€å¯è®°ä½æˆ‘åŠŸèƒ½  cookie è¿›è¡Œå®ç°  1.è®¤è¯æˆåŠŸä¿å­˜è®°ä½æˆ‘ cookie åˆ°å®¢æˆ·ç«¯   2.åªæœ‰ cookie å†™å…¥å®¢æˆ·ç«¯æˆåŠŸæ‰èƒ½å®ç°è‡ªåŠ¨ç™»å½•åŠŸèƒ½
                .rememberMeServices(rememberMeServices())  //è®¾ç½®è‡ªåŠ¨ç™»å½•ä½¿ç”¨å“ªä¸ª rememberMeServices
                .and()
                .exceptionHandling()
                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;
                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);
                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());
                    resp.getWriter().println(&quot;è¯·è®¤è¯ä¹‹åå†å»å¤„ç†!&quot;);
                &#125;)
                .and()
                .logout()
                .logoutRequestMatcher(new OrRequestMatcher(
                        new AntPathRequestMatcher(&quot;/logout&quot;, HttpMethod.DELETE.name()),
                        new AntPathRequestMatcher(&quot;/logout&quot;, HttpMethod.GET.name())
                ))
                .logoutSuccessHandler((req, resp, auth) -&gt; &#123;
                    Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
                    result.put(&quot;msg&quot;, &quot;æ³¨é”€æˆåŠŸ&quot;);
                    result.put(&quot;ç”¨æˆ·ä¿¡æ¯&quot;, auth.getPrincipal());
                    resp.setContentType(&quot;application/json;charset=UTF-8&quot;);
                    resp.setStatus(HttpStatus.OK.value());
                    String s = new ObjectMapper().writeValueAsString(result);
                    resp.getWriter().println(s);
                &#125;)
                .and()
                .csrf().disable();


        // at: ç”¨æ¥æŸä¸ª filter æ›¿æ¢è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter
        // before: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter ä¹‹å‰
        // after: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­é‚£ä¸ª filter ä¹‹å
        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);
    &#125;


    @Bean
    public RememberMeServices rememberMeServices() &#123;
        return new MyPersistentTokenBasedRememberMeServices(UUID.randomUUID().toString(), userDetailsService(), new InMemoryTokenRepositoryImpl());
    &#125;
&#125;
</code></pre>
<hr>
<h2 id="ç¬¬å…­ç« -ä¼šè¯ç®¡ç†">ç¬¬å…­ç«  ä¼šè¯ç®¡ç†</h2>
<ul>
<li>ç®€ä»‹</li>
<li>ä¼šè¯å¹¶å‘ç®¡ç†</li>
<li>ä¼šè¯å…±äº«å®æˆ˜</li>
</ul>
<h3 id="ç®€ä»‹-4">ç®€ä»‹</h3>
<p>å½“æµè§ˆå™¨è°ƒç”¨ç™»å½•æ¥å£ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šå’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªä¼šè¯ (Session) æµè§ˆå™¨åœ¨æ¯æ¬¡å‘é€è¯·æ±‚æ—¶éƒ½ä¼šæºå¸¦ä¸€ä¸ª Sessionldï¼ŒæœåŠ¡ç«¯åˆ™æ ¹æ®è¿™ä¸ª Sessionld æ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½ã€‚å½“æµè§ˆå™¨å…³é—­åï¼ŒæœåŠ¡ç«¯çš„ Session å¹¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ¨æœåŠ¡ç«¯è°ƒç”¨ Sessioné”€æ¯æ–¹æ³•ï¼Œæˆ–è€…ç­‰ Session è¿‡æœŸæ—¶é—´åˆ°äº†è‡ªåŠ¨é”€æ¯ã€‚åœ¨Spring Security ä¸­ï¼Œä¸HttpSessionç›¸å…³çš„åŠŸèƒ½ç”± SessionManagementFiter å’ŒSessionAutheaticationStrateey æ¥å£æ¥å¤„ç†ï¼ŒSessionManagomentFilter è¿‡æ»¤å™¨å°† Session ç›¸å…³æ“ä½œå§”æ‰˜ç»™ SessionAuthenticationStrateey æ¥å£å»å®Œæˆã€‚</p>
<h3 id="ä¼šè¯å¹¶å‘ç®¡ç†">ä¼šè¯å¹¶å‘ç®¡ç†</h3>
<h4 id="ç®€ä»‹-5">ç®€ä»‹</h4>
<p>ä¼šè¯å¹¶å‘ç®¡ç†å°±æ˜¯æŒ‡åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åˆ›å»ºå¤šå°‘ä¸ªä¼šè¯ï¼Œå¦‚æœä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ªä¼šè¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šè¿›è¡Œç™»å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šç™»å½•å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä¸è¿‡å¼€å‘è€…å¯ä»¥åœ¨ Spring Security ä¸­å¯¹æ­¤è¿›è¡Œé…ç½®ã€‚</p>
<h4 id="å¼€å¯ä¼šè¯ç®¡ç†">å¼€å¯ä¼šè¯ç®¡ç†</h4>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;

  	//...
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .rememberMe()
                .and()
                .csrf().disable()
                .sessionManagement()  //å¼€å¯ä¼šè¯ç®¡ç†
                .maximumSessions(1);  //è®¾ç½®ä¼šè¯å¹¶å‘æ•°ä¸º 1
    &#125;

    @Bean
    public HttpSessionEventPublisher httpSessionEventPublisher() &#123;
        return new HttpSessionEventPublisher();
    &#125;
&#125;
</code></pre>
<ol>
<li>sessionManagement() ç”¨æ¥å¼€å¯ä¼šè¯ç®¡ç†ã€maximumSessions æŒ‡å®šä¼šè¯çš„å¹¶å‘æ•°ä¸º 1ã€‚</li>
<li>HttpSessionEventPublisher æä¾›ä¸€ä¸€ä¸ªHtp SessionEvenePubishor-å®ä¾‹ã€‚Spring Securityä¸­é€šè¿‡ä¸€ä¸ª Map é›†åˆæ¥é›†æŠ¤å½“å‰çš„ Http Session è®°å½•ï¼Œè¿›è€Œå®ç°ä¼šè¯çš„å¹¶å‘ç®¡ç†ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œå°±å‘é›†åˆä¸­æ·»åŠ ä¸€æ¡Http Session è®°å½•ï¼›å½“ä¼šè¯é”€æ¯æ—¶ï¼Œå°±ä»é›†åˆä¸­ç§»é™¤ä¸€æ¡ Httpsession è®°å½•ã€‚HtpSesionEvenPublisher å®ç°äº† Fttp SessionListener æ¥å£ï¼Œå¯ä»¥ç›‘å¬åˆ° HtpSession çš„åˆ›å»ºå’Œé”€æ¯€äº‹ä»¶ï¼Œå¹¶å°† Fltp Session çš„åˆ›å»º/é”€æ¯äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œè¿™æ ·ï¼Œå½“æœ‰ HttpSession é”€æ¯€æ—¶ï¼ŒSpring Security å°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥äº‹ä»¶äº†ã€‚</li>
</ol>
<h4 id="æµ‹è¯•ä¼šè¯ç®¡ç†">æµ‹è¯•ä¼šè¯ç®¡ç†</h4>
<p>é…ç½®å®Œæˆåï¼Œå¯åŠ¨é¡¹ç›®ã€‚è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæµè§ˆå™¨ï¼Œå¦‚æœä½¿ç”¨äº† Chrome æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ Chrome æµè§ˆå™¨ä¸­çš„å¤šç”¨æˆ·æ–¹å¼ï¼ˆç›¸å½“äºä¸¤ä¸ªæµè§ˆå™¨ï¼‰å…ˆåœ¨ç¬¬ä¸€ä¸ªæµè§ˆå™¨ä¸­è¾“å…¥ <a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥ <a target="_blank" rel="noopener" href="http://localhost:8080">http://localhost:8080</a>ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ<br>
å®Œæˆç™»å½•æ“ä½œï¼›å½“ç¬¬äºŒä¸ªæµè§ˆå™¨ç™»å½•æˆåŠŸåï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ã€‚ç»“æœå‡ºç°ä¸‹å›¾ï¼š<img src="https://img-blog.csdnimg.cn/02b6bccfc2e04969a499b689580c403d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="ä¼šè¯å¤±æ•ˆå¤„ç†">ä¼šè¯å¤±æ•ˆå¤„ç†</h3>
<h4 id="ä¼ ç»Ÿ-web-å¼€å‘å¤„ç†">ä¼ ç»Ÿ web å¼€å‘å¤„ç†</h4>
<pre><code>protected void configure(HttpSecurity http) throws Exception &#123;
  http.authorizeRequests()
    .anyRequest().authenticated()
    .and()
    ....
    .sessionManagement()  //å¼€å¯ä¼šè¯ç®¡ç†
    .maximumSessions(1)  //å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯
    .expiredUrl(&quot;/login&quot;);//ä¼šè¯è¿‡æœŸå¤„ç†
&#125;
</code></pre>
<h4 id="å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†">å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</h4>
<pre><code>@Override
protected void configure(HttpSecurity http) throws Exception &#123;
  http.authorizeRequests()
    .anyRequest().authenticated()
    .....
    .sessionManagement()  //å¼€å¯ä¼šè¯ç®¡ç†
    .maximumSessions(1)  //å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯
    //.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘
    .expiredSessionStrategy(event -&gt; &#123;
      HttpServletResponse response = event.getResponse();
      response.setContentType(&quot;application/json;charset=UTF-8&quot;);
      Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
      result.put(&quot;status&quot;, 500);
      result.put(&quot;msg&quot;, &quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;);
      String s = new ObjectMapper().writeValueAsString(result);
      response.setContentType(&quot;application/json;charset=UTF-8&quot;);
      response.getWriter().println(s);
      response.flushBuffer();
    &#125;);//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†
&#125;
</code></pre>
<h3 id="ç¦æ­¢å†æ¬¡ç™»å½•">ç¦æ­¢å†æ¬¡ç™»å½•</h3>
<p>é»˜è®¤çš„æ•ˆæœæ˜¯ä¸€ç§è¢« â€œæŒ¤ä¸‹çº¿â€çš„æ•ˆæœï¼Œåé¢ç™»å½•çš„ç”¨æˆ·ä¼šæŠŠå‰é¢ç™»å½•çš„ç”¨æˆ· â€œæŒ¤ä¸‹çº¿â€ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç¦æ­¢åæ¥è€…ç™»å½•ï¼Œå³ä¸€æ—¦å½“å‰ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåæ¥è€…æ— æ³•å†æ¬¡ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ç™»å½•ï¼Œç›´åˆ°å½“å‰ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ç™»å½•ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>@Override
protected void configure(HttpSecurity http) throws Exception &#123;
  http.authorizeRequests()
    .anyRequest().authenticated()
    .and()
    ....
    .sessionManagement()  //å¼€å¯ä¼šè¯ç®¡ç†
    .maximumSessions(1)  //å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯
    //.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘
    .expiredSessionStrategy(event -&gt; &#123;
      HttpServletResponse response = event.getResponse();
      response.setContentType(&quot;application/json;charset=UTF-8&quot;);
      Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
      result.put(&quot;status&quot;, 500);
      result.put(&quot;msg&quot;, &quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;);
      String s = new ObjectMapper().writeValueAsString(result);
      response.getWriter().println(s);
      response.flushBuffer();
    &#125;)//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†
    .maxSessionsPreventsLogin(true);//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•
&#125;
</code></pre>
<h3 id="ä¼šè¯å…±äº«">ä¼šè¯å…±äº«</h3>
<p>å‰é¢æ‰€è®²çš„ä¼šè¯ç®¡ç†éƒ½æ˜¯å•æœºä¸Šçš„ä¼šè¯ç®¡ç†ï¼Œå¦‚æœå½“å‰æ˜¯é›†ç¾¤ç¯å¢ƒï¼Œå‰é¢æ‰€è®²çš„ä¼šè¯ç®¡<br>
ç†æ–¹æ¡ˆå°±ä¼šå¤±æ•ˆã€‚æ­¤æ—¶å¯ä»¥åˆ©ç”¨ spring-session ç»“åˆ redis å®ç° session å…±äº«ã€‚</p>
<h4 id="å®æˆ˜">å®æˆ˜</h4>
<h6 id="å¼•å…¥ä¾èµ–-2">å¼•å…¥ä¾èµ–</h6>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h6 id="ç¼–å†™é…ç½®">ç¼–å†™é…ç½®</h6>
<pre><code>spring.redis.host=localhost
spring.redis.port=6379
</code></pre>
<h6 id="é…ç½®Security">é…ç½®Security</h6>
<pre><code>package com.blr.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;
import org.springframework.session.FindByIndexNameSessionRepository;
import org.springframework.session.security.SpringSessionBackedSessionRegistry;

import javax.servlet.http.HttpServletResponse;
import java.util.HashMap;
import java.util.Map;

@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;


    private final FindByIndexNameSessionRepository sessionRepository;


    @Autowired
    public SecurityConfig(FindByIndexNameSessionRepository sessionRepository) &#123;
        this.sessionRepository = sessionRepository;
    &#125;

    @Bean
    public UserDetailsService userDetailsService() &#123;
        ....
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .rememberMe()
                .and()
                .csrf().disable()
                .sessionManagement()  //å¼€å¯ä¼šè¯ç®¡ç†
                .maximumSessions(1)  //å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯*/
                .expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘
                .expiredSessionStrategy(event -&gt; &#123;
                    HttpServletResponse response = event.getResponse();
                    response.setContentType(&quot;application/json;charset=UTF-8&quot;);
                    Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();
                    result.put(&quot;status&quot;, 500);
                    result.put(&quot;msg&quot;, &quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;);
                    String s = new ObjectMapper().writeValueAsString(result);
                    response.getWriter().println(s);
                    response.flushBuffer();
                &#125;).sessionRegistry(sessionRegistry());//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†
        //.maxSessionsPreventsLogin(true);//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•*/
    &#125;

    @Bean
    public SpringSessionBackedSessionRegistry sessionRegistry() &#123;
        return new SpringSessionBackedSessionRegistry(sessionRepository);
    &#125;

&#125;
</code></pre>
<h6 id="æµ‹è¯•">æµ‹è¯•</h6>
<h2 id="ç¬¬ä¸ƒç« -CSRF-æ¼æ´ä¿æŠ¤">ç¬¬ä¸ƒç«  CSRF æ¼æ´ä¿æŠ¤</h2>
<ul>
<li>
<p>CSRF ç®€ä»‹</p>
</li>
<li>
<p>CSRF é˜²å¾¡&amp;åŸºæœ¬é…ç½®</p>
</li>
<li>
<p>å®æˆ˜</p>
</li>
</ul>
<h4 id="ç®€ä»‹-6">ç®€ä»‹</h4>
<p>CSRF (Cross-Site Request Forgery è·¨ç«™è¯·æ±‚ä¼ªé€ )ï¼Œä¹Ÿå¯ç§°ä¸ºä¸€é”®å¼æ”»å‡» (one-click-attackï¼‰ï¼Œé€šå¸¸ç¼©å†™ä¸º <code>CSRF</code> æˆ–è€… <code>XSRF</code>ã€‚</p>
<p><code>CSRF</code> æ”»å‡»æ˜¯ä¸€ç§æŒŸæŒç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„æµè§ˆå™¨ä¸Šå‘é€æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹æ³•ã€‚ç›¸å¯¹äºXSSåˆ©ç”¨ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼ŒCSRFåˆ™æ˜¯åˆ©ç”¨ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»ã€‚ç®€å•æ¥è¯´ï¼ŒCSRFæ˜¯è‡´å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå»è®¿é—®ä¸€ä¸ªç”¨æˆ·æ›¾ç»è®¤è¯è¿‡çš„ç½‘ç«™å¹¶æ‰§è¡Œæ¶æ„è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€é‚®ä»¶ã€å‘æ¶ˆæ¯ã€ç”šè‡³è´¢äº§æ“ä½œ (å¦‚è½¬è´¦å’Œè´­ä¹°å•†å“ï¼‰ã€‚ç”±äºå®¢æˆ·ç«¯(æµè§ˆå™¨)å·²ç»åœ¨è¯¥ç½‘ç«™ä¸Šè®¤è¯è¿‡ï¼Œæ‰€ä»¥è¯¥ç½‘ç«™ä¼šè®¤ä¸ºæ˜¯çœŸæ­£ç”¨æˆ·åœ¨æ“ä½œè€Œæ‰§è¡Œè¯·æ±‚ï¼ˆå®é™…ä¸Šè¿™ä¸ªå¹¶éç”¨æˆ·çš„æœ¬æ„ï¼‰ã€‚</p>
<p><strong>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</strong></p>
<p>å‡è®¾ blr ç°åœ¨ç™»å½•äº†æŸé“¶è¡Œçš„ç½‘ç«™å‡†å¤‡å®Œæˆä¸€é¡¹è½¬è´¦æ“ä½œï¼Œè½¬è´¦çš„é“¾æ¥å¦‚ä¸‹ï¼š</p>
<p><strong><a href="https://bank%20.xxx%20.com/withdraw?account=blr&amp;amount=1000&amp;for=zhangsan">https: //bank .xxx .com/withdraw?account=blr&amp;amount=1000&amp;for=zhangsan</a></strong></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªé“¾æ¥æ˜¯æƒ³ä» blr è¿™ä¸ªè´¦æˆ·ä¸‹è½¬è´¦ 1000 å…ƒåˆ° zhangsan è´¦æˆ·ä¸‹ï¼Œå‡è®¾blr æ²¡æœ‰æ³¨é”€ç™»å½•è¯¥é“¶è¡Œçš„ç½‘ç«™ï¼Œå°±åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ–°çš„é€‰é¡¹å¡ä¸­æ‰“å¼€äº†ä¸€ä¸ªå±é™©ç½‘ç«™ï¼Œè¿™ä¸ªå±é™©ç½‘ç«™ä¸­æœ‰ä¸€å¹…å›¾ç‰‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/6b964f4ca7b942fea3af81101b032b02.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä¸€æ—¦ç”¨æˆ·æ‰“å¼€äº†è¿™ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªå›¾ç‰‡é“¾æ¥ä¸­çš„è¯·æ±‚å°±ä¼šè‡ªåŠ¨å‘é€å‡ºå»ã€‚ç”±äºæ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å¹¶ä¸”ç”¨æˆ·å°šæœªæ³¨é”€ç™»å½•ï¼Œæ‰€ä»¥è¯¥è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Šå¯¹åº”çš„æœ‰æ•ˆçš„ Cookie ä¿¡æ¯ï¼Œè¿›è€Œå®Œæˆä¸€æ¬¡è½¬è´¦æ“ä½œã€‚è¿™å°±æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ã€‚</p>
<h4 id="CSRFæ”»å‡»æ¼”ç¤º">CSRFæ”»å‡»æ¼”ç¤º</h4>
<h5 id="åˆ›å»ºé“¶è¡Œåº”ç”¨">åˆ›å»ºé“¶è¡Œåº”ç”¨</h5>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;dependency&gt;
   &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
   &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>ä¿®æ”¹é…ç½®</p>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;

    @Bean
    public UserDetailsService userDetailsService() &#123;
        InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
        inMemoryUserDetailsManager.createUser(User.withUsername(&quot;root&quot;).password(&quot;&#123;noop&#125;123&quot;).roles(&quot;admin&quot;).build());
        return inMemoryUserDetailsManager;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests().anyRequest().authenticated()
                .and().formLogin().and().csrf().disable();
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º controller å¹¶å¯åŠ¨å¯åŠ¨</p>
<pre><code>@RestController
public class HelloController &#123;

    @PostMapping(&quot;/withdraw&quot;)
    public String withdraw() &#123;
        System.out.println(&quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;);
        return &quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;;
    &#125;
&#125;
</code></pre>
</li>
</ul>
<h5 id="åˆ›å»ºæ¶æ„åº”ç”¨">åˆ›å»ºæ¶æ„åº”ç”¨</h5>
<ul>
<li>
<p>åˆ›å»ºç®€å• springboot åº”ç”¨</p>
</li>
<li>
<p>ä¿®æ”¹é…ç½®</p>
<pre><code>server:
  port: 8081
</code></pre>
</li>
<li>
<p>å‡†å¤‡æ”»å‡»é¡µé¢</p>
<pre><code>&lt;form action=&quot;http://127.0.0.1:8080/withdraw&quot; method=&quot;post&quot;&gt;
    &lt;input name=&quot;name&quot; type=&quot;hidden&quot; value=&quot;blr&quot;/&gt;
    &lt;input name=&quot;money&quot; type=&quot;hidden&quot; value=&quot;10000&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;ç‚¹æˆ‘&quot;&gt;
&lt;/form&gt;
</code></pre>
</li>
</ul>
<h4 id="CSRF-é˜²å¾¡">CSRF é˜²å¾¡</h4>
<p><strong>CSRF</strong>æ”»å‡»çš„æ ¹æºåœ¨äºæµè§ˆå™¨é»˜è®¤çš„èº«ä»½éªŒè¯æœºåˆ¶(è‡ªåŠ¨æºå¸¦å½“å‰ç½‘ç«™çš„Cookieä¿¡æ¯)ï¼Œè¿™ç§æœºåˆ¶è™½ç„¶å¯ä»¥ä¿è¯è¯·æ±‚æ˜¯æ¥è‡ªç”¨æˆ·çš„æŸä¸ªæµè§ˆå™¨ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿è¿™è¯·æ±‚æ˜¯ç”¨æˆ·æˆæƒå‘é€ã€‚æ”»å‡»è€…å’Œç”¨æˆ·å‘é€çš„è¯·æ±‚ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æœ‰åŠæ³•å»ç›´æ¥æ‹’ç»è¿™é‡Œçš„æŸä¸€ä¸ªè¯·æ±‚ã€‚å¦‚æœèƒ½åœ¨åˆæ³•æ¸…æ±‚ä¸­é¢å¤–æºå¸¦ä¸€ä¸ªæ”»å‡»è€…æ— æ³•è·å–çš„å‚æ•°ï¼Œå°±å¯ä»¥æˆåŠŸåŒºåˆ†å‡ºä¸¤ç§ä¸åŒçš„è¯·æ±‚ï¼Œè¿›è€Œç›´æ¥æ‹’ç»æ‰æ¶æ„è¯·æ±‚ã€‚åœ¨ SpringSecurity ä¸­å°±æä¾›äº†è¿™ç§æœºåˆ¶æ¥é˜²å¾¡ CSRF æ”»å‡»ï¼Œè¿™ç§æœºåˆ¶æˆ‘ä»¬ç§°ä¹‹ä¸º<code>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</code>ã€‚</p>
<h5 id="ä»¤ç‰ŒåŒæ­¥æ¨¡å¼">ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</h5>
<p>è¿™æ˜¯ç›®å‰ä¸»æµçš„ CSRF æ”»å‡»é˜²å¾¡æ–¹æ¡ˆã€‚å…·ä½“çš„æ“ä½œæ–¹å¼å°±æ˜¯åœ¨æ¯ä¸€ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œé™¤äº†é»˜è®¤è‡ªåŠ¨æºå¸¦çš„ Cookie å‚æ•°ä¹‹å¤–ï¼Œå†æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€éšæœºç”Ÿæˆçš„å®‡ç¬¦ä¸²ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º CSRF ä»¤ç‰Œã€‚è¿™ä¸ª CSRF ä»¤ç‰Œç”±æœåŠ¡ç«¯ç”Ÿæˆï¼Œç”Ÿæˆååœ¨ HtpSession ä¸­ä¿å­˜ä¸€ä»½ã€‚å½“å‰ç«¯è¯·æ±‚åˆ°è¾¾åï¼Œå°†è¯·æ±‚æºå¸¦çš„ CSRF ä»¤ç‰Œä¿¡æ¯å’ŒæœåŠ¡ç«¯ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸¤è€…ä¸ç›¸ç­‰ï¼Œåˆ™æ‹’ç»æ‰è¯¥ HITTP è¯·æ±‚ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„:</strong> è€ƒè™‘åˆ°ä¼šæœ‰ä¸€äº›å¤–éƒ¨ç«™ç‚¹é“¾æ¥åˆ°æˆ‘ä»¬çš„ç½‘ç«™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ±‚è¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ ·å¯¹å­HEADã€OPTIONSã€TRACE ç­‰æ–¹æ³•å°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ CSRF ä»¤ç‰Œäº†ï¼Œå¼ºè¡Œä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»¤ç‰Œæ³„éœ²ï¼</p>
</blockquote>
<h5 id="å¼€å¯-CSRF-é˜²å¾¡">å¼€å¯ CSRF é˜²å¾¡</h5>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.
          ...
          formLogin()
          .and()
          .csrf(); //å¼€å¯ csrf
    &#125;
&#125;
</code></pre>
<h5 id="æŸ¥çœ‹ç™»å½•é¡µé¢æºç ">æŸ¥çœ‹ç™»å½•é¡µé¢æºç </h5>
<p><img src="https://img-blog.csdnimg.cn/be0ff190d5b549fdb87f525e2e53d0ca.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF">ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF</h4>
<p>å¼€å¯CSRFé˜²å¾¡åä¼šè‡ªåŠ¨åœ¨æäº¤çš„è¡¨å•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¦‚æœä¸èƒ½è‡ªåŠ¨åŠ å…¥ï¼Œéœ€è¦åœ¨å¼€å¯ä¹‹åæ‰‹åŠ¨åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶éšç€è¯·æ±‚æäº¤ã€‚è·å–æœåŠ¡ç«¯ä»¤ç‰Œæ–¹å¼å¦‚ä¸‹:</p>
<pre><code>&lt;input type=&quot;hidden&quot; th:name=&quot;$&#123;_csrf.parameterName&#125;&quot; th:value=&quot;$&#123;_csrf.token&#125;&quot;/&gt;
</code></pre>
<h5 id="å¼€å‘æµ‹è¯•-controller">å¼€å‘æµ‹è¯• controller</h5>
<pre><code>@Controller
public class HelloController &#123;
    @PostMapping(&quot;/hello&quot;)
    @ResponseBody
    public String hello() &#123;
        System.out.println(&quot;hello success&quot;);
        return &quot;hello success&quot;;
    &#125;

    @GetMapping(&quot;/index.html&quot;)
    public String index() &#123;
        return &quot;index&quot;;
    &#125;
&#125;
</code></pre>
<h5 id="åˆ›å»º-html">åˆ›å»º html</h5>
<pre><code>&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;æµ‹è¯• CSRF é˜²å¾¡&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;form th:action=&quot;@&#123;/hello&#125;&quot; method=&quot;post&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;hello&quot;/&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h5 id="æµ‹è¯•æŸ¥çœ‹index-htmlæºç ">æµ‹è¯•æŸ¥çœ‹index.htmlæºç </h5>
<p><img src="https://img-blog.csdnimg.cn/9b4cc0d08f404bd6aee6f053458f0198.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="å‰åç«¯åˆ†ç¦»ä½¿ç”¨-CSRF">å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF</h4>
<p>å‰åç«¯åˆ†ç¦»å¼€å‘æ—¶ï¼Œåªéœ€è¦å°†ç”Ÿæˆ csrf æ”¾å…¥åˆ°cookie ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚æ—¶è·å– cookie ä¸­ä»¤ç‰Œä¿¡æ¯è¿›è¡Œæäº¤å³å¯ã€‚</p>
<h5 id="ä¿®æ”¹-CSRF-å­˜å…¥-Cookie">ä¿®æ”¹ CSRF å­˜å…¥ Cookie</h5>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests().anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .csrf()
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());//å°†ä»¤ç‰Œä¿å­˜åˆ°cookieä¸­ï¼Œå…è®¸cookieå‰ç«¯è·å–
    &#125;
&#125;
</code></pre>
<h5 id="è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹-cookie">è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie</h5>
<p><img src="https://img-blog.csdnimg.cn/0884e2dec22f4ba3bfd2c563d58c843f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5 id="å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯">å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯</h5>
<ul>
<li>
<p>è¯·æ±‚å‚æ•°ä¸­æºå¸¦ä»¤ç‰Œ</p>
<p>key: _csrf<br>
value:â€œxxxâ€</p>
</li>
<li>
<p>è¯·æ±‚å¤´ä¸­æºå¸¦ä»¤ç‰Œ</p>
<p>X-XSRF-TOKEN:value</p>
</li>
</ul>
<h2 id="ç¬¬å…«ç« -è·¨åŸŸ">ç¬¬å…«ç«  è·¨åŸŸ</h2>
<ul>
<li>Spring å¤„ç†æ–¹æ¡ˆã€‚</li>
<li>Spring Security å¤„ç†æ–¹æ¡ˆã€‚</li>
</ul>
<h3 id="ç®€ä»‹-7">ç®€ä»‹</h3>
<p>è·¨åŸŸé—®é¢˜æ˜¯å®é™…åº”ç”¨å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œåœ¨ Spring æ¡†æ¶ä¸­å¯¹äºè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆæœ‰å¥½å‡ ç§ï¼Œå¼• äº† Spring Security ä¹‹åï¼Œè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆåˆå¢åŠ äº†ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-CORS">ä»€ä¹ˆæ˜¯ CORS</h3>
<p>CORS (Cross-Origin Resource Sharing ï¼‰æ˜¯ç”± W3Cåˆ¶å®šçš„ä¸€ç§è·¨åŸŸèµ„æºå…±äº«æŠ€æœ¯æ ‡å‡†ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³å‰ç«¯çš„è·¨åŸŸè¯·æ±‚ã€‚åœ¨JavaEE å¼€å‘ä¸­ï¼Œæœ€å¸¸è§çš„å‰ç«¯è·¨åŸŸè¯·æ±‚è§£å†³æ–¹æ¡ˆæ˜¯æ—©æœŸçš„JSONPï¼Œä½†æ˜¯ JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼Œè€Œ CORS åˆ™æ”¯ç‰¹å¤šç§ HTTTPè¯·æ±‚æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚</p>
<p>CORS ä¸­æ–°å¢äº†ä¸€ç»„HTTP è¯·æ±‚å¤´å­—æ®µï¼Œé€šè¿‡è¿™äº›å­—æ®µï¼ŒæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨ï¼Œé‚£äº›ç½‘ç«™é€šè¿‡æµè§ˆå™¨æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚åŒæ—¶è§„å®šï¼Œå¯¹é‚£äº›å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨æ•°æ®çš„HTTPè¯·æ±‚æ–¹æ³• ï¼ˆå¦‚GETä»¥å¤–çš„HTTP è¯·æ±‚ç­‰)ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚(prenightstï¼‰ï¼Œé¢„æ£€è¯·æ±‚çš„ç›®çš„æ˜¯æŸ¥çœ‹æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒå³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯å…è®¸ï¼Œæ‰å‘é€å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆå¦‚ Cookiesã€HTTP è®¤è¯ä¿¡æ¯ç­‰ï¼‰ã€‚</p>
<blockquote>
<p>CORS: åŒæº/åŒåŸŸ = åè®®+ä¸»æœº+ç«¯å£</p>
</blockquote>
<h4 id="ç®€å•è¯·æ±‚">ç®€å•è¯·æ±‚</h4>
<p>GET è¯·æ±‚ä¸ºä¾‹ï¼Œå¦‚æœéœ€è¦å‘èµ·ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œåˆ™è¯·æ±‚å¤´å¦‚ä¸‹ï¼š</p>
<pre><code>Host: localhost:8080
Origin: http://localhost:8081
Referer:http://localhost:8081/index.html
</code></pre>
<p>å¦‚æœæœåŠ¡ç«¯æ”¯æŒè¯¥è·¨åŸŸè¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›çš„å“åº”å¤´ä¸­å°†åŒ…å«å¦‚ä¸‹å­—æ®µï¼š</p>
<pre><code>Access-Control-Allow-Origin:http://localhost: 8081
</code></pre>
<p>Access-Control-Allow-Origin å­—æ®µç”¨æ¥å‘Šè¯‰æµè§ˆå™¨å¯ä»¥è®¿é—®è¯¥èµ„æºçš„åŸŸï¼Œå½“æµè§ˆå™¨æ”¶åˆ°è¿™æ ·çš„å“åº”å¤´ä¿¡æ¯ä¹‹åï¼Œæå–å‡º Access-Control-Allow-Origin å­—æ®µä¸­çš„å€¼ï¼Œ å‘ç°è¯¥å€¼åŒ…å«å½“å‰é¡µé¢æ‰€åœ¨çš„åŸŸï¼Œå°±çŸ¥é“è¿™ä¸ªè·¨åŸŸæ˜¯è¢«å…è®¸çš„ï¼Œå› æ­¤å°±ä¸å†å¯¹å‰ç«¯çš„è·¨åŸŸè¯·æ±‚è¿›è¡Œé™åˆ¶ã€‚è¿™å±äºç®€å•è¯·æ±‚ï¼Œå³ä¸éœ€è¦è¿›è¡Œé¢„æ£€è¯·æ±‚çš„è·¨åŸŸã€‚</p>
<h4 id="éç®€å•è¯·æ±‚">éç®€å•è¯·æ±‚</h4>
<p>å¯¹äºä¸€äº›éç®€å•è¯·æ±‚ï¼Œä¼šé¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code>OPTIONS /put HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Accept: */*
Access-Control-Request-Method:PUT
Origin: http://localhost: 8081
Referer:http://localhost:8081/index.html
</code></pre>
<p>è¯·æ±‚æ–¹æ³•æ˜¯ OPTIONSï¼Œè¯·æ±‚å¤´Origin å°±å‘Šè¯‰æœåŠ¡ç«¯å½“å‰é¡µé¢æ‰€åœ¨åŸŸï¼Œè¯·æ±‚å¤´ Access-Control-Request-Methods å‘Šè¯‰æœåŠ¡å™¨ç«¯å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚æ‰€ä½¿ç”¨çš„ä¸‡æ³•ã€‚æœåŠ¡ç«¯å¯¹æ­¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…è®¸å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¼šç»™å‡ºå¦‚ä¸‹å“åº”ï¼š</p>
<pre><code>HTTP/1.1 200
Access-Control-Allow-Origin:http://localhost: 8081
Access-Control-Request-Methods: PUT
Access-Control-Max-Age: 3600
</code></pre>
<p>Access-Control-Allow-Metbods å­—æ®µè¡¨ç¤ºå…è®¸çš„è·¨åŸŸæ–¹æ³•ï¼šAccess-Control-Max-Age å­—æ®µè¡¨ç¤ºé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œåœ¨æœ‰æ•ˆæœŸå†…å¦‚æœå‘èµ·è¯¥è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¸ç”¨å†æ¬¡å‘èµ·é¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç»“æœ¿åï¼Œæ¥ä¸‹æ¥å°±ä¼šå‘èµ·ä¸€ä¸ªçœŸæ­£çš„è·¨åŸŸè¯·æ±‚ï¼Œè·¨åŸŸè¯·æ±‚å’Œå‰é¢çš„ç®€å•è¯·æ±‚è·¨åŸŸæ­¥éª¤ç±»ä¼¼ã€‚</p>
<h3 id="Spring-è·¨åŸŸè§£å†³æ–¹æ¡ˆ">Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h3>
<h4 id="CrossOrigin">@CrossOrigin</h4>
<p>Spring ä¸­ç¬¬ä¸€ç§å¤„ç†è·¨åŸŸçš„æ–¹å¼æ˜¯é€šè¿‡@CrossOrigin æ³¨è§£æ¥æ ‡è®°æ”¯æŒè·¨åŸŸï¼Œè¯¥æ³¨è§£å¯ä»¥æ·»åŠ åœ¨æ–¹æ³•ä¸Šï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ Controller ä¸Šã€‚å½“æ·»åŠ åœ¨ Controller ä¸Šæ—¶ï¼Œè¡¨ç¤º Controller ä¸­çš„æ‰€</p>
<p>æœ‰æ¥å£éƒ½æ”¯æŒè·¨åŸŸï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>@RestController
public Class HelloController&#123;
	@CrossOrigin (origins =&quot;http://localhost:8081&quot;)
	@PostMapping (&quot;/post&quot;)
	public String post ()&#123;
		return &quot;hello post&quot;;
	&#125;
&#125;
</code></pre>
<p>@CrossOrigin æ³¨è§£å„å±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>alowCredentialsï¼šæµè§ˆå™¨æ˜¯å¦åº”å½“å‘é€å‡­è¯ä¿¡æ¯ï¼Œå¦‚ Cookieã€‚</p>
</li>
<li>
<p>allowedHeadersï¼š è¯·æ±‚è¢«å…è®¸çš„è¯·æ±‚å¤´å­—æ®µï¼Œ<code>*</code>è¡¨ç¤ºæ‰€æœ‰å­—æ®µã€‚</p>
</li>
<li>
<p>exposedHeadersï¼šå“ªäº›å“åº”å¤´å¯ä»¥ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p>
<p><code>æ³¨æ„ï¼Œè¿™é‡Œåªå¯ä»¥ä¸€ä¸€åˆ—ä¸¾ï¼Œé€šé…ç¬¦ * åœ¨è¿™é‡Œæ˜¯æ— æ•ˆçš„ã€‚</code></p>
</li>
<li>
<p>maxAgeï¼šé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸå†…ä¸å¿…å†æ¬¡å‘é€é¢„æ£€è¯·æ±‚ï¼Œé»˜è®¤æ˜¯<code>1800</code> ç§’ã€‚</p>
</li>
<li>
<p>methodsï¼šå…è®¸çš„è¯·æ±‚æ–¹æ³•ï¼Œ<code>*</code> è¡¨ç¤ºå…è®¸æ‰€æœ‰æ–¹æ³•ã€‚</p>
</li>
<li>
<p>originsï¼šå…è®¸çš„åŸŸï¼Œ<code>*</code>è¡¨ç¤ºå…è®¸æ‰€æœ‰åŸŸã€‚</p>
</li>
</ul>
<h4 id="addCrosMapping">addCrosMapping</h4>
<p>@CrossOrigin æ³¨è§£éœ€è¦æ·»åŠ åœ¨ä¸åŒçš„ Controller ä¸Šã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ç§å…¨å±€é…ç½®æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡é‡å†™ WebMvcConfigurerComposite#addCorsMappingsæ–¹æ³•æ¥å®ç°ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>Configuration
public class WebMvcConfig implements WebMvcConfigurer&#123;
  Override
  public void addCorsMappings (CorsRegistry registry)&#123;
    registry.addMapping(&quot;/**&quot;) //å¤„ç†çš„è¯·æ±‚åœ°å€
    .allowedMethods (&quot;*&quot;)
    â€¢allowedorigins(&quot;*&quot;)
    .allowedHeaders (&quot;*&quot;)
    .allowCredentials (false)
    â€¢exposedHeaders (&quot;&quot;)
    .maxAge (3600) ;
  &#125;
&#125;
</code></pre>
<h4 id="CrosFilter">CrosFilter</h4>
<p>Cosr Filter æ˜¯Spring Web ä¸­æä¾›çš„ä¸€ä¸ªå¤„ç†è·¨åŸŸçš„è¿‡æ»¤å™¨ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡è¯¥è¿‡è¯¥è¿‡æ»¤å™¨å¤„ç†è·¨åŸŸã€‚</p>
<pre><code>@Configuration
public class WebMvcConfig &#123;
    @Bean
    FilterRegistrationBean&lt;CorsFilter&gt; corsFilter() &#123;
        FilterRegistrationBean&lt;CorsFilter&gt; registrationBean = new FilterRegistrationBean&lt;&gt;();
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.setAllowedHeaders(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setAllowedMethods(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setMaxAge(3600L);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration(&quot;/**&quot;, corsConfiguration);
        registrationBean.setFilter(new CorsFilter(source));
        registrationBean.setOrder(-1);//filter 0 1
        return registrationBean;
    &#125;
&#125;
</code></pre>
<h3 id="Spring-Security-è·¨åŸŸè§£å†³æ–¹æ¡ˆ">Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h3>
<h4 id="åŸç†åˆ†æ-2">åŸç†åˆ†æ</h4>
<p>å½“æˆ‘ä»¬ä¸ºé¡¹ç›®æ·»åŠ äº† Spring Security ä¾èµ–ä¹‹åï¼Œå‘ç°ä¸Šé¢ä¸‰ç§è·¨åŸŸæ–¹å¼æœ‰çš„å¤±æ•ˆäº†ï¼Œæœ‰<br>
åˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>
<p>é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸï¼Œç»Ÿç»Ÿå¤±æ•ˆäº†ï¼Œé€š<br>
CorsFilter é…ç½®çš„è·¨åŸŸï¼Œæœ‰æ²¡æœ‰å¤±æ•ˆåˆ™è¦çœ‹è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº Sp<br>
Security è¿‡æ»¤å™¨ï¼Œå³å…ˆäº Spring Security è¿‡æ»¤å™¨æ‰§è¡Œï¼Œåˆ™ CorsFiter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†ä¾ç„¶æœ‰æ•ˆï¼›å¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§ä½äº Spring Security è¿‡æ»¤å™¨ï¼Œåˆ™ CorsFilter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†å°±ä¼šå¤±æ•ˆã€‚</p>
<p>ä¸ºäº†ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç®€ç•¥äº†è§£ä¸€ä¸‹ Filterã€DispatchserServlet ä»¥åŠInterceptor æ‰§è¡Œé¡ºåºã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/ae3bd2fdd428432487a8d1bd192dd8fa.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç†æ¸…æ¥šäº†æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬å†æ¥çœ‹è·¨åŸŸè¯·æ±‚è¿‡ç¨‹ã€‚ç”±äºéç®€å•è¯·æ±‚éƒ½è¦é¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚<br>
requestï¼‰ï¼Œè€Œé¢„æ£€è¯·æ±‚å¹¶ä¸ä¼šæºå¸¦è®¤è¯ä¿¡æ¯ï¼Œæ‰€ä»¥é¢„æ£€è¯·æ±‚å°±æœ‰è¢« Spring Security æ‹¦æˆªçš„å¯èƒ½ã€‚å› æ­¤é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸå°±ä¼šå¤±æ•ˆã€‚å¦‚æœä½¿ç”¨ CorsFilter é…ç½®çš„è·¨åŸŸï¼Œåªè¦è¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº SpringSecurity è¿‡æ»¤å™¨å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚åä¹‹åŒæ ·ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h4 id="è§£å†³æ–¹æ¡ˆ-2">è§£å†³æ–¹æ¡ˆ</h4>
<p>Spring Security ä¸­ä¹Ÿæä¾›äº†æ›´ä¸“ä¸šçš„æ–¹å¼æ¥è§£å†³é¢„æ£€è¯·æ±‚æ‰€é¢ä¸´çš„é—®é¢˜ã€‚å¦‚ï¼š</p>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
		@Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests().anyRequest()
                .authenticated()
                .and()
                .formLogin()
                .and()
                .cors() //è·¨åŸŸå¤„ç†æ–¹æ¡ˆ
                .configurationSource(configurationSource())
                .and()
                .csrf().disable();
    &#125;

    CorsConfigurationSource configurationSource() &#123;
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        corsConfiguration.setAllowedHeaders(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setAllowedMethods(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setAllowedOrigins(Arrays.asList(&quot;*&quot;));
        corsConfiguration.setMaxAge(3600L);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration(&quot;/**&quot;, corsConfiguration);
        return source;
    &#125;
&#125;
</code></pre>
<h2 id="ç¬¬ä¹ç« -å¼‚å¸¸å¤„ç†">ç¬¬ä¹ç«  å¼‚å¸¸å¤„ç†</h2>
<ul>
<li>Spring Security å¼‚å¸¸ä½“ç³»</li>
<li>è‡ªå®šä¹‰å¼‚å¸¸é…ç½®</li>
</ul>
<h4 id="å¼‚å¸¸ä½“ç³»">å¼‚å¸¸ä½“ç³»</h4>
<p>Spring Security ä¸­å¼‚å¸¸ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»:</p>
<ul>
<li>AuthenticationException: è®¤è¯å¼‚å¸¸</li>
<li>AccessDeniedException: æˆæƒå¼‚å¸¸</li>
</ul>
<p>å…¶ä¸­è®¤è¯æ‰€æ¶‰åŠå¼‚å¸¸ç±»å‹æ¯”è¾ƒå¤šï¼Œé»˜è®¤æä¾›çš„å¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/bafeb842d5e3468e8beb741861010713.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç›¸æ¯”äºè®¤è¯å¼‚å¸¸ï¼Œæƒé™å¼‚å¸¸ç±»å°±è¦å°‘äº†å¾ˆå¤šï¼Œé»˜è®¤æä¾›çš„æƒé™å¼‚å¸¸å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/c9ad7346326a4f86915b2c8323db3021.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœé»˜è®¤æä¾›å¼‚å¸¸æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦æ ¹æ®å®é™…éœ€è¦æ¥è‡ªå®šä¹‰å¼‚å¸¸ç±»ã€‚</p>
<h4 id="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®">è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®</h4>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.authorizeRequests().anyRequest()
                .authenticated()
          			//.....
                .and()
                .exceptionHandling()//å¼‚å¸¸å¤„ç†
                .authenticationEntryPoint((request, response, e) -&gt; &#123;
                  response.setContentType(&quot;application/json;charset=UTF-8&quot;);
                  response.setStatus(HttpStatus.UNAUTHORIZED.value());
                  response.getWriter().write(&quot;å°šæœªè®¤è¯ï¼Œè¯·è¿›è¡Œè®¤è¯æ“ä½œï¼&quot;);
                &#125;)
                .accessDeniedHandler((request, response, e) -&gt; &#123;
                  response.setContentType(&quot;application/json;charset=UTF-8&quot;);
                  response.setStatus(HttpStatus.FORBIDDEN.value());
                  response.getWriter().write(&quot;æ— æƒè®¿é—®!&quot;);
                &#125;);
    &#125;
&#125;
</code></pre>
<h2 id="ç¬¬åç« -æˆæƒ">ç¬¬åç«  æˆæƒ</h2>
<ul>
<li>ä»€ä¹ˆæ˜¯æƒé™ç®¡ç†</li>
<li>æƒé™ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ</li>
<li>Spring Security æƒé™ç®¡ç†ç­–ç•¥</li>
<li>åŸºäº URL åœ°å€çš„æƒé™ç®¡ç†</li>
<li>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†</li>
<li>å®æˆ˜</li>
</ul>
<h4 id="æƒé™ç®¡ç†-2">æƒé™ç®¡ç†</h4>
<h5 id="è®¤è¯-3">è®¤è¯</h5>
<p><strong><code>èº«ä»½è®¤è¯</code></strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚Spring Security ä¸­æ”¯æŒå¤šç§ä¸åŒæ–¹å¼çš„è®¤è¯ï¼Œä½†æ˜¯æ— è®ºå¼€å‘è€…ä½¿ç”¨é‚£ç§æ–¹å¼è®¤è¯ï¼Œéƒ½ä¸ä¼šå½±å“æˆæƒåŠŸèƒ½ä½¿ç”¨ã€‚å› ä¸º Spring Security å¾ˆå¥½åšåˆ°äº†è®¤è¯å’Œæˆæƒè§£è€¦ã€‚</p>
<h5 id="æˆæƒ-3">æˆæƒ</h5>
<p><strong><code>æˆæƒ</code></strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ç®€å•çš„ç†è§£æˆæƒå°±æ˜¯æ ¹æ®ç³»ç»Ÿæå‰è®¾ç½®å¥½çš„è§„åˆ™ï¼Œç»™ç”¨æˆ·åˆ†é…å¯ä»¥è®¿é—®æŸä¸€ä¸ªèµ„æºçš„æƒé™ï¼Œç”¨æˆ·æ ¹æ®è‡ªå·±æ‰€å…·æœ‰æƒé™ï¼Œå»æ‰§è¡Œç›¸åº”æ“ä½œã€‚</p>
<h4 id="æˆæƒæ ¸å¿ƒæ¦‚å¿µ">æˆæƒæ ¸å¿ƒæ¦‚å¿µ</h4>
<p>åœ¨å‰é¢å­¦ä¹ è®¤è¯è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥è®¤è¯æˆåŠŸä¹‹åä¼šå°†å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Authentication å¯¹è±¡ä¸­ï¼ŒAuthentication å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª getAuthorities() æ–¹æ³•ï¼Œç”¨æ¥è¿”å›å½“å‰ç™»å½•ç”¨æˆ·å…·å¤‡çš„æƒé™ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç”¨æˆ·å…·æœ‰æƒé™ä¿¡æ¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º Collection&lt;? extends GrantedAuthority&gt;ï¼Œå½“éœ€è¦è¿›è¡Œæƒé™åˆ¤æ–­æ—¶ï¼Œå°±å›æ ¹æ®é›†åˆè¿”å›æƒé™ä¿¡æ¯è°ƒç”¨ç›¸åº”æ–¹æ³•è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/360962a66d1c412bb80c9f59d69db2ac.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé’ˆå¯¹äºè¿™ä¸ªè¿”å›å€¼ GrantedAuthority åº”è¯¥å¦‚ä½•ç†è§£å‘¢? æ˜¯è§’è‰²è¿˜æ˜¯æƒé™?</p>
<p>æˆ‘ä»¬é’ˆå¯¹äºæˆæƒå¯ä»¥æ˜¯<code>åŸºäºè§’è‰²æƒé™ç®¡ç†</code>å’Œ<code>åŸºäºèµ„æºæƒé™ç®¡ç†</code> ï¼Œä»è®¾è®¡å±‚é¢ä¸Šæ¥è¯´ï¼Œè§’è‰²å’Œæƒé™æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼šæƒé™æ˜¯ä¸€äº›å…·ä½“æ“ä½œï¼Œè§’è‰²åˆ™æ˜¯æŸäº›æƒé™é›†åˆã€‚å¦‚ï¼šREAD_BOOK å’Œ ROLE_ADMIN æ˜¯å®Œå…¨ä¸åŒçš„ã€‚å› æ­¤è‡³äºè¿”å›å€¼æ˜¯ä»€ä¹ˆå–å†³äºä½ çš„ä¸šåŠ¡è®¾è®¡æƒ…å†µï¼š</p>
<ul>
<li>
<p>åŸºäºè§’è‰²æƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>è§’è‰²</code></p>
</li>
<li>
<p>åŸºäºèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>æƒé™</code></p>
</li>
<li>
<p>åŸºäºè§’è‰²å’Œèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> è¿”å›ç»Ÿç§°ä¸ºç”¨æˆ·çš„<code>æƒé™</code></p>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆå¯ä»¥ç»Ÿç§°ä¸ºæƒé™ï¼Œå› ä¸ºä»ä»£ç å±‚é¢è§’è‰²å’Œæƒé™æ²¡æœ‰å¤ªå¤§ä¸åŒéƒ½æ˜¯æƒé™ï¼Œç‰¹åˆ«æ˜¯åœ¨ Spring Security ä¸­ï¼Œè§’è‰²å’Œæƒé™å¤„ç†æ–¹å¼åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€åŒºåˆ« SpringSecurity åœ¨å¾ˆå¤šæ—¶å€™ä¼šè‡ªåŠ¨ç»™è§’è‰²æ·»åŠ ä¸€ä¸ª<code>ROLE_</code>å‰ç¼€ï¼Œè€Œæƒé™åˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ ã€‚</p>
<h4 id="æƒé™ç®¡ç†ç­–ç•¥">æƒé™ç®¡ç†ç­–ç•¥</h4>
<p>Spring Security ä¸­æä¾›çš„æƒé™ç®¡ç†ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ç±»å‹:</p>
<ul>
<li>
<p>åŸºäºè¿‡æ»¤å™¨(URL)çš„æƒé™ç®¡ç† (FilterSecurityInterceptor)</p>
<ul>
<li>åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥æ‹¦æˆª HTTP è¯·æ±‚ï¼Œæ‹¦æˆªä¸‹æ¥ä¹‹åï¼Œæ ¹æ® HTTP è¯·æ±‚åœ°å€è¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
</ul>
</li>
<li>
<p>åŸºäº AOP (æ–¹æ³•)çš„æƒé™ç®¡ç† (MethodSecurityInterceptor)</p>
<ul>
<li>åŸºäº AOP æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ–¹æ³•çº§åˆ«çš„æƒé™é—®é¢˜ã€‚å½“éœ€è¦è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œé€šè¿‡ AOP å°†æ“ä½œæ‹¦æˆªä¸‹æ¥ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸å…³çš„æƒé™ã€‚</li>
</ul>
</li>
</ul>
<h4 id="åŸºäº-URL-æƒé™ç®¡ç†">åŸºäº URL æƒé™ç®¡ç†</h4>
<ul>
<li>
<p>å¼€å‘ controller</p>
<p>@RestController<br>
public class DemoController {</p>
<pre><code>@GetMapping(&quot;/admin&quot;)
public String admin() &#123;
    return &quot;admin ok&quot;;
&#125;

@GetMapping(&quot;/user&quot;)
public String user() &#123;
    return &quot;user ok&quot;;
&#125;

@GetMapping(&quot;/getInfo&quot;)
public String getInfo() &#123;
    return &quot;info ok&quot;;
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½®æˆæƒ</p>
<p>package com.blr.config;</p>
<p>import org.springframework.context.annotation.Configuration;<br>
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;<br>
import org.springframework.security.config.annotation.web.builders.HttpSecurity;<br>
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<br>
import org.springframework.security.core.userdetails.User;<br>
import org.springframework.security.core.userdetails.UserDetailsService;<br>
import org.springframework.security.provisioning.InMemoryUserDetailsManager;</p>
<p>@Configuration<br>
public class SecurityConfig extends WebSecurityConfigurerAdapter {</p>
<pre><code>//åˆ›å»ºå†…å­˜æ•°æ®æº
public UserDetailsService userDetailsService() &#123;
    InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
    //åŸºäºè§’è‰²
    inMemoryUserDetailsManager.createUser(User.withUsername(&quot;root&quot;).password(&quot;&#123;noop&#125;123&quot;).roles(&quot;ADMIN&quot;).build());
    inMemoryUserDetailsManager.createUser(User.withUsername(&quot;win7&quot;).password(&quot;&#123;noop&#125;123&quot;).roles(&quot;USER&quot;).build());
    //åŸºäºæƒé™
    inMemoryUserDetailsManager.createUser(User.withUsername(&quot;lisi&quot;).password(&quot;&#123;noop&#125;123&quot;).authorities(&quot;READ_BOOK&quot;).build());
    return inMemoryUserDetailsManager;
&#125;

@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
    auth.userDetailsService(userDetailsService());
&#125;

@Override
protected void configure(HttpSecurity http) throws Exception &#123;
    http.authorizeHttpRequests()
        //  /**:ä»£è¡¨é€šé…ç¬¦
            .antMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)
            .antMatchers(&quot;/user/**&quot;).hasAnyRole(&quot;USER&quot;, &quot;ADMIN&quot;)
            .antMatchers(&quot;/getInfo&quot;).hasAuthority(&quot;READ_BOOK&quot;)
            .anyRequest().authenticated()
            .and().formLogin()
            .and().csrf().disable();
&#125;
</code></pre>
<p>}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/c978a5a1723c481180e0b430d935ed45.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/666e7ea565524f8089f422961f77adf6.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>å¯åŠ¨é¡¹ç›®æµ‹è¯•</li>
</ul>
<h5 id="æƒé™è¡¨è¾¾å¼">æƒé™è¡¨è¾¾å¼</h5>
<p><img src="https://img-blog.csdnimg.cn/28615043cfe14a0490c02854bd41863f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>æ–¹æ³•</p>
<p>è¯´æ˜</p>
<p>hasAuthority(String authority)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™</p>
<p>hasAnyAuthority(Stringâ€¦ authorities)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™ä¸­ä»»æ„ä¸€ä¸ª</p>
<p>hasRole(String role)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²</p>
<p>hasAnyRole(Stringâ€¦ roles);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²ä¸­ä»»æ„ä¸€ä¸ª</p>
<p>permitAll();</p>
<p>æ”¾è¡Œæ‰€æœ‰è¯·æ±‚/è°ƒç”¨</p>
<p>denyAll();</p>
<p>æ‹’ç»æ‰€æœ‰è¯·æ±‚/è°ƒç”¨</p>
<p>isAnonymous();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªåŒ¿åç”¨æˆ·</p>
<p>isAuthenticated();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è®¤è¯æˆåŠŸ</p>
<p>isRememberMe();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•</p>
<p>isFullyAuthenticated();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦æ—¢ä¸æ˜¯åŒ¿åç”¨æˆ·åˆä¸æ˜¯é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•çš„</p>
<p>hasPermission(Object targetId, Object permission);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</p>
<p>hasPermission(Object targetId, String targetType, Object permission);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</p>
<h5 id="antMatchersï¼ŒmvcMatchersï¼ŒregexMatchers-çš„åŒºåˆ«ï¼š">antMatchersï¼ŒmvcMatchersï¼ŒregexMatchers çš„åŒºåˆ«ï¼š</h5>
<p><img src="https://img-blog.csdnimg.cn/3d53f9e569864db2bf3c3831898e6790.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="åŸºäº-æ–¹æ³•-æƒé™ç®¡ç†">åŸºäº æ–¹æ³• æƒé™ç®¡ç†</h4>
<p>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯é€šè¿‡ A0P æ¥å®ç°çš„ï¼ŒSpring Security ä¸­é€šè¿‡ MethodSecurityInterceptor æ¥æä¾›ç›¸å…³çš„å®ç°ã€‚ä¸åŒåœ¨äº FilterSecurityInterceptor åªæ˜¯åœ¨è¯·æ±‚ä¹‹å‰è¿›è¡Œå‰ç½®å¤„ç†ï¼ŒMethodSecurityInterceptor é™¤äº†å‰ç½®å¤„ç†ä¹‹å¤–è¿˜å¯ä»¥è¿›è¡Œåç½®å¤„ç†ã€‚å‰ç½®å¤„ç†å°±æ˜¯åœ¨è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å…·å¤‡ç›¸åº”çš„æƒé™ï¼Œåç½®å¤„ç†åˆ™æ˜¯å¯¹æ–¹æ³•çš„æ‰§è¡Œç»“æœè¿›è¡ŒäºŒæ¬¡è¿‡æ»¤ã€‚å‰ç½®å¤„ç†å’Œåç½®å¤„ç†åˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„å®ç°ç±»ã€‚</p>
<h5 id="EnableGlobalMethodSecurity">@EnableGlobalMethodSecurity</h5>
<p>EnableGlobalMethodSecurity è¯¥æ³¨è§£æ˜¯ç”¨æ¥å¼€å¯æƒé™æ³¨è§£ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre><code>@Configuration
@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)
public class SecurityConfig extends WebsecurityConfigurerAdapter&#123;&#125;
</code></pre>
<ul>
<li>
<p><strong>perPostEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„å››ä¸ªæƒé™æ³¨è§£ï¼Œ@PostAuthorizeã€@PostFilterã€@PreAuthorize ä»¥åŠ@PreFilterã€‚</p>
</li>
<li>
<p><strong>securedEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„ @Secured æ³¨è§£æ”¯æŒï¼Œè¯¥æ³¨è§£ä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</p>
</li>
<li>
<p><strong>jsr250Enabled</strong>: å¼€å¯ JSR-250 æä¾›çš„æ³¨è§£ï¼Œä¸»è¦æ˜¯@DenyAllã€@PermitAllã€@RolesAll åŒæ ·è¿™äº›æ³¨è§£ä¹Ÿä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</p>
<h1>ä»¥ä¸Šæ³¨è§£å«ä¹‰å¦‚ä¸‹:</h1>
<ul>
<li>@PostAuthorizeï¼š åœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åè¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
<li>@PostFiterï¼š åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åå¯¹æ–¹æ³•çš„è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</li>
<li>@PreAuthorizeï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰è¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
<li>@PreFiterï¼šåœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œè¿‡æ»¤ã€‚</li>
<li>@Securedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å„ç›¸åº”çš„è§’è‰²ã€‚</li>
<li>@DenyAllï¼šæ‹’ç»æ‰€æœ‰è®¿é—®ã€‚</li>
<li>@PermitAllï¼šå…è®¸æ‰€æœ‰è®¿é—®ã€‚</li>
<li>@RolesAllowedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å¤‡ç›¸åº”çš„è§’è‰²ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™äº›åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ç›¸å…³çš„æ³¨è§£ï¼Œä¸€èˆ¬æ¥è¯´åªè¦è®¾ç½® <strong><code>prePostEnabled=true</code></strong> å°±å¤Ÿç”¨äº†ã€‚</p>
<h5 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h5>
<ul>
<li>
<p>å¼€å¯æ³¨è§£ä½¿ç”¨</p>
<p>@Configuration<br>
@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)<br>
public class SecurityConfig extends WebsecurityConfigurerAdapter{}</p>
</li>
<li>
<p>ä½¿ç”¨æ³¨è§£</p>
<p>@RestController<br>
@RequestMapping(â€œ/helloâ€)<br>
public class AuthorizeMethodController {</p>
<p>// @PreAuthorize(â€œhasRole(â€˜ADMINâ€™) and authentication.name==â€˜rootâ€™â€)//åŸºäºè§’è‰²å’Œç”¨æˆ·å<br>
@PreAuthorize(&quot;hasAuthority(â€˜READ_INFOâ€™))//åŸºäºæƒé™<br>
@GetMapping<br>
public String hello() {<br>
return â€œhelloâ€;<br>
}</p>
<pre><code>@PreAuthorize(&quot;authentication.name==#name&quot;)
@GetMapping(&quot;/name&quot;)
public String hello(String name) &#123;
    return &quot;hello:&quot; + name;
&#125;

@PreFilter(value = &quot;filterObject.id%2!=0&quot;,filterTarget = &quot;users&quot;)
@PostMapping(&quot;/users&quot;)  //filterTarget å¿…é¡»æ˜¯ æ•°ç»„  é›†åˆ
public void addUsers(@RequestBody List&lt;User&gt; users) &#123;
    System.out.println(&quot;users = &quot; + users);
&#125;

@PostAuthorize(&quot;returnObject.id==1&quot;)
@GetMapping(&quot;/userId&quot;)
public User getUserById(Integer id) &#123;
    return new User(id, &quot;blr&quot;);
&#125;

@PostFilter(&quot;filterObject.id%2==0&quot;)
@GetMapping(&quot;/lists&quot;)
public List&lt;User&gt; getAll() &#123;
    List&lt;User&gt; users = new ArrayList&lt;&gt;();
    for (int i = 0; i &lt; 10; i++) &#123;
        users.add(new User(i, &quot;blr:&quot; + i));
    &#125;
    return users;
&#125;

@Secured(&#123;&quot;ROLE_USER&quot;&#125;) //åªèƒ½åˆ¤æ–­è§’è‰²
@GetMapping(&quot;/secured&quot;)
public User getUserByUsername() &#123;
    return new User(99, &quot;secured&quot;);
&#125;

@Secured(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;) //å…·æœ‰å…¶ä¸­ä¸€ä¸ªå³å¯
@GetMapping(&quot;/username&quot;)
public User getUserByUsername2(String username) &#123;
    return new User(99, username);
&#125;

@PermitAll
@GetMapping(&quot;/permitAll&quot;)
public String permitAll() &#123;
    return &quot;PermitAll&quot;;
&#125;

@DenyAll
@GetMapping(&quot;/denyAll&quot;)
public String denyAll() &#123;
    return &quot;DenyAll&quot;;
&#125;

@RolesAllowed(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;) //å…·æœ‰å…¶ä¸­ä¸€ä¸ªè§’è‰²å³å¯
@GetMapping(&quot;/rolesAllowed&quot;)
public String rolesAllowed() &#123;
    return &quot;RolesAllowed&quot;;
&#125;
</code></pre>
<p>}</p>
</li>
</ul>
<h3 id="åŸç†åˆ†æ-3">åŸç†åˆ†æ</h3>
<p><img src="https://img-blog.csdnimg.cn/897707bd55e6425dbcf4d449f44dd026.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li><strong><code>ConfigAttribute</code></strong> åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ªèµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</li>
<li><strong><code>AccesDecisionVoter å’Œ AccessDecisionManager</code></strong> éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</li>
</ul>
<h3 id="å®æˆ˜-2">å®æˆ˜</h3>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ URL æ‹¦æˆªè§„åˆ™å’Œè¯·æ±‚ URL æ‰€éœ€è¦çš„æƒé™éƒ½æ˜¯é€šè¿‡ä»£ç æ¥é…ç½®çš„ï¼Œè¿™æ ·å°±æ¯”è¾ƒæ­»æ¿ï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è®¿é—®æŸä¸€ä¸ª URL æ‰€éœ€è¦çš„æƒé™ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚</p>
<p>åŠ¨æ€ç®¡ç†æƒé™è§„åˆ™å°±æ˜¯æˆ‘ä»¬å°† URL æ‹¦æˆªè§„åˆ™å’Œè®¿é—® URI æ‰€éœ€è¦çš„æƒé™éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè¿™æ ·ï¼Œåœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå°±å¯ä»¥å¯¹æƒé™è¿›è¡Œè°ƒæ•´ã€‚</p>
<p><code>ç”¨æˆ·&lt;--ä¸­é—´è¡¨--&gt; è§’è‰² &lt;--ä¸­é—´è¡¨--&gt; èœå•</code></p>
<h4 id="åº“è¡¨è®¾è®¡">åº“è¡¨è®¾è®¡</h4>
<pre><code>SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
-- ----------------------------
-- Table structure for menu
-- ----------------------------
DROP TABLE IF EXISTS `menu`;
CREATE TABLE `menu` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `pattern` varchar(128) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of menu
-- ----------------------------
BEGIN;
INSERT INTO `menu` VALUES (1, '/admin/**');
INSERT INTO `menu` VALUES (2, '/user/**');
INSERT INTO `menu` VALUES (3, '/guest/**');
COMMIT;

-- ----------------------------
-- Table structure for menu_role
-- ----------------------------
DROP TABLE IF EXISTS `menu_role`;
CREATE TABLE `menu_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `mid` int(11) DEFAULT NULL,
  `rid` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `mid` (`mid`),
  KEY `rid` (`rid`),
  CONSTRAINT `menu_role_ibfk_1` FOREIGN KEY (`mid`) REFERENCES `menu` (`id`),
  CONSTRAINT `menu_role_ibfk_2` FOREIGN KEY (`rid`) REFERENCES `role` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of menu_role
-- ----------------------------
BEGIN;
INSERT INTO `menu_role` VALUES (1, 1, 1);
INSERT INTO `menu_role` VALUES (2, 2, 2);
INSERT INTO `menu_role` VALUES (3, 3, 3);
INSERT INTO `menu_role` VALUES (4, 3, 2);
COMMIT;

-- ----------------------------
-- Table structure for role
-- ----------------------------
DROP TABLE IF EXISTS `role`;
CREATE TABLE `role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(32) DEFAULT NULL,
  `nameZh` varchar(32) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of role
-- ----------------------------
BEGIN;
INSERT INTO `role` VALUES (1, 'ROLE_ADMIN', 'ç³»ç»Ÿç®¡ç†å‘˜');
INSERT INTO `role` VALUES (2, 'ROLE_USER', 'æ™®é€šç”¨æˆ·');
INSERT INTO `role` VALUES (3, 'ROLE_GUEST', 'æ¸¸å®¢');
COMMIT;

-- ----------------------------
-- Table structure for user
-- ----------------------------
DROP TABLE IF EXISTS `user`;
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(32) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `enabled` tinyint(1) DEFAULT NULL,
  `locked` tinyint(1) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of user
-- ----------------------------
BEGIN;
INSERT INTO `user` VALUES (1, 'admin', '&#123;noop&#125;123', 1, 0);
INSERT INTO `user` VALUES (2, 'user', '&#123;noop&#125;123', 1, 0);
INSERT INTO `user` VALUES (3, 'blr', '&#123;noop&#125;123', 1, 0);
COMMIT;

-- ----------------------------
-- Table structure for user_role
-- ----------------------------
DROP TABLE IF EXISTS `user_role`;
CREATE TABLE `user_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uid` int(11) DEFAULT NULL,
  `rid` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `uid` (`uid`),
  KEY `rid` (`rid`),
  CONSTRAINT `user_role_ibfk_1` FOREIGN KEY (`uid`) REFERENCES `user` (`id`),
  CONSTRAINT `user_role_ibfk_2` FOREIGN KEY (`rid`) REFERENCES `role` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of user_role
-- ----------------------------
BEGIN;
INSERT INTO `user_role` VALUES (1, 1, 1);
INSERT INTO `user_role` VALUES (2, 1, 2);
INSERT INTO `user_role` VALUES (3, 2, 2);
INSERT INTO `user_role` VALUES (4, 3, 3);
COMMIT;
SET FOREIGN_KEY_CHECKS = 1;
</code></pre>
<h4 id="åˆ›å»º-springboot-åº”ç”¨">åˆ›å»º springboot åº”ç”¨</h4>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
  &lt;groupId&gt;mysql&lt;/groupId&gt;
  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
  &lt;version&gt;5.1.38&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
  &lt;artifactId&gt;druid&lt;/artifactId&gt;
  &lt;version&gt;1.2.8&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
  &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
  &lt;version&gt;2.2.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li>
<p>é…ç½®é…ç½®æ–‡ä»¶</p>
<pre><code>server.port=8080
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
mybatis.mapper-locations=classpath:com/blr/mapper/*.xml
mybatis.type-aliases-package=com.blr.entity
</code></pre>
</li>
<li>
<p>åˆ›å»ºå®ä½“ç±»</p>
<pre><code>public class User implements UserDetails &#123;
    private Integer id;
    private String password;
    private String username;
    private boolean enabled;
    private boolean locked;
    private List&lt;Role&gt; roles;

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;
        return roles.stream().map(r -&gt; new SimpleGrantedAuthority(r.getName())).collect(Collectors.toList());
    &#125;

    @Override
    public String getPassword() &#123;
        return password;
    &#125;

    @Override
    public String getUsername() &#123;
        return username;
    &#125;

    @Override
    public boolean isAccountNonExpired() &#123;
        return true;
    &#125;

    @Override
    public boolean isAccountNonLocked() &#123;
        return !locked;
    &#125;

    @Override
    public boolean isCredentialsNonExpired() &#123;
        return true;
    &#125;

    @Override
    public boolean isEnabled() &#123;
        return enabled;
    &#125;

    public void setId(Integer id) &#123;
        this.id = id;
    &#125;

    public void setPassword(String password) &#123;
        this.password = password;
    &#125;

    public void setUsername(String username) &#123;
        this.username = username;
    &#125;

    public void setEnabled(boolean enabled) &#123;
        this.enabled = enabled;
    &#125;

    public void setLocked(boolean locked) &#123;
        this.locked = locked;
    &#125;

    public void setRoles(List&lt;Role&gt; roles) &#123;
        this.roles = roles;
    &#125;

    public Integer getId() &#123;
        return id;
    &#125;

    public List&lt;Role&gt; getRoles() &#123;
        return roles;
    &#125;
&#125;


public class Role &#123;
    private Integer id;
    private String name;
    private String nameZh;

    public Integer getId() &#123;
        return id;
    &#125;

    public void setId(Integer id) &#123;
        this.id = id;
    &#125;

    public String getName() &#123;
        return name;
    &#125;

    public void setName(String name) &#123;
        this.name = name;
    &#125;

    public String getNameZh() &#123;
        return nameZh;
    &#125;

    public void setNameZh(String nameZh) &#123;
        this.nameZh = nameZh;
    &#125;
&#125;


public class Menu &#123;
    private Integer id;
    private String pattern;
    private List&lt;Role&gt; roles;

    public List&lt;Role&gt; getRoles() &#123;
        return roles;
    &#125;

    public void setRoles(List&lt;Role&gt; roles) &#123;
        this.roles = roles;
    &#125;

    public Integer getId() &#123;
        return id;
    &#125;

    public void setId(Integer id) &#123;
        this.id = id;
    &#125;

    public String getPattern() &#123;
        return pattern;
    &#125;

    public void setPattern(String pattern) &#123;
        this.pattern = pattern;
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º mapper æ¥å£</p>
<pre><code>@Mapper
public interface UserMapper &#123;
    List&lt;Role&gt; getUserRoleByUid(Integer uid);
    User loadUserByUsername(String username);
&#125;


@Mapper
public interface MenuMapper &#123;
    List&lt;Menu&gt; getAllMenu();
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º mapper æ–‡ä»¶</p>
<pre><code>&lt;!DOCTYPE mapper
        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;com.blr.mapper.UserMapper&quot;&gt;

    &lt;select id=&quot;loadUserByUsername&quot; resultType=&quot;com.blr.entity.User&quot;&gt;
        select *
        from user
        where username = #&#123;username&#125;;
    &lt;/select&gt;

    &lt;select id=&quot;getUserRoleByUid&quot; resultType=&quot;com.blr.entity.Role&quot;&gt;
        select r.*
        from role r,
             user_role ur
        where ur.uid = #&#123;uid&#125;
          and ur.rid = r.id
    &lt;/select&gt;
&lt;/mapper&gt;


&lt;mapper namespace=&quot;com.blr.mapper.MenuMapper&quot;&gt;
    &lt;resultMap id=&quot;MenuResultMap&quot; type=&quot;com.blr.entity.Menu&quot;&gt;
        &lt;id property=&quot;id&quot; column=&quot;id&quot;/&gt;
        &lt;result property=&quot;pattern&quot; column=&quot;pattern&quot;&gt;&lt;/result&gt;
        &lt;collection property=&quot;roles&quot; ofType=&quot;com.blr.entity.Role&quot;&gt;
            &lt;id column=&quot;rid&quot; property=&quot;id&quot;/&gt;
            &lt;result column=&quot;rname&quot; property=&quot;name&quot;/&gt;
            &lt;result column=&quot;rnameZh&quot; property=&quot;nameZh&quot;/&gt;
        &lt;/collection&gt;
    &lt;/resultMap&gt;
  
    &lt;select id=&quot;getAllMenu&quot; resultMap=&quot;MenuResultMap&quot;&gt;
        select m.*, r.id as rid, r.name as rname, r.nameZh as rnameZh
        from menu m
                 left join menu_role mr on m.`id` = mr.`mid`
                 left join role r on r.`id` = mr.`rid`
    &lt;/select&gt;
&lt;/mapper&gt;
</code></pre>
</li>
<li>
<p>åˆ›å»º service æ¥å£</p>
<pre><code>@Service
public class UserService implements UserDetailsService &#123;
    private final UserMapper userMapper;

    @Autowired
    public UserService(UserMapper userMapper) &#123;
        this.userMapper = userMapper;
    &#125;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        User user = userMapper.loadUserByUsername(username);
        if (user == null) &#123;
            throw new UsernameNotFoundException(&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;);
        &#125;
        user.setRoles(userMapper.getUserRoleByUid(user.getId()));
        return user;
    &#125;
&#125;


@Service
public class MenuService &#123;
    private final MenuMapper menuMapper;

    @Autowired
    public MenuService(MenuMapper menuMapper) &#123;
        this.menuMapper = menuMapper;
    &#125;

    public List&lt;Menu&gt; getAllMenu() &#123;
        return menuMapper.getAllMenu();
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»ºæµ‹è¯• controller</p>
<pre><code>@RestController
public class HelloController &#123;
    @GetMapping(&quot;/admin/hello&quot;)
    public String admin() &#123;
        return &quot;hello admin&quot;;
    &#125;

    @GetMapping(&quot;/user/hello&quot;)
    public String user() &#123;
        return &quot;hello user&quot;;
    &#125;

    @GetMapping(&quot;/guest/hello&quot;)
    public String guest() &#123;
        return &quot;hello guest&quot;;
    &#125;

    @GetMapping(&quot;/hello&quot;)
    public String hello() &#123;
        return &quot;hello&quot;;
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>åˆ›å»º CustomSecurityMetadataSource</p>
<pre><code>@Component
public class CustomSecurityMetadataSource implements FilterInvocationSecurityMetadataSource &#123;
    private final MenuService menuService;

    @Autowired
    public CustomSecurityMetadataSource(MenuService menuService) &#123;
        this.menuService = menuService;
    &#125;

    AntPathMatcher antPathMatcher = new AntPathMatcher();

    @Override
    public Collection&lt;ConfigAttribute&gt; getAttributes(Object object) throws IllegalArgumentException &#123;
        String requestURI = ((FilterInvocation) object).getRequest().getRequestURI();
        List&lt;Menu&gt; allMenu = menuService.getAllMenu();
        for (Menu menu : allMenu) &#123;
            if (antPathMatcher.match(menu.getPattern(), requestURI)) &#123;
                String[] roles = menu.getRoles().stream().map(r -&gt; r.getName()).toArray(String[]::new);
                return SecurityConfig.createList(roles);
            &#125;
        &#125;
        return null;
    &#125;

    @Override
    public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123;
        return null;
    &#125;

    @Override
    public boolean supports(Class&lt;?&gt; clazz) &#123;
        return FilterInvocation.class.isAssignableFrom(clazz);
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>é…ç½® Security é…ç½®</p>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    private final CustomSecurityMetadataSource customSecurityMetadataSource;
    private final UserService userService;

    @Autowired
    public SecurityConfig(CustomSecurityMetadataSource customSecurityMetadataSource, UserService userService) &#123;
        this.customSecurityMetadataSource = customSecurityMetadataSource;
        this.userService = userService;
    &#125;

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userService);
    &#125;

    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
       //1.è·å–å·¥å‚å¯¹è±¡
        ApplicationContext applicationContext = http.getSharedObject(ApplicationContext.class);
        //2.è®¾ç½®è‡ªå®šä¹‰ url æƒé™å¤„ç†
        http.apply(new UrlAuthorizationConfigurer&lt;&gt;(applicationContext))
                .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;
                    @Override
                    public &lt;O extends FilterSecurityInterceptor&gt; O postProcess(O object) &#123;
                        object.setSecurityMetadataSource(customSecurityMetadataSource);
                        //æ˜¯å¦æ‹’ç»å…¬å…±èµ„æºè®¿é—®
                        object.setRejectPublicInvocations(false);
                        return object;
                    &#125;
                &#125;);
        http.formLogin().and().csrf().disable();
    &#125;
&#125;
</code></pre>
</li>
<li>
<p>å¯åŠ¨å…¥å£ç±»è¿›è¡Œæµ‹è¯•</p>
</li>
</ul>
<h2 id="ç¬¬åä¸€ç« -OAuth2">ç¬¬åä¸€ç«  OAuth2</h2>
<ul>
<li>OAuth2 ç®€ä»‹</li>
<li>å››ç§æˆæƒæ¨¡å¼</li>
<li>Spring Security OAuth2</li>
<li>GitHub æˆæƒç™»å½•</li>
<li>æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨</li>
<li>ä½¿ç”¨ JWT</li>
</ul>
<h3 id="OAuth2-ç®€ä»‹">OAuth2 ç®€ä»‹</h3>
<p>OAuth æ˜¯ä¸€ä¸ªå¼€æ”¾çš„éå¸¸é‡è¦çš„è®¤è¯æ ‡å‡†/åè®®ï¼Œè¯¥æ ‡å‡†å…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†èµ„æºï¼ˆå¦‚å¤´åƒã€ç…§ç‰‡ã€è§†é¢‘ç­‰ï¼‰ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— é¡»å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚é€šè¿‡ä»¤ç‰Œï¼ˆtokenï¼‰å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæ¯ä¸€ä¸ªä»¤ç‰Œæˆæƒä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™åœ¨ç‰¹å®šçš„æ—¶æ®µå†…å…è®¸å¯ç‰¹å®šçš„èµ„æºã€‚OAuth è®©ç”¨æˆ·å¯ä»¥æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™çµæ´»è®¿é—®å®ƒä»¬å­˜å‚¨åœ¨å¦å¤–ä¸€äº›èµ„æºæœåŠ¡å™¨ä¸Šçš„ç‰¹å®šä¿¡æ¯ï¼Œè€Œéæ‰€æœ‰å†…å®¹ã€‚å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨äº’è”ç½‘åº”ç”¨ä¸­æœ€å¸¸è§çš„ OAuth åº”ç”¨å°±æ˜¯å„ç§ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œä¾‹å¦‚QQæˆæƒç™»å½•ã€å¾®ä¿¡æˆæƒç™»å½•ã€å¾®åšæˆæƒç™»å½•ã€GitHub æˆæƒç™»å½•ç­‰ã€‚</p>
<p>ä¾‹å¦‚ç”¨æˆ·æƒ³ç™»å½• Ruby Chinaï¼Œä¼ ç»Ÿæ–¹å¼æ˜¯ä½¿ç”¨ç”¨æˆ·åå¯†ç ä½†æ˜¯è¿™æ ·å¹¶ä¸å®‰å…¨ï¼Œå› ä¸ºç½‘ç«™ä¼šå­˜å‚¨ä½ çš„ç”¨æˆ·åå¯†ç ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å¯†ç æ³„éœ²ã€‚è¿™ç§æˆæƒæ–¹å¼å®‰å…¨éšæ‚£å¾ˆå¤§ï¼Œå¦‚æœä½¿ç”¨ OAuth åè®®å°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/2f4b4c89b0784f858c19f40e820a3a13.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<blockquote>
<p>æ³¨æ„: OAuth2 æ˜¯OAuth åè®®çš„ä¸‹ä¸€ç‰ˆæœ¬ï¼Œä½†ä¸å…¼å®¹ OAuth 1.0ã€‚ OAuth2 å…³æ³¨å®¢æˆ·ç«¯å¼€å‘è€…çš„ç®€æ˜“æ€§ï¼ŒåŒæ—¶ä¸º Web åº”ç”¨ã€æ¡Œé¢åº”ç”¨ã€ç§»åŠ¨è®¾å¤‡ã€IoT è®¾å¤‡æä¾›ä¸“é—¨çš„è®¤è¯æµç¨‹ã€‚</p>
</blockquote>
<h3 id="OAuth2-æˆæƒæ€»ä½“æµç¨‹">OAuth2 æˆæƒæ€»ä½“æµç¨‹</h3>
<p>è§’è‰²æ¢³ç†: ç¬¬ä¸‰æ–¹åº”ç”¨ &lt;----&gt; å­˜å‚¨ç”¨æˆ·ç§å¯†ä¿¡æ¯åº”ç”¨ ----&gt; æˆæƒæœåŠ¡å™¨ ----&gt; èµ„æºæœåŠ¡å™¨</p>
<p>æ•´ä½“æµç¨‹å¦‚ä¸‹:ï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/c8faee8ce3d7478e8d4b9cbd414f7b58.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code>- ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚
- ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚
- ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚
- ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚
- ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚
- ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚
</code></pre>
<p>ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…­ä¸ªæ­¥éª¤ä¹‹ä¸­ï¼ŒBæ˜¯å…³é”®ï¼Œå³ç”¨æˆ·æ€æ ·æ‰èƒ½ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚åŒæ—¶ä¼šå‘ç° OAuth2 ä¸­åŒ…å«å››ç§ä¸åŒçš„è§’è‰²ï¼š</p>
<ul>
<li>**Clientï¼š**ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</li>
<li><strong>Resource Owner</strong>ï¼šèµ„æºæ‰€æœ‰è€…ã€‚</li>
<li><strong>Authorization Server</strong> ï¼šæˆæƒæœåŠ¡å™¨ã€‚</li>
<li><strong>Resource Server</strong>ï¼š èµ„æºæœåŠ¡å™¨ã€‚</li>
</ul>
<h3 id="å››ç§æˆæƒæ¨¡å¼">å››ç§æˆæƒæ¨¡å¼</h3>
<h4 id="æˆæƒç æ¨¡å¼">æˆæƒç æ¨¡å¼</h4>
<p><strong>æˆæƒç æ¨¡å¼ï¼ˆ<code>Authorization Code</code>ï¼‰</strong> æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†ã€æœ€å®‰å…¨å¹¶ä¸”ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§OAuth2æˆæƒæ¨¡å¼ã€‚åŒæ—¶ä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ç§æˆæƒæ¨¡å¼ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸<code>æœåŠ¡æä¾›å•†</code>çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<ul>
<li>Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œç®€ç§°&quot;å®¢æˆ·ç«¯&quot;ï¼ˆclientï¼‰ï¼›</li>
<li>Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œç®€ç§°&quot;ç”¨æˆ·&quot;ï¼ˆuserï¼‰ï¼›</li>
<li>User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæ˜¯æŒ‡æµè§ˆå™¨ï¼›</li>
<li>Authorization Serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ï¼›</li>
<li>Resource Serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/62fd9b08d7d14541989987ec7e6e4960.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æµç¨‹å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡æµè§ˆå™¨å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚</p>
</li>
<li>
<p>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼ˆredirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚</p>
</li>
<li>
<p>ï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„&quot;é‡å®šå‘URI&quot;ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚</p>
</li>
<li>
<p>ï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚</p>
</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code>https://wx.com/oauth/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;redirect_uri=http://www.baidu.com&amp;scope=read
</code></pre>
<p>å­—æ®µ</p>
<p>æè¿°</p>
<p>client_id</p>
<p>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</p>
<p>response_type</p>
<p>å¿…é¡» å›ºå®šå€¼ åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º code</p>
<p>redirect_uri</p>
<p>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</p>
<p>scope</p>
<p>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™ read åªè¯» all è¯»å†™</p>
<p>state</p>
<p>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</p>
<h4 id="ç®€åŒ–æ¨¡å¼">ç®€åŒ–æ¨¡å¼</h4>
<p>**ç®€åŒ–æ¨¡å¼ï¼ˆ<code>implicit</code> grant typeï¼‰**ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†&quot;æˆæƒç &quot;è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/99ee2dfee0f94990b98f27579e0f7d04.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>ï¼ˆAï¼‰ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</li>
<li>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</li>
<li>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„&quot;é‡å®šå‘URI&quot;ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚#token</li>
<li>ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</li>
<li>ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</li>
<li>ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</li>
<li>ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code>https://wx.com/oauth/authorize?response_type=token&amp;client_id=CLIENT_ID&amp;redirect_uri=http://www.baidu.com&amp;scope=read
</code></pre>
<p>å­—æ®µ</p>
<p>æè¿°</p>
<p>client_id</p>
<p>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</p>
<p>response_type</p>
<p>å¿…é¡» å›ºå®šå€¼ åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º token</p>
<p>redirect_uri</p>
<p>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</p>
<p>scope</p>
<p>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™</p>
<p>state</p>
<p>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</p>
<h4 id="å¯†ç æ¨¡å¼">å¯†ç æ¨¡å¼</h4>
<p>**å¯†ç æ¨¡å¼ï¼ˆResource Owner <code>Password</code> Credentials Grantï¼‰**ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘&quot;æœåŠ¡å•†æä¾›å•†&quot;ç´¢è¦æˆæƒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªç›¸åŒå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/34c3bd74b2314450bbb77d79b828e9fc.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚</p>
</li>
<li>
<p>ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p>
</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code>https://wx.com/token?grant_type=password&amp;username=USERNAME&amp;password=PASSWORD&amp;client_id=CLIENT_ID
</code></pre>
<h4 id="å®¢æˆ·ç«¯æ¨¡å¼">å®¢æˆ·ç«¯æ¨¡å¼</h4>
<p>**å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆ<code>Client Credentials</code> Grantï¼‰**æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘&quot;æœåŠ¡æä¾›å•†&quot;è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚&quot;æœåŠ¡æä¾›å•†&quot;æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/5476095b062d4df68d2465b24346a863.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://wx.com/token?grant_type=client_credentials&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET">https://wx.com/token?grant_type=client_credentials&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET</a></p>
</li>
</ul>
<h3 id="OAuth2-æ ‡å‡†æ¥å£">OAuth2 æ ‡å‡†æ¥å£</h3>
<ul>
<li>
<p><code>/oauth/authorize</code>ï¼šæˆæƒç«¯ç‚¹</p>
</li>
<li>
<p><code>/oauth/token</code>ï¼šè·å–ä»¤ç‰Œç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/confirm_accessï¼šç”¨æˆ·ç¡®è®¤æˆæƒæäº¤ç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/errorï¼šæˆæƒæœåŠ¡é”™è¯¯ä¿¡æ¯ç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/check_tokenï¼šç”¨äºèµ„æºæœåŠ¡è®¿é—®çš„ä»¤ç‰Œè§£æç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/token_keyï¼šæä¾›å…¬æœ‰å¯†åŒ™çš„ç«¯ç‚¹ï¼Œå¦‚æœä½¿ç”¨JWTä»¤ç‰Œçš„è¯</p>
</li>
</ul>
<h3 id="GitHub-æˆæƒç™»å½•">GitHub æˆæƒç™»å½•</h3>
<h4 id="åˆ›å»º-OAuth-åº”ç”¨">åˆ›å»º OAuth åº”ç”¨</h4>
<p>è®¿é—® github å¹¶ç™»å½•ï¼Œåœ¨<a target="_blank" rel="noopener" href="https://github.com/settings/profile">https://github.com/settings/profile</a>ä¸­æ‰¾åˆ° Developer Settings é€‰é¡¹</p>
<p><img src="https://img-blog.csdnimg.cn/1d761922aa2e4c4c8ce20923b6e931fd.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>åˆ›å»º OAuth Appå¹¶è¾“å…¥ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯:</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/1e6af95052954c43add556fcc3af9f65.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>æ³¨å†ŒæˆåŠŸåä¼šè·å–åˆ°å¯¹åº”çš„ Client ID å’Œ Client Secretã€‚</li>
</ul>
<h4 id="é¡¹ç›®å¼€å‘">é¡¹ç›®å¼€å‘</h4>
<ul>
<li>
<p>åˆ›å»º springboot åº”ç”¨ï¼Œå¹¶å¼•å…¥ä¾èµ–</p>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
</dependency>
</li>
<li>
<p>åˆ›å»ºæµ‹è¯• controller</p>
<p>@RestController<br>
public class HelloController {</p>
<pre><code>@GetMapping(&quot;/hello&quot;)
public DefaultOAuth2User hello()&#123;
    System.out.println(&quot;hello &quot;);
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    return (DefaultOAuth2User) authentication.getPrincipal();
&#125;
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½® security</p>
<p>@Configuration<br>
public class SecurityConfig extends WebSecurityConfigurerAdapter {<br>
@Override<br>
protected void configure(HttpSecurity http) throws Exception {<br>
http.authorizeRequests()<br>
.anyRequest().authenticated()<br>
.and()<br>
.oauth2Login();<br>
}<br>
}</p>
</li>
<li>
<p>é…ç½®é…ç½®æ–‡ä»¶</p>
<p>server.port=8080</p>
<p>spring.security.oauth2.client.registration.github.client-id=d6ea299b9ade3cd3b97d<br>
spring.security.oauth2.client.registration.github.client-secret=aaa44b2675a7b636b1b43371e509e88ee9013816</p>
<h1>ä¸€å®šè¦ä¸é‡å®šå‘å›è°ƒ URL ä¸€è‡´</h1>
<p>spring.security.oauth2.client.registration.github.redirect-uri=http://localhost:8080/login/oauth2/code/github</p>
</li>
<li>
<p>å¯åŠ¨æµ‹è¯•</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/6a7429b6673a4de9bffcad6e633c1ecb.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>ç‚¹å‡» github ç™»å½•,ç‚¹å‡»æˆæƒ è®¿é—® hello æ¥å£</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/9371644d35fd4cb2978cc0c6004336f6.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="Spring-Security-OAuth2">Spring Security OAuth2</h3>
<p>Spring Security å¯¹ OAuth2 æä¾›äº†å¾ˆå¥½çš„æ”¯æŒï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨ Spring Securityä¸­ä½¿ç”¨ OAuth2 éå¸¸åœ°æ–¹ä¾¿ã€‚ç„¶è€Œç”±äºå†å²åŸå› ï¼ŒSpring Seaurityå¯¹ OAuth2 çš„æ”¯æŒæ¯”è¾ƒæ··ä¹±ï¼Œè¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹ã€‚</p>
<p>å¤§çº¦åå¹´å‰ï¼ŒSpring å¼•å…¥äº†ä¸€ä¸ªç¤¾åŒºé©±åŠ¨çš„å¼€æºé¡¹ç›® Spring Security OAuthï¼Œ å¹¶å°†å…¶çº³å…¥ Spring é¡¹ç›®ç»„åˆä¸­ã€‚åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œè¿™ä¸ªé¡¹ç›®å·±ç»å‘å±•æˆä¸ºä¸€ä¸ªæˆç†Ÿçš„é¡¹ç›®ï¼Œå¯ä»¥æ”¯æŒå¤§éƒ¨åˆ†OAuth è§„èŒƒï¼ŒåŒ…æ‹¬èµ„æºæœåŠ¡å™¨ã€ å®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨ç­‰ã€‚</p>
<p>ç„¶è€Œæ—©æœŸçš„é¡¹ç›®å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>
<p>OAuth æ˜¯åœ¨æ—©æœŸå®Œæˆçš„ï¼Œå¼€å‘è€…æ— æ³•é¢„æ–™æœªæ¥çš„å˜åŒ–ä»¥åŠè¿™äº›ä»£ç åˆ°åº•è¦è¢«æ€ä¹ˆä½¿ç”¨ï¼Œ</p>
<p>è¿™å¯¼è‡´å¾ˆå¤š Spring é¡¹ç›®æä¾›äº†è‡ªå·±çš„ OAuth æ”¯æŒï¼Œä¹Ÿå°±å¸¦æ¥äº† OAuth æ”¯æŒçš„ç¢ç‰‡åŒ–ã€‚</p>
</li>
<li>
<p>æœ€æ—©çš„OAuthé¡¹ç›®åŒæ—¶æ”¯ç‰¹ OAuth1.0 å’Œ OAuth2.0ï¼Œè€Œç°åœ¨OAuth1.0 æ—©å·²ç»ä¸å†ä½¿ç”¨ï¼Œ</p>
<p>å¯ä»¥æ”¾å¼ƒäº†ã€‚</p>
</li>
<li>
<p>ç°åœ¨æˆ‘ä»¬æœ‰æ›´å¤šçš„åº“å¯ä»¥é€‰æ‹©ï¼Œå¯ä»¥åœ¨è¿™äº›åº“çš„åŸºç¡€ä¸Šå»å¼€å‘ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒJWTç­‰æ–°æŠ€æœ¯ã€‚</p>
</li>
</ul>
<p>åŸºäºä»¥ä¸Šè¿™äº›åŸå› ï¼Œå®˜æ–¹å†³å®šé‡å†™ Spring Security OAuthï¼Œ ä»¥ä¾¿æ›´å¥½åœ°åè°ƒ Spring å’ŒOAuthï¼Œå¹¶ç®€åŒ–ä»£ç åº“ï¼Œä½¿Spring çš„ OAuth æ”¯æŒæ›´åŠ çµæ´»ã€‚ç„¶è€Œï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†ä¸å°‘æ³¢æŠ˜ã€‚</p>
<p>2018å¹´1æœˆ30æ—¥ï¼ŒSpring å®˜æ–¹å‘äº†ä¸€ä¸ªé€šçŸ¥ï¼Œè¡¨ç¤ºè¦é€æ¸åœæ­¢ç°æœ‰çš„ OAuth2æ”¯æŒï¼Œç„¶ååœ¨ Spring Security 5ä¸­æ„å»ºä¸‹ä¸€ä»£ OAuth2.0 æ”¯æŒã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸ºå½“æ—¶ OAuth2 çš„è½åœ°æ–¹æ¡ˆæ¯”è¾ƒæ··ä¹±ï¼Œåœ¨ Spring Security OAuthã€ Spring Cloud Securityã€Spring Boot 1.5.x ä»¥åŠå½“æ—¶æœ€æ–°çš„Spring Security 5.x ä¸­éƒ½æä¾›äº†å¯¹ OAuth2 çš„å®ç°ã€‚ä»¥è‡³äºå½“å¼€å‘è€…éœ€è¦ä½¿ç”¨ OAuth2 æ—¶ï¼Œä¸å¾—ä¸é—®ï¼Œåˆ°åº•é€‰å“ªä¸€ä¸ªä¾èµ–åˆé€‚å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥Spring å®˜æ–¹å†³å®šæœ‰å¿…è¦å°† OAuth2.0 çš„æ”¯æŒç»Ÿä¸€åˆ°ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œä»¥ä¾¿ä¸ºç”¨æˆ·æä¾›æ˜ç¡®çš„é€‰æ‹©ï¼Œå¹¶é¿å…ä»»ä½•æ½œåœ¨çš„æ··ä¹±ï¼ŒåŒæ—¶ OAuth2.0 çš„å¼€å‘æ–‡æ¡£ä¹Ÿè¦é‡æ–°ç¼–å†™ï¼Œä»¥æ–¹ä¾¿å¼€å‘äººå‘˜å­¦ä¹ ã€‚æ‰€æœ‰çš„å†³å®šå°†åœ¨ Spring Security 5 ä¸­å¼€å§‹ï¼Œæ„å»ºä¸‹ä¸€ä»£ OAuth2.0çš„æ”¯æŒã€‚ä»é‚£ä¸ªæ—¶å€™èµ·ï¼ŒSpring Security OAuth é¡¹ç›®å°±æ­£å¼å¤„äºç»´æŠ¤æ¨¡å¼ã€‚å®˜æ–¹å°†æä¾›è‡³å°‘ä¸€å¹´çš„é”™è¯†/å®‰å…¨ä¿®å¤ç¨‹åºï¼Œå¹¶ä¸”ä¼šè€ƒè™‘æ·»åŠ æ¬¡è¦åŠŸèƒ½ï¼Œä½†ä¸ä¼šæ·»åŠ ä¸»è¦åŠŸèƒ½ã€‚åŒæ—¶å°† Spring Security OAuthä¸­çš„æ‰€æœ‰åŠŸèƒ½é‡æ„åˆ° Spring Security 5.x ä¸­ã€‚</p>
<p>åˆ°äº†2019å¹´11æœˆ14æ—¥ï¼ŒSpring å®˜æ–¹åˆå‘å¸ƒä¸€ä¸ªé€šçŸ¥ï¼Œè¿™æ¬¡çš„é€šçŸ¥é¦–å…ˆè¡¨ç¤º Spring Security OAuth åœ¨è¿å¾€ Spring Security 5.x çš„è¿‡ç¨‹éå¸¸é¡ºåˆ©ï¼Œå¤§éƒ½åˆ†è¿ç¨‹å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°†åœ¨5.3 ç‰ˆæœ¬ä¸­å®Œæˆè¿ç§»ï¼Œåœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­è¿˜æ·»åŠ äº†è®¸å¤šæ–°åŠŸèƒ½ã€‚åŒ…æ‹¬å¯¹ OpenID Connect1.0 çš„æ”¯æŒã€‚åŒæ—¶è¿˜å®£å¸ƒå°†ä¸å†æ”¯æŒæˆæƒæœåŠ¡å™¨ï¼Œä¸æ”¯æŒçš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li><code>åœ¨2019å¹´ï¼Œå·²ç»æœ‰å¤§é‡çš„å•†ä¸šå’Œå¼€æºæˆæƒæœåŠ¡å™¨å¯ç”¨ã€‚</code></li>
<li><code>æˆæƒæœåŠ¡å™¨æ˜¯ä½¿ç”¨ä¸€ä¸ªåº“æ¥æ„å»ºäº§å“ï¼Œè€Œ Spring Security ä½œä¸ºæ¡†æ¶ï¼Œå¹¶ä¸é€‚åˆåšè¿™ä»¶äº‹æƒ…ã€‚</code></li>
</ol>
<p>ä¸€çŸ³æ¿€èµ·åƒå±‚æµªï¼Œè®¸å¤šå¼€å‘è€…è¡¨ç¤ºå¯¹æ­¤éš¾ä»¥æ¥å—ã€‚è¿™ä»¶äº‹ä¹Ÿåœ¨Spring ç¤¾åŒºå¼•å‘äº†æ¿€çƒˆçš„è®¨è®ºï¼Œå¥½åœ¨ Spring å®˜æ–¹æ„¿æ„å€¾å¬æ¥è‡ªç¤¾åŒºçš„å£°éŸ³ã€‚</p>
<p>åˆ°äº†2020å¹´4æœˆ15æ—¥ï¼ŒSpring å®˜æ–¹å®£å¸ƒå¯åŠ¨ Spring Authorization server é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ªç”± Spring Security å›¢é˜Ÿé¢†å¯¼çš„ç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®ï¼Œè‡´åŠ›äºå‘ Spring ç¤¾åŒºæä¾› Authorization Serveræ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒSpring åˆé‡æ–°æ”¯æŒæˆæƒæœåŠ¡å™¨äº†ã€‚</p>
<p>2020å¹´8æœˆ21æ—¥ï¼ŒSpring Authorization Server 0.0.1 æ­£å¼å‘å¸ƒï¼</p>
<p>è¿™å°±æ˜¯ OAuth2 åœ¨Spring å®¶æ—ä¸­çš„å‘å±•å†ç¨‹äº†ã€‚åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨éƒ½å°†é‡‡ç”¨æœ€æ–°çš„æ–¹å¼æ¥æ„å»ºï¼ŒæˆæƒæœåŠ¡å™¨ä¾ç„¶é‡‡ç”¨æ—§çš„æ–¹å¼æ¥æ„å»ºï¼Œå› ä¸ºç›®å‰çš„ Spring Authorization Server 0.0.1 åŠŸèƒ½è¾ƒå°‘ä¸” BUG è¾ƒå¤šã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ OAuth2 æ—¶ï¼Œéƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼ŒæˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨éƒ½æ˜¯ç”±å¤–éƒ¨æä¾›ã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³åœ¨è‡ªå·±æ­å»ºç½‘ç«™ä¸Šé›†æˆ GitHub ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œåªéœ€è¦å¼€å‘è‡ªå·±çš„å®¢æˆ·ç«¯å³å¯ï¼Œè®¤è¯æœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨éƒ½æ˜¯ç”± GitHub æä¾›çš„ã€‚</p>
<h3 id="æˆæƒã€èµ„æºæœåŠ¡å™¨">æˆæƒã€èµ„æºæœåŠ¡å™¨</h3>
<p>å‰é¢çš„ GitHub æˆæƒç™»å½•ä¸»è¦å‘å¤§å®¶å±•ç¤ºäº† OAuth2 ä¸­å®¢æˆ·ç«¯çš„å·¥ä½œæ¨¡å¼ã€‚å¯¹äºå¤§éƒ¨åˆ†çš„å¼€å‘è€…è€Œè¨€ï¼Œæ—¥å¸¸æ¥è§¦åˆ°çš„ OAuth2 éƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚æ¥å…¥ QQ ç™»å½•ã€æ¥å…¥å¾®ä¿¡ç™»å½•ç­‰ã€‚ä¸è¿‡ä¹Ÿæœ‰å°‘é‡åœºæ™¯ï¼Œå¯èƒ½éœ€è¦å¼€å‘è€…æä¾›æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹æ¼”ç¤ºå¦‚ä½•æ­å»ºæˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ã€‚</p>
<p>æ­å»ºæˆæƒæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€äº›ç°æˆçš„å¼€æºé¡¹ç›®ï¼Œç›´æ¥è¿è¡Œå³å¯ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>Keycloakï¼š RedFat å…¬å¸æä¾›çš„å¼€æºå·¥å…·ï¼Œæä¾›äº†å¾ˆå¤šå®ç”¨åŠŸèƒ½ï¼Œå€’å¦‚å•ç‚¹ç™»å½•ã€æ”¯æŒOpenIDã€å¯è§†åŒ–åå°ç®¡ç†ç­‰ã€‚</li>
<li>Apache Oltu: Apache ä¸Šçš„å¼€æºé¡¹ç›®ï¼Œæœ€è¿‘å‡ å¹´æ²¡æ€ä¹ˆç»´æŠ¤äº†ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ­å»ºä¸€ä¸ªåŒ…å«æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯åœ¨å†…çš„ OAuth2 æ¡ˆä¾‹ã€‚</p>
<p>é¡¹ç›®è§„åˆ’é¦–å…ˆæŠŠé¡¹ç›®åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>æˆæƒæœåŠ¡å™¨ï¼šé‡‡ç”¨è¾ƒæ—©çš„ spring-cloud-starter-oauth2 æ¥æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚</li>
<li>èµ„æºæœåŠ¡å™¨ï¼šé‡‡ç”¨æœ€æ–°çš„ Spring Security 5.x æ­å»ºèµ„æºæœåŠ¡å™¨ï¼Œ</li>
<li>å®¢æˆ·ç«¯: é‡‡ç”¨æœ€æ–°çš„ Spring Security5.x æ­å»ºå®¢æˆ·ç«¯ã€‚</li>
</ul>
<h4 id="æˆæƒæœåŠ¡å™¨æ­å»º">æˆæƒæœåŠ¡å™¨æ­å»º</h4>
<h5 id="1-åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨">1. åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h5>
<p>åˆ›å»º springboot åº”ç”¨,å¹¶å¼•å…¥ä¾èµ–</p>
<blockquote>
<p>æ³¨æ„: é™ä½ springboot ç‰ˆæœ¬ä¸º 2.2.5.RELEASE</p>
</blockquote>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
  &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
  &lt;version&gt;2.2.5.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>ç¼–å†™é…ç½®ç±»,æ·»åŠ  security é…ç½®ç±»ä»¥åŠ oauth é…ç½®ç±»</p>
<blockquote>
<p>Spring Security é…ç½®ç±»:</p>
</blockquote>
<pre><code>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Bean
    public PasswordEncoder passwordEncoder() &#123;
        return new BCryptPasswordEncoder();
    &#125;
    @Override
    @Bean
    protected AuthenticationManager authenticationManager() throws Exception &#123;
        return super.authenticationManager();
    &#125;
    @Bean
    public UserDetailsService userDetailsService() &#123;
        InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
        UserDetails user = User.withUsername(&quot;root&quot;).password(passwordEncoder().encode(&quot;123&quot;)).roles(&quot;ADMIN&quot;).build();
        inMemoryUserDetailsManager.createUser(user);
        return inMemoryUserDetailsManager;
    &#125;
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;
        auth.userDetailsService(userDetailsService());
    &#125;
    @Override
    protected void configure(HttpSecurity http) throws Exception &#123;
        http.csrf().disable().formLogin();
    &#125;
&#125;
</code></pre>
<blockquote>
<p>Authorization Server é…ç½®ç±»:</p>
</blockquote>
<pre><code>@Configuration
@EnableAuthorizationServer
public class AuthorizationServer extends AuthorizationServerConfigurerAdapter &#123;
  
    private final PasswordEncoder passwordEncoder;

    private final UserDetailsService userDetailsService;

    @Autowired
    public AuthorizationServer(PasswordEncoder passwordEncoder, UserDetailsService userDetailsService) &#123;
        this.passwordEncoder = passwordEncoder;
        this.userDetailsService = userDetailsService;
    &#125;

    /**
     * é…ç½®å®¢æˆ·ç«¯ç»†èŠ‚ å¦‚ å®¢æˆ·ç«¯ id ç§˜é’¥ é‡å®šå‘ url ç­‰
     *
     * @throws Exception
     */
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
        clients.inMemory().withClient(&quot;client&quot;)
                .secret(passwordEncoder.encode(&quot;secret&quot;))
                .redirectUris(&quot;http://www.baidu.com&quot;)
                .scopes(&quot;client:read,user:read&quot;)
                .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;refresh_token&quot;,&quot;implicit&quot;,&quot;password&quot;,&quot;client_credentials&quot;);
    &#125;

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
        endpoints.userDetailsService(userDetailsService);//å¼€å¯åˆ·æ–°ä»¤ç‰Œå¿…é¡»æŒ‡å®š
    &#125;
&#125;
</code></pre>
<p>å¯åŠ¨æœåŠ¡,ç™»å½•ä¹‹åè¿›è¡Œæˆæƒç è·å–</p>
<p><img src="https://img-blog.csdnimg.cn/75927c831bae42498d90a86312ed0a23.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code>http://localhost:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.baidu.com
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/6124083450bd432491402132cef23b31.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç‚¹å‡»æˆæƒè·å–æˆæƒç </p>
<p><img src="https://img-blog.csdnimg.cn/22470f48df724808b0d5c09df477c119.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>æ ¹æ®æˆæƒç ,ç”³è¯·ä»¤ç‰Œ</p>
<pre><code>curl -X POST -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -d 'grant_type=authorization_code&amp;code=IwvCtx&amp;redirect_uri=http://www.baidu.com' &quot;http://client:secret@localhost:8080/oauth/token&quot;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/39c9e6f65fac457c958c88c7edb7754a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åˆ·æ–°ä»¤ç‰Œ</p>
<pre><code>curl -X POST -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -d 'grant_type=refresh_token&amp;refresh_token=f6583d8a-598c-46bb-81d8-01fa6484cf05&amp;client_id=client' &quot;http://client:secret@localhost:8080/oauth/token&quot;
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/877fce07c30b4c22b154381375c38f95.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5 id="2-åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨">2. åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h5>
<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼ŒTokenStore çš„é»˜è®¤å®ç°ä¸º InMemoryTokenStore å³å†…å­˜å­˜å‚¨ï¼Œå¯¹äº Client ä¿¡æ¯ï¼ŒClientDetailsService æ¥å£è´Ÿè´£ä»å­˜å‚¨ä»“åº“ä¸­è¯»å–æ•°æ®ï¼Œåœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­é»˜è®¤ä½¿ç”¨çš„ä¹Ÿæ˜¯ InMemoryClientDetailsService å®ç°ç±»ã€‚</p>
<p>å¦‚æœè¦æƒ³ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼Œåªè¦æä¾›è¿™äº›æ¥å£çš„å®ç°ç±»å³å¯ï¼Œè€Œæ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬å†™å¥½ JdbcTokenStore å’Œ JdbcClientDetailsService</p>
<p>å»ºè¡¨:</p>
<pre><code>https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql
# æ³¨æ„: å¹¶ç”¨ BLOB æ›¿æ¢è¯­å¥ä¸­çš„ LONGVARBINARY ç±»å‹


SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for clientdetails
-- ----------------------------
DROP TABLE IF EXISTS `clientdetails`;
CREATE TABLE `clientdetails` (
  `appId` varchar(256) NOT NULL,
  `resourceIds` varchar(256) DEFAULT NULL,
  `appSecret` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `grantTypes` varchar(256) DEFAULT NULL,
  `redirectUrl` varchar(256) DEFAULT NULL,
  `authorities` varchar(256) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additionalInformation` varchar(4096) DEFAULT NULL,
  `autoApproveScopes` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`appId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_access_token
-- ----------------------------
DROP TABLE IF EXISTS `oauth_access_token`;
CREATE TABLE `oauth_access_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication_id` varchar(256) NOT NULL,
  `user_name` varchar(256) DEFAULT NULL,
  `client_id` varchar(256) DEFAULT NULL,
  `authentication` blob,
  `refresh_token` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_approvals
-- ----------------------------
DROP TABLE IF EXISTS `oauth_approvals`;
CREATE TABLE `oauth_approvals` (
  `userId` varchar(256) DEFAULT NULL,
  `clientId` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `status` varchar(10) DEFAULT NULL,
  `expiresAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `lastModifiedAt` date DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_client_details
-- ----------------------------
DROP TABLE IF EXISTS `oauth_client_details`;
CREATE TABLE `oauth_client_details` (
  `client_id` varchar(256) NOT NULL,
  `resource_ids` varchar(256) DEFAULT NULL,
  `client_secret` varchar(256) DEFAULT NULL,
  `scope` varchar(256) DEFAULT NULL,
  `authorized_grant_types` varchar(256) DEFAULT NULL,
  `web_server_redirect_uri` varchar(256) DEFAULT NULL,
  `authorities` varchar(256) DEFAULT NULL,
  `access_token_validity` int(11) DEFAULT NULL,
  `refresh_token_validity` int(11) DEFAULT NULL,
  `additional_information` varchar(4096) DEFAULT NULL,
  `autoapprove` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_client_token
-- ----------------------------
DROP TABLE IF EXISTS `oauth_client_token`;
CREATE TABLE `oauth_client_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication_id` varchar(256) NOT NULL,
  `user_name` varchar(256) DEFAULT NULL,
  `client_id` varchar(256) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_code
-- ----------------------------
DROP TABLE IF EXISTS `oauth_code`;
CREATE TABLE `oauth_code` (
  `code` varchar(256) DEFAULT NULL,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- Table structure for oauth_refresh_token
-- ----------------------------
DROP TABLE IF EXISTS `oauth_refresh_token`;
CREATE TABLE `oauth_refresh_token` (
  `token_id` varchar(256) DEFAULT NULL,
  `token` blob,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

SET FOREIGN_KEY_CHECKS = 1;

-- å†™å…¥å®¢æˆ·ç«¯ä¿¡æ¯
INSERT INTO `oauth_client_details` VALUES ('client', NULL, '$2a$10$QCsINtuRfP8kM112xRVdvuI58MrefLlEP2mM0kzB5KZCPhnOf4392', 'read', 'authorization_code,refresh_token', 'http://www.baidu.com', NULL, NULL, NULL, NULL, NULL);
</code></pre>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>ç¼–å†™é…ç½®æ–‡ä»¶</p>
<pre><code>spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/oauth?characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
</code></pre>
<p>ç¼–å†™æ•°æ®åº“ä¿¡æ¯å®ç°</p>
<pre><code>@Configuration
@EnableAuthorizationServer
public class JdbcAuthorizationServer extends AuthorizationServerConfigurerAdapter &#123;

    private final AuthenticationManager authenticationManager;


    private final PasswordEncoder passwordEncoder;

    private final DataSource dataSource;


    @Autowired
    public JdbcAuthorizationServer(AuthenticationManager authenticationManager, PasswordEncoder passwordEncoder, DataSource dataSource) &#123;
        this.authenticationManager = authenticationManager;
        this.passwordEncoder = passwordEncoder;
        this.dataSource = dataSource;
    &#125;

    @Bean // å£°æ˜TokenStoreå®ç°
    public TokenStore tokenStore() &#123;
        return new JdbcTokenStore(dataSource);
    &#125;

    @Bean // å£°æ˜ ClientDetailså®ç°
    public ClientDetailsService clientDetails() &#123;
        JdbcClientDetailsService jdbcClientDetailsService = new JdbcClientDetailsService(dataSource);
        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);
        return jdbcClientDetailsService;
    &#125;

    @Override //é…ç½®ä½¿ç”¨æ•°æ®åº“å®ç°
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
        endpoints.authenticationManager(authenticationManager);//è®¤è¯ç®¡ç†å™¨
        endpoints.tokenStore(tokenStore());//é…ç½®ä»¤ç‰Œå­˜å‚¨ä¸ºæ•°æ®åº“å­˜å‚¨

        // é…ç½®TokenServiceså‚æ•°
        DefaultTokenServices tokenServices = new DefaultTokenServices();//ä¿®æ”¹é»˜è®¤ä»¤ç‰Œç”ŸæˆæœåŠ¡
        tokenServices.setTokenStore(endpoints.getTokenStore());//åŸºäºæ•°æ®åº“ä»¤ç‰Œç”Ÿæˆ
        tokenServices.setSupportRefreshToken(true);//æ˜¯å¦æ”¯æŒåˆ·æ–°ä»¤ç‰Œ
        tokenServices.setReuseRefreshToken(true);//æ˜¯å¦é‡å¤ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼ˆç›´åˆ°è¿‡æœŸï¼‰

        tokenServices.setClientDetailsService(endpoints.getClientDetailsService());//è®¾ç½®å®¢æˆ·ç«¯ä¿¡æ¯
        tokenServices.setTokenEnhancer(endpoints.getTokenEnhancer());//ç”¨æ¥æ§åˆ¶ä»¤ç‰Œå­˜å‚¨å¢å¼ºç­–ç•¥
        //è®¿é—®ä»¤ç‰Œçš„é»˜è®¤æœ‰æ•ˆæœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚è¿‡æœŸçš„ä»¤ç‰Œä¸ºé›¶æˆ–è´Ÿæ•°ã€‚
        tokenServices.setAccessTokenValiditySeconds((int) TimeUnit.DAYS.toSeconds(30)); // 30å¤©
        //åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¦‚æœå°äºæˆ–ç­‰äºé›¶ï¼Œåˆ™ä»¤ç‰Œå°†ä¸ä¼šè¿‡æœŸ
        tokenServices.setRefreshTokenValiditySeconds((int) TimeUnit.DAYS.toSeconds(3)); //3å¤©
        endpoints.tokenServices(tokenServices);//ä½¿ç”¨é…ç½®ä»¤ç‰ŒæœåŠ¡
    &#125;

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
        clients.withClientDetails(clientDetails());//ä½¿ç”¨ jdbcå­˜å‚¨
    &#125;
&#125;
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,å‘ç°æ•°æ®åº“ä¸­å·²ç»å­˜å‚¨ç›¸å…³çš„ä»¤ç‰Œ</p>
<p><img src="https://img-blog.csdnimg.cn/f95214fcad2242528b33bc967d418380.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="èµ„æºæœåŠ¡å™¨æ­å»º">èµ„æºæœåŠ¡å™¨æ­å»º</h4>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code>&lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;spring-boot.version&gt;2.2.5.RELEASE&lt;/spring-boot.version&gt;
        &lt;spring-cloud.version&gt;Hoxton.SR9&lt;/spring-cloud.version&gt;

    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-oauth2-resource-server&lt;/artifactId&gt;
        &lt;/dependency&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
                &lt;version&gt;$&#123;spring-boot.version&#125;&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;
</code></pre>
<p>åˆ›å»ºèµ„æº</p>
<pre><code>@RestController
public class HelloController &#123;
    @GetMapping(&quot;/hello&quot;)
    public String hello()&#123;
        return &quot;hello!&quot;;
    &#125;
&#125;
</code></pre>
<p>ç¼–å†™èµ„æºæœåŠ¡å™¨é…ç½®ç±»</p>
<pre><code>@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;
    private final DataSource dataSource;
    @Autowired
    public ResourceServerConfig(DataSource dataSource) &#123;
        this.dataSource = dataSource;
    &#125;
    @Override
    public void configure(ResourceServerSecurityConfigurer resources) throws Exception &#123;
        resources.tokenStore(tokenStore());
    &#125;
    @Bean
    public TokenStore tokenStore() &#123;
        return new JdbcTokenStore(dataSource);
    &#125;
&#125;
</code></pre>
<p>ç¼–å†™é…ç½®æ–‡ä»¶</p>
<pre><code># åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£
server.port=8081
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=root
logging.level.org.springframework.jdbc.core=debug
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,ç”Ÿæˆä»¤ç‰Œä¹‹åå¸¦æœ‰ä»¤ç‰Œè®¿é—®:</p>
<pre><code>curl -H &quot;Authorization:Bearer dffa62d2-1078-457e-8a2b-4bd46fae0f47&quot; http://localhost:8081/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/ebce554c5c0c404b80d4af36d477b241.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3 id="ä½¿ç”¨-JWT">ä½¿ç”¨ JWT</h3>
<h4 id="æˆæƒæœåŠ¡å™¨é¢å‘-JWT-ä»¤ç‰Œ">æˆæƒæœåŠ¡å™¨é¢å‘ JWT ä»¤ç‰Œ</h4>
<p>é…ç½®é¢å‘ JWT ä»¤ç‰Œ</p>
<pre><code>@Configuration
@EnableAuthorizationServer
public class JwtAuthServerConfig extends AuthorizationServerConfigurerAdapter &#123;

    private final PasswordEncoder passwordEncoder;
    private final AuthenticationManager authenticationManager;
    private final DataSource dataSource;

    @Autowired
    public JwtAuthServerConfig(PasswordEncoder passwordEncoder, AuthenticationManager authenticationManager, DataSource dataSource) &#123;
        this.passwordEncoder = passwordEncoder;
        this.authenticationManager = authenticationManager;
        this.dataSource = dataSource;
    &#125;
    @Override //é…ç½®ä½¿ç”¨ jwt æ–¹å¼é¢å‘ä»¤ç‰Œ,åŒæ—¶é…ç½® jwt è½¬æ¢å™¨
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;
        endpoints.tokenStore(tokenStore())
                .accessTokenConverter(jwtAccessTokenConverter())
                .authenticationManager(authenticationManager);
    &#125;
    @Bean//ä½¿ç”¨JWTæ–¹å¼ç”Ÿæˆä»¤ç‰Œ
    public TokenStore tokenStore() &#123;
        return new JwtTokenStore(jwtAccessTokenConverter());
    &#125;
    @Bean//ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥æ¥ç¼–ç  JWT ä¸­çš„  OAuth2 ä»¤ç‰Œ
    public JwtAccessTokenConverter jwtAccessTokenConverter() &#123;
        JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
        converter.setSigningKey(&quot;123&quot;);//å¯ä»¥é‡‡ç”¨å±æ€§æ³¨å…¥æ–¹å¼ ç”Ÿäº§ä¸­å»ºè®®åŠ å¯†
        return converter;
    &#125;
    @Bean // å£°æ˜ ClientDetailså®ç°
    public ClientDetailsService clientDetails() &#123;
        JdbcClientDetailsService jdbcClientDetailsService = new JdbcClientDetailsService(dataSource);
        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);
        return jdbcClientDetailsService;
    &#125;
    @Override//ä½¿ç”¨æ•°æ®åº“æ–¹å¼å®¢æˆ·ç«¯å­˜å‚¨
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;
        clients.withClientDetails(clientDetails());
    &#125;
&#125;
</code></pre>
<p>å¯åŠ¨æœåŠ¡,æ ¹æ®æˆæƒç è·å–ä»¤ç‰Œ</p>
<p><img src="https://img-blog.csdnimg.cn/b83b933ee774462b9b3e3ff8c72299f7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4 id="ä½¿ç”¨-JWT-ä»¤ç‰Œèµ„æºæœåŠ¡å™¨">ä½¿ç”¨ JWT ä»¤ç‰Œèµ„æºæœåŠ¡å™¨</h4>
<p>é…ç½®èµ„æºæœåŠ¡å™¨è§£æjwt</p>
<pre><code>@Configuration
@EnableResourceServer
public class JwtResourceServerConfig extends ResourceServerConfigurerAdapter &#123;
    @Override
    public void configure(ResourceServerSecurityConfigurer resources) throws Exception &#123;
        resources.tokenStore(tokenStore());
    &#125;
    @Bean
    public TokenStore tokenStore() &#123;
        return new JwtTokenStore(jwtAccessTokenConverter());
    &#125;
    @Bean
    public JwtAccessTokenConverter jwtAccessTokenConverter() &#123;
        JwtAccessTokenConverter jwtAccessTokenConverter = new JwtAccessTokenConverter();
        jwtAccessTokenConverter.setSigningKey(&quot;123&quot;);
        return jwtAccessTokenConverter;
    &#125;
&#125;
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,é€šè¿‡ jwt ä»¤ç‰Œè®¿é—®èµ„æº</p>
<pre><code>curl -H &quot;Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjAzMzM4MjgsInVzZXJfbmFtZSI6InJvb3QiLCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIl0sImp0aSI6ImJmZGVjMzg1LWQyYmYtNDc5Yi05YjhhLTgyZWE4YTRkNzgzMyIsImNsaWVudF9pZCI6ImNsaWVudCIsInNjb3BlIjpbImFwcDpyZWFkIl19.QlELW7LMLuD4OghbEFFzJpIxjW80hC3WHd3I0PiuI7Y&quot; http://localhost:8081/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/eb993c7eb6b140dca2a889882c474b20.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/cn/17.BeanPostProcessor/" data-toggle="tooltip" data-placement="top" title="æµ…è°ˆBeanPostProcessoråŠ è½½æ¬¡åºåŠå…¶å¯¹Beané€ æˆçš„å½±å“åˆ†æ">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/cn/16.flutter-resize-widget/" data-toggle="tooltip" data-placement="top" title="Flutter resize widget">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      å¦‚æœæ‚¨å–œæ¬¢æ­¤åšå®¢æˆ–å‘ç°å®ƒå¯¹æ‚¨æœ‰ç”¨ï¼Œåˆ™æ¬¢è¿å¯¹æ­¤å‘è¡¨è¯„è®ºã€‚ ä¹Ÿæ¬¢è¿æ‚¨å…±äº«æ­¤åšå®¢ï¼Œä»¥ä¾¿æ›´å¤šäººå¯ä»¥å‚ä¸ã€‚ å¦‚æœåšå®¢ä¸­ä½¿ç”¨çš„å›¾åƒä¾µçŠ¯äº†æ‚¨çš„ç‰ˆæƒï¼Œè¯·ä¸ä½œè€…è”ç³»ä»¥å°†å…¶åˆ é™¤ã€‚ è°¢è°¢ ï¼
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=SpringSecurity æ€»ç»“&body=Hi,I found this website and thought you might like it https://onote.doopp.com/cn/18.spring-security/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">ç›®å½•</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">ç¬¬ä¸€ç«  æƒé™ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%EF%BC%9A"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">æƒé™ç®¡ç†ï¼š</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%A4%E8%AF%81%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">è®¤è¯ç®¡ç†æµç¨‹</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">æƒé™ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">è®¤è¯</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-nav-number">1.2.2.</span> <span class="toc-nav-text">æˆæƒ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-nav-number">1.2.3.</span> <span class="toc-nav-text">è§£å†³æ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">ç®€ä»‹</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%98%E6%96%B9%E5%AE%9A%E4%B9%89"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">å®˜æ–¹å®šä¹‰</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8E%86%E5%8F%B2"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">å†å²</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">æ•´ä½“æ¶æ„</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%AE%A4%E8%AF%81-2"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">è®¤è¯</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#AuthenticationManager"><span class="toc-nav-number">1.4.1.1.</span> <span class="toc-nav-text">AuthenticationManager</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Authentication"><span class="toc-nav-number">1.4.1.2.</span> <span class="toc-nav-text">Authentication</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#SecurityContextHolder"><span class="toc-nav-number">1.4.1.3.</span> <span class="toc-nav-text">SecurityContextHolder</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83-2"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">æˆæƒ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#AccessDecisionManager"><span class="toc-nav-number">1.4.2.1.</span> <span class="toc-nav-text">AccessDecisionManager</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#AccessDecisionVoter"><span class="toc-nav-number">1.4.2.2.</span> <span class="toc-nav-text">AccessDecisionVoter</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#ConfigAttribute"><span class="toc-nav-number">1.4.2.3.</span> <span class="toc-nav-text">ConfigAttribute</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">ç¬¬äºŒç«  ç¯å¢ƒæ­å»º</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">ç¯å¢ƒæ­å»º</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-nav-number">2.1.1.</span> <span class="toc-nav-text">åˆ›å»ºé¡¹ç›®</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%95%B4%E5%90%88-Spring-Security"><span class="toc-nav-number">2.1.2.</span> <span class="toc-nav-text">æ•´åˆ Spring Security</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-number">2.1.3.</span> <span class="toc-nav-text">å®ç°åŸç†</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Security-Filters"><span class="toc-nav-number">2.1.4.</span> <span class="toc-nav-text">Security Filters</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SpringBootWebSecurityConfiguration"><span class="toc-nav-number">2.1.5.</span> <span class="toc-nav-text">SpringBootWebSecurityConfiguration</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-nav-number">2.1.6.</span> <span class="toc-nav-text">æµç¨‹åˆ†æ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7%E7%94%9F%E6%88%90"><span class="toc-nav-number">2.1.7.</span> <span class="toc-nav-text">é»˜è®¤ç”¨æˆ·ç”Ÿæˆ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#UserDetailService"><span class="toc-nav-number">2.1.8.</span> <span class="toc-nav-text">UserDetailService</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#UserDetailServiceAutoConfigutation"><span class="toc-nav-number">2.1.9.</span> <span class="toc-nav-text">UserDetailServiceAutoConfigutation</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-nav-number">2.1.10.</span> <span class="toc-nav-text">æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-%E8%AE%A4%E8%AF%81%E5%8E%9F%E7%90%86-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">ç¬¬ä¸‰ç«  è®¤è¯åŸç†&amp;è‡ªå®šä¹‰è®¤è¯</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">è‡ªå®šä¹‰è®¤è¯</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90%E6%9D%83%E9%99%90%E8%A7%84%E5%88%99"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2"><span class="toc-nav-number">3.1.2.</span> <span class="toc-nav-text">è‡ªå®šä¹‰ç™»å½•ç•Œé¢</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E6%88%90%E5%8A%9F%E5%A4%84%E7%90%86"><span class="toc-nav-number">3.1.3.</span> <span class="toc-nav-text">è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E4%BF%A1%E6%81%AF"><span class="toc-nav-number">3.1.4.</span> <span class="toc-nav-text">æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-nav-number">3.1.5.</span> <span class="toc-nav-text">è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B3%A8%E9%94%80%E7%99%BB%E5%BD%95"><span class="toc-nav-number">3.1.6.</span> <span class="toc-nav-text">æ³¨é”€ç™»å½•</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"><span class="toc-nav-number">3.1.7.</span> <span class="toc-nav-text">ç™»å½•ç”¨æˆ·æ•°æ®è·å–</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#SecurityContextHolder-2"><span class="toc-nav-number">3.1.7.1.</span> <span class="toc-nav-text">SecurityContextHolder</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#SecurityContextHolderStrategy"><span class="toc-nav-number">3.1.7.2.</span> <span class="toc-nav-text">SecurityContextHolderStrategy</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E4%BB%A3%E7%A0%81%E4%B8%AD%E8%8E%B7%E5%8F%96%E8%AE%A4%E8%AF%81%E4%B9%8B%E5%90%8E%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">3.1.7.3.</span> <span class="toc-nav-text">ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%83%85%E5%86%B5%E4%B8%8B%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE"><span class="toc-nav-number">3.1.7.4.</span> <span class="toc-nav-text">å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%A1%B5%E9%9D%A2%E4%B8%8A%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-nav-number">3.1.7.5.</span> <span class="toc-nav-text">é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-nav-number">3.1.8.</span> <span class="toc-nav-text">è‡ªå®šä¹‰è®¤è¯æ•°æ®æº</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-nav-number">3.1.8.1.</span> <span class="toc-nav-text">è®¤è¯æµç¨‹åˆ†æ</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB"><span class="toc-nav-number">3.1.8.2.</span> <span class="toc-nav-text">ä¸‰è€…å…³ç³»</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80-AuthenticationManager"><span class="toc-nav-number">3.1.8.3.</span> <span class="toc-nav-text">é…ç½®å…¨å±€ AuthenticationManager</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-nav-number">3.1.8.4.</span> <span class="toc-nav-text">è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-nav-number">3.1.8.5.</span> <span class="toc-nav-text">è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%A4%E8%AF%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-nav-number">3.1.9.</span> <span class="toc-nav-text">æ·»åŠ è®¤è¯éªŒè¯ç </span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-nav-number">3.1.9.1.</span> <span class="toc-nav-text">é…ç½®éªŒè¯ç </span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E4%BC%A0%E7%BB%9F-web-%E5%BC%80%E5%8F%91"><span class="toc-nav-number">3.1.9.2.</span> <span class="toc-nav-text">ä¼ ç»Ÿ web å¼€å‘</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91"><span class="toc-nav-number">3.1.9.3.</span> <span class="toc-nav-text">å‰åç«¯åˆ†ç¦»å¼€å‘</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">ç¬¬å››ç«  å¯†ç åŠ å¯†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8A%A0%E5%AF%86%E6%84%8F%E4%B9%89"><span class="toc-nav-number">4.1.1.</span> <span class="toc-nav-text">åŠ å¯†æ„ä¹‰</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%B8%B8%E8%A7%81%E6%96%B9%E6%A1%88"><span class="toc-nav-number">4.1.2.</span> <span class="toc-nav-text">å¸¸è§æ–¹æ¡ˆ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Hash-%E7%AE%97%E6%B3%95"><span class="toc-nav-number">4.1.2.1.</span> <span class="toc-nav-text">Hash ç®—æ³•</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%8D%95%E5%90%91%E8%87%AA%E9%80%82%E5%BA%94%E5%87%BD%E6%95%B0"><span class="toc-nav-number">4.1.2.2.</span> <span class="toc-nav-text">å•å‘è‡ªé€‚åº”å‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#PasswordEncoder"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">PasswordEncoder</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#DelegatingPasswordEncoder"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">DelegatingPasswordEncoder</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#DelegatingPasswordEncoder%E6%BA%90%E7%A0%81"><span class="toc-nav-number">4.3.0.1.</span> <span class="toc-nav-text">DelegatingPasswordEncoderæºç </span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#PasswordEncoderFactories%E6%BA%90%E7%A0%81"><span class="toc-nav-number">4.3.0.2.</span> <span class="toc-nav-text">PasswordEncoderFactoriesæºç </span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-PasswordEncoder"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">å¦‚ä½•ä½¿ç”¨ PasswordEncoder</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E5%AE%9E%E6%88%98"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">å¯†ç åŠ å¯†å®æˆ˜</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AF%86%E7%A0%81%E8%87%AA%E5%8A%A8%E5%8D%87%E7%BA%A7"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">å¯†ç è‡ªåŠ¨å‡çº§</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-RememberMe"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">ç¬¬äº”ç«  RememberMe</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%80%E5%90%AF%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.2.1.</span> <span class="toc-nav-text">å¼€å¯è®°ä½æˆ‘</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.2.2.</span> <span class="toc-nav-text">ä½¿ç”¨è®°ä½æˆ‘</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.2.3.</span> <span class="toc-nav-text">æµ‹è¯•è®°ä½æˆ‘</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">åŸç†åˆ†æ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#RememberMeAuthenticationFilter"><span class="toc-nav-number">5.3.1.</span> <span class="toc-nav-text">RememberMeAuthenticationFilter</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#RememberMeServices"><span class="toc-nav-number">5.3.2.</span> <span class="toc-nav-text">RememberMeServices</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#TokenBasedRememberMeServices"><span class="toc-nav-number">5.3.3.</span> <span class="toc-nav-text">TokenBasedRememberMeServices</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-nav-number">5.3.4.</span> <span class="toc-nav-text">æ€»ç»“</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%86%85%E5%AD%98%E4%BB%A4%E7%89%8C"><span class="toc-nav-number">5.4.</span> <span class="toc-nav-text">å†…å­˜ä»¤ç‰Œ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#PersistentTokenBasedRememberMeServices"><span class="toc-nav-number">5.4.1.</span> <span class="toc-nav-text">PersistentTokenBasedRememberMeServices</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98%E4%B8%AD%E4%BB%A4%E7%89%8C%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">5.4.2.</span> <span class="toc-nav-text">ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E4%BB%A4%E7%89%8C"><span class="toc-nav-number">5.5.</span> <span class="toc-nav-text">æŒä¹…åŒ–ä»¤ç‰Œ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-nav-number">5.5.1.</span> <span class="toc-nav-text">å¼•å…¥ä¾èµ–</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-nav-number">5.5.2.</span> <span class="toc-nav-text">é…ç½®æ•°æ®æº</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E6%8C%81%E4%B9%85%E5%8C%96%E4%BB%A4%E7%89%8C"><span class="toc-nav-number">5.5.3.</span> <span class="toc-nav-text">é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E5%B9%B6%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-nav-number">5.5.4.</span> <span class="toc-nav-text">å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%86%8D%E6%AC%A1%E6%B5%8B%E8%AF%95%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.5.5.</span> <span class="toc-nav-text">å†æ¬¡æµ‹è¯•è®°ä½æˆ‘</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.6.</span> <span class="toc-nav-text">è‡ªå®šä¹‰è®°ä½æˆ‘</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9F%A5%E7%9C%8B%E8%AE%B0%E4%BD%8F%E6%88%91%E6%BA%90%E7%A0%81"><span class="toc-nav-number">5.6.1.</span> <span class="toc-nav-text">æŸ¥çœ‹è®°ä½æˆ‘æºç </span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BC%A0%E7%BB%9F-web-%E5%BC%80%E5%8F%91%E8%AE%B0%E4%BD%8F%E6%88%91%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">5.6.2.</span> <span class="toc-nav-text">ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E8%AE%B0%E4%BD%8F%E6%88%91%E5%AE%9E%E7%8E%B0"><span class="toc-nav-number">5.6.3.</span> <span class="toc-nav-text">å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%A4%E8%AF%81%E7%B1%BB-LoginFilter"><span class="toc-nav-number">5.6.3.1.</span> <span class="toc-nav-text">è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-RememberMeService"><span class="toc-nav-number">5.6.3.2.</span> <span class="toc-nav-text">è‡ªå®šä¹‰ RememberMeService</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%B0%E4%BD%8F%E6%88%91"><span class="toc-nav-number">5.6.3.3.</span> <span class="toc-nav-text">é…ç½®è®°ä½æˆ‘</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E5%85%AD%E7%AB%A0-%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">ç¬¬å…­ç«  ä¼šè¯ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%9A%E8%AF%9D%E5%B9%B6%E5%8F%91%E7%AE%A1%E7%90%86"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">ä¼šè¯å¹¶å‘ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="toc-nav-number">6.2.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%80%E5%90%AF%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-nav-number">6.2.2.</span> <span class="toc-nav-text">å¼€å¯ä¼šè¯ç®¡ç†</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86"><span class="toc-nav-number">6.2.3.</span> <span class="toc-nav-text">æµ‹è¯•ä¼šè¯ç®¡ç†</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%9A%E8%AF%9D%E5%A4%B1%E6%95%88%E5%A4%84%E7%90%86"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">ä¼šè¯å¤±æ•ˆå¤„ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BC%A0%E7%BB%9F-web-%E5%BC%80%E5%8F%91%E5%A4%84%E7%90%86"><span class="toc-nav-number">6.3.1.</span> <span class="toc-nav-text">ä¼ ç»Ÿ web å¼€å‘å¤„ç†</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E5%BC%80%E5%8F%91%E5%A4%84%E7%90%86"><span class="toc-nav-number">6.3.2.</span> <span class="toc-nav-text">å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%A6%81%E6%AD%A2%E5%86%8D%E6%AC%A1%E7%99%BB%E5%BD%95"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">ç¦æ­¢å†æ¬¡ç™»å½•</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BC%9A%E8%AF%9D%E5%85%B1%E4%BA%AB"><span class="toc-nav-number">6.5.</span> <span class="toc-nav-text">ä¼šè¯å…±äº«</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-nav-number">6.5.1.</span> <span class="toc-nav-text">å®æˆ˜</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="toc-nav-number">6.5.1.0.1.</span> <span class="toc-nav-text">å¼•å…¥ä¾èµ–</span></a></li><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">6.5.1.0.2.</span> <span class="toc-nav-text">ç¼–å†™é…ç½®</span></a></li><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E9%85%8D%E7%BD%AESecurity"><span class="toc-nav-number">6.5.1.0.3.</span> <span class="toc-nav-text">é…ç½®Security</span></a></li><li class="toc-nav-item toc-nav-level-6"><a class="toc-nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-nav-number">6.5.1.0.4.</span> <span class="toc-nav-text">æµ‹è¯•</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%B8%83%E7%AB%A0-CSRF-%E6%BC%8F%E6%B4%9E%E4%BF%9D%E6%8A%A4"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">ç¬¬ä¸ƒç«  CSRF æ¼æ´ä¿æŠ¤</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-6"><span class="toc-nav-number">7.0.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CSRF%E6%94%BB%E5%87%BB%E6%BC%94%E7%A4%BA"><span class="toc-nav-number">7.0.2.</span> <span class="toc-nav-text">CSRFæ”»å‡»æ¼”ç¤º</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA%E9%93%B6%E8%A1%8C%E5%BA%94%E7%94%A8"><span class="toc-nav-number">7.0.2.1.</span> <span class="toc-nav-text">åˆ›å»ºé“¶è¡Œåº”ç”¨</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA%E6%81%B6%E6%84%8F%E5%BA%94%E7%94%A8"><span class="toc-nav-number">7.0.2.2.</span> <span class="toc-nav-text">åˆ›å»ºæ¶æ„åº”ç”¨</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CSRF-%E9%98%B2%E5%BE%A1"><span class="toc-nav-number">7.0.3.</span> <span class="toc-nav-text">CSRF é˜²å¾¡</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E4%BB%A4%E7%89%8C%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">7.0.3.1.</span> <span class="toc-nav-text">ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%BC%80%E5%90%AF-CSRF-%E9%98%B2%E5%BE%A1"><span class="toc-nav-number">7.0.3.2.</span> <span class="toc-nav-text">å¼€å¯ CSRF é˜²å¾¡</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%9F%A5%E7%9C%8B%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E6%BA%90%E7%A0%81"><span class="toc-nav-number">7.0.3.3.</span> <span class="toc-nav-text">æŸ¥çœ‹ç™»å½•é¡µé¢æºç </span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BC%A0%E7%BB%9Fweb%E5%BC%80%E5%8F%91%E4%BD%BF%E7%94%A8CSRF"><span class="toc-nav-number">7.0.4.</span> <span class="toc-nav-text">ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95-controller"><span class="toc-nav-number">7.0.4.1.</span> <span class="toc-nav-text">å¼€å‘æµ‹è¯• controller</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA-html"><span class="toc-nav-number">7.0.4.2.</span> <span class="toc-nav-text">åˆ›å»º html</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%B5%8B%E8%AF%95%E6%9F%A5%E7%9C%8Bindex-html%E6%BA%90%E7%A0%81"><span class="toc-nav-number">7.0.4.3.</span> <span class="toc-nav-text">æµ‹è¯•æŸ¥çœ‹index.htmlæºç </span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E4%BD%BF%E7%94%A8-CSRF"><span class="toc-nav-number">7.0.5.</span> <span class="toc-nav-text">å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E4%BF%AE%E6%94%B9-CSRF-%E5%AD%98%E5%85%A5-Cookie"><span class="toc-nav-number">7.0.5.1.</span> <span class="toc-nav-text">ä¿®æ”¹ CSRF å­˜å…¥ Cookie</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%AE%BF%E9%97%AE%E7%99%BB%E5%BD%95%E7%95%8C%E9%9D%A2%E6%9F%A5%E7%9C%8B-cookie"><span class="toc-nav-number">7.0.5.2.</span> <span class="toc-nav-text">è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%E6%90%BA%E5%B8%A6%E4%BB%A4%E7%89%8C%E5%8D%B3%E5%8F%AF"><span class="toc-nav-number">7.0.5.3.</span> <span class="toc-nav-text">å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-%E8%B7%A8%E5%9F%9F"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">ç¬¬å…«ç«  è·¨åŸŸ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E7%AE%80%E4%BB%8B-7"><span class="toc-nav-number">8.1.</span> <span class="toc-nav-text">ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-CORS"><span class="toc-nav-number">8.2.</span> <span class="toc-nav-text">ä»€ä¹ˆæ˜¯ CORS</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="toc-nav-number">8.2.1.</span> <span class="toc-nav-text">ç®€å•è¯·æ±‚</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82"><span class="toc-nav-number">8.2.2.</span> <span class="toc-nav-text">éç®€å•è¯·æ±‚</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Spring-%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-nav-number">8.3.</span> <span class="toc-nav-text">Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CrossOrigin"><span class="toc-nav-number">8.3.1.</span> <span class="toc-nav-text">@CrossOrigin</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#addCrosMapping"><span class="toc-nav-number">8.3.2.</span> <span class="toc-nav-text">addCrosMapping</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CrosFilter"><span class="toc-nav-number">8.3.3.</span> <span class="toc-nav-text">CrosFilter</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Spring-Security-%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-nav-number">8.4.</span> <span class="toc-nav-text">Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-2"><span class="toc-nav-number">8.4.1.</span> <span class="toc-nav-text">åŸç†åˆ†æ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="toc-nav-number">8.4.2.</span> <span class="toc-nav-text">è§£å†³æ–¹æ¡ˆ</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">ç¬¬ä¹ç«  å¼‚å¸¸å¤„ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BC%82%E5%B8%B8%E4%BD%93%E7%B3%BB"><span class="toc-nav-number">9.0.1.</span> <span class="toc-nav-text">å¼‚å¸¸ä½“ç³»</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-nav-number">9.0.2.</span> <span class="toc-nav-text">è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-%E6%8E%88%E6%9D%83"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">ç¬¬åç«  æˆæƒ</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-2"><span class="toc-nav-number">10.0.1.</span> <span class="toc-nav-text">æƒé™ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E8%AE%A4%E8%AF%81-3"><span class="toc-nav-number">10.0.1.1.</span> <span class="toc-nav-text">è®¤è¯</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83-3"><span class="toc-nav-number">10.0.1.2.</span> <span class="toc-nav-text">æˆæƒ</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-nav-number">10.0.2.</span> <span class="toc-nav-text">æˆæƒæ ¸å¿ƒæ¦‚å¿µ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%AD%96%E7%95%A5"><span class="toc-nav-number">10.0.3.</span> <span class="toc-nav-text">æƒé™ç®¡ç†ç­–ç•¥</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8E-URL-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-nav-number">10.0.4.</span> <span class="toc-nav-text">åŸºäº URL æƒé™ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E6%9D%83%E9%99%90%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-nav-number">10.0.4.1.</span> <span class="toc-nav-text">æƒé™è¡¨è¾¾å¼</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#antMatchers%EF%BC%8CmvcMatchers%EF%BC%8CregexMatchers-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A"><span class="toc-nav-number">10.0.4.2.</span> <span class="toc-nav-text">antMatchersï¼ŒmvcMatchersï¼ŒregexMatchers çš„åŒºåˆ«ï¼š</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8E-%E6%96%B9%E6%B3%95-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-nav-number">10.0.5.</span> <span class="toc-nav-text">åŸºäº æ–¹æ³• æƒé™ç®¡ç†</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#EnableGlobalMethodSecurity"><span class="toc-nav-number">10.0.5.1.</span> <span class="toc-nav-text">@EnableGlobalMethodSecurity</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number"></span> <span class="toc-nav-text">ä»¥ä¸Šæ³¨è§£å«ä¹‰å¦‚ä¸‹:</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-nav-number">0.0.0.1.</span> <span class="toc-nav-text">åŸºæœ¬ç”¨æ³•</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-3"><span class="toc-nav-number">0.1.</span> <span class="toc-nav-text">åŸç†åˆ†æ</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%AE%9E%E6%88%98-2"><span class="toc-nav-number">0.2.</span> <span class="toc-nav-text">å®æˆ˜</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%BA%93%E8%A1%A8%E8%AE%BE%E8%AE%A1"><span class="toc-nav-number">0.2.1.</span> <span class="toc-nav-text">åº“è¡¨è®¾è®¡</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA-springboot-%E5%BA%94%E7%94%A8"><span class="toc-nav-number">0.2.2.</span> <span class="toc-nav-text">åˆ›å»º springboot åº”ç”¨</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-OAuth2"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">ç¬¬åä¸€ç«  OAuth2</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OAuth2-%E7%AE%80%E4%BB%8B"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">OAuth2 ç®€ä»‹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OAuth2-%E6%8E%88%E6%9D%83%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">OAuth2 æˆæƒæ€»ä½“æµç¨‹</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">å››ç§æˆæƒæ¨¡å¼</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">1.3.1.</span> <span class="toc-nav-text">æˆæƒç æ¨¡å¼</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E7%AE%80%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">1.3.2.</span> <span class="toc-nav-text">ç®€åŒ–æ¨¡å¼</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">1.3.3.</span> <span class="toc-nav-text">å¯†ç æ¨¡å¼</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="toc-nav-number">1.3.4.</span> <span class="toc-nav-text">å®¢æˆ·ç«¯æ¨¡å¼</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#OAuth2-%E6%A0%87%E5%87%86%E6%8E%A5%E5%8F%A3"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">OAuth2 æ ‡å‡†æ¥å£</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#GitHub-%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">GitHub æˆæƒç™»å½•</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E5%88%9B%E5%BB%BA-OAuth-%E5%BA%94%E7%94%A8"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">åˆ›å»º OAuth åº”ç”¨</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">é¡¹ç›®å¼€å‘</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number"></span> <span class="toc-nav-text">ä¸€å®šè¦ä¸é‡å®šå‘å›è°ƒ URL ä¸€è‡´</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Spring-Security-OAuth2"><span class="toc-nav-number">0.1.</span> <span class="toc-nav-text">Spring Security OAuth2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83%E3%80%81%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-nav-number">0.2.</span> <span class="toc-nav-text">æˆæƒã€èµ„æºæœåŠ¡å™¨</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA"><span class="toc-nav-number">0.2.1.</span> <span class="toc-nav-text">æˆæƒæœåŠ¡å™¨æ­å»º</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#1-%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E4%BB%A4%E7%89%8C%E5%AD%98%E5%82%A8"><span class="toc-nav-number">0.2.1.1.</span> <span class="toc-nav-text">1. åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#2-%E5%9F%BA%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E4%BB%A4%E7%89%8C%E5%AD%98%E5%82%A8"><span class="toc-nav-number">0.2.1.2.</span> <span class="toc-nav-text">2. åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA"><span class="toc-nav-number">0.2.2.</span> <span class="toc-nav-text">èµ„æºæœåŠ¡å™¨æ­å»º</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8-JWT"><span class="toc-nav-number">0.3.</span> <span class="toc-nav-text">ä½¿ç”¨ JWT</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E6%8E%88%E6%9D%83%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%A2%81%E5%8F%91-JWT-%E4%BB%A4%E7%89%8C"><span class="toc-nav-number">0.3.1.</span> <span class="toc-nav-text">æˆæƒæœåŠ¡å™¨é¢å‘ JWT ä»¤ç‰Œ</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E4%BD%BF%E7%94%A8-JWT-%E4%BB%A4%E7%89%8C%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-nav-number">0.3.2.</span> <span class="toc-nav-text">ä½¿ç”¨ JWT ä»¤ç‰Œèµ„æºæœåŠ¡å™¨</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">ç‰¹è‰²æ ‡ç­¾</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#flutter" title="flutter">flutter</a>
            
            <a class="tag" href="/tags/#app" title="app">app</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'â„¬'
      icon: 'â¡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColorã€viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/koocyton">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          koocyton
          2024
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  
    <!-- Busuanzi JavaScript -->
    <script async="async" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("https://onote.doopp.com/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="æœç´¢..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
