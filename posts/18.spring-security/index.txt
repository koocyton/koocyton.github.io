1:"$Sreact.fragment"
2:I[22016,["/_next/static/chunks/7c92e96509cd355e.js","/_next/static/chunks/9027c2a9ef8f11ae.js"],""]
3:I[39756,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"default"]
4:I[37457,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"default"]
8:I[68027,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"default"]
:HL["/_next/static/chunks/9988c12a819fa1cb.css","style"]
0:{"P":null,"b":"9R-7WF0D3oDc9L_xEx1aT","c":["","posts","18.spring-security",""],"q":"","i":false,"f":[[["",{"children":["posts",{"children":[["slug","18.spring-security","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],[["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/chunks/9988c12a819fa1cb.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","script","script-0",{"src":"/_next/static/chunks/7c92e96509cd355e.js","async":true,"nonce":"$undefined"}]],["$","html",null,{"lang":"zh-CN","children":["$","body",null,{"className":"min-h-screen flex flex-col antialiased","children":[["$","header",null,{"className":"border-b border-[var(--color-border)]","children":["$","div",null,{"className":"max-w-2xl mx-auto px-5 h-12 flex items-center justify-between","children":[["$","$L2",null,{"href":"/","className":"font-mono text-sm font-semibold text-[var(--color-text)] hover:text-[var(--color-link)] transition-colors","children":"ä¸€æ´¼ç»¿åœ°"}],["$","nav",null,{"className":"flex items-center gap-5","children":[[["$","$L2","/",{"href":"/","className":"text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text)] transition-colors","children":"æ–‡ç« "}],["$","$L2","/archives",{"href":"/archives","className":"text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text)] transition-colors","children":"å½’æ¡£"}],["$","$L2","/tags",{"href":"/tags","className":"text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text)] transition-colors","children":"æ ‡ç­¾"}],["$","$L2","/about",{"href":"/about","className":"text-sm text-[var(--color-text-secondary)] hover:text-[var(--color-text)] transition-colors","children":"å…³äº"}]],["$","a",null,{"href":"https://github.com/koocyton","target":"_blank","rel":"noopener noreferrer","className":"text-[var(--color-text-tertiary)] hover:text-[var(--color-text)] transition-colors","children":["$","svg",null,{"className":"w-4 h-4","fill":"currentColor","viewBox":"0 0 24 24","children":["$","path",null,{"d":"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"}]}]}]]}]]}]}],["$","main",null,{"className":"flex-1","children":["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","div",null,{"className":"max-w-2xl mx-auto px-5 py-20 text-center","children":[["$","h1",null,{"className":"font-mono text-4xl font-semibold text-[var(--color-text)] mb-2","children":"404"}],["$","p",null,{"className":"text-sm text-[var(--color-text-tertiary)] mb-6","children":"é¡µé¢ä¸å­˜åœ¨"}],["$","$L2",null,{"href":"/","className":"text-sm text-[var(--color-link)] hover:underline","children":"â† è¿”å›é¦–é¡µ"}]]}],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],["$","footer",null,{"className":"border-t border-[var(--color-border)] py-6","children":["$","div",null,{"className":"max-w-2xl mx-auto px-5 text-xs text-[var(--color-text-tertiary)]","children":["Â© ",2026," koocyton"]}]}]]}]}]]}],{"children":[["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["$","$1","c",{"children":["$L5",[["$","script","script-0",{"src":"/_next/static/chunks/9027c2a9ef8f11ae.js","async":true,"nonce":"$undefined"}]],"$L6"]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],"$L7",false]],"m":"$undefined","G":["$8",[]],"S":true}
9:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"OutletBoundary"]
a:"$Sreact.suspense"
c:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"ViewportBoundary"]
e:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"MetadataBoundary"]
6:["$","$L9",null,{"children":["$","$a",null,{"name":"Next.MetadataOutlet","children":"$@b"}]}]
7:["$","$1","h",{"children":[null,["$","$Lc",null,{"children":"$Ld"}],["$","div",null,{"hidden":true,"children":["$","$Le",null,{"children":["$","$a",null,{"name":"Next.Metadata","children":"$Lf"}]}]}],null]}]
10:T5c208,<h2>ç¬¬ä¸€ç«  æƒé™ç®¡ç†</h2>
<ul>
<li>æƒé™ç®¡ç†</li>
<li>SpringSecurity ç®€ä»‹</li>
<li>æ•´ä½“æ¶æ„</li>
</ul>
<h3>æƒé™ç®¡ç†ï¼š</h3>
<pre><code class="hljs language-arduino">å®ç°: <span class="hljs-string">"å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶"</span>(èº«ä»½è®¤è¯) ï¼Œ æŒ‰ç…§ <span class="hljs-string">"å®‰å…¨è§„åˆ™"</span>æˆ–è€… <span class="hljs-string">"å®‰å…¨ç­–ç•¥"</span> (å¯¹å·²ç»è®¤è¯çš„ç”¨æˆ·è¿›è¡Œæˆæƒ)  æ§åˆ¶ï¼Œç”¨æˆ·å¯ä»¥è®¿é—®ï¼Œè€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚

æƒé™ç®¡ç†åŒ…æ‹¬ç”¨<span class="hljs-string">"æˆ·èº«ä»½è®¤è¯"</span>å’Œ<span class="hljs-string">"æˆæƒ"</span>ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°<span class="hljs-string">"è®¤è¯æˆæƒ"</span>ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºï¼Œé¦–å…ˆè¦å¯¹ç”¨æˆ·è¿›è¡Œä¸€ä¸ªèº«ä»½çš„è®¤è¯ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„æƒé™ã€‚æ‰èƒ½è¿›è¡Œè®¿é—®ã€‚

è®¤è¯: å°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚
æˆæƒ: åŠè®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°ï¼Ÿèƒ½è®¿é—®å“ªäº›èµ„æºï¼Ÿ

 
</code></pre>
<p>æ•´ä½“æ¶æ„:</p>
<pre><code class="hljs language-scss">åœ¨SpringSecurityä¸­è®¤è¯(Authentication)å’Œæˆæƒ(Authorization)æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼éƒ½ä¸ä¼šå½±å“æˆæƒã€‚
</code></pre>
<p><img src="/posts/18.spring-security/001.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>è®¤è¯ç®¡ç†æµç¨‹</h4>
<pre><code class="hljs language-arduino">AuthenticationMagger æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªAuthenticateæ–¹æ³•è¿›è¡Œè®¤è¯è€Œè¿™ä¸ªæ¥å£çš„ä¸»è¦å®ç°ç±»ä¸º: <span class="hljs-string">"ProvideManager"</span>,è€Œåœ¨ProvideManagerå½“ä¸­ç®¡ç†äº†å¤šï¼š<span class="hljs-string">"Authenticationprovider"</span> å®ä¾‹ï¼Œä¸€ä¸ªè¿™æ ·çš„å®åŠ›å°±æ˜¯ä¸€å¥—å®Œæ•´çš„è®¤è¯æµç¨‹ã€‚

<span class="hljs-number">1.</span>AuthenticationMaggerä¸»è¦ç”¨æ¥åšè®¤è¯ï¼Œè®¤è¯æˆåŠŸä¹‹åä¼šå°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ° <span class="hljs-string">"Authentication"</span> ä¸­ï¼Œ <span class="hljs-string">"Authentication"</span> ä¸­ä¼šä¿å­˜å½“å‰çº¿ç¨‹:<span class="hljs-string">"Threadlocal"</span> çš„å˜é‡
<span class="hljs-string">"SecurityContextHolder"</span> ä¸­ï¼Œåœ¨å®é™…ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚ç»“æŸåï¼Œè¿™ä¸ªSecurityContextHolderä¼šéšç€å½“å‰çš„è¯·æ±‚è€Œæ¸…ç©ºã€‚ç­‰ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šæŠŠç­›é€‰ä¸­çš„è®¤è¯ä¿¡æ¯æ”¾åˆ°ï¼š<span class="hljs-string">"SecurityContextHolder"</span> ä¸­å½“æˆ‘ä»¬åœ¨<span class="hljs-string">"controller"</span>, <span class="hljs-string">"service"</span>å±‚ä¸­è¦è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨<span class="hljs-string">"SecurityContextHolder"</span>ä¸­è·å–ã€‚

<span class="hljs-number">2.</span>å…¶å®çœŸæ­£ä¿å­˜ç”¨æˆ·ä¿¡æ¯è¿˜æ˜¯: <span class="hljs-string">"Authentication"</span>è¿™ä¸ªç±»(å®ƒçš„å®ç°ç±»)æ¥ä¿å­˜çš„ã€‚æ¯”å¦‚å‰ç«¯å‘èµ·äº†ä¸€ä¸ªè®¤è¯ï¼Œè®¤è¯æˆåŠŸä¹‹åä¼šæŠŠç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åˆ°<span class="hljs-string">"Authentication"</span>ä¸­ï¼Œåœ¨JAVA Webç¯å¢ƒå½“ä¸­ï¼Œ<span class="hljs-string">"Authentication"</span>å¯¹è±¡è¦æ°¸ä¹…ä¿å­˜ä¸‹æ¥,è€Œåœ¨ä»¥å¾€å½“ä¸­ä¼šæŠŠ<span class="hljs-string">"Authentication"</span>ä¿å­˜åœ¨<span class="hljs-string">"Session"</span>å½“ä¸­ã€‚è€Œåœ¨<span class="hljs-string">"Security"</span>å½“ä¸­ä¹Ÿæ˜¯ä¿å­˜åœ¨<span class="hljs-string">"Session"</span>å½“ä¸­ï¼Œä½†æ˜¯ä¸ºäº†æ—¥åè®©æˆ‘ä»¬å†ä¸€æ¬¡è·å–<span class="hljs-string">"Authentication"</span>è¿™ä¸ªä¿¡æ¯(ç”¨æˆ·ä¿¡æ¯æ—¶)èƒ½æ›´åŠ çš„æ–¹ä¾¿ï¼Œä»–åˆæŠŠè¿™ä¸ª<span class="hljs-string">"Session"</span>åšäº†è¿›ä¸€æ­¥çš„å¤„ç†ã€‚
ä»–åˆè®¾è®¡äº†ä¸€ä¸ª<span class="hljs-string">"Security ContextHolder"</span>ç±»ï¼Œå®ƒæ˜¯ç”¨æ¥è·å–ç”¨æˆ·çš„ä¿¡æ¯ã€‚è€Œä¸æ˜¯ä»£ç†ä»–<span class="hljs-string">"Authentication"</span>,å®ƒåªæ˜¯ç”¨æ¥è·å–çš„ä¸€ç§é€”å¾„ã€‚è€Œ<span class="hljs-string">"Authentication"</span>æ˜¯çœŸæ­£ç”¨æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ã€‚

å°±æ˜¯å½“æˆ‘ä»¬å‘èµ·ä¸€ä¸ªè¯·æ±‚åï¼Œç»è¿‡è®¤è¯æˆåŠŸä¹‹åè¿”å›ä¸€ä¸ª<span class="hljs-string">"Authentication"</span>ç±»ã€‚è¿™ä¸ªç±»ä¿å­˜æˆ‘ä»¬ç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒæ—¶ä¼šå°†è¿™ä¸ªç±»æ”¾åœ¨ä¸€ä¸ªæœ¬åœ°çš„çº¿ç¨‹<span class="hljs-string">"Threadlocal"</span> çš„å˜é‡
<span class="hljs-string">"SecurityContextHolder"</span> è¿™ä¸ªç±»å½“ä¸­ï¼Œå½“ç™»å½•æˆåŠŸä¹‹åï¼Œæˆ‘ä»¬çš„è¯·æ±‚è¦å“åº”ã€‚å“åº”ä¹‹åæ„å‘³ç€è®¤è¯ã€‚è¿™æ¬¡è¯·æ±‚è¦ç»“æŸäº†ï¼Œç»“æŸçš„æ—¶å€™,å³å½“å‰å“åº”çš„æ—¶å€™ï¼Œä»–ä¼šæŠŠ<span class="hljs-string">"SecurityContextHolder"</span>ä¸­çš„<span class="hljs-string">"Authentication"</span>è¿™ä¸ªç±»å–å‡ºæ¥ã€‚æ”¾åˆ°æˆ‘ä»¬å¯¹åº”çš„<span class="hljs-string">"Session"</span>é‡Œé¢ä¿å­˜ä¸‹æ¥,è€Œå½“å‰åˆ°<span class="hljs-string">"SecurityContextHolder"</span>ä¼šéšç€æœ¬åœ°è¯·æ±‚ç»“æŸè€Œç»“æŸäº†ã€‚

ä»¥åæ¯å½“æœ‰è¯·æ±‚æ¥çš„æ—¶å€™ï¼Œéƒ½ä¼šæºå¸¦ä¸€ä¸ª<span class="hljs-string">"sessionID"</span>,æˆ‘ä»¬æºå¸¦çš„session IDä¼šå¯¹åº”æœåŠ¡å™¨ç«¯æ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„sessionã€‚åŒæ—¶çœ‹åˆ°sessioné‡Œé¢æœ‰Authenticationè¿™ä¸ªç±»å°±è¯´æ˜å·²ç»è®¤è¯äº†ã€‚Securityä¼šä»ç­›é€‰ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°SecurityContextHolderä¸­ã€‚æ–¹ä¾¿åœ¨è¯·æ±‚åç»­å¤„ç†è¿‡ç¨‹å½“ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸçš„æ—¶å€™å°†SecurityContextHolderä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ°<span class="hljs-string">"Session"</span>å½“ä¸­ã€‚ç„¶åå°†<span class="hljs-string">"SecurityContextHolder"</span>ä¸­çš„æ•°æ®æ¸…ç©ºã€‚
 
</code></pre>
<h3>æƒé™ç®¡ç†</h3>
<p>åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°<code>å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶</code>ï¼ŒæŒ‰ç…§<code>å®‰å…¨è§„åˆ™</code>æˆ–è€…<code>å®‰å…¨ç­–ç•¥</code>æ§åˆ¶ç”¨æˆ·<code>å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æº</code>ã€‚</p>
<p>æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>æˆæƒ</strong>ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°<strong>è®¤è¯æˆæƒ</strong>ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡<a href="https://so.csdn.net/so/search?q=%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81&#x26;spm=1001.2101.3001.7020">èº«ä»½è®¤è¯</a>ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„è®¿é—®æƒé™æ–¹å¯è®¿é—®ã€‚</p>
<h4>è®¤è¯</h4>
<p><strong><code>èº«ä»½è®¤è¯</code></strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚æœ€å¸¸ç”¨çš„ç®€å•èº«ä»½è®¤è¯æ–¹å¼æ˜¯ç³»ç»Ÿé€šè¿‡æ ¸å¯¹ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œçœ‹å…¶æ˜¯å¦ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„è¯¥ç”¨æˆ·çš„ç”¨æˆ·åå’Œå£ä»¤ä¸€è‡´ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚å¯¹äºé‡‡ç”¨<a href="http://baike.baidu.com/view/5628.htm">æŒ‡çº¹</a>ç­‰ç³»ç»Ÿï¼Œåˆ™å‡ºç¤ºæŒ‡çº¹ï¼›å¯¹äºç¡¬ä»¶Keyç­‰åˆ·å¡ç³»ç»Ÿï¼Œåˆ™éœ€è¦åˆ·å¡ã€‚</p>
<h4>æˆæƒ</h4>
<p><strong><code>æˆæƒ</code></strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ä¸»ä½“è¿›è¡Œèº«ä»½è®¤è¯åéœ€è¦åˆ†é…æƒé™æ–¹å¯è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œå¯¹äºæŸäº›èµ„æºæ²¡æœ‰æƒé™æ˜¯æ— æ³•è®¿é—®çš„</p>
<h4>è§£å†³æ–¹æ¡ˆ</h4>
<p>å’Œå…¶ä»–é¢†åŸŸä¸åŒï¼Œåœ¨ Java ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œå®‰å…¨ç®¡ç†æ¡†æ¶éå¸¸å°‘ï¼Œç›®å‰æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ï¼š</p>
<ul>
<li>Shiro
<ul>
<li>Shiro æœ¬èº«æ˜¯ä¸€ä¸ªè€ç‰Œçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œæœ‰ç€ä¼—å¤šçš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚è½»é‡ã€ç®€å•ã€æ˜“äºé›†æˆã€å¯ä»¥åœ¨JavaSEç¯å¢ƒä¸­ä½¿ç”¨ç­‰ã€‚ä¸è¿‡ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼ŒShiro å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ï¼Œåœ¨å¾®æœåŠ¡é¢å‰å’Œæ‰©å±•æ–¹é¢ï¼Œæ— æ³•å……åˆ†å±•ç¤ºè‡ªå·±çš„ä¼˜åŠ¿ã€‚</li>
</ul>
</li>
<li>å¼€å‘è€…è‡ªå®šä¹‰
<ul>
<li>ä¹Ÿæœ‰å¾ˆå¤šå…¬å¸é€‰æ‹©è‡ªå®šä¹‰æƒé™ï¼Œå³è‡ªå·±å¼€å‘æƒé™ç®¡ç†ã€‚ä½†æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯ç™»å½•å’Œæƒé™æ§åˆ¶è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ç§å„æ ·å¯èƒ½å­˜åœ¨çš„ç½‘ç»œæ”¿å‡»ä»¥åŠé˜²å½»ç­–ç•¥ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œå¼€å‘è€…ç™½å·±å®ç°å®‰å…¨ç®¡ç†ä¹Ÿå¹¶éæ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œåªæœ‰å¤§å…¬å¸æ‰æœ‰è¶³å¤Ÿçš„äººåŠ›ç‰©åŠ›å»æ”¯æŒè¿™ä»¶äº‹æƒ…ã€‚</li>
</ul>
</li>
<li>Spring Security
<ul>
<li>Spring Security,ä½œä¸ºspring å®¶æ—çš„ä¸€å‘˜ï¼Œåœ¨å’Œ Spring å®¶æ—çš„å…¶ä»–æˆå‘˜å¦‚ Spring Boot Spring Clondç­‰è¿›è¡Œæ•´åˆæ—¶ï¼Œå…·æœ‰å…¶ä»–æ¡†æ¶æ— å¯æ¯”æ‹Ÿçš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¯¹ OAuth2 æœ‰ç€è‰¯å¥½çš„æ”¯æŒï¼Œå†åŠ ä¸ŠSpring Cloudå¯¹ Spring Securityçš„ä¸æ–­åŠ æŒï¼ˆå¦‚æ¨å‡º Spring Cloud Security )ï¼Œè®© Spring Securiy ä¸çŸ¥ä¸è§‰ä¸­æˆä¸ºå¾®æœåŠ¡é¡¹ç›®çš„é¦–é€‰å®‰å…¨ç®¡ç†æ–¹æ¡ˆã€‚</li>
</ul>
</li>
</ul>
<h3>ç®€ä»‹</h3>
<h4>å®˜æ–¹å®šä¹‰</h4>
<ul>
<li><a href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li>
</ul>
<p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p>
<p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚å®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚</p>
<p>Spring Securityæ˜¯ä¸€ä¸ªé¢å‘Javaåº”ç”¨ç¨‹åºæä¾›èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§çš„æ¡†æ¶ã€‚ä¸æ‰€æœ‰Springé¡¹ç›®ä¸€æ ·ï¼ŒSpring Securityçš„çœŸæ­£å¨åŠ›åœ¨äºå®ƒå¯ä»¥è½»æ¾åœ°æ‰©å±•ä»¥æ»¡è¶³å®šåˆ¶éœ€æ±‚ã€‚</p>
<ul>
<li>æ€»ç»“</li>
</ul>
<blockquote>
<p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„<code>èº«ä»½éªŒè¯</code>å’Œ<code>è®¿é—®æ§åˆ¶</code>çš„æ¡†æ¶ã€‚æˆ–è€…è¯´ç”¨æ¥å®ç°ç³»ç»Ÿä¸­æƒé™ç®¡ç†çš„æ¡†æ¶ã€‚</p>
</blockquote>
<h4>å†å²</h4>
<p>Spring Security æœ€æ—©å« Acegi Securityï¼Œ è¿™ä¸ªåç§°å¹¶ä¸æ˜¯è¯´å®ƒå’Œ Spring å°±æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¾ç„¶æ˜¯ä¸ºSpring æ¡†æ¶æä¾›å®‰å…¨æ”¯æŒçš„ã€‚Acegi Security åŸºäº Springï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸ºé¡¹ç›®å»ºç«‹ä¸°å¯Œçš„è§’è‰²ä¸<a href="https://so.csdn.net/so/search?q=%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F&#x26;spm=1001.2101.3001.7020">æƒé™ç®¡ç†ç³»ç»Ÿ</a>ã€‚Acegi security è™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„åˆ™æ˜¯å®ƒè‡ƒè‚¿çƒ¦ççš„é…ç½®è¿™ä¸€é—®é¢˜æœ€ç»ˆä¹Ÿé—ä¼ ç»™äº† Spring Securityã€‚</p>
<p>â€‹ Acegi Security æœ€ç»ˆè¢«å¹¶å…¥ Spring Security é¡¹ç›®ä¸­ï¼Œå¹¶äº 2008 å¹´4æœˆå‘å¸ƒäº†æ”¹ååçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Spring Security 2.0.0ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Security çš„æœ€æ–°ç‰ˆæœ¬å·±ç»åˆ°äº† 5.6.1ã€‚å’Œ Shiro ç›¸æ¯”ï¼ŒSpring Securityé‡é‡çº§å¹¶ä¸”é…ç½®çƒ¦çï¼Œç›´è‡³ä»Šå¤©ï¼Œä¾ç„¶æœ‰äººä»¥æ­¤ä¸ºç†ç”±è€Œæ‹’ç»äº†è§£ Spring Securityã€‚å…¶å®ï¼Œè‡ªä» Spring Boot æ¨å‡ºåï¼Œå°±å½»åº•é¢ è¦†äº†ä¼ ç»Ÿäº† JavaEE å¼€å‘ï¼Œè‡ªåŠ¨åŒ–é…ç½®è®©è®¸å¤šäº‹æƒ…å˜å¾—éå¸¸å®¹æ˜“ï¼ŒåŒ…æ‹¬ Spring Security çš„é…ç½®ã€‚åœ¨ä¸€ä¸ª Spring Boot é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–é…ç½®ï¼Œé¡¹ç›®çš„æ‰€æœ‰æ¥å£å°±ä¼šè¢«è‡ªåŠ¨ä¿æŠ¤èµ·æ¥äº†ã€‚åœ¨ Spring Cloudä¸­ï¼Œå¾ˆå¤šæ¶‰åŠå®‰å…¨ç®¡ç†çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Spring Security ä¾èµ–ä¸¤è¡Œé…ç½®å°±èƒ½æå®šï¼Œåœ¨å’Œ Spring å®¶æ—çš„äº§å“ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒSpring Security çš„ä¼˜åŠ¿å°±éå¸¸æ˜æ˜¾äº†ã€‚</p>
<p>â€‹ å› æ­¤ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼Œæˆ‘ä»¬ä¸éœ€è¦çº ç»“è¦ä¸è¦å­¦ä¹  Spring Securityï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•å¿«é€ŸæŒæ¡Spring Securityï¼Œ å¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ Spring Security å®ç°æˆ‘ä»¬å¾®æœåŠ¡çš„å®‰å…¨ç®¡ç†ã€‚</p>
<h3>æ•´ä½“æ¶æ„</h3>
<p>åœ¨çš„æ¶æ„è®¾è®¡ä¸­ï¼Œ**<code>è®¤è¯</code><strong>å’Œ</strong><code>æˆæƒ</code>** æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼ã€‚éƒ½ä¸ä¼šå½±å“æˆæƒï¼Œè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å­˜åœ¨ï¼Œè¿™ç§ç‹¬ç«‹å¸¦æ¥çš„å¥½å¤„ä¹‹ä¸€ï¼Œå°±æ˜¯å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ•´åˆä¸€äº›å¤–éƒ¨çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p><img src="/posts/18.spring-security/002.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>è®¤è¯</h4>
<h5>AuthenticationManager</h5>
<p>åœ¨Spring Securityä¸­è®¤è¯æ˜¯ç”±<code>AuthenticationManager</code>æ¥å£æ¥è´Ÿè´£çš„ï¼Œæ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="/posts/18.spring-security/003.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> { 
	Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> 
  														<span class="hljs-keyword">throws</span> AuthenticationException;
}
</code></pre>
<ul>
<li>è¿”å› Authentication è¡¨ç¤ºè®¤è¯æˆåŠŸ</li>
<li>è¿”å› AuthenticationException å¼‚å¸¸ï¼Œè¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚</li>
</ul>
<p>AuthenticationManager ä¸»è¦å®ç°ç±»ä¸º ProviderManagerï¼Œåœ¨ ProviderManager ä¸­ç®¡ç†äº†ä¼—å¤š AuthenticationProvider å®ä¾‹ã€‚åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯æµç¨‹ä¸­ï¼ŒSpring Security å…è®¸å­˜åœ¨å¤šä¸ª AuthenticationProvider ï¼Œç”¨æ¥å®ç°å¤šç§è®¤è¯æ–¹å¼ï¼Œè¿™äº› AuthenticationProvider éƒ½æ˜¯ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†çš„ã€‚</p>
<p><img src="/posts/18.spring-security/004.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5>Authentication</h5>
<p>è®¤è¯ä»¥åŠè®¤è¯æˆåŠŸçš„ä¿¡æ¯ä¸»è¦æ˜¯ç”± Authentication çš„å®ç°ç±»è¿›è¡Œä¿å­˜çš„ï¼Œå…¶æ¥å£å®šä¹‰ä¸ºï¼š</p>
<p><img src="/posts/18.spring-security/005.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable {
	Collection&#x3C;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>> getAuthorities();
	Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;
	Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;
	Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;
	<span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;
	<span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isAuthenticated)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;
}
</code></pre>
<ul>
<li>getAuthorities è·å–ç”¨æˆ·æƒé™ä¿¡æ¯</li>
<li>getCredentials è·å–ç”¨æˆ·å‡­è¯ä¿¡æ¯ï¼Œä¸€èˆ¬æŒ‡å¯†ç </li>
<li>getDetails è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</li>
<li>getPrincipal è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œç”¨æˆ·åã€ç”¨æˆ·å¯¹è±¡ç­‰</li>
<li>isAuthenticated ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸ</li>
</ul>
<h5>SecurityContextHolder</h5>
<p>SecurityContextHolder ç”¨æ¥è·å–ç™»å½•ä¹‹åç”¨æˆ·ä¿¡æ¯ã€‚Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ° SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°† Security SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚è¿™ä¸€ç­–ç•¥éå¸¸æ–¹ä¾¿ç”¨æˆ·åœ¨ Controllerã€Service å±‚ä»¥åŠä»»ä½•ä»£ç ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·æ•°æ®ã€‚</p>
<h4>æˆæƒ</h4>
<p>å½“å®Œæˆè®¤è¯åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆæƒäº†ã€‚åœ¨ Spring Security çš„æˆæƒä½“ç³»ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ¥å£ï¼Œ</p>
<h5>AccessDecisionManager</h5>
<blockquote>
<p>AccessDecisionManager (è®¿é—®å†³ç­–ç®¡ç†å™¨)ï¼Œç”¨æ¥å†³å®šæ­¤æ¬¡è®¿é—®æ˜¯å¦è¢«å…è®¸ã€‚</p>
</blockquote>
<p><img src="/posts/18.spring-security/006.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5>AccessDecisionVoter</h5>
<blockquote>
<p>AccessDecisionVoter (è®¿é—®å†³å®šæŠ•ç¥¨å™¨)ï¼ŒæŠ•ç¥¨å™¨ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡åº”æœ‰çš„è§’è‰²ï¼Œè¿›è€ŒæŠ•å‡ºèµæˆã€åå¯¹æˆ–è€…å¼ƒæƒç¥¨ã€‚</p>
</blockquote>
<p><img src="/posts/18.spring-security/007.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>AccesDecisionVoter å’Œ AccessDecisionManager éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</p>
<h5>ConfigAttribute</h5>
<blockquote>
<p>ConfigAttributeï¼Œç”¨æ¥ä¿å­˜æˆæƒæ—¶çš„è§’è‰²ä¿¡æ¯</p>
</blockquote>
<p><img src="/posts/18.spring-security/008.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ª<br>
èµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</p>
<h2>ç¬¬äºŒç«  ç¯å¢ƒæ­å»º</h2>
<ul>
<li>ç¯å¢ƒæ­å»º</li>
<li>è‡ªåŠ¨é…ç½®ç»†èŠ‚</li>
</ul>
<h3>ç¯å¢ƒæ­å»º</h3>
<ul>
<li>spring boot</li>
<li>spring security
<ul>
<li>è®¤è¯: åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç³»ç»Ÿåˆæ³•ç”¨æˆ·è¿‡ç¨‹</li>
<li>æˆæƒ: åˆ¤æ–­ç³»ç»Ÿå†…ç”¨æˆ·å¯ä»¥è®¿é—®æˆ–å…·æœ‰è®¿é—®é‚£äº›èµ„æºæƒé™è¿‡ç¨‹</li>
</ul>
</li>
</ul>
<h4>åˆ›å»ºé¡¹ç›®</h4>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 1.åˆ›å»º springboot åº”ç”¨</span>
</code></pre>
<p><img src="/posts/18.spring-security/009.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-kotlin"># <span class="hljs-number">2.</span>åˆ›å»º controller


<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-keyword">public</span> String hello() {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"hello security"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello security"</span>;
    }
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/188f587db6c74edfbf3fd40b066dcaa9.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># 3.å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•</span>
- http://localhost:8080/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/75027cfb5d1e492badae5fdbb9531481.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>æ•´åˆ Spring Security</h4>
<pre><code class="hljs language-php-template"><span class="xml"># 1.å¼•å…¥spring securityç›¸å…³ä¾èµ–


<span class="hljs-comment">&#x3C;!--å¼•å…¥spring securityä¾èµ–--></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-security<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>


# 2.å†æ¬¡å¯åŠ¨é¡¹ç›®
- 1.å¯åŠ¨å®Œæˆåæ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªå¯†ç 
- 2.è®¿é—® hello å‘ç°ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
</span></code></pre>
<p><img src="https://img-blog.csdnimg.cn/dabc01844d6846e98f5c6ecdf57bc9b9.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/81203d61e94448f6930b9f92eba8c3ed.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-markdown"><span class="hljs-section"># 3.ç™»å½•ç³»ç»Ÿ</span>
<span class="hljs-bullet">-</span> é»˜è®¤ç”¨æˆ·åä¸º: user
<span class="hljs-bullet">-</span> é»˜è®¤å¯†ç ä¸º:  æ§åˆ¶å°æ‰“å°çš„ uuid
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/96e96ba5ee044e55b0e0095c42a127db.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/0ecce4cd60cf483fb8ff6649bbde970a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>è¿™å°±æ˜¯ Spring Security çš„å¼ºå¤§ä¹‹å¤„ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œæ‰€æœ‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨ä¿æŠ¤èµ·æ¥ï¼</strong></p>
<p>æ€è€ƒğŸ¤”?</p>
<ul>
<li>
<p>ä¸ºä»€ä¹ˆå¼•å…¥ Spring Security ä¹‹å<code>æ²¡æœ‰ä»»ä½•é…ç½®æ‰€æœ‰è¯·æ±‚å°±è¦è®¤è¯</code>å‘¢?</p>
</li>
<li>
<p>åœ¨é¡¹ç›®ä¸­æ˜æ˜æ²¡æœ‰ç™»å½•ç•Œé¢ï¼Œ<code>ç™»å½•ç•Œé¢</code>æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>user</code> å’Œ <code>æ§åˆ¶å°å¯†ç </code> èƒ½ç™»é™†ï¼Œç™»å½•æ—¶éªŒè¯æ•°æ®æºå­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
</li>
</ul>
<h4>å®ç°åŸç†</h4>
<p><a href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture</a></p>
<p>è™½ç„¶å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œå°±å¯ä»¥è®© Spring Security å¯¹åº”ç”¨è¿›è¡Œä¿æŠ¤ã€‚Spring Security åˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ Spring Security ä¸­ <code>è®¤è¯ã€æˆæƒ</code> ç­‰åŠŸèƒ½éƒ½æ˜¯åŸºäº<a href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">è¿‡æ»¤å™¨</a>å®Œæˆçš„ã€‚</p>
<p>[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ <img src="https://img-blog.csdnimg.cn/7a489514ce50453f95ba677a38c5bdef.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/405cad31711643a6b3e7809eb8a97bb5.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤è¿‡æ»¤å™¨å¹¶ä¸æ˜¯ç›´æ¥æ”¾åœ¨ Web é¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<br>
FlterChainProxy æ¥ç»Ÿä¸€ç®¡ç†ã€‚Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾é€šè¿‡ FilterChainProxy åµŒå…¥åˆ° Webé¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ã€‚FilterChainProxy ä½œä¸ºä¸€ä¸ªé¡¶å±‚çš„ç®¡ç†è€…ï¼Œå°†ç»Ÿä¸€ç®¡ç† Security Filterã€‚FilterChainProxy æœ¬èº«æ˜¯é€šè¿‡ Spring æ¡†æ¶æä¾›çš„ DelegatingFilterProxy æ•´åˆåˆ°åŸç”Ÿçš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p>
<h4>Security Filters</h4>
<p>é‚£ä¹ˆåœ¨ Spring Security ä¸­ç»™æˆ‘ä»¬æä¾›é‚£äº›è¿‡æ»¤å™¨? é»˜è®¤æƒ…å†µä¸‹é‚£äº›è¿‡æ»¤å™¨ä¼šè¢«åŠ è½½å‘¢ï¼Ÿ</p>
<p>è¿‡æ»¤å™¨</p>
<p>è¿‡æ»¤å™¨ä½œç”¨</p>
<p>é»˜è®¤æ˜¯å¦åŠ è½½</p>
<p>ChannelProcessingFilter</p>
<p>è¿‡æ»¤è¯·æ±‚åè®® HTTP ã€HTTPS</p>
<p>NO</p>
<p><code>WebAsyncManagerIntegrationFilter</code></p>
<p>å°† WebAsyncManger ä¸ SpringSecurity ä¸Šä¸‹æ–‡è¿›è¡Œé›†æˆ</p>
<p>YES</p>
<p><code>SecurityContextPersistenceFilter</code></p>
<p>åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰,å°†å®‰å…¨ä¿¡æ¯åŠ è½½åˆ° SecurityContextHolder ä¸­</p>
<p>YES</p>
<p><code>HeaderWriterFilter</code></p>
<p>å¤„ç†å¤´ä¿¡æ¯åŠ å…¥å“åº”ä¸­</p>
<p>YES</p>
<p>CorsFilter</p>
<p>å¤„ç†è·¨åŸŸé—®é¢˜</p>
<p>NO</p>
<p><code>CsrfFilter</code></p>
<p>å¤„ç† CSRF æ”»å‡»</p>
<p>YES</p>
<p><code>LogoutFilter</code></p>
<p>å¤„ç†æ³¨é”€ç™»å½•</p>
<p>YES</p>
<p>OAuth2AuthorizationRequestRedirectFilter</p>
<p>å¤„ç† OAuth2 è®¤è¯é‡å®šå‘</p>
<p>NO</p>
<p>Saml2WebSsoAuthenticationRequestFilter</p>
<p>å¤„ç† SAML è®¤è¯</p>
<p>NO</p>
<p>X509AuthenticationFilter</p>
<p>å¤„ç† X509 è®¤è¯</p>
<p>NO</p>
<p>AbstractPreAuthenticatedProcessingFilter</p>
<p>å¤„ç†é¢„è®¤è¯é—®é¢˜</p>
<p>NO</p>
<p>CasAuthenticationFilter</p>
<p>å¤„ç† CAS å•ç‚¹ç™»å½•</p>
<p>NO</p>
<p><code>OAuth2LoginAuthenticationFilter</code></p>
<p>å¤„ç† OAuth2 è®¤è¯</p>
<p>NO</p>
<p>Saml2WebSsoAuthenticationFilter</p>
<p>å¤„ç† SAML è®¤è¯</p>
<p>NO</p>
<p><code>UsernamePasswordAuthenticationFilter</code></p>
<p>å¤„ç†è¡¨å•ç™»å½•</p>
<p>YES</p>
<p>OpenIDAuthenticationFilter</p>
<p>å¤„ç† OpenID è®¤è¯</p>
<p>NO</p>
<p><code>DefaultLoginPageGeneratingFilter</code></p>
<p>é…ç½®é»˜è®¤ç™»å½•é¡µé¢</p>
<p>YES</p>
<p><code>DefaultLogoutPageGeneratingFilter</code></p>
<p>é…ç½®é»˜è®¤æ³¨é”€é¡µé¢</p>
<p>YES</p>
<p>ConcurrentSessionFilter</p>
<p>å¤„ç† Session æœ‰æ•ˆæœŸ</p>
<p>NO</p>
<p>DigestAuthenticationFilter</p>
<p>å¤„ç† HTTP æ‘˜è¦è®¤è¯</p>
<p>NO</p>
<p>BearerTokenAuthenticationFilter</p>
<p>å¤„ç† OAuth2 è®¤è¯çš„ Access Token</p>
<p>NO</p>
<p><code>BasicAuthenticationFilter</code></p>
<p>å¤„ç† HttpBasic ç™»å½•</p>
<p>YES</p>
<p><code>RequestCacheAwareFilter</code></p>
<p>å¤„ç†è¯·æ±‚ç¼“å­˜</p>
<p>YES</p>
<p><code>SecurityContextHolder&#x3C;br />AwareRequestFilter</code></p>
<p>åŒ…è£…åŸå§‹è¯·æ±‚</p>
<p>YES</p>
<p>JaasApiIntegrationFilter</p>
<p>å¤„ç† JAAS è®¤è¯</p>
<p>NO</p>
<p><code>RememberMeAuthenticationFilter</code></p>
<p>å¤„ç† RememberMe ç™»å½•</p>
<p>NO</p>
<p><code>AnonymousAuthenticationFilter</code></p>
<p>é…ç½®åŒ¿åè®¤è¯</p>
<p>YES</p>
<p><code>OAuth2AuthorizationCodeGrantFilter</code></p>
<p>å¤„ç†OAuth2è®¤è¯ä¸­æˆæƒç </p>
<p>NO</p>
<p><code>SessionManagementFilter</code></p>
<p>å¤„ç† session å¹¶å‘é—®é¢˜</p>
<p>YES</p>
<p><code>ExceptionTranslationFilter</code></p>
<p>å¤„ç†è®¤è¯/æˆæƒä¸­çš„å¼‚å¸¸</p>
<p>YES</p>
<p><code>FilterSecurityInterceptor</code></p>
<p>å¤„ç†æˆæƒç›¸å…³</p>
<p>YES</p>
<p>SwitchUserFilter</p>
<p>å¤„ç†è´¦æˆ·åˆ‡æ¢</p>
<p>NO</p>
<p>å¯ä»¥çœ‹å‡ºï¼ŒSpring Security æä¾›äº† 30 å¤šä¸ªè¿‡æ»¤å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹Spring Boot åœ¨å¯¹ Spring Security è¿›å…¥è‡ªåŠ¨åŒ–é…ç½®æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º SpringSecurityFilerChain çš„è¿‡æ»¤å™¨ï¼Œå¹¶æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨å°†è´Ÿè´£æ‰€æœ‰çš„å®‰å…¨ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€æˆæƒã€é‡å®šå‘åˆ°ç™»å½•é¡µé¢ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒWebSecurityConfigurationçš„æºç :</p>
<p><img src="https://img-blog.csdnimg.cn/7a8bd8ca1df34aefab8b2c696e16da20.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/3b15a04b350d40fba9930230458eacfa.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>SpringBootWebSecurityConfiguration</h4>
<p>è¿™ä¸ªç±»æ˜¯ spring boot è‡ªåŠ¨é…ç½®ç±»ï¼Œé€šè¿‡è¿™ä¸ªæºç å¾—çŸ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæƒé™æ§åˆ¶:</p>
<pre><code class="hljs language-less"><span class="hljs-variable">@Configuration</span>(proxyBeanMethods = false)
<span class="hljs-variable">@ConditionalOnDefaultWebSecurity</span>
<span class="hljs-variable">@ConditionalOnWebApplication</span>(type = Type.SERVLET)
class SpringBootWebSecurityConfiguration {
	<span class="hljs-variable">@Bean</span>
	<span class="hljs-variable">@Order</span>(SecurityProperties.BASIC_AUTH_ORDER)
	SecurityFilterChain <span class="hljs-built_in">defaultSecurityFilterChain</span>(HttpSecurity http) 
    throws Exception {
			<span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.authorizeRequests</span>()<span class="hljs-selector-class">.anyRequest</span>()
      <span class="hljs-selector-class">.authenticated</span>()<span class="hljs-selector-class">.and</span>()<span class="hljs-selector-class">.formLogin</span>()<span class="hljs-selector-class">.and</span>()<span class="hljs-selector-class">.httpBasic</span>();
		<span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">http</span><span class="hljs-selector-class">.build</span>();
	}
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/0871a9f0be0847199b1c080aac5301ee.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼•å…¥ Spring Security ä¸­æ²¡æœ‰ä»»ä½•é…ç½®æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¼šè¢«æ‹¦æˆªçš„åŸå› ï¼</strong></p>
<p>é€šè¿‡ä¸Šé¢å¯¹è‡ªåŠ¨é…ç½®åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºé»˜è®¤ç”Ÿæ•ˆæ¡ä»¶ä¸º:</p>
<pre><code class="hljs language-perl"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultWebSecurityCondition</span> <span class="hljs-title">extends</span> <span class="hljs-title">AllNestedConditions</span> </span>{

	DefaultWebSecurityCondition() {
		super(ConfigurationPhase.REGISTER_BEAN);
	}

	<span class="hljs-variable">@ConditionalOnClass</span>({ SecurityFilterChain.class, HttpSecurity.class })
	static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Classes</span> </span>{

	}

	<span class="hljs-variable">@ConditionalOnMissingBean</span>({ WebSecurityConfigurerAdapter.class, SecurityFilterChain.class })
	static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Beans</span> </span>{

	}

}
</code></pre>
<ul>
<li>æ¡ä»¶ä¸€ classpathä¸­å­˜åœ¨ SecurityFilterChain.class, HttpSecurity.class</li>
<li>æ¡ä»¶äºŒ æ²¡æœ‰è‡ªå®šä¹‰ WebSecurityConfigurerAdapter.class, SecurityFilterChain.class</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„ã€‚WebSecurityConfigurerAdapter è¿™ä¸ªç±»æå…¶é‡è¦ï¼ŒSpring Security æ ¸å¿ƒé…ç½®éƒ½åœ¨è¿™ä¸ªç±»ä¸­:</p>
<p><img src="https://img-blog.csdnimg.cn/da9365cddcc34a67a6cf8beb6f12432e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¦‚æœè¦å¯¹ Spring Security è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œå°±è¦è‡ªå®šä¹‰è¿™ä¸ªç±»å®ä¾‹ï¼Œé€šè¿‡è¦†ç›–ç±»ä¸­æ–¹æ³•è¾¾åˆ°ä¿®æ”¹é»˜è®¤é…ç½®çš„ç›®çš„ã€‚</p>
<h4>æµç¨‹åˆ†æ</h4>
<p><img src="https://img-blog.csdnimg.cn/9ab16c43eb4e484fb5f3e302c852f8c3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>è¯·æ±‚ /hello æ¥å£ï¼Œåœ¨å¼•å…¥ spring security ä¹‹åä¼šå…ˆç»è¿‡ä¸€äº›åˆ—è¿‡æ»¤å™¨</li>
<li>åœ¨è¯·æ±‚åˆ°è¾¾ FilterSecurityInterceptoræ—¶ï¼Œå‘ç°è¯·æ±‚å¹¶æœªè®¤è¯ã€‚è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¹¶æŠ›å‡º AccessDeniedException å¼‚å¸¸ã€‚</li>
<li>æŠ›å‡º AccessDeniedException çš„å¼‚å¸¸ä¼šè¢« ExceptionTranslationFilter æ•è·ï¼Œè¿™ä¸ª Filter ä¸­ä¼šè°ƒç”¨ LoginUrlAuthenticationEntryPoint#commence æ–¹æ³•ç»™å®¢æˆ·ç«¯è¿”å› 302ï¼Œè¦æ±‚å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘åˆ° /login é¡µé¢ã€‚</li>
<li>å®¢æˆ·ç«¯å‘é€ /login è¯·æ±‚ã€‚</li>
<li>/login è¯·æ±‚ä¼šå†æ¬¡è¢«æ‹¦æˆªå™¨ä¸­ DefaultLoginPageGeneratingFilter æ‹¦æˆªåˆ°ï¼Œå¹¶åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›ç”Ÿæˆç™»å½•é¡µé¢ã€‚</li>
</ol>
<p><strong>å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Security é»˜è®¤è¿‡æ»¤å™¨ä¸­ç”Ÿæˆäº†ç™»å½•é¡µé¢ï¼Œå¹¶è¿”å›ï¼</strong></p>
<h4>é»˜è®¤ç”¨æˆ·ç”Ÿæˆ</h4>
<ol>
<li>æŸ¥çœ‹ SpringBootWebSecurityConfiguration#defaultSecurityFilterChain æ–¹æ³•è¡¨å•ç™»å½•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/d8a108d9c3a549c3949bdb44b37d52a2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="2">
<li>å¤„ç†ç™»å½•ä¸º FormLoginConfigurer ç±»ä¸­ è°ƒç”¨ UsernamePasswordAuthenticationFilterè¿™ä¸ªç±»å®ä¾‹</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/10ac4ef04614482192dbec38983c0c92.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="3">
<li>æŸ¥çœ‹ç±»ä¸­ UsernamePasswordAuthenticationFilter#attempAuthentication æ–¹æ³•å¾—çŸ¥å®é™…è°ƒç”¨ AuthenticationManager ä¸­ authenticate æ–¹æ³•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/0654dc2eae6b43f389e89e434d250ac7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="4">
<li>è°ƒç”¨ ProviderManager ç±»ä¸­æ–¹æ³• authenticate</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/17fa2a0da1f342518e2a3ecec0949785.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="5">
<li>è°ƒç”¨äº† ProviderManager å®ç°ç±»ä¸­ AbstractUserDetailsAuthenticationProviderç±»ä¸­æ–¹æ³•</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/1d6c8da290b446a8b217ccfb57399b96.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol start="6">
<li>æœ€ç»ˆè°ƒç”¨å®ç°ç±» DaoAuthenticationProvider ç±»ä¸­æ–¹æ³•æ¯”è¾ƒ</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/5ee9397c175949d19f1f3aa2c174f38c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/2c468bec265f413784cb93398eb812ee.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>çœ‹åˆ°è¿™é‡Œå°±çŸ¥é“é»˜è®¤å®ç°æ˜¯åŸºäº InMemoryUserDetailsManager è¿™ä¸ªç±»,ä¹Ÿå°±æ˜¯å†…å­˜çš„å®ç°!</strong></p>
<h4>UserDetailService</h4>
<p>é€šè¿‡åˆšæ‰æºç åˆ†æä¹Ÿèƒ½å¾—çŸ¥ UserDetailService æ˜¯é¡¶å±‚çˆ¶æ¥å£ï¼Œæ¥å£ä¸­ loadUserByUserName æ–¹æ³•æ˜¯ç”¨æ¥åœ¨è®¤è¯æ—¶è¿›è¡Œç”¨æˆ·åè®¤è¯æ–¹æ³•ï¼Œé»˜è®¤å®ç°ä½¿ç”¨æ˜¯å†…å­˜å®ç°ï¼Œ<strong>å¦‚æœæƒ³è¦ä¿®æ”¹æ•°æ®åº“å®ç°æˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰ UserDetailService å®ç°ï¼Œæœ€ç»ˆè¿”å› UserDetails å®ä¾‹å³å¯ã€‚</strong></p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> {
	UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/80ca5da0a9704e62926d9a2be6aa9257.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>UserDetailServiceAutoConfigutation</h4>
<p>è¿™ä¸ªæºç éå¸¸å¤šï¼Œè¿™é‡Œæ¢³ç†äº†å…³é”®éƒ¨åˆ†ï¼š</p>
<pre><code class="hljs language-less"><span class="hljs-variable">@Configuration</span>(proxyBeanMethods = false)
<span class="hljs-variable">@ConditionalOnClass</span>(AuthenticationManager.class)
<span class="hljs-variable">@ConditionalOnBean</span>(ObjectPostProcessor.class)
<span class="hljs-variable">@ConditionalOnMissingBean</span>(
		value = { AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,
				AuthenticationManagerResolver.class },
		type = { <span class="hljs-string">"org.springframework.security.oauth2.jwt.JwtDecoder"</span>,
				<span class="hljs-string">"org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector"</span>,
				<span class="hljs-string">"org.springframework.security.oauth2.client.registration.ClientRegistrationRepository"</span> })
public class UserDetailsServiceAutoConfiguration {
  <span class="hljs-comment">//....</span>
  <span class="hljs-variable">@Bean</span>
	<span class="hljs-variable">@Lazy</span>
	public InMemoryUserDetailsManager <span class="hljs-built_in">inMemoryUserDetailsManager</span>(SecurityProperties properties,
			ObjectProvider&#x3C;PasswordEncoder> passwordEncoder) {
		<span class="hljs-selector-tag">SecurityProperties</span><span class="hljs-selector-class">.User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">properties</span><span class="hljs-selector-class">.getUser</span>();
		<span class="hljs-selector-tag">List</span>&#x3C;<span class="hljs-selector-tag">String</span>> <span class="hljs-selector-tag">roles</span> = <span class="hljs-selector-tag">user</span><span class="hljs-selector-class">.getRoles</span>();
		<span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">InMemoryUserDetailsManager</span>(
				User.<span class="hljs-built_in">withUsername</span>(user.<span class="hljs-built_in">getName</span>()).<span class="hljs-built_in">password</span>(<span class="hljs-built_in">getOrDeducePassword</span>(user, passwordEncoder.<span class="hljs-built_in">getIfAvailable</span>()))
						.<span class="hljs-built_in">roles</span>(StringUtils.<span class="hljs-built_in">toStringArray</span>(roles)).<span class="hljs-built_in">build</span>());
	}
  <span class="hljs-comment">//...</span>
}
</code></pre>
<p><strong>ç»“è®º</strong></p>
<ol>
<li>ä»è‡ªåŠ¨é…ç½®æºç ä¸­å¾—çŸ¥å½“ classpath ä¸‹å­˜åœ¨ AuthenticationManager ç±»</li>
<li>å½“å‰é¡¹ç›®ä¸­ï¼Œç³»ç»Ÿæ²¡æœ‰æä¾› AuthenticationManager.classã€ AuthenticationProvider.classã€UserDetailsService.classã€<br>
AuthenticationManagerResolver.classã€å®ä¾‹</li>
</ol>
<p><strong>é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæ»¡è¶³ï¼Œæ­¤æ—¶Spring Securityä¼šæä¾›ä¸€ä¸ª InMemoryUserDetailManager å®ä¾‹</strong></p>
<p><img src="https://img-blog.csdnimg.cn/7d821d0b0b0147de96c8d17e1ffcccb3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-java"><span class="hljs-meta">@ConfigurationProperties(prefix = "spring.security")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityProperties</span> {
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
	<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.user;
  }
  <span class="hljs-comment">//....</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
		<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user"</span>;
		<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
		<span class="hljs-keyword">private</span> List&#x3C;String> roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&#x3C;>();
		<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">passwordGenerated</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
		<span class="hljs-comment">//get set ...</span>
	}
}
</code></pre>
<p><strong>è¿™å°±æ˜¯é»˜è®¤ç”Ÿæˆ user ä»¥åŠ uuid å¯†ç è¿‡ç¨‹! å¦å¤–çœ‹æ˜ç™½æºç ä¹‹åï¼Œå°±çŸ¥é“åªè¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®å¯ä»¥å¯¹å†…å­˜ä¸­ç”¨æˆ·å’Œå¯†ç è¿›è¡Œè¦†ç›–ã€‚</strong></p>
<pre><code class="hljs language-ini"><span class="hljs-attr">spring.security.user.name</span>=root
<span class="hljs-attr">spring.security.user.password</span>=root
<span class="hljs-attr">spring.security.user.roles</span>=admin,users
</code></pre>
<h4>æ€»ç»“</h4>
<ul>
<li>AuthenticationManagerã€ProviderMangerã€ä»¥åŠ AuthenticationProvider å…³ç³»</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/f2460dac16ae4274b53b0f3502e49c0e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p><strong>WebSecurityConfigurerAdapter</strong> æ‰©å±• Spring Security æ‰€æœ‰é»˜è®¤é…ç½®</p>
<p><img src="https://img-blog.csdnimg.cn/231468040ea54adf8de0519220fd2527.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
<li>
<p><strong>UserDetailService</strong> ç”¨æ¥ä¿®æ”¹é»˜è®¤è®¤è¯çš„æ•°æ®æºä¿¡æ¯</p>
<p><img src="https://img-blog.csdnimg.cn/a8db57ea05f046fe8dbbc2bb1cf23c6c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
</ul>
<h2>ç¬¬ä¸‰ç«  è®¤è¯åŸç†&#x26;è‡ªå®šä¹‰è®¤è¯</h2>
<ul>
<li>è®¤è¯é…ç½®</li>
<li>è¡¨å•è®¤è¯</li>
<li>æ³¨é”€ç™»å½•</li>
<li>å‰åç«¯åˆ†ç¦»è®¤è¯</li>
<li>æ·»åŠ éªŒè¯ç </li>
</ul>
<h3>è‡ªå®šä¹‰è®¤è¯</h3>
<h4>è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™</h4>
<ul>
<li>/index å…¬å…±èµ„æº</li>
<li>/hello â€¦ å—ä¿æŠ¤èµ„æº æƒé™ç®¡ç†</li>
</ul>
<p>åœ¨é¡¹ç›®ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å°±å¯ä»¥å®ç°å¯¹èµ„æºæƒé™è§„åˆ™è®¾å®š:</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/index")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()<span class="hljs-selector-class">.formLogin</span>();
    }
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/72cff20e628945c68b6335b660adf5a2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-scss"># è¯´æ˜
- <span class="hljs-built_in">permitAll</span>() ä»£è¡¨æ”¾è¡Œè¯¥èµ„æº,è¯¥èµ„æºä¸ºå…¬å…±èµ„æº æ— éœ€è®¤è¯å’Œæˆæƒå¯ä»¥ç›´æ¥è®¿é—®
- <span class="hljs-built_in">anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>() ä»£è¡¨æ‰€æœ‰è¯·æ±‚,å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®
- <span class="hljs-built_in">formLogin</span>() ä»£è¡¨å¼€å¯è¡¨å•è®¤è¯
## æ³¨æ„: æ”¾è¡Œèµ„æºå¿…é¡»æ”¾åœ¨æ‰€æœ‰è®¤è¯è¯·æ±‚ä¹‹å‰!
</code></pre>
<h4>è‡ªå®šä¹‰ç™»å½•ç•Œé¢</h4>
<ul>
<li>
<p>å¼•å…¥æ¨¡æ¿ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-comment">&#x3C;!--thymeleaf--></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-thymeleaf<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
</li>
<li>
<p>å®šä¹‰ç™»å½•é¡µé¢ controller</p>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span> {

    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/login.html"</span>)</span>
    <span class="hljs-keyword">public</span> String login() {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"login"</span>;
    }
}
</code></pre>
</li>
<li>
<p>åœ¨ templates ä¸­å®šä¹‰ç™»å½•ç•Œé¢</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-keyword">html</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">"https://www.thymeleaf.org"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>ç™»å½•<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>ç”¨æˆ·ç™»å½•<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">"@{/doLogin}"</span>></span>
    ç”¨æˆ·å:<span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"uname"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>/></span><span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>></span>
    å¯†ç :<span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"passwd"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>/></span><span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"ç™»å½•"</span>/></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">form</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</span></code></pre>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong></p>
<ul>
<li>ç™»å½•è¡¨å• method å¿…é¡»ä¸º <code>post</code>ï¼Œaction çš„è¯·æ±‚è·¯å¾„ä¸º <code>/doLogin</code></li>
<li>ç”¨æˆ·åçš„ name å±æ€§ä¸º <code>uname</code></li>
<li>å¯†ç çš„ name å±æ€§ä¸º <code>passwd</code></li>
</ul>
</li>
<li>
<p>é…ç½® Spring Security é…ç½®ç±»</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
         http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/login.html")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/index")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.loginPage</span>("/login.html")
                <span class="hljs-selector-class">.loginProcessingUrl</span>("/doLogin")
                <span class="hljs-selector-class">.usernameParameter</span>("uname")
                <span class="hljs-selector-class">.passwordParameter</span>("passwd")
                <span class="hljs-selector-class">.successForwardUrl</span>("/index") 		 <span class="hljs-comment">//forward è·³è½¬           æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</span>
                <span class="hljs-comment">//.defaultSuccessUrl("/index")   //redirect é‡å®šå‘    æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„</span>
                <span class="hljs-selector-class">.failureUrl</span>("/login.html")
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
    }
}
</code></pre>
<ul>
<li>successForwardUrl ã€defaultSuccessUrl è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å®ç°æˆåŠŸä¹‹åè·³è½¬
<ul>
<li>successForwardUrl é»˜è®¤ä½¿ç”¨ <code>forward</code> è·³è½¬ <code>æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</code></li>
<li>defaultSuccessUrl é»˜è®¤ä½¿ç”¨ <code>redirect</code> è·³è½¬ <code>æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„,å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†</h4>
<p>æœ‰æ—¶å€™é¡µé¢è·³è½¬å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬ï¼Œç‰¹åˆ«æ˜¯åœ¨å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­å°±ä¸éœ€è¦æˆåŠŸä¹‹åè·³è½¬é¡µé¢ã€‚åªéœ€è¦ç»™å‰ç«¯è¿”å›ä¸€ä¸ª JSON é€šçŸ¥ç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ä¸å¦ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>AuthenticationSucccessHandler</code> å®ç°</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationSuccessHandler</span> {

	<span class="hljs-comment">/**
	 * Called when a user has been successfully authenticated.
	 * <span class="hljs-doctag">@param</span> request the request which caused the successful authentication
	 * <span class="hljs-doctag">@param</span> response the response
	 * <span class="hljs-doctag">@param</span> authentication the &#x3C;tt>Authentication&#x3C;/tt> object which was created during
	 * the authentication process.
	 */</span>
	<span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,
			Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;
}
</code></pre>
<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•æˆåŠŸä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°successForwardUrlã€defaultSuccessUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„</strong></p>
<p><img src="https://img-blog.csdnimg.cn/dfdb733c9d5848cf8c77f15a3bf523b2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>è‡ªå®šä¹‰ AuthenticationSuccessHandler å®ç°</p>
<p>public class MyAuthenticationSuccessHandler implements AuthenticationSuccessHandler {
@Override
public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
Map&#x3C;String, Object> result = new HashMap&#x3C;String, Object>();
result.put("msg", "ç™»å½•æˆåŠŸ");
result.put("status", 200);
response.setContentType("application/json;charset=UTF-8");
String s = new ObjectMapper().writeValueAsString(result);
response.getWriter().println(s);
}
}</p>
</li>
<li>
<p>é…ç½® AuthenticationSuccessHandler</p>
<p>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
@Override
protected void configure(HttpSecurity http) throws Exception {
http.authorizeHttpRequests()
//...
.and()
.formLogin()
//....
.successHandler(new MyAuthenticationSuccessHandler())
.failureUrl("/login.html")
.and()
.csrf().disable();//è¿™é‡Œå…ˆå…³é—­ CSRF
}
}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/83bfa0f3d210411a9640c0e951f2737e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯</h4>
<p>ä¸ºäº†èƒ½æ›´ç›´è§‚åœ¨ç™»å½•é¡µé¢çœ‹åˆ°å¼‚å¸¸é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ç™»å½•é¡µé¢ä¸­ç›´æ¥è·å–å¼‚å¸¸ä¿¡æ¯ã€‚Spring Security åœ¨ç™»å½•å¤±è´¥ä¹‹åä¼šå°†å¼‚å¸¸ä¿¡æ¯å­˜å‚¨åˆ° <code>request</code> ã€<code>session</code>ä½œç”¨åŸŸä¸­ key ä¸º <code>SPRING_SECURITY_LAST_EXCEPTION</code> å‘½åå±æ€§ä¸­ï¼Œæºç å¯ä»¥å‚è€ƒ SimpleUrlAuthenticationFailureHandler ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/b4a4cbb8d0424327be5bda9ec060712a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-keyword">html</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">"https://www.thymeleaf.org"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>ç™»å½•<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
  ....
  <span class="hljs-tag">&#x3C;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">"${SPRING_SECURITY_LAST_EXCEPTION}"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</span></code></pre>
</li>
<li>
<p>é…ç½®</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {

    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
              	<span class="hljs-comment">//..</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-comment">//....</span>
                <span class="hljs-comment">//.failureUrl("/login.html")</span>
                <span class="hljs-selector-class">.failureForwardUrl</span>("/login.html")
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
    }
}

</code></pre>
<ul>
<li>failureUrlã€failureForwardUrl å…³ç³»ç±»ä¼¼äºä¹‹å‰æåˆ°çš„ successForwardUrl ã€defaultSuccessUrl æ–¹æ³•
<ul>
<li>failureUrl å¤±è´¥ä»¥åçš„é‡å®šå‘è·³è½¬</li>
<li>failureForwardUrl å¤±è´¥ä»¥åçš„ forward è·³è½¬ <code>æ³¨æ„:å› æ­¤è·å– request ä¸­å¼‚å¸¸ä¿¡æ¯,è¿™é‡Œåªèƒ½ä½¿ç”¨failureForwardUrl</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4>è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†</h4>
<p>å’Œè‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†ä¸€æ ·ï¼ŒSpring Security åŒæ ·ä¸ºå‰åç«¯åˆ†ç¦»å¼€å‘æä¾›äº†ç™»å½•å¤±è´¥çš„å¤„ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯ AuthenticationFailureHandlerï¼Œæºç ä¸ºï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationFailureHandler</span> {

	<span class="hljs-comment">/**
	 * Called when an authentication attempt fails.
	 * <span class="hljs-doctag">@param</span> request the request during which the authentication attempt occurred.
	 * <span class="hljs-doctag">@param</span> response the response.
	 * <span class="hljs-doctag">@param</span> exception the exception which was thrown to reject the authentication
	 * request.
	 */</span>
	<span class="hljs-keyword">void</span> <span class="hljs-title function_">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,
			AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException;

}
</code></pre>
<p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•å¤±è´¥ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°failureUrlã€failureForwardUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„ã€‚</strong></p>
<p><img src="https://img-blog.csdnimg.cn/b91d2a8da698449ea437ebe7d8380bd2.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>è‡ªå®šä¹‰ AuthenticationFailureHandler å®ç°</p>
<p>public class MyAuthenticationFailureHandler implements AuthenticationFailureHandler {</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onAuthenticationFailure</span>(<span class="hljs-title class_">HttpServletRequest</span> request, <span class="hljs-title class_">HttpServletResponse</span> response, <span class="hljs-title class_">AuthenticationException</span> exception) throws <span class="hljs-title class_">IOException</span>, <span class="hljs-title class_">ServletException</span> {
    <span class="hljs-title class_">Map</span>&#x3C;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&#x3C;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>>();
    result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"ç™»å½•å¤±è´¥: "</span>+exception.<span class="hljs-title function_">getMessage</span>());
    result.<span class="hljs-title function_">put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-number">500</span>);
    response.<span class="hljs-title function_">setContentType</span>(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
    <span class="hljs-title class_">String</span> s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().<span class="hljs-title function_">writeValueAsString</span>(result);
    response.<span class="hljs-title function_">getWriter</span>().<span class="hljs-title function_">println</span>(s);
}
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½® AuthenticationFailureHandler</p>
<p>@Configuration
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Override</span>
protected void configure(HttpSecurity http) throws Exception {
    http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
              <span class="hljs-comment">//...</span>
            <span class="hljs-selector-class">.and</span>()
            <span class="hljs-selector-class">.formLogin</span>()
           	<span class="hljs-comment">//..</span>
            <span class="hljs-selector-class">.failureHandler</span>(new MyAuthenticationFailureHandler())
            <span class="hljs-selector-class">.and</span>()
            <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
}
</code></pre>
<p>}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/3618b3d992f54e65be2cfd27a5ec3e9a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>æ³¨é”€ç™»å½•</h4>
<p>Spring Security ä¸­ä¹Ÿæä¾›äº†é»˜è®¤çš„æ³¨é”€ç™»å½•é…ç½®ï¼Œåœ¨å¼€å‘æ—¶ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±éœ€æ±‚å¯¹æ³¨é”€è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚</p>
<ul>
<li>
<p>å¼€å¯æ³¨é”€ç™»å½•<code>é»˜è®¤å¼€å¯</code></p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
<span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
                <span class="hljs-comment">//...</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-comment">//...</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.logout</span>()
                <span class="hljs-selector-class">.logoutUrl</span>("/logout")
                <span class="hljs-selector-class">.invalidateHttpSession</span>(true)
                <span class="hljs-selector-class">.clearAuthentication</span>(true)
                <span class="hljs-selector-class">.logoutSuccessUrl</span>("/login.html")
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
    }
}
</code></pre>
<ul>
<li>é€šè¿‡ logout() æ–¹æ³•å¼€å¯æ³¨é”€é…ç½®</li>
<li>logoutUrl æŒ‡å®šé€€å‡ºç™»å½•è¯·æ±‚åœ°å€ï¼Œé»˜è®¤æ˜¯ GET è¯·æ±‚ï¼Œè·¯å¾„ä¸º <code>/logout</code></li>
<li>invalidateHttpSession é€€å‡ºæ—¶æ˜¯å¦æ˜¯ session å¤±æ•ˆï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>clearAuthentication é€€å‡ºæ—¶æ˜¯å¦æ¸…é™¤è®¤è¯ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true</li>
<li>logoutSuccessUrl é€€å‡ºç™»å½•æ—¶è·³è½¬åœ°å€</li>
</ul>
</li>
<li>
<p>é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•è¯·æ±‚</p>
<p>å¦‚æœé¡¹ç›®ä¸­æœ‰éœ€è¦ï¼Œå¼€å‘è€…è¿˜å¯ä»¥é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•çš„è¯·æ±‚ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‡å®šè¯·æ±‚çš„æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
		<span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeHttpRequests()
                <span class="hljs-comment">//...</span>
                .and()
                .formLogin()
                <span class="hljs-comment">//...</span>
                .and()
                .logout()
                .logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">"/logout1"</span>,<span class="hljs-string">"GET"</span>),
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">"/logout"</span>,<span class="hljs-string">"GET"</span>)
                ))
                .invalidateHttpSession(<span class="hljs-literal">true</span>)
                .clearAuthentication(<span class="hljs-literal">true</span>)
                .logoutSuccessUrl(<span class="hljs-string">"/login.html"</span>)
                .and()
                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
    }
}
</code></pre>
</li>
<li>
<p>å‰åç«¯åˆ†ç¦»æ³¨é”€ç™»å½•é…ç½®</p>
<p>å¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œæ³¨é”€æˆåŠŸä¹‹åå°±ä¸éœ€è¦é¡µé¢è·³è½¬äº†ï¼Œåªéœ€è¦å°†æ³¨é”€æˆåŠŸçš„ä¿¡æ¯è¿”å›å‰ç«¯å³å¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ LogoutSuccessHandler å®ç°æ¥è¿”å›æ³¨é”€ä¹‹åä¿¡æ¯ï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLogoutSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LogoutSuccessHandler</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        Map&#x3C;String, Object> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&#x3C;String, Object>();
        result.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"æ³¨é”€æˆåŠŸ"</span>);
        result.put(<span class="hljs-string">"status"</span>, <span class="hljs-number">200</span>);
        response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);
        response.getWriter().println(s);
    }
}


<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeHttpRequests()
          			<span class="hljs-comment">//....</span>
                .and()
                .formLogin()
 								<span class="hljs-comment">//...</span>
                .and()
                .logout()
                <span class="hljs-comment">//.logoutUrl("/logout")</span>
                .logoutRequestMatcher(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrRequestMatcher</span>(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">"/logout1"</span>,<span class="hljs-string">"GET"</span>),
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathRequestMatcher</span>(<span class="hljs-string">"/logout"</span>,<span class="hljs-string">"GET"</span>)
                ))
                .invalidateHttpSession(<span class="hljs-literal">true</span>)
                .clearAuthentication(<span class="hljs-literal">true</span>)
                <span class="hljs-comment">//.logoutSuccessUrl("/login.html")</span>
                .logoutSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyLogoutSuccessHandler</span>())
                .and()
                .csrf().disable();<span class="hljs-comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span>
    }
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/97ccf280380d40b1b67ed79ea603a556.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
</li>
</ul>
<h4>ç™»å½•ç”¨æˆ·æ•°æ®è·å–</h4>
<h5>SecurityContextHolder</h5>
<p>â€‹ Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚</p>
<p>â€‹ SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ°SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°†SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚</p>
<p>â€‹ å®é™…ä¸Š SecurityContextHolder ä¸­å­˜å‚¨æ˜¯ SecurityContextï¼Œåœ¨ SecurityContext ä¸­å­˜å‚¨æ˜¯ Authenticationã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/734efa4d48e14648a8a73755b1121b38.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>è¿™ç§è®¾è®¡æ˜¯å…¸å‹çš„ç­–ç•¥è®¾è®¡æ¨¡å¼:</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolder</span> {
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_THREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MODE_THREADLOCAL"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_INHERITABLETHREADLOCAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MODE_INHERITABLETHREADLOCAL"</span>;
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_GLOBAL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MODE_GLOBAL"</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODE_PRE_INITIALIZED</span> <span class="hljs-operator">=</span> <span class="hljs-string">"MODE_PRE_INITIALIZED"</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SecurityContextHolderStrategy strategy;
  <span class="hljs-comment">//....</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeStrategy</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) {
			Assert.state(strategy != <span class="hljs-literal">null</span>, <span class="hljs-string">"When using "</span> + MODE_PRE_INITIALIZED
					+ <span class="hljs-string">", setContextHolderStrategy must be called with the fully constructed strategy"</span>);
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">if</span> (!StringUtils.hasText(strategyName)) {
			<span class="hljs-comment">// Set default</span>
			strategyName = MODE_THREADLOCAL;
		}
		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) {
			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalSecurityContextHolderStrategy</span>();
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) {
			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-keyword">if</span> (strategyName.equals(MODE_GLOBAL)) {
			strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalSecurityContextHolderStrategy</span>();
			<span class="hljs-keyword">return</span>;
		}
    <span class="hljs-comment">//.....</span>
  }
}
</code></pre>
<ol>
<li><code>MODE THREADLOCAL</code>ï¼šè¿™ç§å­˜æ”¾ç­–ç•¥æ˜¯å°† SecurityContext å­˜æ”¾åœ¨ ThreadLocalä¸­ï¼Œå¤§å®¶çŸ¥é“ Threadlocal çš„ç‰¹ç‚¹æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å°±è¦åœ¨å“ªä¸ªçº¿ç¨‹ä¸­è¯»å–ï¼Œè¿™å…¶å®éå¸¸é€‚åˆ web åº”ç”¨ï¼Œå› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚æ— è®ºç»è¿‡å¤šå°‘ Filter åˆ°è¾¾ Servletï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†çš„ã€‚è¿™ä¹Ÿæ˜¯ SecurityContextHolder çš„é»˜è®¤å­˜å‚¨ç­–ç•¥ï¼Œè¿™ç§å­˜å‚¨ç­–ç•¥æ„å‘³ç€å¦‚æœåœ¨å…·ä½“çš„ä¸šåŠ¡å¤„ç†ä»£ç ä¸­ï¼Œå¼€å¯äº†å­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­å»è·å–ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œå°±ä¼šè·å–ä¸åˆ°ã€‚</li>
<li><code>MODE INHERITABLETHREADLOCAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¦‚æœå¸Œæœ›åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½å¤Ÿè·å–åˆ°ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ç§å­˜å‚¨æ¨¡å¼ã€‚</li>
<li><code>MODE GLOBAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼å®é™…ä¸Šæ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªé™æ€å˜é‡ä¸­ï¼Œåœ¨ JavaWebå¼€å‘ä¸­ï¼Œè¿™ç§æ¨¡å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li>
</ol>
<h5>SecurityContextHolderStrategy</h5>
<p>é€šè¿‡ SecurityContextHolder å¯ä»¥å¾—çŸ¥ï¼ŒSecurityContextHolderStrategy æ¥å£ç”¨æ¥å®šä¹‰å­˜å‚¨ç­–ç•¥æ–¹æ³•</p>
<pre><code class="hljs language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityContextHolderStrategy</span> {
	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clearContext</span>()</span>;
	<span class="hljs-function">SecurityContext <span class="hljs-title">getContext</span>()</span>;
	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setContext</span>(<span class="hljs-params">SecurityContext context</span>)</span>;
	<span class="hljs-function">SecurityContext <span class="hljs-title">createEmptyContext</span>()</span>;
}
</code></pre>
<p>æ¥å£ä¸­ä¸€å…±å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>clearContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥æ¸…é™¤å­˜å‚¨çš„ SecurityContextå¯¹è±¡ã€‚</li>
<li><code>getContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è·å–å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>setContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li>
<li><code>create Empty Context</code>ï¼šè¯¥æ–¹æ³•åˆ™ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ SecurityContext å¯¹è±¡ã€‚</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/3dfa8a08875e4d29a13af810a425a22f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªå®ç°ç±»å¯¹åº”ä¸€ç§ç­–ç•¥çš„å®ç°ã€‚</p>
<h5>ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®</h5>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-keyword">public</span> String hello() {
      Authentication authentication = SecurityContextHolder
        .getContext().getAuthentication();
      User principal = (User) authentication.getPrincipal();
      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"èº«ä»½ :"</span>+principal.getUsername());
      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"å‡­è¯ :"</span>+authentication.getCredentials());
      System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"æƒé™ :"</span>+authentication.getAuthorities());
      <span class="hljs-keyword">return</span> <span class="hljs-string">"hello security"</span>;
    }
}
</code></pre>
<h5>å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®</h5>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-keyword">public</span> String hello() {
      new Thread(()->{
        Authentication authentication = SecurityContextHolder
          .getContext().getAuthentication();
        User principal = (User) authentication.getPrincipal();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"èº«ä»½ :"</span>+principal.getUsername());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"å‡­è¯ :"</span>+authentication.getCredentials());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"æƒé™ :"</span>+authentication.getAuthorities());
      }).start();
      <span class="hljs-keyword">return</span> <span class="hljs-string">"hello security"</span>;
    }
}
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/e318a71b80db4cfabdf1d95bce5a033e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>å¯ä»¥çœ‹åˆ°é»˜è®¤ç­–ç•¥ï¼Œæ˜¯æ— æ³•åœ¨å­çº¿ç¨‹ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦åœ¨å­çº¿ç¨‹ä¸­è·å–å¿…é¡»ä½¿ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥æ˜¯é€šè¿‡ System.getProperty åŠ è½½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  VM Options å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚</strong></p>
<pre><code class="hljs language-ini"><span class="hljs-attr">-Dspring.security.strategy</span>=MODE_INHERITABLETHREADLOCAL
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/94ffd4b1f72e4ac8a71ed95a1992881c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5>é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯</h5>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.thymeleaf.extras<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>thymeleaf-extras-springsecurity5<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>3.0.4.RELEASE<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
</li>
<li>
<p>é¡µé¢åŠ å…¥å‘½åç©ºé—´</p>
<pre><code class="hljs language-ini">&#x3C;html <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> xmlns:th=<span class="hljs-string">"https://www.thymeleaf.org"</span> 
xmlns:<span class="hljs-attr">sec</span>=<span class="hljs-string">"http://www.thymeleaf.org/extras/spring-security"</span>>
</code></pre>
</li>
<li>
<p>é¡µé¢ä¸­ä½¿ç”¨</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-comment">&#x3C;!--è·å–è®¤è¯ç”¨æˆ·å--></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">ul</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">"principal.username"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">li</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">"principal.authorities"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">li</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">"principal.accountNonExpired"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">li</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">"principal.accountNonLocked"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">li</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">li</span> <span class="hljs-attr">sec:authentication</span>=<span class="hljs-string">"principal.credentialsNonExpired"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">li</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">ul</span>></span>
</span></code></pre>
</li>
</ul>
<h4>è‡ªå®šä¹‰è®¤è¯æ•°æ®æº</h4>
<h5>è®¤è¯æµç¨‹åˆ†æ</h5>
<p><a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/c7ea96e8232c42a6bc2871ac2f6cb27c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>å‘èµ·è®¤è¯è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦ç”¨æˆ·åã€å¯†ç ï¼Œè¯¥è¯·æ±‚ä¼šè¢«<code>UsernamePasswordAuthenticationFilter</code> æ‹¦æˆª</li>
<li>åœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸­å°†è¯·æ±‚ä¸­ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…ä¸º<code>Authentication</code>å¯¹è±¡ï¼Œå¹¶äº¤ç»™<code>AuthenticationManager</code> è¿›è¡Œè®¤è¯</li>
<li>è®¤è¯æˆåŠŸï¼Œå°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ° SecurityContextHodler ä»¥åŠè°ƒç”¨è®°ä½æˆ‘ç­‰ï¼Œå¹¶å›è°ƒ <code>AuthenticationSuccessHandler</code> å¤„ç†</li>
<li>è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ SecurityContextHodler ä»¥åŠ è®°ä½æˆ‘ä¸­ä¿¡æ¯ï¼Œå›è°ƒ <code>AuthenticationFailureHandler</code> å¤„ç†</li>
</ul>
<h5>ä¸‰è€…å…³ç³»</h5>
<p>ä»ä¸Šé¢åˆ†æä¸­å¾—çŸ¥ï¼ŒAuthenticationManager æ˜¯è®¤è¯çš„æ ¸å¿ƒç±»ï¼Œä½†å®é™…ä¸Šåœ¨åº•å±‚çœŸæ­£è®¤è¯æ—¶è¿˜ç¦»ä¸å¼€ ProviderManager ä»¥åŠ AuthenticationProvider ã€‚ä»–ä»¬ä¸‰è€…å…³ç³»æ˜¯æ ·çš„å‘¢ï¼Ÿ</p>
<ul>
<li><code>AuthenticationManager</code> æ˜¯ä¸€ä¸ªè®¤è¯ç®¡ç†å™¨ï¼Œå®ƒå®šä¹‰äº† Spring Security è¿‡æ»¤å™¨è¦æ‰§è¡Œè®¤è¯æ“ä½œã€‚</li>
<li><code>ProviderManager</code> AuthenticationManageræ¥å£çš„å®ç°ç±»ã€‚Spring Security è®¤è¯æ—¶é»˜è®¤ä½¿ç”¨å°±æ˜¯ ProviderManagerã€‚</li>
<li><code>AuthenticationProvider</code> å°±æ˜¯é’ˆå¯¹ä¸åŒçš„èº«ä»½ç±»å‹æ‰§è¡Œçš„å…·ä½“çš„èº«ä»½è®¤è¯ã€‚</li>
</ul>
<p><strong>AuthenticationManager ä¸ ProviderManager</strong></p>
<p><img src="https://img-blog.csdnimg.cn/f4cca81c77084d5eabae2f05cd41c27b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>â€‹ ProviderManager æ˜¯ AuthenticationManager çš„å”¯ä¸€å®ç°ï¼Œä¹Ÿæ˜¯ Spring Security é»˜è®¤ä½¿ç”¨å®ç°ã€‚ä»è¿™é‡Œä¸éš¾çœ‹å‡ºé»˜è®¤æƒ…å†µä¸‹AuthenticationManager å°±æ˜¯ä¸€ä¸ªProviderManagerã€‚</p>
<p><strong>ProviderManager ä¸ AuthenticationProvider</strong></p>
<p>æ‘˜è‡ªå®˜æ–¹: <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p>
<p><img src="https://img-blog.csdnimg.cn/d5582ca2d98a4145b3b0ececd4a7f32c.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>â€‹ åœ¨ Spring Seourity ä¸­ï¼Œå…è®¸ç³»ç»ŸåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¾‹å¦‚åŒæ—¶æ”¯æŒç”¨æˆ·å/å¯†ç è®¤è¯ã€ReremberMe è®¤è¯ã€æ‰‹æœºå·ç åŠ¨æ€è®¤è¯ç­‰ï¼Œè€Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”äº†ä¸åŒçš„ AuthenticationProviderï¼Œæ‰€ä»¥ä¸€ä¸ªå®Œæ•´çš„è®¤è¯æµç¨‹å¯èƒ½ç”±å¤šä¸ª AuthenticationProvider æ¥æä¾›ã€‚</p>
<p>â€‹ å¤šä¸ª AuthenticationProvider å°†ç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°†ç”± ProviderManager ä»£ç†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ProviderManager ä¸­å­˜åœ¨ä¸€ä¸ª AuthenticationProvider åˆ—è¡¨ï¼Œåœ¨Provider Manager ä¸­éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ª AuthenticationProvider å»æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œæœ€ç»ˆå¾—åˆ°è®¤è¯ç»“æœã€‚</p>
<p>â€‹ ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥å†é…ç½®ä¸€ä¸ª AuthenticationManager ä½œä¸º parentï¼Œè¿™æ ·å½“ProviderManager è®¤è¯å¤±è´¥ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ° parent ä¸­å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ç†è®ºä¸Šæ¥è¯´ï¼ŒProviderManager çš„ parent å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„ AuthenticationManagerï¼Œä½†æ˜¯é€šå¸¸éƒ½æ˜¯ç”±<br>
ProviderManager æ¥æ‰®æ¼” parent çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯ ProviderManager æ˜¯ ProviderManager çš„ parentã€‚</p>
<p>â€‹ ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ªProviderManager å…±ç”¨åŒä¸€ä¸ª parentã€‚æœ‰æ—¶ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰å—ä¿æŠ¤èµ„æºçš„é€»è¾‘ç»„ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰ç¬¦åˆè·¯å¾„æ¨¡å¼çš„ç½‘ç»œèµ„æºï¼Œå¦‚/api/**ï¼‰ï¼Œæ¯ä¸ªç»„å¯ä»¥æœ‰è‡ªå·±çš„ä¸“ç”¨ AuthenticationManagerã€‚é€šå¸¸ï¼Œæ¯ä¸ªç»„éƒ½æ˜¯ä¸€ä¸ªProviderManagerï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªçˆ¶çº§ã€‚ç„¶åï¼Œçˆ¶çº§æ˜¯ä¸€ç§ <code>å…¨å±€</code>èµ„æºï¼Œä½œä¸ºæ‰€æœ‰æä¾›è€…çš„åå¤‡èµ„æºã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç»˜å‡ºæ–°çš„ AuthenticationManagerã€ProvideManager å’Œ AuthentictionProvider å…³ç³»</p>
<p>æ‘˜è‡ªå®˜ç½‘: <a href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<p><img src="https://img-blog.csdnimg.cn/2851bb1a5ed7441484b378f24037322a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¼„æ¸…æ¥šè®¤è¯åŸç†ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“è®¤è¯æ—¶æ•°æ®æºçš„è·å–ã€‚<code>é»˜è®¤æƒ…å†µä¸‹ AuthenticationProvider æ˜¯ç”± DaoAuthenticationProvider ç±»æ¥å®ç°è®¤è¯çš„ï¼Œåœ¨DaoAuthenticationProvider è®¤è¯æ—¶åˆé€šè¿‡ UserDetailsServiceï¼ˆæ˜¯ä¸€ä¸ªæ¥å£ï¼‰ å®Œæˆæ•°æ®æºçš„æ ¡éªŒã€‚</code>ä»–ä»¬ä¹‹é—´è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/1024f0b723884133a8349e978040435f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><strong>æ€»ç»“: AuthenticationManager æ˜¯è®¤è¯ç®¡ç†å™¨ï¼Œåœ¨ Spring Security ä¸­æœ‰å…¨å±€AuthenticationManagerï¼Œä¹Ÿå¯ä»¥æœ‰å±€éƒ¨AuthenticationManagerã€‚å…¨å±€çš„AuthenticationManagerç”¨æ¥å¯¹å…¨å±€è®¤è¯è¿›è¡Œå¤„ç†ï¼Œå±€éƒ¨çš„AuthenticationManagerç”¨æ¥å¯¹æŸäº›ç‰¹æ®Šèµ„æºè®¤è¯å¤„ç†ã€‚å½“ç„¶æ— è®ºæ˜¯å…¨å±€è®¤è¯ç®¡ç†å™¨è¿˜æ˜¯å±€éƒ¨è®¤è¯ç®¡ç†å™¨éƒ½æ˜¯ç”± ProviderManger è¿›è¡Œå®ç°ã€‚ æ¯ä¸€ä¸ªProviderMangerä¸­éƒ½ä»£ç†ä¸€ä¸ªAuthenticationProviderçš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå®ç°ä»£è¡¨ä¸€ç§èº«ä»½è®¤è¯æ–¹å¼ã€‚è®¤è¯æ—¶åº•å±‚æ•°æ®æºéœ€è¦è°ƒç”¨ UserDetailService æ¥å®ç°ã€‚</strong></p>
<h5>é…ç½®å…¨å±€ AuthenticationManager</h5>
<p><a href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p>
<ul>
<li>
<p>é»˜è®¤çš„å…¨å±€ AuthenticationManager</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
  <span class="hljs-meta">@Autowired</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> {
    <span class="hljs-comment">//builder..</span>
  }
}
</code></pre>
<ul>
<li>springboot å¯¹ security è¿›è¡Œè‡ªåŠ¨é…ç½®æ—¶è‡ªåŠ¨åœ¨å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªå…¨å±€AuthenticationManager</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager é»˜è®¤æ‰¾å½“å‰é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰ UserDetailService å®ä¾‹ è‡ªåŠ¨å°†å½“å‰é¡¹ç›® UserDetailService å®ä¾‹è®¾ç½®ä¸ºæ•°æ®æº</li>
<li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager åœ¨å·¥å‚ä¸­ä½¿ç”¨æ—¶ç›´æ¥åœ¨ä»£ç ä¸­æ³¨å…¥å³å¯</li>
</ol>
</li>
<li>
<p>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
  <span class="hljs-meta">@Override</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> {
  	<span class="hljs-comment">//builder ....</span>
  }
}
</code></pre>
<ul>
<li>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</li>
</ul>
<p><strong>æ€»ç»“</strong></p>
<ol>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° å°±å›å°†å·¥å‚ä¸­è‡ªåŠ¨é…ç½®AuthenticationManager è¿›è¡Œè¦†ç›–</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° éœ€è¦åœ¨å®ç°ä¸­æŒ‡å®šè®¤è¯æ•°æ®æºå¯¹è±¡ UserDetaiService å®ä¾‹</li>
<li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° è¿™ç§æ–¹å¼åˆ›å»ºAuthenticationManagerå¯¹è±¡å·¥å‚å†…éƒ¨æœ¬åœ°ä¸€ä¸ª AuthenticationManager å¯¹è±¡ ä¸å…è®¸åœ¨å…¶ä»–è‡ªå®šä¹‰ç»„ä»¶ä¸­è¿›è¡Œæ³¨å…¥</li>
</ol>
</li>
<li>
<p>ç”¨æ¥åœ¨å·¥å‚ä¸­æš´éœ²è‡ªå®šä¹‰AuthenticationManager å®ä¾‹</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
  
    <span class="hljs-comment">//1.è‡ªå®šä¹‰AuthenticationManager  æ¨è  å¹¶æ²¡æœ‰åœ¨å·¥å‚ä¸­æš´éœ²å‡ºæ¥</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"è‡ªå®šä¹‰AuthenticationManager: "</span> + builder);
        builder.userDetailsService(userDetailsService());
    }

    <span class="hljs-comment">//ä½œç”¨: ç”¨æ¥å°†è‡ªå®šä¹‰AuthenticationManageråœ¨å·¥å‚ä¸­è¿›è¡Œæš´éœ²,å¯ä»¥åœ¨ä»»ä½•ä½ç½®æ³¨å…¥</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();
    }
}

</code></pre>
</li>
</ul>
<h5>è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</h5>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span>{
        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span>
                <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();
        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">u1</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"zhangs"</span>)
                .password(<span class="hljs-string">"{noop}111"</span>).roles(<span class="hljs-string">"USER"</span>).build();
        inMemoryUserDetailsManager.createUser(u1);
        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> 
      <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userDetailsService());
    }  	
}
</code></pre>
<h5>è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº</h5>
<ul>
<li>
<p>è®¾è®¡è¡¨ç»“æ„</p>
<pre><code class="hljs language-scss">-- ç”¨æˆ·è¡¨
CREATE <span class="hljs-selector-tag">TABLE</span> `user`
(
    `id`                    int(<span class="hljs-number">11</span>) NOT NULL AUTO_INCREMENT,
    `username`              <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>)  DEFAULT NULL,
    `password`              <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) DEFAULT NULL,
    `enabled`               <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">1</span>) DEFAULT NULL,
    `accountNonExpired`     <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">1</span>) DEFAULT NULL,
    `accountNonLocked`      <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">1</span>) DEFAULT NULL,
    `credentialsNonExpired` <span class="hljs-built_in">tinyint</span>(<span class="hljs-number">1</span>) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=<span class="hljs-number">4</span> DEFAULT CHARSET=utf8;
-- è§’è‰²è¡¨
CREATE <span class="hljs-selector-tag">TABLE</span> `role`
(
    `id`      int(<span class="hljs-number">11</span>) NOT NULL AUTO_INCREMENT,
    `name`    <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) DEFAULT NULL,
    `name_zh` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=<span class="hljs-number">4</span> DEFAULT CHARSET=utf8;
-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE <span class="hljs-selector-tag">TABLE</span> `user_role`
(
    `id`  int(<span class="hljs-number">11</span>) NOT NULL AUTO_INCREMENT,
    `uid` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
    `rid` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
    PRIMARY KEY (`id`),
    KEY   `uid` (`uid`),
    KEY   `rid` (`rid`)
) ENGINE=InnoDB AUTO_INCREMENT=<span class="hljs-number">5</span> DEFAULT CHARSET=utf8;
</code></pre>
</li>
<li>
<p>æ’å…¥æµ‹è¯•æ•°æ®</p>
<pre><code class="hljs language-sql"><span class="hljs-comment">-- æ’å…¥ç”¨æˆ·æ•°æ®</span>
<span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'root'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'admin'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'blr'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- æ’å…¥è§’è‰²æ•°æ®</span>
<span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-keyword">INSERT INTO</span> `role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'ROLE_product'</span>, <span class="hljs-string">'å•†å“ç®¡ç†å‘˜'</span>);
  <span class="hljs-keyword">INSERT INTO</span> `role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'ROLE_admin'</span>, <span class="hljs-string">'ç³»ç»Ÿç®¡ç†å‘˜'</span>);
  <span class="hljs-keyword">INSERT INTO</span> `role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'ROLE_user'</span>, <span class="hljs-string">'ç”¨æˆ·ç®¡ç†å‘˜'</span>);
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®</span>
<span class="hljs-keyword">BEGIN</span>;
  <span class="hljs-keyword">INSERT INTO</span> `user_role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  <span class="hljs-keyword">INSERT INTO</span> `user_role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
  <span class="hljs-keyword">INSERT INTO</span> `user_role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
  <span class="hljs-keyword">INSERT INTO</span> `user_role`
  <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
</li>
<li>
<p>é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.mybatis.spring.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mybatis-spring-boot-starter<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>2.2.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>mysql<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mysql-connector-java<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>5.1.38<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>com.alibaba<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>druid<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>1.2.7<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
</li>
<li>
<p>é…ç½® springboot é…ç½®æ–‡ä»¶</p>
<pre><code class="hljs language-ini"><span class="hljs-comment"># datasource</span>
<span class="hljs-attr">spring.datasource.type</span>=com.alibaba.druid.pool.DruidDataSource
<span class="hljs-attr">spring.datasource.driver-class-name</span>=com.mysql.jdbc.Driver
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/security?characterEncoding=UTF-<span class="hljs-number">8</span>&#x26;useSSL=<span class="hljs-literal">false</span>
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root

<span class="hljs-comment"># mybatis</span>
<span class="hljs-attr">mybatis.mapper-locations</span>=classpath:com/baizhi/mapper/*.xml
<span class="hljs-attr">mybatis.type-aliases-package</span>=com.baizhi.entity

<span class="hljs-comment"># log</span>
<span class="hljs-attr">logging.level.com.baizhi</span>=debug
</code></pre>
</li>
<li>
<p>åˆ›å»º entity</p>
<ul>
<li>
<p>åˆ›å»º user å¯¹è±¡</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> username;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> enabled;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> accountNonExpired;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> accountNonLocked;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Boolean</span> credentialsNonExpired;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&#x3C;>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&#x3C;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>> <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) {
        <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">GrantedAuthority</span>> grantedAuthorities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&#x3C;>();
        roles.<span class="hljs-title function_">forEach</span>(role->grantedAuthorities.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(role.<span class="hljs-title function_">getName</span>())));
        <span class="hljs-keyword">return</span> grantedAuthorities;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> accountNonExpired;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> accountNonLocked;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> credentialsNonExpired;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> enabled;
    }
		<span class="hljs-comment">//get/set....</span>
}
</code></pre>
</li>
<li>
<p>åˆ›å»º role å¯¹è±¡</p>
<pre><code class="hljs language-vbnet"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Role {
    <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> nameZh;
  	//<span class="hljs-keyword">get</span> <span class="hljs-keyword">set</span>..
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>åˆ›å»º UserDao æ¥å£</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Mapper</span>
public interface UserDao {
    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·</span>
    User <span class="hljs-built_in">loadUserByUsername</span>(String username);
  	
  	<span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢è§’è‰²</span>
  	List&#x3C;Role> <span class="hljs-built_in">getRolesByUid</span>(Integer uid);
}
</code></pre>
</li>
<li>
<p>åˆ›å»º UserMapper å®ç°</p>
<pre><code class="hljs language-xml"><span class="hljs-meta">&#x3C;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?></span>
<span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.baizhi.dao.UserDao"</span>></span>
    <span class="hljs-comment">&#x3C;!--æŸ¥è¯¢å•ä¸ª--></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"loadUserByUsername"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span>></span>
        select id,
               username,
               password,
               enabled,
               accountNonExpired,
               accountNonLocked,
               credentialsNonExpired
        from user
        where username = #{username}
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">select</span>></span>

    <span class="hljs-comment">&#x3C;!--æŸ¥è¯¢æŒ‡å®šè¡Œæ•°æ®--></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getRolesByUid"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Role"</span>></span>
        select r.id,
               r.name,
               r.name_zh nameZh
        from role r,
             user_role ur
        where r.id = ur.rid
          and ur.uid = #{uid}
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">select</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">mapper</span>></span>
</code></pre>
</li>
<li>
<p>åˆ›å»º UserDetailService å®ä¾‹</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyUserDetailService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> {

    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">final</span> UserDao userDao;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetailService</span><span class="hljs-params">(UserDao userDao)</span> {
        <span class="hljs-built_in">this</span>.userDao = userDao;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userDao.loadUserByUsername(username);
        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(user))<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ç”¨æˆ·ä¸å­˜åœ¨"</span>);
        user.setRoles(userDao.getRolesByUid(user.getId()));
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
</li>
<li>
<p>é…ç½® authenticationManager ä½¿ç”¨è‡ªå®šä¹‰UserDetailService</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDetailsService userDetailsService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebSecurityConfigurer</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> {
        <span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception {
        builder.userDetailsService(userDetailsService);
    }
  
  	
  	<span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
      <span class="hljs-comment">//web security..</span>
    }
}
</code></pre>
</li>
<li>
<p>å¯åŠ¨æµ‹è¯•å³å¯</p>
</li>
</ul>
<hr>
<h4>æ·»åŠ è®¤è¯éªŒè¯ç </h4>
<h5>é…ç½®éªŒè¯ç </h5>
<pre><code class="hljs language-typescript">&#x3C;dependency>
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>com.github.penggle<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span></span>
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>kaptcha<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span></span>
  <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>2.3.2<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span></span>
&#x3C;/dependency>


<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Producer</span> <span class="hljs-title function_">kaptcha</span>(<span class="hljs-params"></span>) {
        <span class="hljs-title class_">Properties</span> properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">"kaptcha.image.width"</span>, <span class="hljs-string">"150"</span>);
        properties.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">"kaptcha.image.height"</span>, <span class="hljs-string">"50"</span>);
        properties.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">"kaptcha.textproducer.char.string"</span>, <span class="hljs-string">"0123456789"</span>);
        properties.<span class="hljs-title function_">setProperty</span>(<span class="hljs-string">"kaptcha.textproducer.char.length"</span>, <span class="hljs-string">"4"</span>);
        <span class="hljs-title class_">Config</span> config = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>(properties);
        <span class="hljs-title class_">DefaultKaptcha</span> defaultKaptcha = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultKaptcha</span>();
        defaultKaptcha.<span class="hljs-title function_">setConfig</span>(config);
        <span class="hljs-keyword">return</span> defaultKaptcha;
    }
}
</code></pre>
<h5>ä¼ ç»Ÿ web å¼€å‘</h5>
<ul>
<li>
<p>ç”ŸæˆéªŒè¯ç  controller</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Producer producer;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaController</span><span class="hljs-params">(Producer producer)</span> {
        <span class="hljs-built_in">this</span>.producer = producer;
    }

    <span class="hljs-meta">@GetMapping("/vc.jpg")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getVerifyCode</span><span class="hljs-params">(HttpServletResponse response, HttpSession session)</span> <span class="hljs-keyword">throws</span> IOException {
        response.setContentType(<span class="hljs-string">"image/png"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> producer.createText();
        session.setAttribute(<span class="hljs-string">"kaptcha"</span>, code);<span class="hljs-comment">//å¯ä»¥æ›´æ¢æˆ redis å®ç°</span>
        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">bi</span> <span class="hljs-operator">=</span> producer.createImage(code);
        <span class="hljs-type">ServletOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> response.getOutputStream();
        ImageIO.write(bi, <span class="hljs-string">"jpg"</span>, os);
    }
}
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaNotMatchException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthenticationException</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg)</span> {
        <span class="hljs-built_in">super</span>(msg);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg, Throwable cause)</span> {
        <span class="hljs-built_in">super</span>(msg, cause);
    }
}
</code></pre>
</li>
<li>
<p>è‡ªå®šä¹‰filteréªŒè¯éªŒè¯ç </p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UsernamePasswordAuthenticationFilter</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">KAPTCHA_KEY</span> = <span class="hljs-string">"kaptcha"</span>;<span class="hljs-comment">//é»˜è®¤å€¼</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> kaptcha = <span class="hljs-variable constant_">KAPTCHA_KEY</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getKaptcha</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> kaptcha;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setKaptcha</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> kaptcha</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">kaptcha</span> = kaptcha;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-title function_">attemptAuthentication</span>(<span class="hljs-title class_">HttpServletRequest</span> request, <span class="hljs-title class_">HttpServletResponse</span> response) throws <span class="hljs-title class_">AuthenticationException</span> {
        <span class="hljs-comment">//1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼</span>
        <span class="hljs-keyword">if</span> (request.<span class="hljs-title function_">getMethod</span>().<span class="hljs-title function_">equals</span>(<span class="hljs-string">"POST"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">"Authentication method not supported: "</span> + request.<span class="hljs-title function_">getMethod</span>());
        }
        <span class="hljs-comment">//2.è·å–éªŒè¯ç </span>
        <span class="hljs-title class_">String</span> kaptcha = request.<span class="hljs-title function_">getParameter</span>(<span class="hljs-title function_">getKaptcha</span>());
        <span class="hljs-title class_">String</span> sessionKaptcha = (<span class="hljs-title class_">String</span>) request.<span class="hljs-title function_">getSession</span>().<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">"kaptcha"</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">ObjectUtils</span>.<span class="hljs-title function_">isEmpty</span>(kaptcha) &#x26;&#x26; !<span class="hljs-title class_">ObjectUtils</span>.<span class="hljs-title function_">isEmpty</span>(sessionKaptcha) &#x26;&#x26;
                kaptcha.<span class="hljs-title function_">equalsIgnoreCase</span>(sessionKaptcha)) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">attemptAuthentication</span>(request, response);
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">"éªŒè¯ç è¾“å…¥é”™è¯¯!"</span>);
    }
}
</code></pre>
</li>
<li>
<p>æ”¾è¡Œä»¥åŠé…ç½®éªŒè¯ç  filter</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSecurityConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDetailsService userDetailsService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebSecurityConfigurer</span><span class="hljs-params">(UserDetailsService userDetailsService)</span> {
        <span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> <span class="hljs-keyword">throws</span> Exception {
        builder.userDetailsService(userDetailsService);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KaptchaFilter <span class="hljs-title function_">kaptchaFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">KaptchaFilter</span> <span class="hljs-variable">kaptchaFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaFilter</span>();
        <span class="hljs-comment">//æŒ‡å®šæ¥æ”¶éªŒè¯ç è¯·æ±‚å‚æ•°å</span>
        kaptchaFilter.setKaptcha(<span class="hljs-string">"kaptcha"</span>);
        <span class="hljs-comment">//æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span>
        kaptchaFilter.setAuthenticationManager(authenticationManagerBean());
        <span class="hljs-comment">//æŒ‡å®šè®¤è¯æˆåŠŸå’Œå¤±è´¥å¤„ç†</span>
        kaptchaFilter.setAuthenticationSuccessHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationSuccessHandler</span>());
        kaptchaFilter.setAuthenticationFailureHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAuthenticationFailureHandler</span>());
        <span class="hljs-comment">//æŒ‡å®šå¤„ç†ç™»å½•</span>
        kaptchaFilter.setFilterProcessesUrl(<span class="hljs-string">"/doLogin"</span>);
        kaptchaFilter.setUsernameParameter(<span class="hljs-string">"uname"</span>);
        kaptchaFilter.setPasswordParameter(<span class="hljs-string">"passwd"</span>);
        <span class="hljs-keyword">return</span> kaptchaFilter;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeHttpRequests()
                .mvcMatchers(<span class="hljs-string">"/vc.jpg"</span>).permitAll()
                .mvcMatchers(<span class="hljs-string">"/login.html"</span>).permitAll()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .loginPage(<span class="hljs-string">"/login.html"</span>)
              	...
        http.addFilterAt(kaptchaFilter(), UsernamePasswordAuthenticationFilter.class);
    }
}
</code></pre>
</li>
<li>
<p>ç™»å½•é¡µé¢æ·»åŠ éªŒè¯ç </p>
<pre><code class="hljs language-ini">&#x3C;form <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> th:action=<span class="hljs-string">"@{/doLogin}"</span>>
    ç”¨æˆ·å:&#x3C;input <span class="hljs-attr">name</span>=<span class="hljs-string">"uname"</span> type=<span class="hljs-string">"text"</span>/>&#x3C;br>
    å¯†ç :&#x3C;input <span class="hljs-attr">name</span>=<span class="hljs-string">"passwd"</span> type=<span class="hljs-string">"password"</span>/>&#x3C;br>
    éªŒè¯ç : &#x3C;input <span class="hljs-attr">name</span>=<span class="hljs-string">"kaptcha"</span> type=<span class="hljs-string">"text"</span>/> &#x3C;img alt=<span class="hljs-string">""</span> th:src=<span class="hljs-string">"@{/vc.jpg}"</span>>&#x3C;br>
    &#x3C;input <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"ç™»å½•"</span>/>
&#x3C;/form>
</code></pre>
</li>
</ul>
<h5>å‰åç«¯åˆ†ç¦»å¼€å‘</h5>
<ul>
<li>
<p>ç”ŸæˆéªŒè¯ç  controller</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Producer producer;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaController</span><span class="hljs-params">(Producer producer)</span> {
        <span class="hljs-built_in">this</span>.producer = producer;
    }

    <span class="hljs-meta">@GetMapping("/vc.png")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getVerifyCode</span><span class="hljs-params">(HttpSession session)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">//1.ç”ŸæˆéªŒè¯ç </span>
        <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> producer.createText();
        session.setAttribute(<span class="hljs-string">"kaptcha"</span>, code);<span class="hljs-comment">//å¯ä»¥æ›´æ¢æˆ redis å®ç°</span>
        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">bi</span> <span class="hljs-operator">=</span> producer.createImage(code);
        <span class="hljs-comment">//2.å†™å…¥å†…å­˜</span>
        <span class="hljs-type">FastByteArrayOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastByteArrayOutputStream</span>();
        ImageIO.write(bi, <span class="hljs-string">"png"</span>, fos);
        <span class="hljs-comment">//3.ç”Ÿæˆ base64</span>
        <span class="hljs-keyword">return</span> Base64.encodeBase64String(fos.toByteArray());
    }
}
</code></pre>
</li>
<li>
<p>å®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaNotMatchException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthenticationException</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg)</span> {
        <span class="hljs-built_in">super</span>(msg);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KaptchaNotMatchException</span><span class="hljs-params">(String msg, Throwable cause)</span> {
        <span class="hljs-built_in">super</span>(msg, cause);
    }
}
</code></pre>
</li>
<li>
<p>åœ¨è‡ªå®šä¹‰LoginKaptchaFilterä¸­åŠ å…¥éªŒè¯ç éªŒè¯</p>
<pre><code class="hljs language-java"><span class="hljs-comment">//è‡ªå®šä¹‰ filter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginKaptchaFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UsernamePasswordAuthenticationFilter</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FORM_KAPTCHA_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"kaptcha"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">kaptchaParameter</span> <span class="hljs-operator">=</span> FORM_KAPTCHA_KEY;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getKaptchaParameter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> kaptchaParameter;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setKaptchaParameter</span><span class="hljs-params">(String kaptchaParameter)</span> {
        <span class="hljs-built_in">this</span>.kaptchaParameter = kaptchaParameter;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException {
        <span class="hljs-keyword">if</span> (!request.getMethod().equals(<span class="hljs-string">"POST"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationServiceException</span>(<span class="hljs-string">"Authentication method not supported: "</span> + request.getMethod());
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//1.è·å–è¯·æ±‚æ•°æ®</span>
            Map&#x3C;String, String> userInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);
            <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> userInfo.get(getKaptchaParameter());<span class="hljs-comment">//ç”¨æ¥è·å–æ•°æ®ä¸­éªŒè¯ç </span>
            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> userInfo.get(getUsernameParameter());<span class="hljs-comment">//ç”¨æ¥æ¥æ”¶ç”¨æˆ·å</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> userInfo.get(getPasswordParameter());<span class="hljs-comment">//ç”¨æ¥æ¥æ”¶å¯†ç </span>
            <span class="hljs-comment">//2.è·å– session ä¸­éªŒè¯ç </span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sessionVerifyCode</span> <span class="hljs-operator">=</span> (String) request.getSession().getAttribute(<span class="hljs-string">"kaptcha"</span>);
            <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &#x26;&#x26; !ObjectUtils.isEmpty(sessionVerifyCode) &#x26;&#x26;
                    kaptcha.equalsIgnoreCase(sessionVerifyCode)) {
                <span class="hljs-comment">//3.è·å–ç”¨æˆ·å å’Œå¯†ç è®¤è¯</span>
                <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);
                setDetails(request, authRequest);
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);
            }
        } <span class="hljs-keyword">catch</span> (IOException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KaptchaNotMatchException</span>(<span class="hljs-string">"éªŒè¯ç ä¸åŒ¹é…!"</span>);
    }
}
</code></pre>
</li>
<li>
<p>é…ç½®</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    <span class="hljs-comment">//è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</span>
    <span class="hljs-keyword">@Bean</span>
    public UserDetailsService userDetailsService() {
        InMemoryUserDetailsManager inMemoryUserDetailsManager = new <span class="hljs-built_in">InMemoryUserDetailsManager</span>();
        inMemoryUserDetailsManager<span class="hljs-selector-class">.createUser</span>(User.withUsername("root")<span class="hljs-selector-class">.password</span>("{noop}<span class="hljs-number">123</span>")<span class="hljs-selector-class">.roles</span>("admin")<span class="hljs-selector-class">.build</span>());
        return inMemoryUserDetailsManager;
    }

    <span class="hljs-keyword">@Override</span>
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth<span class="hljs-selector-class">.userDetailsService</span>(userDetailsService());
    }

    <span class="hljs-keyword">@Override</span>
    <span class="hljs-keyword">@Bean</span>
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super<span class="hljs-selector-class">.authenticationManagerBean</span>();
    }

    <span class="hljs-comment">//é…ç½®</span>
    <span class="hljs-keyword">@Bean</span>
    public LoginKaptchaFilter loginKaptchaFilter() throws Exception {
        LoginKaptchaFilter loginKaptchaFilter = new <span class="hljs-built_in">LoginKaptchaFilter</span>();
        <span class="hljs-comment">//1.è®¤è¯ url</span>
        loginKaptchaFilter<span class="hljs-selector-class">.setFilterProcessesUrl</span>("/doLogin");
        <span class="hljs-comment">//2.è®¤è¯ æ¥æ”¶å‚æ•°</span>
        loginKaptchaFilter<span class="hljs-selector-class">.setUsernameParameter</span>("uname");
        loginKaptchaFilter<span class="hljs-selector-class">.setPasswordParameter</span>("passwd");
        loginKaptchaFilter<span class="hljs-selector-class">.setKaptchaParameter</span>("kaptcha");
        <span class="hljs-comment">//3.æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span>
        loginKaptchaFilter<span class="hljs-selector-class">.setAuthenticationManager</span>(authenticationManagerBean());
        <span class="hljs-comment">//4.æŒ‡å®šæˆåŠŸæ—¶å¤„ç†</span>
        loginKaptchaFilter<span class="hljs-selector-class">.setAuthenticationSuccessHandler</span>((req, resp, authentication) -> {
            Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;String, <span class="hljs-selector-tag">Object</span>>();
            result<span class="hljs-selector-class">.put</span>("msg", "ç™»å½•æˆåŠŸ");
            result<span class="hljs-selector-class">.put</span>("ç”¨æˆ·ä¿¡æ¯", authentication.getPrincipal());
            resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
            resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.OK.value());
            String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
            resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
        });
        <span class="hljs-comment">//5.è®¤è¯å¤±è´¥å¤„ç†</span>
        loginKaptchaFilter<span class="hljs-selector-class">.setAuthenticationFailureHandler</span>((req, resp, ex) -> {
            Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;String, <span class="hljs-selector-tag">Object</span>>();
            result<span class="hljs-selector-class">.put</span>("msg", "ç™»å½•å¤±è´¥: " + ex.getMessage());
            resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR.value());
            resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
            String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
            resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
        });
        return loginKaptchaFilter;
    }

    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/vc.jpg")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.exceptionHandling</span>()
                <span class="hljs-selector-class">.authenticationEntryPoint</span>((req, resp, ex) -> {
                    resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
                    resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.UNAUTHORIZED.value());
                    resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>("å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®!");
                })
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.logout</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();

        http<span class="hljs-selector-class">.addFilterAt</span>(loginKaptchaFilter(), UsernamePasswordAuthenticationFilter<span class="hljs-selector-class">.class</span>);
    }

</code></pre>
</li>
<li>
<p>æµ‹è¯•éªŒè¯</p>
</li>
</ul>
<h2>ç¬¬å››ç«  å¯†ç åŠ å¯†</h2>
<ul>
<li>å¯†ç ä¸ºä»€ä¹ˆè¦åŠ å¯†</li>
<li>å¸¸è§åŠ å¯†çš„è§£å†³æ–¹æ¡ˆ</li>
<li>PasswordEncoder è¯¦è§£</li>
<li>ä¼˜é›…ä½¿ç”¨åŠ å¯†</li>
</ul>
<h3>ç®€ä»‹</h3>
<h4>åŠ å¯†æ„ä¹‰</h4>
<p>â€‹ 2011 å¹´12æœˆ21 æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å«600ä¸‡ä¸ª CSDN ç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”Ÿå CSDN åœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºäº†å£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“ç³»2009 å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„æ¼ï¼Œå·²ç»å‘è­¦æ–¹æŠ¥<br>
æ¡ˆï¼Œååˆåœ¨å®˜ç½‘å‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äº CSDN æŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„æ¼å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚ç”±äºæœ‰äº†è¿™ä¹ˆå¤šå‰è½¦ä¹‹é‰´ï¼Œæˆ‘ä»¬ç°åœ¨åšç³»ç»Ÿæ—¶ï¼Œå¯†ç éƒ½è¦åŠ å¯†å¤„ç†ã€‚</p>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œå‡¡æ˜¯æ¶‰åŠå¯†ç çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨æ˜æ–‡å­˜å‚¨ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™è‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥æé«˜çš„å®‰å…¨é£é™©ã€‚åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¯†ç ä¸ä»…éœ€è¦åŠ å¯†ï¼Œè¿˜éœ€è¦åŠ <code>ç›</code>ï¼Œæœ€å¤§ç¨‹åº¦åœ°ä¿è¯å¯†ç å®‰å…¨ã€‚</p>
<h4>å¸¸è§æ–¹æ¡ˆ</h4>
<h5>Hash ç®—æ³•</h5>
<p>â€‹ æœ€æ—©æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼ SHA-256 ã€SHA-512 ã€MD5ç­‰è¿™æ ·çš„å•å‘ Hash ç®—æ³•ã€‚ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œä¿å­˜åœ¨æ•°æ®åº“ä¸­ä¸å†æ˜¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œè€Œæ˜¯ç»è¿‡ SHA-256 åŠ å¯†è®¡ç®—çš„ä¸€ä¸ªå­—è¡Œä¸²ï¼Œå½“ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç ç”¨ SHA-256 è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆä¹‹åï¼Œå†å’Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œè¿›è€Œç¡®å®šç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœç³»ç»Ÿé­é‡æ”»å‡»ï¼Œæœ€å¤šä¹Ÿåªæ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†æ–‡è¢«æ³„æ¼ã€‚</p>
<p>â€‹ è¿™æ ·å°±ç»å¯¹å®‰å…¨äº†å—ï¼Ÿç”±äºå½©è™¹è¡¨è¿™ç§æ”»å‡»æ–¹å¼çš„å­˜åœ¨ä»¥åŠéšç€è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•ï¼Œæ¯ç§’æ‰§è¡Œæ•°åäº¿æ¬¡ HASHè®¡ç®—å·±ç»å˜å¾—è½»è½»æ¾æ¾ï¼Œè¿™æ„å‘³ç€å³ä½¿ç»™å¯†ç åŠ å¯†åŠ ç›ä¹Ÿä¸å†å®‰å…¨ã€‚</p>
<p>å‚è€ƒ: <a href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin">[å½©è™¹è¡¨]</a></p>
<h5>å•å‘è‡ªé€‚åº”å‡½æ•°</h5>
<p>åœ¨Spring Security ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯ç”¨ä¸€ç§è‡ªé€‚åº”å•å‘å‡½æ•° (Adaptive One-way Functions)æ¥å¤„ç†å¯†ç é—®é¢˜ï¼Œè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åœ¨è¿›è¡Œå¯†ç åŒ¹é…æ—¶ï¼Œä¼šæœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼ˆä¾‹å¦‚CPUã€å†…å­˜ç­‰ï¼‰ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ¶æ„ç”¨æˆ·æ”»å‡»ç³»ç»Ÿçš„éš¾åº¦ã€‚åœ¨Spring Securiy ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ bcryptã€PBKDF2ã€sCrypt ä»¥åŠ argon2 æ¥ä½“éªŒè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åŠ å¯†ã€‚ç”±äºè‡ªé€‚åº”å•å‘å‡½æ•°æœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼Œå› æ­¤æ¯ä¸ªç™»å½•è®¤è¯è¯·æ±‚éƒ½ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä½†æ˜¯ Spring Secuity ä¸ä¼šé‡‡å–ä»»ä½•æªæ–½æ¥æé«˜å¯†ç éªŒè¯é€Ÿåº¦ï¼Œå› ä¸ºå®ƒæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
<p>å‚è€ƒ 1: <a href="https://byronhe.gitbooks.io/libsodium/content/password_hashing/">https://byronhe.gitbooks.io/libsodium/content/password_hashing/</a></p>
<p>å‚è€ƒ 2: <a href="https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md">https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md</a></p>
<ul>
<li>
<p>BCryptPasswordEncoder</p>
<p>BCryptPasswordEncoder ä½¿ç”¨ bcrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œä¸ºäº†æé«˜å¯†ç çš„å®‰å…¨æ€§ï¼Œbcryptç®—æ³•æ•…æ„é™ä½è¿è¡Œé€Ÿåº¦ï¼Œä»¥å¢å¼ºå¯†ç ç ´è§£çš„éš¾åº¦ã€‚åŒæ—¶ BCryptP asswordEncoder â€œä¸ºè‡ªå·±å¸¦ç›â€å¼€å‘è€…ä¸éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªâ€œç›â€ å­—æ®µï¼Œä½¿ç”¨ BCryptPasswordEncoder åŠ å¯†åçš„å­—ç¬¦ä¸²å°±å·²ç»â€œå¸¦ç›â€äº†ï¼Œå³ä½¿ç›¸åŒçš„æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„åŠ å¯†å­—ç¬¦ä¸²éƒ½ä¸ç›¸åŒã€‚</p>
</li>
<li>
<p>Argon2PasswordEncoder</p>
<p>Argon2PasswordEncoder ä½¿ç”¨ Argon2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼ŒArgon2 æ›¾åœ¨ Password Hashing Competition ç«èµ›ä¸­è·èƒœã€‚ä¸ºäº†è§£å†³åœ¨å®šåˆ¶ç¡¬ä»¶ä¸Šå¯†ç å®¹æ˜“è¢«ç ´è§£çš„é—®é¢˜ï¼ŒArgon2ä¹Ÿæ˜¯æ•…æ„é™ä½è¿ç®—é€Ÿåº¦ï¼ŒåŒæ—¶éœ€è¦å¤§é‡å†…å­˜ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>
</li>
<li>
<p>Pbkdf2PasswordEncoder</p>
<p>Pbkdf2PasswordEncoder ä½¿ç”¨ PBKDF2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢å‡ ç§ç±»ä¼¼ï¼ŒPBKDF2</p>
<p>ç®—æ³•ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œå½“éœ€è¦ FIPS (Federal Information Processing Standard,ç¾å›½è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ï¼‰è®¤è¯æ—¶ï¼ŒPBKDF2 ç®—æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>
</li>
<li>
<p>SCryptPasswordEncoder</p>
<p>SCryptPasswordEncoder ä½¿ç”¨scrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢çš„å‡ ç§ç±»ä¼¼ï¼Œserypt ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œè€Œä¸”éœ€è¦å¤§é‡å†…å­˜ã€‚</p>
</li>
</ul>
<h3>PasswordEncoder</h3>
<p>é€šè¿‡å¯¹è®¤è¯æµç¨‹æºç åˆ†æå¾—çŸ¥ï¼Œå®é™…å¯†ç æ¯”è¾ƒæ˜¯ç”±PasswordEncoderå®Œæˆçš„ï¼Œå› æ­¤åªéœ€è¦ä½¿ç”¨PasswordEncoder ä¸åŒå®ç°å°±å¯ä»¥å®ç°ä¸åŒæ–¹å¼åŠ å¯†ã€‚</p>
<pre><code class="hljs language-arduino"><span class="hljs-keyword">public</span> interface PasswordEncoder {
	<span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">encode</span><span class="hljs-params">(CharSequence rawPassword)</span></span>;
	<span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(CharSequence rawPassword, <span class="hljs-type">String</span> encodedPassword)</span></span>;
	<span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title">upgradeEncoding</span><span class="hljs-params">(<span class="hljs-type">String</span> encodedPassword)</span> </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	}
}
</code></pre>
<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<p>é»˜è®¤æä¾›åŠ å¯†ç®—æ³•å¦‚ä¸‹:</p>
<p><img src="https://img-blog.csdnimg.cn/f7d6283f494f4315976a6a5592aed02f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/f858267f116b4980a1feeef9b654c74b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3>DelegatingPasswordEncoder</h3>
<p>æ ¹æ®ä¸Šé¢ PasswordEncoderçš„ä»‹ç»ï¼Œå¯èƒ½ä¼šä»¥ä¸º Spring security ä¸­é»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆåº”è¯¥æ˜¯å››ç§è‡ªé€‚åº”å•å‘åŠ å¯†å‡½æ•°ä¸­çš„ä¸€ç§ï¼Œå…¶å®ä¸ç„¶ï¼Œåœ¨ spring Security 5.0ä¹‹åï¼Œé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå…¶å®æ˜¯ DelegatingPasswordEncoderã€‚ä»åå­—ä¸Šæ¥çœ‹ï¼ŒDelegatingPaswordEncoder æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œå¹¶éä¸€ç§å…¨æ–°çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼ŒDeleggtinePasswordEncoder ä¸»è¦ç”¨æ¥ä»£ç†ä¸Šé¢ä»‹ç»çš„ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚ä¸ºä»€ä¹ˆé‡‡DelegatingPasswordEncoder è€Œä¸æ˜¯æŸä¸€ä¸ªå…·ä½“åŠ å¯†æ–¹å¼ä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå‘¢ï¼Ÿä¸»è¦è€ƒè™‘äº†å¦‚ä¸‹ä¸¤æ–¹é¢çš„å› ç´ ï¼š</p>
<ul>
<li>
<p>å…¼å®¹æ€§ï¼šä½¿ç”¨ DelegatingPasswrordEncoder å¯ä»¥å¸®åŠ©è®¸å¤šä½¿ç”¨æ—§å¯†ç åŠ å¯†æ–¹å¼çš„ç³»ç»Ÿé¡ºåˆ©è¿ç§»åˆ° Spring security ä¸­ï¼Œå®ƒå…è®¸åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šç§ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚</p>
</li>
<li>
<p>ä¾¿æ·æ€§ï¼šå¯†ç å­˜å‚¨çš„æœ€ä½³æ–¹æ¡ˆä¸å¯èƒ½ä¸€ç›´ä¸å˜ï¼Œå¦‚æœä½¿ç”¨ DelegatingPasswordEncoderä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼Œå½“éœ€è¦ä¿®æ”¹åŠ å¯†æ–¹æ¡ˆæ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¾ˆå°ä¸€éƒ¨åˆ†ä»£ç å°±å¯ä»¥å®ç°ã€‚</p>
</li>
</ul>
<h5>DelegatingPasswordEncoderæºç </h5>
<pre><code class="hljs language-perl">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DelegatingPasswordEncoder</span> <span class="hljs-title">implements</span> <span class="hljs-title">PasswordEncoder</span> </span>{
  ....
}
</code></pre>
<ul>
<li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li>
<li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li>
<li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li>
</ul>
<h5>PasswordEncoderFactoriesæºç </h5>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PasswordEncoder <span class="hljs-title function_">createDelegatingPasswordEncoder</span><span class="hljs-params">()</span> {
		<span class="hljs-type">String</span> <span class="hljs-variable">encodingId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"bcrypt"</span>;
		Map&#x3C;String, PasswordEncoder> encoders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&#x3C;>();
		encoders.put(encodingId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>());
		encoders.put(<span class="hljs-string">"ldap"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.LdapShaPasswordEncoder());
		encoders.put(<span class="hljs-string">"MD4"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.Md4PasswordEncoder());
		encoders.put(<span class="hljs-string">"MD5"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">"MD5"</span>));
		encoders.put(<span class="hljs-string">"noop"</span>, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());
		encoders.put(<span class="hljs-string">"pbkdf2"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pbkdf2PasswordEncoder</span>());
		encoders.put(<span class="hljs-string">"scrypt"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SCryptPasswordEncoder</span>());
		encoders.put(<span class="hljs-string">"SHA-1"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">"SHA-1"</span>));
		encoders.put(<span class="hljs-string">"SHA-256"</span>,
				<span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="hljs-string">"SHA-256"</span>));
		encoders.put(<span class="hljs-string">"sha256"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">org</span>.springframework.security.crypto.password.StandardPasswordEncoder());
		encoders.put(<span class="hljs-string">"argon2"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Argon2PasswordEncoder</span>());
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);
	}
</code></pre>
<h3>å¦‚ä½•ä½¿ç”¨ PasswordEncoder</h3>
<ul>
<li>
<p>æŸ¥çœ‹WebSecurityConfigurerAdapterç±»ä¸­æºç </p>
<p>static class LazyPasswordEncoder implements PasswordEncoder {
private ApplicationContext applicationContext;
private PasswordEncoder passwordEncoder;
LazyPasswordEncoder(ApplicationContext applicationContext) {
this.applicationContext = applicationContext;
}
@Override
public String encode(CharSequence rawPassword) {
return getPasswordEncoder().encode(rawPassword);
}</p>
<pre><code class="hljs language-typescript">	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">matches</span>(<span class="hljs-params"><span class="hljs-title class_">CharSequence</span> rawPassword, <span class="hljs-title class_">String</span> encodedPassword</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">getPasswordEncoder</span>().<span class="hljs-title function_">matches</span>(rawPassword, encodedPassword);
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">upgradeEncoding</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> encodedPassword</span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">getPasswordEncoder</span>().<span class="hljs-title function_">upgradeEncoding</span>(encodedPassword);
	}

	<span class="hljs-keyword">private</span> <span class="hljs-title class_">PasswordEncoder</span> <span class="hljs-title function_">getPasswordEncoder</span>(<span class="hljs-params"></span>) {
		<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">passwordEncoder</span> != <span class="hljs-literal">null</span>) {
			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">passwordEncoder</span>;
		}
		<span class="hljs-title class_">PasswordEncoder</span> passwordEncoder = <span class="hljs-title function_">getBeanOrNull</span>(<span class="hljs-title class_">PasswordEncoder</span>.<span class="hljs-property">class</span>);
		<span class="hljs-keyword">if</span> (passwordEncoder == <span class="hljs-literal">null</span>) {
			passwordEncoder = <span class="hljs-title class_">PasswordEncoderFactories</span>.<span class="hljs-title function_">createDelegatingPasswordEncoder</span>();
		}
		<span class="hljs-variable language_">this</span>.<span class="hljs-property">passwordEncoder</span> = passwordEncoder;
		<span class="hljs-keyword">return</span> passwordEncoder;
	}

	<span class="hljs-keyword">private</span> &#x3C;T> T <span class="hljs-title function_">getBeanOrNull</span>(<span class="hljs-params"><span class="hljs-title class_">Class</span>&#x3C;T> <span class="hljs-keyword">type</span></span>) {
		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">applicationContext</span>.<span class="hljs-title function_">getBean</span>(<span class="hljs-keyword">type</span>);
		}
		<span class="hljs-keyword">catch</span> (<span class="hljs-title class_">NoSuchBeanDefinitionException</span> ex) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
		}
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"></span>) {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">getPasswordEncoder</span>().<span class="hljs-title function_">toString</span>();
	}

}
</code></pre>
</li>
</ul>
<p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¦‚æœåœ¨å·¥å‚ä¸­æŒ‡å®šäº†PasswordEncoderï¼Œå°±ä¼šä½¿ç”¨æŒ‡å®šPasswordEncoderï¼Œå¦åˆ™å°±ä¼šä½¿ç”¨é»˜è®¤DelegatingPasswordEncoderã€‚</p>
<h3>å¯†ç åŠ å¯†å®æˆ˜</h3>
<ul>
<li>
<p>æµ‹è¯•ç”Ÿæˆçš„å¯†ç </p>
<p>@Test
public void test() {
//1.BCryptPasswordEncoder
BCryptPasswordEncoder bCryptPasswordEncoder = new BCryptPasswordEncoder();
System.out.println(bCryptPasswordEncoder.encode("123"));</p>
<p>//2.Pbkdf2PasswordEncoder
Pbkdf2PasswordEncoder pbkdf2PasswordEncoder = new Pbkdf2PasswordEncoder();
System.out.println(pbkdf2PasswordEncoder.encode("123"));</p>
<p>//3.SCryptPasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–
SCryptPasswordEncoder sCryptPasswordEncoder = new SCryptPasswordEncoder();
System.out.println(sCryptPasswordEncoder.encode("123"));</p>
<p>//4.Argon2PasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–
Argon2PasswordEncoder argon2PasswordEncoder = new Argon2PasswordEncoder();
System.out.println(argon2PasswordEncoder.encode("123"));
}</p>
</li>
<li>
<p>ä½¿ç”¨å›ºå®šå¯†ç åŠ å¯†æ–¹æ¡ˆ</p>
<p>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
@Bean
public PasswordEncoder BcryptPasswordEncoder() {
return new BCryptPasswordEncoder();
}
@Bean
public UserDetailsService userDetailsService() {
InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
inMemoryUserDetailsManager.createUser(User.withUsername("root").password("$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a").roles("xxx").build());
return inMemoryUserDetailsManager;
}
}</p>
</li>
<li>
<p>ä½¿ç”¨çµæ´»å¯†ç åŠ å¯†æ–¹æ¡ˆ æ¨è</p>
<p>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
@Bean
public UserDetailsService userDetailsService() {
InMemoryUserDetailsManager inMemoryUserDetailsManager = new InMemoryUserDetailsManager();
inMemoryUserDetailsManager.createUser(User.withUsername("root").password("{bcrypt}$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a").roles("xxx").build());
return inMemoryUserDetailsManager;
}
}</p>
</li>
</ul>
<h3>å¯†ç è‡ªåŠ¨å‡çº§</h3>
<p>æ¨èä½¿ç”¨DelegatingPasswordEncoder çš„å¦å¤–ä¸€ä¸ªå¥½å¤„å°±æ˜¯è‡ªåŠ¨è¿›è¡Œå¯†ç åŠ å¯†æ–¹æ¡ˆçš„å‡çº§ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨æ•´åˆä¸€äº›è€çš„ç³»ç»Ÿæ—¶éå¸¸æœ‰ç”¨ã€‚</p>
<ul>
<li>
<p>å‡†å¤‡åº“è¡¨</p>
<p>-- ç”¨æˆ·è¡¨
CREATE TABLE <code>user</code>
(
<code>id</code>                    int(11) NOT NULL AUTO_INCREMENT,
<code>username</code>              varchar(32)  DEFAULT NULL,
<code>password</code>              varchar(255) DEFAULT NULL,
<code>enabled</code>               tinyint(1) DEFAULT NULL,
<code>accountNonExpired</code>     tinyint(1) DEFAULT NULL,
<code>accountNonLocked</code>      tinyint(1) DEFAULT NULL,
<code>credentialsNonExpired</code> tinyint(1) DEFAULT NULL,
PRIMARY KEY (<code>id</code>)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
-- è§’è‰²è¡¨
CREATE TABLE <code>role</code>
(
<code>id</code>      int(11) NOT NULL AUTO_INCREMENT,
<code>name</code>    varchar(32) DEFAULT NULL,
<code>name_zh</code> varchar(32) DEFAULT NULL,
PRIMARY KEY (<code>id</code>)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;
-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE <code>user_role</code>
(
<code>id</code>  int(11) NOT NULL AUTO_INCREMENT,
<code>uid</code> int(11) DEFAULT NULL,
<code>rid</code> int(11) DEFAULT NULL,
PRIMARY KEY (<code>id</code>),
KEY   <code>uid</code> (<code>uid</code>),
KEY   <code>rid</code> (<code>rid</code>)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</p>
</li>
<li>
<p>æ’å…¥æ•°æ®</p>
<p>-- æ’å…¥ç”¨æˆ·æ•°æ®
BEGIN;
INSERT INTO <code>user</code>
VALUES (1, 'root', '{noop}123', 1, 1, 1, 1);
INSERT INTO <code>user</code>
VALUES (2, 'admin', '{noop}123', 1, 1, 1, 1);
INSERT INTO <code>user</code>
VALUES (3, 'blr', '{noop}123', 1, 1, 1, 1);
COMMIT;
-- æ’å…¥è§’è‰²æ•°æ®
BEGIN;
INSERT INTO <code>role</code>
VALUES (1, 'ROLE_product', 'å•†å“ç®¡ç†å‘˜');
INSERT INTO <code>role</code>
VALUES (2, 'ROLE_admin', 'ç³»ç»Ÿç®¡ç†å‘˜');
INSERT INTO <code>role</code>
VALUES (3, 'ROLE_user', 'ç”¨æˆ·ç®¡ç†å‘˜');
COMMIT;
-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®
BEGIN;
INSERT INTO <code>user_role</code>
VALUES (1, 1, 1);
INSERT INTO <code>user_role</code>
VALUES (2, 1, 2);
INSERT INTO <code>user_role</code>
VALUES (3, 2, 2);
INSERT INTO <code>user_role</code>
VALUES (4, 3, 3);
COMMIT;</p>
</li>
<li>
<p>æ•´åˆ mybatis</p>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>5.1.38</version>
</dependency>
<dependency>
  <groupId>org.mybatis.spring.boot</groupId>
  <artifactId>mybatis-spring-boot-starter</artifactId>
  <version>2.2.0</version>
</dependency>
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <version>1.2.8</version>
</dependency>
<p>spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&#x26;serverTimezone=UTC&#x26;useSSL=false
spring.datasource.username=root
spring.datasource.password=root
mybatis.mapper-locations=classpath:/mapper/*.xml
mybatis.type-aliases-package=com.baizhi.entity
logging.level.com.baizhi.dao=debug</p>
</li>
<li>
<p>ç¼–å†™å®ä½“ç±»</p>
<p>public class User implements UserDetails {
private Integer id;
private String username;
private String password;
private Boolean enabled;
private Boolean accountNonExpired;
private Boolean accountNonLocked;
private Boolean credentialsNonExpired;
private List<Role> roles = new ArrayList&#x3C;>();
@Override
public Collection&#x3C;? extends GrantedAuthority> getAuthorities() {
List<SimpleGrantedAuthority> authorities = new ArrayList&#x3C;>();
for (Role role : roles) {
authorities.add(new SimpleGrantedAuthority(role.getName()));
}
return authorities;
}</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> password;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPassword</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> password</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> username;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUsername</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> username</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = username;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> accountNonExpired;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAccountNonExpired</span>(<span class="hljs-params"><span class="hljs-title class_">Boolean</span> accountNonExpired</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountNonExpired</span> = accountNonExpired;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> accountNonLocked;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAccountNonLocked</span>(<span class="hljs-params"><span class="hljs-title class_">Boolean</span> accountNonLocked</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">accountNonLocked</span> = accountNonLocked;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> credentialsNonExpired;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCredentialsNonExpired</span>(<span class="hljs-params"><span class="hljs-title class_">Boolean</span> credentialsNonExpired</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">credentialsNonExpired</span> = credentialsNonExpired;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> enabled;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setEnabled</span>(<span class="hljs-params"><span class="hljs-title class_">Boolean</span> enabled</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span> = enabled;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setRoles</span>(<span class="hljs-params"><span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">roles</span> = roles;
}

<span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> id;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
}
</code></pre>
<p>}</p>
<p>public class Role {
private Integer id;
private String name;
private String nameZh;</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> id;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
}

<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> name;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getNameZh</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> nameZh;
}

<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setNameZh</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> nameZh</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nameZh</span> = nameZh;
}
</code></pre>
<p>}</p>
</li>
<li>
<p>åˆ›å»ºdao</p>
<p>@Mapper
public interface UserDao {
List<Role> getRolesByUid(Integer uid);
User loadUserByUsername(String username);
Integer updatePassword(@Param("username") String username,@Param("password") String password);
}</p>
</li>
<li>
<p>ç¼–å†™ mapper</p>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baizhi.dao.UserDao">
<pre><code class="hljs language-bash">&#x3C;<span class="hljs-keyword">select</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">"loadUserByUsername"</span> resultType=<span class="hljs-string">"User"</span>>
    <span class="hljs-keyword">select</span> <span class="hljs-built_in">id</span>,
           username,
           password,
           enabled,
           accountNonExpired,
           accountNonLocked,
           credentialsNonExpired
    from `user`
    <span class="hljs-built_in">where</span> username = <span class="hljs-comment">#{username}</span>
&#x3C;/select>


&#x3C;<span class="hljs-keyword">select</span> <span class="hljs-built_in">id</span>=<span class="hljs-string">"getRolesByUid"</span> resultType=<span class="hljs-string">"Role"</span>>
    <span class="hljs-keyword">select</span> r.id,
           r.name,
           r.name_zh nameZh
    from `role` r,
         `user_role` ur
    <span class="hljs-built_in">where</span> r.id = ur.rid
      and ur.uid = <span class="hljs-comment">#{uid}</span>
&#x3C;/select>

&#x3C;update <span class="hljs-built_in">id</span>=<span class="hljs-string">"updatePassword"</span>>
  update `user` <span class="hljs-built_in">set</span> password=#{password}
  <span class="hljs-built_in">where</span> username=#{username}
&#x3C;/update>
</code></pre>
</mapper>
</li>
<li>
<p>ç¼–å†™service å®ç°</p>
<p>@Service
public class MyUserDetailService implements UserDetailsService,UserDetailsPasswordService {
private final UserDao userDao;</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">MyUserDetailService</span><span class="hljs-params">(UserDao userDao)</span> {
    <span class="hljs-built_in">this</span>.userDao = userDao;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userDao.loadUserByUsername(username);
    <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(user)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ç”¨æˆ·ä¸å­˜åœ¨!"</span>);
    }
    user.setRoles(userDao.getRolesByUid(user.getId()));
    <span class="hljs-keyword">return</span> user;
}

 <span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(UserDetails user, String newPassword)</span> {
    <span class="hljs-type">Integer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userDao.updatePassword(user.getUsername(), newPassword);
    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span>) {
        ((User) user).setPassword(newPassword);
    }
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½®securityconfig</p>
<p>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MyUserDetailService myUserDetailService;

<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(MyUserDetailService myUserDetailService)</span> {
    <span class="hljs-built_in">this</span>.myUserDetailService = myUserDetailService;
}
  <span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">//æŸ¥è¯¢æ•°æ®åº“</span>
    auth.userDetailsService(myUserDetailService);
}
</code></pre>
<p>}</p>
</li>
<li>
<p>å¯åŠ¨é¡¹ç›®æµ‹è¯•</p>
</li>
</ul>
<h2>ç¬¬äº”ç«  RememberMe</h2>
<ul>
<li>ç®€ä»‹</li>
<li>åŸºæœ¬ä½¿ç”¨</li>
<li>åŸç†åˆ†æ</li>
<li>æŒä¹…åŒ–ä»¤ç‰Œ</li>
</ul>
<h3>ç®€ä»‹</h3>
<p>RememberMe è¿™ä¸ªåŠŸèƒ½éå¸¸å¸¸è§ï¼Œä¸‹å›¾å°±æ˜¯QQ é‚®ç®±ç™»å½•æ—¶çš„â€œè®°ä½æˆ‘â€ é€‰é¡¹ã€‚æåˆ° RememberMeï¼Œä¸€äº›åˆå­¦è€…å¾€å¾€ä¼šæœ‰ä¸€äº›è¯¯è§£ï¼Œè®¤ä¸º RememberMe åŠŸèƒ½å°±æ˜¯æŠŠç”¨æˆ·å/å¯†ç ç”¨ Cookie ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡ç™»å½•æ—¶ä¸ç”¨å†æ¬¡è¾“å…¥ç”¨æˆ·å/å¯†ç ã€‚è¿™ä¸ªç†è§£æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ RememberMe æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯çš„è¡Œä¸ºã€‚ä¼ ç»Ÿçš„ç™»å½•æ–¹å¼åŸºäº Sessionä¼šè¯ï¼Œä¸€æ—¦ç”¨æˆ·çš„ä¼šè¯è¶…æ—¶è¿‡æœŸï¼Œå°±è¦å†æ¬¡ç™»å½•ï¼Œè¿™æ ·å¤ªè¿‡äºçƒ¦çã€‚å¦‚æœèƒ½æœ‰ä¸€ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·ä¼šè¯è¿‡æœŸä¹‹åï¼Œè¿˜èƒ½ç»§ç»­ä¿æŒè®¤è¯çŠ¶æ€ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼ŒRememberMe å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€éœ€æ±‚è€Œç”Ÿçš„ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/2696c87cadf84c019a26deeba726a42a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“çš„å®ç°æ€è·¯å°±æ˜¯é€šè¿‡ Cookie æ¥è®°å½•å½“å‰ç”¨æˆ·èº«ä»½ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œä¼šé€šè¿‡ä¸€å®šç®—æ³•ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´æˆ³ç­‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆåï¼Œé€šè¿‡å“åº”å¤´å¸¦å›å‰ç«¯å­˜å‚¨åœ¨cookieä¸­ï¼Œå½“æµè§ˆå™¨ä¼šè¯è¿‡æœŸä¹‹åï¼Œå¦‚æœå†æ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œä¼šè‡ªåŠ¨å°† Cookie ä¸­çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯¹ Cookieä¸­çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒåˆ†æï¼Œè¿›è€Œç¡®å®šå‡ºç”¨æˆ·çš„èº«ä»½ï¼ŒCookieä¸­æ‰€ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œä¾‹å¦‚ä¸‰å¤©ã€ä¸€å‘¨ç­‰ã€‚</p>
<h3>åŸºæœ¬ä½¿ç”¨</h3>
<h4>å¼€å¯è®°ä½æˆ‘</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    <span class="hljs-comment">//....</span>
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/login.html")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-comment">//...</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
    }
}
</code></pre>
<h4>ä½¿ç”¨è®°ä½æˆ‘</h4>
<p>å¯ä»¥çœ‹åˆ°ä¸€æ—¦æ‰“å¼€äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œç™»å½•é¡µé¢ä¸­ä¼šå¤šå‡ºä¸€ä¸ª RememberMe é€‰é¡¹ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/771334161dd94182b662a35e148f980e.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>æµ‹è¯•è®°ä½æˆ‘</h4>
<p>ç™»å½•æ—¶å‹¾é€‰ RememberMe é€‰é¡¹ï¼Œç„¶åé‡å¯æœåŠ¡ç«¯ä¹‹åï¼Œåœ¨æµ‹è¯•æ¥å£æ˜¯å¦èƒ½å…ç™»å½•è®¿é—®ã€‚</p>
<h3>åŸç†åˆ†æ</h3>
<h4>RememberMeAuthenticationFilter</h4>
<p><img src="https://img-blog.csdnimg.cn/be04bd5dccaa4f6cbf4a029bc0665b1d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä»ä¸Šå›¾ä¸­ï¼Œå½“åœ¨SecurityConfigé…ç½®ä¸­å¼€å¯äº†"è®°ä½æˆ‘"åŠŸèƒ½ä¹‹å,åœ¨è¿›è¡Œè®¤è¯æ—¶å¦‚æœå‹¾é€‰äº†"è®°ä½æˆ‘"é€‰é¡¹ï¼Œæ­¤æ—¶æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåˆ†ææ•´ä¸ªç™»å½•è¿‡ç¨‹ã€‚é¦–å…ˆå½“æˆ‘ä»¬ç™»å½•æ—¶ï¼Œåœ¨ç™»å½•è¯·æ±‚ä¸­å¤šäº†ä¸€ä¸ª RememberMe çš„å‚æ•°ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/25ba66d2540944738cb2261c90e4ac28.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨åº”è¯¥å¼€å¯ RememberMeåŠŸèƒ½çš„ã€‚å¦‚æœè‡ªå®šä¹‰ç™»å½•é¡µé¢å¼€å¯ RememberMe åŠŸèƒ½åº”è¯¥å¤šåŠ å…¥ä¸€ä¸ªä¸€æ ·çš„è¯·æ±‚å‚æ•°å°±å¯ä»¥å•¦ã€‚è¯¥è¯·æ±‚ä¼šè¢« <code>RememberMeAuthenticationFilter</code>è¿›è¡Œæ‹¦æˆªç„¶åè‡ªåŠ¨ç™»å½•å…·ä½“å‚è§æºç :</p>
<p><img src="https://img-blog.csdnimg.cn/0c1cf539f5f84ec881cf9ebb752a3b88.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>
<p>(1ï¼‰è¯·æ±‚åˆ°è¾¾è¿‡æ»¤å™¨ä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­ SecurityContextHolder ä¸­æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼çš„è¯è¡¨ç¤ºç”¨æˆ·å°šæœªç™»å½•ï¼Œæ­¤æ—¶è°ƒç”¨ autoLogin æ–¹æ³•è¿›è¡Œè‡ªåŠ¨ç™»å½•ã€‚</p>
</li>
<li>
<p>(2ï¼‰å½“è‡ªåŠ¨ç™»å½•æˆåŠŸåè¿”å›çš„rememberMeAuth ä¸ä¸ºnull æ—¶ï¼Œè¡¨ç¤ºè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ­¤æ—¶è°ƒç”¨ authenticate æ–¹æ³•å¯¹ key è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸”å°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ç™»å½•æˆåŠŸå›è°ƒï¼Œå¹¶å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç™»å½•æˆåŠŸçš„å›è°ƒå¹¶ä¸åŒ…å« RememberMeServices ä¸­çš„ 1oginSuccess æ–¹æ³•ã€‚</p>
</li>
<li>
<p>(3ï¼‰å¦‚æœè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œåˆ™è°ƒç”¨ remenberMeServices.loginFailæ–¹æ³•å¤„ç†ç™»å½•å¤±è´¥å›è°ƒã€‚onUnsuccessfulAuthentication å’Œ onSuccessfulAuthentication éƒ½æ˜¯è¯¥è¿‡æ»¤å™¨ä¸­å®šä¹‰çš„ç©ºæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å®ç°è¿™å°±æ˜¯ RememberMeAuthenticationFilter è¿‡æ»¤å™¨æ‰€åšçš„äº‹æƒ…ï¼ŒæˆåŠŸå°† RememberMeServicesçš„æœåŠ¡é›†æˆè¿›æ¥ã€‚</p>
</li>
</ul>
<h4>RememberMeServices</h4>
<p>è¿™é‡Œä¸€å…±å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>autoLogin æ–¹æ³•å¯ä»¥ä»è¯·æ±‚ä¸­æå–å‡ºéœ€è¦çš„å‚æ•°ï¼Œå®Œæˆè‡ªåŠ¨ç™»å½•åŠŸèƒ½ã€‚</li>
<li>loginFail æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•å¤±è´¥çš„å›è°ƒã€‚</li>
<li>1oginSuccess æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•æˆåŠŸçš„å›è°ƒã€‚</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/81920123faf54476b1457237083d5d63.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>TokenBasedRememberMeServices</h4>
<p>åœ¨å¼€å¯è®°ä½æˆ‘åå¦‚æœæ²¡æœ‰åŠ å…¥é¢å¤–é…ç½®é»˜è®¤å®ç°å°±æ˜¯ç”±TokenBasedRememberMeServicesè¿›è¡Œçš„å®ç°ã€‚æŸ¥çœ‹è¿™ä¸ªç±»æºç ä¸­ processAutoLoginCookie æ–¹æ³•å®ç°:</p>
<p><img src="https://img-blog.csdnimg.cn/2c0f1b9d54644970809451c3d244d75b.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>processAutoLoginCookie æ–¹æ³•ä¸»è¦ç”¨æ¥éªŒè¯ Cookie ä¸­çš„ä»¤ç‰Œä¿¡æ¯æ˜¯å¦åˆæ³•ï¼š</p>
<ol>
<li>
<p>é¦–å…ˆåˆ¤æ–­ cookieTokens é•¿åº¦æ˜¯å¦ä¸ºäº†ï¼Œä¸ä¸ºäº†è¯´æ˜æ ¼å¼ä¸å¯¹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>ä»cookieTokens æ•°ç»„ä¸­æå–å‡ºç¬¬ 1é¡¹ï¼Œä¹Ÿå°±æ˜¯è¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå·±ç»è¿‡æœŸï¼Œåˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p>æ ¹æ®ç”¨æˆ·å ï¼ˆcookieTokens æ•°ç»„çš„ç¬¬ã€‚é¡¹ï¼‰æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·å¯¹è±¡ã€‚</p>
</li>
<li>
<p>è°ƒç”¨ makeTokenSignature æ–¹æ³•ç”Ÿæˆä¸€ä¸ªç­¾åï¼Œç­¾åçš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆå°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ã€ç”¨æˆ·å¯†ç ä»¥åŠ key ç»„æˆä¸€ä¸ªå®‡ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œï¼šâ€éš”å¼€ï¼Œç„¶åé€šè¿‡ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯¥å®‡ç¬¦ä¸²è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å°†åŠ å¯†ç»“æœè½¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚</p>
</li>
<li>
<p>åˆ¤æ–­ç¬¬4 æ­¥ç”Ÿæˆçš„ç­¾åå’Œé€šè¿‡ Cookie ä¼ æ¥çš„ç­¾åæ˜¯å¦ç›¸ç­‰ï¼ˆå³ cookieTokens æ•°ç»„<br>
çš„ç¬¬2é¡¹ï¼‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºä»¤ç‰Œåˆæ³•ï¼Œåˆ™ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œå¦åˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p>
</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/2588a8e456a348c3a93acf9880acbaf0.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>
<p>åœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œé¦–å…ˆè·å–ç”¨æˆ·ç»å’Œå¯†ç ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·å¯†ç åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåä»successfulAuthenticationå¯¹è±¡ä¸­æ“¦é™¤ï¼Œåˆ™ä»æ•°æ®åº“ä¸­é‡æ–°åŠ è½½å‡ºç”¨æˆ·å¯†ç ã€‚</p>
</li>
<li>
<p>è®¡ç®—å‡ºä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸæ˜¯ä¸¤å‘¨ã€‚</p>
</li>
<li>
<p>æ ¹æ®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€ç”¨æˆ·åä»¥åŠç”¨æˆ·å¯†ç ï¼Œè®¡ç®—å‡ºä¸€ä¸ªç­¾åã€‚</p>
</li>
<li>
<p>è°ƒç”¨ setCookie æ–¹æ³•è®¾ç½® Cookieï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¸€å…±åŒ…å«ä¸‰é¡¹ã€‚ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ä»¥åŠç­¾åï¼Œåœ¨setCookie æ–¹æ³•ä¸­ä¼šå°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œ Base64ç¼–ç åå“åº”ç»™å‰ç«¯ã€‚</p>
</li>
</ol>
<h4>æ€»ç»“</h4>
<p>å½“ç”¨æˆ·é€šè¿‡ç”¨æˆ·å/å¯†ç çš„å½¢å¼ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç ä»¥åŠä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´è®¡ç®—å‡ºä¸€ä¸ªç­¾åï¼Œè¿™ä¸ªç­¾åä½¿ç”¨ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ç”Ÿæˆï¼Œæ˜¯ä¸å¯é€†çš„ã€‚ç„¶åå†å°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ä»¥åŠç­¾åæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œ:â€ éš”å¼€ï¼Œå¯¹æ‹¼æ¥å¥½çš„å­—ç¬¦ä¸²è¿›è¡ŒBase64 ç¼–ç ï¼Œç„¶åå°†ç¼–ç åçš„ç»“æœè¿”å›åˆ°å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°çš„ä»¤ç‰Œã€‚å½“ä¼šè¯è¿‡æœŸä¹‹åï¼Œè®¿é—®ç³»ç»Ÿèµ„æºæ—¶ä¼šè‡ªåŠ¨æºå¸¦ä¸ŠCookieä¸­çš„ä»¤ç‰Œï¼ŒæœåŠ¡ç«¯æ‹¿åˆ° Cookieä¸­çš„ä»¤ç‰Œåï¼Œå…ˆè¿›è¡Œ Bae64è§£ç ï¼Œè§£ç ååˆ†åˆ«æå–å‡ºä»¤ç‰Œä¸­çš„ä¸‰é¡¹æ•°æ®ï¼šæ¥ç€æ ¹æ®ä»¤ç‰Œä¸­çš„æ•°æ®åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™æ ¹æ®ä»¤ç‰Œä¸­çš„ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼šæ¥ç€å†è®¡ç®—å‡ºä¸€ä¸ªç­¾åå’Œä»¤ç‰Œä¸­çš„ç­¾åè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºä¼šç‰Œæ˜¯åˆæ³•ä»¤ç‰Œï¼Œè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œå¦åˆ™è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/d54cf77d55e14f099f6ac18b4948df82.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/e27232b661c2426a877283f498f580f3.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3>å†…å­˜ä»¤ç‰Œ</h3>
<h4>PersistentTokenBasedRememberMeServices</h4>
<p><img src="https://img-blog.csdnimg.cn/91bb878b50e8470b817e9078f30e0de8.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ol>
<li>ä¸åŒäº TokonBasedRemornberMeServices ä¸­çš„ processAutologinCookie æ–¹æ³•ï¼Œè¿™é‡ŒcookieTokens æ•°ç»„çš„é•¿åº¦ä¸º2ï¼Œç¬¬ä¸€é¡¹æ˜¯seriesï¼Œç¬¬äºŒé¡¹æ˜¯ tokenã€‚</li>
<li>ä»cookieTokensæ•°ç»„ä¸­åˆ†åˆ°æå–å‡º series å’Œ tokenï¼ ç„¶åæ ¹æ® series å»å†…å­˜ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ª PersistentRememberMeTokenå¯¹è±¡ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„å¯¹è±¡ä¸ºnullï¼Œè¡¨ç¤ºå†…å­˜ä¸­å¹¶æ²¡æœ‰serieså¯¹åº”çš„å€¼ï¼Œæœ¬æ¬¡è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„ token å’Œä» cookieTokens ä¸­è§£æå‡ºæ¥çš„tokenä¸ç›¸åŒï¼Œè¯´æ˜è‡ªåŠ¨ç™»å½•ä¼šç‰Œå·²ç»æ³„æ¼ï¼ˆæ¶æ„ç”¨æˆ·åˆ©ç”¨ä»¤ç‰Œç™»å½•åï¼Œå†…å­˜ä¸­çš„tokenå˜äº†)ï¼Œæ­¤æ—¶ç§»é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è‡ªåŠ¨ç™»å½•è®°å½•å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>æ ¹æ®æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ç»“æœåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç”Ÿæˆä¸€ä¸ªæ–°çš„ PersistentRememberMeToken å¯¹è±¡ï¼Œç”¨æˆ·åå’Œseries ä¸å˜ï¼Œtoken é‡æ–°<br>
ç”Ÿæˆï¼Œdate ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´ã€‚newToken ç”Ÿæˆåï¼Œæ ¹æ® series å»ä¿®æ”¹å†…å­˜ä¸­çš„ token å’Œ date(å³æ¯æ¬¡è‡ªåŠ¨ç™»å½•åéƒ½ä¼šäº§ç”Ÿæ–°çš„ token å’Œ dateï¼‰</li>
<li>è°ƒç”¨ addCookie æ–¹æ³•æ·»åŠ  Cookieï¼Œ åœ¨addCookie æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢æ‰€è¯´çš„<br>
setCookie æ–¹æ³•ï¼Œä½†æ˜¯è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ•°ç»„å‚æ•°ä¸­åªæœ‰ä¸¤é¡¹ï¼šseries å’Œ tokenï¼ˆå³è¿”å›åˆ°å‰ç«¯çš„ä»¤ç‰Œæ˜¯é€šè¿‡å¯¹ series å’Œ token è¿›è¡Œ Base64 ç¼–ç å¾—åˆ°çš„ï¼‰</li>
<li>æœ€åå°†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡å¹¶è¿”å›ã€‚</li>
</ol>
<h4>ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter { 
<span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span>
                <span class="hljs-selector-class">.rememberMeServices</span>(rememberMeServices())
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
    }

    <span class="hljs-keyword">@Bean</span>
    public RememberMeServices rememberMeServices() {
        return new <span class="hljs-built_in">PersistentTokenBasedRememberMeServices</span>(
          	   "key",//å‚æ•° <span class="hljs-number">1</span>: è‡ªå®šä¹‰ä¸€ä¸ªç”Ÿæˆä»¤ç‰Œ key é»˜è®¤ UUID  
               userDetailsService(), <span class="hljs-comment">//å‚æ•° 2:è®¤è¯æ•°æ®æº  </span>
               new <span class="hljs-built_in">InMemoryTokenRepositoryImpl</span>());<span class="hljs-comment">//å‚æ•° 3:ä»¤ç‰Œå­˜å‚¨æ–¹å¼</span>
    }
}
</code></pre>
<h3>æŒä¹…åŒ–ä»¤ç‰Œ</h3>
<h4>å¼•å…¥ä¾èµ–</h4>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>com.alibaba<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>druid<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>1.2.8<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>mysql<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mysql-connector-java<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>5.1.38<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.mybatis.spring.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mybatis-spring-boot-starter<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>2.2.0<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
<h4>é…ç½®æ•°æ®æº</h4>
<pre><code class="hljs language-ini"><span class="hljs-attr">spring.thymeleaf.cache</span>=<span class="hljs-literal">false</span>
<span class="hljs-attr">spring.datasource.type</span>=com.alibaba.druid.pool.DruidDataSource
<span class="hljs-attr">spring.datasource.driver-class-name</span>=com.mysql.jdbc.Driver
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/security?characterEncoding=UTF-<span class="hljs-number">8</span>
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root
<span class="hljs-attr">mybatis.mapper-locations</span>=classpath:mapper/*.xml
<span class="hljs-attr">mybatis.type-aliases-package</span>=com.entity
</code></pre>
<h4>é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    <span class="hljs-comment">//...</span>
    <span class="hljs-keyword">@Autowired</span>
    private DataSource dataSource;
    <span class="hljs-keyword">@Bean</span>
    public PersistentTokenRepository persistentTokenRepository(){
        JdbcTokenRepositoryImpl jdbcTokenRepository = new <span class="hljs-built_in">JdbcTokenRepositoryImpl</span>();
        jdbcTokenRepository<span class="hljs-selector-class">.setCreateTableOnStartup</span>(false);<span class="hljs-comment">//åªéœ€è¦æ²¡æœ‰è¡¨æ—¶è®¾ç½®ä¸º true</span>
        jdbcTokenRepository<span class="hljs-selector-class">.setDataSource</span>(dataSource);
        return jdbcTokenRepository;
    }
  	<span class="hljs-comment">//..</span>
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {

        http<span class="hljs-selector-class">.authorizeRequests</span>()
                <span class="hljs-selector-class">.mvcMatchers</span>("/login.html")<span class="hljs-selector-class">.permitAll</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
								 <span class="hljs-comment">//...</span>
                <span class="hljs-selector-class">.logout</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span>
                <span class="hljs-selector-class">.tokenRepository</span>(persistentTokenRepository())
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
    }
}
</code></pre>
<h4>å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“</h4>
<p><strong><code>æ³¨æ„:å¯åŠ¨é¡¹ç›®ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè¡¨,ç”¨æ¥ä¿å­˜è®°ä½æˆ‘çš„ token ä¿¡æ¯</code></strong></p>
<p><img src="https://img-blog.csdnimg.cn/a1208eccb9374c308694ca2168b80e67.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>å†æ¬¡æµ‹è¯•è®°ä½æˆ‘</h4>
<p>åœ¨æµ‹è¯•å‘ç°å³ä½¿æœåŠ¡å™¨é‡æ–°å¯åŠ¨ï¼Œä¾ç„¶å¯ä»¥è‡ªåŠ¨ç™»å½•ã€‚</p>
<h3>è‡ªå®šä¹‰è®°ä½æˆ‘</h3>
<h4>æŸ¥çœ‹è®°ä½æˆ‘æºç </h4>
<p>AbstractUserDetailsAuthenticationProviderç±»ä¸­authenticateæ–¹æ³•åœ¨æœ€åè®¤è¯æˆåŠŸä¹‹åå®ç°äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œä½†æ˜¯æŸ¥çœ‹æºç å¾—çŸ¥å¦‚æœå¼€å¯è®°ä½æˆ‘,å¿…é¡»è¿›è¡Œç›¸å…³çš„è®¾ç½®</p>
<p><img src="https://img-blog.csdnimg.cn/d6fb1f17bb9e430eb6fbb64018388130.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/5802dd840c184615900540718845c2da.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/d4c83b75992d4b1ca6bf2ca507bc4edf.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/1f3217c9b8584c77b9780db7c3e45be7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°</h4>
<p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¿…é¡»åœ¨è®¤è¯è¯·æ±‚ä¸­åŠ å…¥å‚æ•°remember-meå€¼ä¸º"true,on,yes,1"å…¶ä¸­ä»»æ„ä¸€ä¸ªæ‰å¯ä»¥å®Œæˆè®°ä½æˆ‘åŠŸèƒ½,è¿™ä¸ªæ—¶å€™ä¿®æ”¹è®¤è¯ç•Œé¢:</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-keyword">html</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>ç™»å½•<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>ç”¨æˆ·ç™»å½•<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">"@{/doLogin}"</span>></span>
    ç”¨æˆ·å:<span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"uname"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>/></span><span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>></span>
    å¯†ç :<span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"passwd"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>/></span><span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>></span>
  	è®°ä½æˆ‘: <span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"remember-me"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"on|yes|true|1"</span>/></span><span class="hljs-tag">&#x3C;<span class="hljs-name">br</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"ç™»å½•"</span>/></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">form</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</span></code></pre>
<p>é…ç½®ä¸­å¼€å¯è®°ä½æˆ‘</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
		<span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()
                .....
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘</span>
                <span class="hljs-comment">//.alwaysRemember(true) æ€»æ˜¯è®°ä½æˆ‘</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
    }
}
</code></pre>
<h4>å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°</h4>
<h5>è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter</h5>
<pre><code class="hljs language-vbnet">/**
 * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è®¤è¯ Filter
 */
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> LoginFilter extends UsernamePasswordAuthenticationFilter {

    @Override
    <span class="hljs-keyword">public</span> Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
        System.out.println(<span class="hljs-string">"========================================"</span>);
        //<span class="hljs-number">1</span>.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼è¯·æ±‚
        <span class="hljs-keyword">if</span> (!request.getMethod().<span class="hljs-keyword">equals</span>(<span class="hljs-string">"POST"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> AuthenticationServiceException(<span class="hljs-string">"Authentication method not supported: "</span> + request.getMethod());
        }
        //<span class="hljs-number">2</span>.åˆ¤æ–­æ˜¯å¦æ˜¯ json æ ¼å¼è¯·æ±‚ç±»å‹
        <span class="hljs-keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) {
            //<span class="hljs-number">3</span>.ä» json æ•°æ®ä¸­è·å–ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ {<span class="hljs-string">"uname"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"password"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"remember-me"</span>:<span class="hljs-literal">true</span>}
            <span class="hljs-keyword">try</span> {
                Map&#x3C;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>> userInfo = <span class="hljs-built_in">new</span> ObjectMapper().readValue(request.getInputStream(), Map.<span class="hljs-keyword">class</span>);
                <span class="hljs-type">String</span> username = userInfo.<span class="hljs-keyword">get</span>(getUsernameParameter());
                <span class="hljs-type">String</span> password = userInfo.<span class="hljs-keyword">get</span>(getPasswordParameter());
                <span class="hljs-type">String</span> rememberValue = userInfo.<span class="hljs-keyword">get</span>(AbstractRememberMeServices.DEFAULT_PARAMETER);
                <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(rememberValue)) {
                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);
                }
                System.out.println(<span class="hljs-string">"ç”¨æˆ·å: "</span> + username + <span class="hljs-string">" å¯†ç : "</span> + password + <span class="hljs-string">" æ˜¯å¦è®°ä½æˆ‘: "</span> + rememberValue);
                UsernamePasswordAuthenticationToken authRequest = <span class="hljs-built_in">new</span> UsernamePasswordAuthenticationToken(username, password);
                setDetails(request, authRequest);
                <span class="hljs-keyword">return</span> this.getAuthenticationManager().authenticate(authRequest);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                e.printStackTrace();
            }
        }
        <span class="hljs-keyword">return</span> super.attemptAuthentication(request, response);
    }
}
</code></pre>
<h5>è‡ªå®šä¹‰ RememberMeService</h5>
<pre><code class="hljs language-typescript"><span class="hljs-comment">/**
 * è‡ªå®šä¹‰è®°ä½æˆ‘ services å®ç°ç±»
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPersistentTokenBasedRememberMeServices</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PersistentTokenBasedRememberMeServices</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MyPersistentTokenBasedRememberMeServices</span>(<span class="hljs-title class_">String</span> key, <span class="hljs-title class_">UserDetailsService</span> userDetailsService, <span class="hljs-title class_">PersistentTokenRepository</span> tokenRepository) {
        <span class="hljs-variable language_">super</span>(key, userDetailsService, tokenRepository);
    }
    <span class="hljs-comment">/**
     * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è·å– remember-me æ–¹å¼
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">rememberMeRequested</span>(<span class="hljs-params"><span class="hljs-title class_">HttpServletRequest</span> request, <span class="hljs-title class_">String</span> parameter</span>) {
        <span class="hljs-title class_">String</span> paramValue = request.<span class="hljs-title function_">getAttribute</span>(parameter).<span class="hljs-title function_">toString</span>();
        <span class="hljs-keyword">if</span> (paramValue != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (paramValue.<span class="hljs-title function_">equalsIgnoreCase</span>(<span class="hljs-string">"true"</span>) || paramValue.<span class="hljs-title function_">equalsIgnoreCase</span>(<span class="hljs-string">"on"</span>)
                    || paramValue.<span class="hljs-title function_">equalsIgnoreCase</span>(<span class="hljs-string">"yes"</span>) || paramValue.<span class="hljs-title function_">equals</span>(<span class="hljs-string">"1"</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h5>é…ç½®è®°ä½æˆ‘</h5>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    <span class="hljs-keyword">@Bean</span>
    public UserDetailsService userDetailsService() {
        <span class="hljs-comment">//.....</span>
        return inMemoryUserDetailsManager;
    }
    <span class="hljs-keyword">@Override</span>
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth<span class="hljs-selector-class">.userDetailsService</span>(userDetailsService());
    }

    <span class="hljs-keyword">@Override</span>
    <span class="hljs-keyword">@Bean</span>
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super<span class="hljs-selector-class">.authenticationManagerBean</span>();
    }

    <span class="hljs-comment">//è‡ªå®šä¹‰ filter äº¤ç»™å·¥å‚ç®¡ç†</span>
    <span class="hljs-keyword">@Bean</span>
    public LoginFilter loginFilter() throws Exception {
        LoginFilter loginFilter = new <span class="hljs-built_in">LoginFilter</span>();
        loginFilter<span class="hljs-selector-class">.setFilterProcessesUrl</span>("/doLogin");<span class="hljs-comment">//æŒ‡å®šè®¤è¯ url</span>
        loginFilter<span class="hljs-selector-class">.setUsernameParameter</span>("uname");<span class="hljs-comment">//æŒ‡å®šæ¥æ”¶json ç”¨æˆ·å key</span>
        loginFilter<span class="hljs-selector-class">.setPasswordParameter</span>("passwd");<span class="hljs-comment">//æŒ‡å®šæ¥æ”¶ json å¯†ç  key</span>
        loginFilter<span class="hljs-selector-class">.setAuthenticationManager</span>(authenticationManagerBean());
        loginFilter<span class="hljs-selector-class">.setRememberMeServices</span>(rememberMeServices()); <span class="hljs-comment">//è®¾ç½®è®¤è¯æˆåŠŸæ—¶ä½¿ç”¨è‡ªå®šä¹‰rememberMeService</span>
        <span class="hljs-comment">//è®¤è¯æˆåŠŸå¤„ç†</span>
        loginFilter<span class="hljs-selector-class">.setAuthenticationSuccessHandler</span>((req, resp, authentication) -> {
            Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;String, <span class="hljs-selector-tag">Object</span>>();
            result<span class="hljs-selector-class">.put</span>("msg", "ç™»å½•æˆåŠŸ");
            result<span class="hljs-selector-class">.put</span>("ç”¨æˆ·ä¿¡æ¯", authentication.getPrincipal());
            resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
            resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.OK.value());
            String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
            resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
        });
        <span class="hljs-comment">//è®¤è¯å¤±è´¥å¤„ç†</span>
        loginFilter<span class="hljs-selector-class">.setAuthenticationFailureHandler</span>((req, resp, ex) -> {
            Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;String, <span class="hljs-selector-tag">Object</span>>();
            result<span class="hljs-selector-class">.put</span>("msg", "ç™»å½•å¤±è´¥: " + ex.getMessage());
            resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.INTERNAL_SERVER_ERROR.value());
            resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
            String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
            resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
        });
        return loginFilter;
    }

    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()<span class="hljs-comment">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>() <span class="hljs-comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½  cookie è¿›è¡Œå®ç°  1.è®¤è¯æˆåŠŸä¿å­˜è®°ä½æˆ‘ cookie åˆ°å®¢æˆ·ç«¯   2.åªæœ‰ cookie å†™å…¥å®¢æˆ·ç«¯æˆåŠŸæ‰èƒ½å®ç°è‡ªåŠ¨ç™»å½•åŠŸèƒ½</span>
                <span class="hljs-selector-class">.rememberMeServices</span>(rememberMeServices())  <span class="hljs-comment">//è®¾ç½®è‡ªåŠ¨ç™»å½•ä½¿ç”¨å“ªä¸ª rememberMeServices</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.exceptionHandling</span>()
                <span class="hljs-selector-class">.authenticationEntryPoint</span>((req, resp, ex) -> {
                    resp<span class="hljs-selector-class">.setContentType</span>(MediaType.APPLICATION_JSON_UTF8_VALUE);
                    resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.UNAUTHORIZED.value());
                    resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>("è¯·è®¤è¯ä¹‹åå†å»å¤„ç†!");
                })
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.logout</span>()
                <span class="hljs-selector-class">.logoutRequestMatcher</span>(new OrRequestMatcher(
                        new AntPathRequestMatcher("/logout", HttpMethod.DELETE.name()),
                        new <span class="hljs-built_in">AntPathRequestMatcher</span>("/logout", HttpMethod.GET.name())
                ))
                <span class="hljs-selector-class">.logoutSuccessHandler</span>((req, resp, auth) -> {
                    Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;String, <span class="hljs-selector-tag">Object</span>>();
                    result<span class="hljs-selector-class">.put</span>("msg", "æ³¨é”€æˆåŠŸ");
                    result<span class="hljs-selector-class">.put</span>("ç”¨æˆ·ä¿¡æ¯", auth.getPrincipal());
                    resp<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
                    resp<span class="hljs-selector-class">.setStatus</span>(HttpStatus.OK.value());
                    String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
                    resp<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
                })
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();


        <span class="hljs-comment">// at: ç”¨æ¥æŸä¸ª filter æ›¿æ¢è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter</span>
        <span class="hljs-comment">// before: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter ä¹‹å‰</span>
        <span class="hljs-comment">// after: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­é‚£ä¸ª filter ä¹‹å</span>
        http<span class="hljs-selector-class">.addFilterAt</span>(loginFilter(), UsernamePasswordAuthenticationFilter<span class="hljs-selector-class">.class</span>);
    }


    <span class="hljs-keyword">@Bean</span>
    public RememberMeServices rememberMeServices() {
        return new <span class="hljs-built_in">MyPersistentTokenBasedRememberMeServices</span>(UUID.randomUUID()<span class="hljs-selector-class">.toString</span>(), <span class="hljs-built_in">userDetailsService</span>(), new <span class="hljs-built_in">InMemoryTokenRepositoryImpl</span>());
    }
}

</code></pre>
<hr>
<h2>ç¬¬å…­ç«  ä¼šè¯ç®¡ç†</h2>
<ul>
<li>ç®€ä»‹</li>
<li>ä¼šè¯å¹¶å‘ç®¡ç†</li>
<li>ä¼šè¯å…±äº«å®æˆ˜</li>
</ul>
<h3>ç®€ä»‹</h3>
<p>å½“æµè§ˆå™¨è°ƒç”¨ç™»å½•æ¥å£ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šå’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªä¼šè¯ (Session) æµè§ˆå™¨åœ¨æ¯æ¬¡å‘é€è¯·æ±‚æ—¶éƒ½ä¼šæºå¸¦ä¸€ä¸ª Sessionldï¼ŒæœåŠ¡ç«¯åˆ™æ ¹æ®è¿™ä¸ª Sessionld æ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½ã€‚å½“æµè§ˆå™¨å…³é—­åï¼ŒæœåŠ¡ç«¯çš„ Session å¹¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ¨æœåŠ¡ç«¯è°ƒç”¨ Sessioné”€æ¯æ–¹æ³•ï¼Œæˆ–è€…ç­‰ Session è¿‡æœŸæ—¶é—´åˆ°äº†è‡ªåŠ¨é”€æ¯ã€‚åœ¨Spring Security ä¸­ï¼Œä¸HttpSessionç›¸å…³çš„åŠŸèƒ½ç”± SessionManagementFiter å’ŒSessionAutheaticationStrateey æ¥å£æ¥å¤„ç†ï¼ŒSessionManagomentFilter è¿‡æ»¤å™¨å°† Session ç›¸å…³æ“ä½œå§”æ‰˜ç»™ SessionAuthenticationStrateey æ¥å£å»å®Œæˆã€‚</p>
<h3>ä¼šè¯å¹¶å‘ç®¡ç†</h3>
<h4>ç®€ä»‹</h4>
<p>ä¼šè¯å¹¶å‘ç®¡ç†å°±æ˜¯æŒ‡åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åˆ›å»ºå¤šå°‘ä¸ªä¼šè¯ï¼Œå¦‚æœä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ªä¼šè¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šè¿›è¡Œç™»å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šç™»å½•å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä¸è¿‡å¼€å‘è€…å¯ä»¥åœ¨ Spring Security ä¸­å¯¹æ­¤è¿›è¡Œé…ç½®ã€‚</p>
<h4>å¼€å¯ä¼šè¯ç®¡ç†</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {

  	<span class="hljs-comment">//...</span>
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()
                <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.rememberMe</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>()
                <span class="hljs-selector-class">.sessionManagement</span>()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span>
                <span class="hljs-selector-class">.maximumSessions</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">//è®¾ç½®ä¼šè¯å¹¶å‘æ•°ä¸º 1</span>
    }

    <span class="hljs-keyword">@Bean</span>
    public HttpSessionEventPublisher httpSessionEventPublisher() {
        return new <span class="hljs-built_in">HttpSessionEventPublisher</span>();
    }
}
</code></pre>
<ol>
<li>sessionManagement() ç”¨æ¥å¼€å¯ä¼šè¯ç®¡ç†ã€maximumSessions æŒ‡å®šä¼šè¯çš„å¹¶å‘æ•°ä¸º 1ã€‚</li>
<li>HttpSessionEventPublisher æä¾›ä¸€ä¸€ä¸ªHtp SessionEvenePubishor-å®ä¾‹ã€‚Spring Securityä¸­é€šè¿‡ä¸€ä¸ª Map é›†åˆæ¥é›†æŠ¤å½“å‰çš„ Http Session è®°å½•ï¼Œè¿›è€Œå®ç°ä¼šè¯çš„å¹¶å‘ç®¡ç†ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œå°±å‘é›†åˆä¸­æ·»åŠ ä¸€æ¡Http Session è®°å½•ï¼›å½“ä¼šè¯é”€æ¯æ—¶ï¼Œå°±ä»é›†åˆä¸­ç§»é™¤ä¸€æ¡ Httpsession è®°å½•ã€‚HtpSesionEvenPublisher å®ç°äº† Fttp SessionListener æ¥å£ï¼Œå¯ä»¥ç›‘å¬åˆ° HtpSession çš„åˆ›å»ºå’Œé”€æ¯€äº‹ä»¶ï¼Œå¹¶å°† Fltp Session çš„åˆ›å»º/é”€æ¯äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œè¿™æ ·ï¼Œå½“æœ‰ HttpSession é”€æ¯€æ—¶ï¼ŒSpring Security å°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥äº‹ä»¶äº†ã€‚</li>
</ol>
<h4>æµ‹è¯•ä¼šè¯ç®¡ç†</h4>
<p>é…ç½®å®Œæˆåï¼Œå¯åŠ¨é¡¹ç›®ã€‚è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæµè§ˆå™¨ï¼Œå¦‚æœä½¿ç”¨äº† Chrome æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ Chrome æµè§ˆå™¨ä¸­çš„å¤šç”¨æˆ·æ–¹å¼ï¼ˆç›¸å½“äºä¸¤ä¸ªæµè§ˆå™¨ï¼‰å…ˆåœ¨ç¬¬ä¸€ä¸ªæµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://localhost:8080%EF%BC%8C%E6%AD%A4%E6%97%B6%E4%BC%9A%E8%87%AA%E5%8A%A8%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%EF%BC%8C%E5%AE%8C%E6%88%90%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E5%88%B0%E6%95%B0%E6%8D%AE%E4%BA%86%EF%BC%9B%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%9C%A8%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%B9%9F%E8%BE%93%E5%85%A5">http://localhost:8080ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥</a> <a href="http://localhost:8080%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E7%99%BB%E5%BD%95%EF%BC%8C">http://localhost:8080ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ</a><br>
å®Œæˆç™»å½•æ“ä½œï¼›å½“ç¬¬äºŒä¸ªæµè§ˆå™¨ç™»å½•æˆåŠŸåï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ã€‚ç»“æœå‡ºç°ä¸‹å›¾ï¼š<img src="https://img-blog.csdnimg.cn/02b6bccfc2e04969a499b689580c403d.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3>ä¼šè¯å¤±æ•ˆå¤„ç†</h3>
<h4>ä¼ ç»Ÿ web å¼€å‘å¤„ç†</h4>
<pre><code class="hljs language-scss">protected void <span class="hljs-built_in">configure</span>(HttpSecurity http) throws Exception {
  http<span class="hljs-selector-class">.authorizeRequests</span>()
    <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
    <span class="hljs-selector-class">.and</span>()
    ....
    <span class="hljs-selector-class">.sessionManagement</span>()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span>
    <span class="hljs-selector-class">.maximumSessions</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span>
    <span class="hljs-selector-class">.expiredUrl</span>("/login");<span class="hljs-comment">//ä¼šè¯è¿‡æœŸå¤„ç†</span>
}
</code></pre>
<h4>å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Override</span>
protected void configure(HttpSecurity http) throws Exception {
  http<span class="hljs-selector-class">.authorizeRequests</span>()
    <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
    .....
    <span class="hljs-selector-class">.sessionManagement</span>()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span>
    <span class="hljs-selector-class">.maximumSessions</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span>
    <span class="hljs-comment">//.expiredUrl("/login")//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span>
    <span class="hljs-selector-class">.expiredSessionStrategy</span>(event -> {
      HttpServletResponse response = event.getResponse();
      response<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
      Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;>();
      result<span class="hljs-selector-class">.put</span>("status", <span class="hljs-number">500</span>);
      result<span class="hljs-selector-class">.put</span>("msg", "å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!");
      String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
      response<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
      response<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
      response<span class="hljs-selector-class">.flushBuffer</span>();
    });<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span>
}
</code></pre>
<h3>ç¦æ­¢å†æ¬¡ç™»å½•</h3>
<p>é»˜è®¤çš„æ•ˆæœæ˜¯ä¸€ç§è¢« â€œæŒ¤ä¸‹çº¿â€çš„æ•ˆæœï¼Œåé¢ç™»å½•çš„ç”¨æˆ·ä¼šæŠŠå‰é¢ç™»å½•çš„ç”¨æˆ· â€œæŒ¤ä¸‹çº¿â€ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç¦æ­¢åæ¥è€…ç™»å½•ï¼Œå³ä¸€æ—¦å½“å‰ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåæ¥è€…æ— æ³•å†æ¬¡ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ç™»å½•ï¼Œç›´åˆ°å½“å‰ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ç™»å½•ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Override</span>
protected void configure(HttpSecurity http) throws Exception {
  http<span class="hljs-selector-class">.authorizeRequests</span>()
    <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
    <span class="hljs-selector-class">.and</span>()
    ....
    <span class="hljs-selector-class">.sessionManagement</span>()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span>
    <span class="hljs-selector-class">.maximumSessions</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span>
    <span class="hljs-comment">//.expiredUrl("/login")//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span>
    <span class="hljs-selector-class">.expiredSessionStrategy</span>(event -> {
      HttpServletResponse response = event.getResponse();
      response<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
      Map&#x3C;String, <span class="hljs-selector-tag">Object</span>> result = new HashMap&#x3C;>();
      result<span class="hljs-selector-class">.put</span>("status", <span class="hljs-number">500</span>);
      result<span class="hljs-selector-class">.put</span>("msg", "å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!");
      String s = new <span class="hljs-built_in">ObjectMapper</span>()<span class="hljs-selector-class">.writeValueAsString</span>(result);
      response<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.println</span>(s);
      response<span class="hljs-selector-class">.flushBuffer</span>();
    })<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span>
    <span class="hljs-selector-class">.maxSessionsPreventsLogin</span>(true);<span class="hljs-comment">//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•</span>
}
</code></pre>
<h3>ä¼šè¯å…±äº«</h3>
<p>å‰é¢æ‰€è®²çš„ä¼šè¯ç®¡ç†éƒ½æ˜¯å•æœºä¸Šçš„ä¼šè¯ç®¡ç†ï¼Œå¦‚æœå½“å‰æ˜¯é›†ç¾¤ç¯å¢ƒï¼Œå‰é¢æ‰€è®²çš„ä¼šè¯ç®¡<br>
ç†æ–¹æ¡ˆå°±ä¼šå¤±æ•ˆã€‚æ­¤æ—¶å¯ä»¥åˆ©ç”¨ spring-session ç»“åˆ redis å®ç° session å…±äº«ã€‚</p>
<h4>å®æˆ˜</h4>
<h6>å¼•å…¥ä¾èµ–</h6>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-data-redis<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.session<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-session-data-redis<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
<h6>ç¼–å†™é…ç½®</h6>
<pre><code class="hljs language-ini"><span class="hljs-attr">spring.redis.host</span>=localhost
<span class="hljs-attr">spring.redis.port</span>=<span class="hljs-number">6379</span>
</code></pre>
<h6>é…ç½®Security</h6>
<pre><code class="hljs language-java"><span class="hljs-keyword">package</span> com.blr.config;

<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;
<span class="hljs-keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;
<span class="hljs-keyword">import</span> org.springframework.session.FindByIndexNameSessionRepository;
<span class="hljs-keyword">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> FindByIndexNameSessionRepository sessionRepository;


    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(FindByIndexNameSessionRepository sessionRepository)</span> {
        <span class="hljs-built_in">this</span>.sessionRepository = sessionRepository;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        ....
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userDetailsService());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeRequests()
                .anyRequest().authenticated()
                .and()
                .formLogin()
                .and()
                .rememberMe()
                .and()
                .csrf().disable()
                .sessionManagement()  <span class="hljs-comment">//å¼€å¯ä¼šè¯ç®¡ç†</span>
                .maximumSessions(<span class="hljs-number">1</span>)  <span class="hljs-comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯*/</span>
                .expiredUrl(<span class="hljs-string">"/login"</span>)<span class="hljs-comment">//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span>
                .expiredSessionStrategy(event -> {
                    <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> event.getResponse();
                    response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
                    Map&#x3C;String, Object> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&#x3C;>();
                    result.put(<span class="hljs-string">"status"</span>, <span class="hljs-number">500</span>);
                    result.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!"</span>);
                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>().writeValueAsString(result);
                    response.getWriter().println(s);
                    response.flushBuffer();
                }).sessionRegistry(sessionRegistry());<span class="hljs-comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span>
        <span class="hljs-comment">//.maxSessionsPreventsLogin(true);//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•*/</span>
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SpringSessionBackedSessionRegistry <span class="hljs-title function_">sessionRegistry</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringSessionBackedSessionRegistry</span>(sessionRepository);
    }

}
</code></pre>
<h6>æµ‹è¯•</h6>
<h2>ç¬¬ä¸ƒç«  CSRF æ¼æ´ä¿æŠ¤</h2>
<ul>
<li>
<p>CSRF ç®€ä»‹</p>
</li>
<li>
<p>CSRF é˜²å¾¡&#x26;åŸºæœ¬é…ç½®</p>
</li>
<li>
<p>å®æˆ˜</p>
</li>
</ul>
<h4>ç®€ä»‹</h4>
<p>CSRF (Cross-Site Request Forgery è·¨ç«™è¯·æ±‚ä¼ªé€ )ï¼Œä¹Ÿå¯ç§°ä¸ºä¸€é”®å¼æ”»å‡» (one-click-attackï¼‰ï¼Œé€šå¸¸ç¼©å†™ä¸º <code>CSRF</code> æˆ–è€… <code>XSRF</code>ã€‚</p>
<p><code>CSRF</code> æ”»å‡»æ˜¯ä¸€ç§æŒŸæŒç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„æµè§ˆå™¨ä¸Šå‘é€æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹æ³•ã€‚ç›¸å¯¹äºXSSåˆ©ç”¨ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼ŒCSRFåˆ™æ˜¯åˆ©ç”¨ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»ã€‚ç®€å•æ¥è¯´ï¼ŒCSRFæ˜¯è‡´å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå»è®¿é—®ä¸€ä¸ªç”¨æˆ·æ›¾ç»è®¤è¯è¿‡çš„ç½‘ç«™å¹¶æ‰§è¡Œæ¶æ„è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€é‚®ä»¶ã€å‘æ¶ˆæ¯ã€ç”šè‡³è´¢äº§æ“ä½œ (å¦‚è½¬è´¦å’Œè´­ä¹°å•†å“ï¼‰ã€‚ç”±äºå®¢æˆ·ç«¯(æµè§ˆå™¨)å·²ç»åœ¨è¯¥ç½‘ç«™ä¸Šè®¤è¯è¿‡ï¼Œæ‰€ä»¥è¯¥ç½‘ç«™ä¼šè®¤ä¸ºæ˜¯çœŸæ­£ç”¨æˆ·åœ¨æ“ä½œè€Œæ‰§è¡Œè¯·æ±‚ï¼ˆå®é™…ä¸Šè¿™ä¸ªå¹¶éç”¨æˆ·çš„æœ¬æ„ï¼‰ã€‚</p>
<p><strong>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</strong></p>
<p>å‡è®¾ blr ç°åœ¨ç™»å½•äº†æŸé“¶è¡Œçš„ç½‘ç«™å‡†å¤‡å®Œæˆä¸€é¡¹è½¬è´¦æ“ä½œï¼Œè½¬è´¦çš„é“¾æ¥å¦‚ä¸‹ï¼š</p>
<p><strong><a href="https://bank%20.xxx%20.com/withdraw?account=blr&#x26;amount=1000&#x26;for=zhangsan">https: //bank .xxx .com/withdraw?account=blr&#x26;amount=1000&#x26;for=zhangsan</a></strong></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªé“¾æ¥æ˜¯æƒ³ä» blr è¿™ä¸ªè´¦æˆ·ä¸‹è½¬è´¦ 1000 å…ƒåˆ° zhangsan è´¦æˆ·ä¸‹ï¼Œå‡è®¾blr æ²¡æœ‰æ³¨é”€ç™»å½•è¯¥é“¶è¡Œçš„ç½‘ç«™ï¼Œå°±åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ–°çš„é€‰é¡¹å¡ä¸­æ‰“å¼€äº†ä¸€ä¸ªå±é™©ç½‘ç«™ï¼Œè¿™ä¸ªå±é™©ç½‘ç«™ä¸­æœ‰ä¸€å¹…å›¾ç‰‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/6b964f4ca7b942fea3af81101b032b02.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ä¸€æ—¦ç”¨æˆ·æ‰“å¼€äº†è¿™ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªå›¾ç‰‡é“¾æ¥ä¸­çš„è¯·æ±‚å°±ä¼šè‡ªåŠ¨å‘é€å‡ºå»ã€‚ç”±äºæ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å¹¶ä¸”ç”¨æˆ·å°šæœªæ³¨é”€ç™»å½•ï¼Œæ‰€ä»¥è¯¥è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Šå¯¹åº”çš„æœ‰æ•ˆçš„ Cookie ä¿¡æ¯ï¼Œè¿›è€Œå®Œæˆä¸€æ¬¡è½¬è´¦æ“ä½œã€‚è¿™å°±æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ã€‚</p>
<h4>CSRFæ”»å‡»æ¼”ç¤º</h4>
<h5>åˆ›å»ºé“¶è¡Œåº”ç”¨</h5>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
   <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
   <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-security<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-web<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
</li>
<li>
<p>ä¿®æ”¹é…ç½®</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();
        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="hljs-string">"root"</span>).password(<span class="hljs-string">"{noop}123"</span>).roles(<span class="hljs-string">"admin"</span>).build());
        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userDetailsService());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeRequests().anyRequest().authenticated()
                .and().formLogin().and().csrf().disable();
    }
}
</code></pre>
</li>
<li>
<p>åˆ›å»º controller å¹¶å¯åŠ¨å¯åŠ¨</p>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {

    <span class="hljs-meta">@PostMapping(<span class="hljs-string">"/withdraw"</span>)</span>
    <span class="hljs-keyword">public</span> String withdraw() {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ"</span>;
    }
}
</code></pre>
</li>
</ul>
<h5>åˆ›å»ºæ¶æ„åº”ç”¨</h5>
<ul>
<li>
<p>åˆ›å»ºç®€å• springboot åº”ç”¨</p>
</li>
<li>
<p>ä¿®æ”¹é…ç½®</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span>
</code></pre>
</li>
<li>
<p>å‡†å¤‡æ”»å‡»é¡µé¢</p>
<pre><code class="hljs language-ini">&#x3C;form <span class="hljs-attr">action</span>=<span class="hljs-string">"http://127.0.0.1:8080/withdraw"</span> method=<span class="hljs-string">"post"</span>>
    &#x3C;input <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> type=<span class="hljs-string">"hidden"</span> value=<span class="hljs-string">"blr"</span>/>
    &#x3C;input <span class="hljs-attr">name</span>=<span class="hljs-string">"money"</span> type=<span class="hljs-string">"hidden"</span> value=<span class="hljs-string">"10000"</span>>
    &#x3C;input <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"ç‚¹æˆ‘"</span>>
&#x3C;/form>
</code></pre>
</li>
</ul>
<h4>CSRF é˜²å¾¡</h4>
<p><strong>CSRF</strong>æ”»å‡»çš„æ ¹æºåœ¨äºæµè§ˆå™¨é»˜è®¤çš„èº«ä»½éªŒè¯æœºåˆ¶(è‡ªåŠ¨æºå¸¦å½“å‰ç½‘ç«™çš„Cookieä¿¡æ¯)ï¼Œè¿™ç§æœºåˆ¶è™½ç„¶å¯ä»¥ä¿è¯è¯·æ±‚æ˜¯æ¥è‡ªç”¨æˆ·çš„æŸä¸ªæµè§ˆå™¨ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿è¿™è¯·æ±‚æ˜¯ç”¨æˆ·æˆæƒå‘é€ã€‚æ”»å‡»è€…å’Œç”¨æˆ·å‘é€çš„è¯·æ±‚ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æœ‰åŠæ³•å»ç›´æ¥æ‹’ç»è¿™é‡Œçš„æŸä¸€ä¸ªè¯·æ±‚ã€‚å¦‚æœèƒ½åœ¨åˆæ³•æ¸…æ±‚ä¸­é¢å¤–æºå¸¦ä¸€ä¸ªæ”»å‡»è€…æ— æ³•è·å–çš„å‚æ•°ï¼Œå°±å¯ä»¥æˆåŠŸåŒºåˆ†å‡ºä¸¤ç§ä¸åŒçš„è¯·æ±‚ï¼Œè¿›è€Œç›´æ¥æ‹’ç»æ‰æ¶æ„è¯·æ±‚ã€‚åœ¨ SpringSecurity ä¸­å°±æä¾›äº†è¿™ç§æœºåˆ¶æ¥é˜²å¾¡ CSRF æ”»å‡»ï¼Œè¿™ç§æœºåˆ¶æˆ‘ä»¬ç§°ä¹‹ä¸º<code>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</code>ã€‚</p>
<h5>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</h5>
<p>è¿™æ˜¯ç›®å‰ä¸»æµçš„ CSRF æ”»å‡»é˜²å¾¡æ–¹æ¡ˆã€‚å…·ä½“çš„æ“ä½œæ–¹å¼å°±æ˜¯åœ¨æ¯ä¸€ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œé™¤äº†é»˜è®¤è‡ªåŠ¨æºå¸¦çš„ Cookie å‚æ•°ä¹‹å¤–ï¼Œå†æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€éšæœºç”Ÿæˆçš„å®‡ç¬¦ä¸²ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º CSRF ä»¤ç‰Œã€‚è¿™ä¸ª CSRF ä»¤ç‰Œç”±æœåŠ¡ç«¯ç”Ÿæˆï¼Œç”Ÿæˆååœ¨ HtpSession ä¸­ä¿å­˜ä¸€ä»½ã€‚å½“å‰ç«¯è¯·æ±‚åˆ°è¾¾åï¼Œå°†è¯·æ±‚æºå¸¦çš„ CSRF ä»¤ç‰Œä¿¡æ¯å’ŒæœåŠ¡ç«¯ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸¤è€…ä¸ç›¸ç­‰ï¼Œåˆ™æ‹’ç»æ‰è¯¥ HITTP è¯·æ±‚ã€‚</p>
<blockquote>
<p><strong>æ³¨æ„:</strong> è€ƒè™‘åˆ°ä¼šæœ‰ä¸€äº›å¤–éƒ¨ç«™ç‚¹é“¾æ¥åˆ°æˆ‘ä»¬çš„ç½‘ç«™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ±‚è¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ ·å¯¹å­HEADã€OPTIONSã€TRACE ç­‰æ–¹æ³•å°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ CSRF ä»¤ç‰Œäº†ï¼Œå¼ºè¡Œä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»¤ç‰Œæ³„éœ²ï¼</p>
</blockquote>
<h5>å¼€å¯ CSRF é˜²å¾¡</h5>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.
          ...
          formLogin()
          .and()
          .csrf(); <span class="hljs-comment">//å¼€å¯ csrf</span>
    }
}
</code></pre>
<h5>æŸ¥çœ‹ç™»å½•é¡µé¢æºç </h5>
<p><img src="https://img-blog.csdnimg.cn/be0ff190d5b549fdb87f525e2e53d0ca.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF</h4>
<p>å¼€å¯CSRFé˜²å¾¡åä¼šè‡ªåŠ¨åœ¨æäº¤çš„è¡¨å•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¦‚æœä¸èƒ½è‡ªåŠ¨åŠ å…¥ï¼Œéœ€è¦åœ¨å¼€å¯ä¹‹åæ‰‹åŠ¨åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶éšç€è¯·æ±‚æäº¤ã€‚è·å–æœåŠ¡ç«¯ä»¤ç‰Œæ–¹å¼å¦‚ä¸‹:</p>
<pre><code class="hljs language-bash">&#x3C;input <span class="hljs-built_in">type</span>=<span class="hljs-string">"hidden"</span> th:name=<span class="hljs-string">"<span class="hljs-variable">${_csrf.parameterName}</span>"</span> th:value=<span class="hljs-string">"<span class="hljs-variable">${_csrf.token}</span>"</span>/>
</code></pre>
<h5>å¼€å‘æµ‹è¯• controller</h5>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@PostMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-keyword">public</span> String hello() {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"hello success"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello success"</span>;
    }

    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/index.html"</span>)</span>
    <span class="hljs-keyword">public</span> String index() {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"index"</span>;
    }
}
</code></pre>
<h5>åˆ›å»º html</h5>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>æµ‹è¯• CSRF é˜²å¾¡<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">"@{/hello}"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hello"</span>/></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">form</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</span></code></pre>
<h5>æµ‹è¯•æŸ¥çœ‹index.htmlæºç </h5>
<p><img src="https://img-blog.csdnimg.cn/9b4cc0d08f404bd6aee6f053458f0198.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF</h4>
<p>å‰åç«¯åˆ†ç¦»å¼€å‘æ—¶ï¼Œåªéœ€è¦å°†ç”Ÿæˆ csrf æ”¾å…¥åˆ°cookie ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚æ—¶è·å– cookie ä¸­ä»¤ç‰Œä¿¡æ¯è¿›è¡Œæäº¤å³å¯ã€‚</p>
<h5>ä¿®æ”¹ CSRF å­˜å…¥ Cookie</h5>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()<span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()
                <span class="hljs-selector-class">.csrfTokenRepository</span>(CookieCsrfTokenRepository.withHttpOnlyFalse());<span class="hljs-comment">//å°†ä»¤ç‰Œä¿å­˜åˆ°cookieä¸­ï¼Œå…è®¸cookieå‰ç«¯è·å–</span>
    }
}
</code></pre>
<h5>è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie</h5>
<p><img src="https://img-blog.csdnimg.cn/0884e2dec22f4ba3bfd2c563d58c843f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5>å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯</h5>
<ul>
<li>
<p>è¯·æ±‚å‚æ•°ä¸­æºå¸¦ä»¤ç‰Œ</p>
<p>key: _csrf<br>
value:"xxx"</p>
</li>
<li>
<p>è¯·æ±‚å¤´ä¸­æºå¸¦ä»¤ç‰Œ</p>
<p>X-XSRF-TOKEN:value</p>
</li>
</ul>
<h2>ç¬¬å…«ç«  è·¨åŸŸ</h2>
<ul>
<li>Spring å¤„ç†æ–¹æ¡ˆã€‚</li>
<li>Spring Security å¤„ç†æ–¹æ¡ˆã€‚</li>
</ul>
<h3>ç®€ä»‹</h3>
<p>è·¨åŸŸé—®é¢˜æ˜¯å®é™…åº”ç”¨å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œåœ¨ Spring æ¡†æ¶ä¸­å¯¹äºè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆæœ‰å¥½å‡ ç§ï¼Œå¼• äº† Spring Security ä¹‹åï¼Œè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆåˆå¢åŠ äº†ã€‚</p>
<h3>ä»€ä¹ˆæ˜¯ CORS</h3>
<p>CORS (Cross-Origin Resource Sharing ï¼‰æ˜¯ç”± W3Cåˆ¶å®šçš„ä¸€ç§è·¨åŸŸèµ„æºå…±äº«æŠ€æœ¯æ ‡å‡†ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³å‰ç«¯çš„è·¨åŸŸè¯·æ±‚ã€‚åœ¨JavaEE å¼€å‘ä¸­ï¼Œæœ€å¸¸è§çš„å‰ç«¯è·¨åŸŸè¯·æ±‚è§£å†³æ–¹æ¡ˆæ˜¯æ—©æœŸçš„JSONPï¼Œä½†æ˜¯ JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼Œè€Œ CORS åˆ™æ”¯ç‰¹å¤šç§ HTTTPè¯·æ±‚æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚</p>
<p>CORS ä¸­æ–°å¢äº†ä¸€ç»„HTTP è¯·æ±‚å¤´å­—æ®µï¼Œé€šè¿‡è¿™äº›å­—æ®µï¼ŒæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨ï¼Œé‚£äº›ç½‘ç«™é€šè¿‡æµè§ˆå™¨æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚åŒæ—¶è§„å®šï¼Œå¯¹é‚£äº›å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨æ•°æ®çš„HTTPè¯·æ±‚æ–¹æ³• ï¼ˆå¦‚GETä»¥å¤–çš„HTTP è¯·æ±‚ç­‰)ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚(prenightstï¼‰ï¼Œé¢„æ£€è¯·æ±‚çš„ç›®çš„æ˜¯æŸ¥çœ‹æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒå³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯å…è®¸ï¼Œæ‰å‘é€å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆå¦‚ Cookiesã€HTTP è®¤è¯ä¿¡æ¯ç­‰ï¼‰ã€‚</p>
<blockquote>
<p>CORS: åŒæº/åŒåŸŸ = åè®®+ä¸»æœº+ç«¯å£</p>
</blockquote>
<h4>ç®€å•è¯·æ±‚</h4>
<p>GET è¯·æ±‚ä¸ºä¾‹ï¼Œå¦‚æœéœ€è¦å‘èµ·ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œåˆ™è¯·æ±‚å¤´å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-bash">Host: localhost:8080
Origin: http://localhost:8081
Referer:http://localhost:8081/index.html
</code></pre>
<p>å¦‚æœæœåŠ¡ç«¯æ”¯æŒè¯¥è·¨åŸŸè¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›çš„å“åº”å¤´ä¸­å°†åŒ…å«å¦‚ä¸‹å­—æ®µï¼š</p>
<pre><code class="hljs language-ruby"><span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span><span class="hljs-symbol">:http</span><span class="hljs-symbol">://localhost</span>: <span class="hljs-number">8081</span>
</code></pre>
<p>Access-Control-Allow-Origin å­—æ®µç”¨æ¥å‘Šè¯‰æµè§ˆå™¨å¯ä»¥è®¿é—®è¯¥èµ„æºçš„åŸŸï¼Œå½“æµè§ˆå™¨æ”¶åˆ°è¿™æ ·çš„å“åº”å¤´ä¿¡æ¯ä¹‹åï¼Œæå–å‡º Access-Control-Allow-Origin å­—æ®µä¸­çš„å€¼ï¼Œ å‘ç°è¯¥å€¼åŒ…å«å½“å‰é¡µé¢æ‰€åœ¨çš„åŸŸï¼Œå°±çŸ¥é“è¿™ä¸ªè·¨åŸŸæ˜¯è¢«å…è®¸çš„ï¼Œå› æ­¤å°±ä¸å†å¯¹å‰ç«¯çš„è·¨åŸŸè¯·æ±‚è¿›è¡Œé™åˆ¶ã€‚è¿™å±äºç®€å•è¯·æ±‚ï¼Œå³ä¸éœ€è¦è¿›è¡Œé¢„æ£€è¯·æ±‚çš„è·¨åŸŸã€‚</p>
<h4>éç®€å•è¯·æ±‚</h4>
<p>å¯¹äºä¸€äº›éç®€å•è¯·æ±‚ï¼Œä¼šé¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="hljs language-makefile">OPTIONS /put HTTP/1.1
<span class="hljs-section">Host: localhost:8080</span>
<span class="hljs-section">Connection: keep-alive</span>
<span class="hljs-section">Accept: */*</span>
<span class="hljs-section">Access-Control-Request-Method:PUT</span>
<span class="hljs-section">Origin: http://localhost: 8081</span>
<span class="hljs-section">Referer:http://localhost:8081/index.html</span>
</code></pre>
<p>è¯·æ±‚æ–¹æ³•æ˜¯ OPTIONSï¼Œè¯·æ±‚å¤´Origin å°±å‘Šè¯‰æœåŠ¡ç«¯å½“å‰é¡µé¢æ‰€åœ¨åŸŸï¼Œè¯·æ±‚å¤´ Access-Control-Request-Methods å‘Šè¯‰æœåŠ¡å™¨ç«¯å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚æ‰€ä½¿ç”¨çš„ä¸‡æ³•ã€‚æœåŠ¡ç«¯å¯¹æ­¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…è®¸å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¼šç»™å‡ºå¦‚ä¸‹å“åº”ï¼š</p>
<pre><code class="hljs language-yaml"><span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span>
<span class="hljs-attr">Access-Control-Allow-Origin:http://localhost:</span> <span class="hljs-number">8081</span>
<span class="hljs-attr">Access-Control-Request-Methods:</span> <span class="hljs-string">PUT</span>
<span class="hljs-attr">Access-Control-Max-Age:</span> <span class="hljs-number">3600</span>
</code></pre>
<p>Access-Control-Allow-Metbods å­—æ®µè¡¨ç¤ºå…è®¸çš„è·¨åŸŸæ–¹æ³•ï¼šAccess-Control-Max-Age å­—æ®µè¡¨ç¤ºé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œåœ¨æœ‰æ•ˆæœŸå†…å¦‚æœå‘èµ·è¯¥è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¸ç”¨å†æ¬¡å‘èµ·é¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç»“æœ¿åï¼Œæ¥ä¸‹æ¥å°±ä¼šå‘èµ·ä¸€ä¸ªçœŸæ­£çš„è·¨åŸŸè¯·æ±‚ï¼Œè·¨åŸŸè¯·æ±‚å’Œå‰é¢çš„ç®€å•è¯·æ±‚è·¨åŸŸæ­¥éª¤ç±»ä¼¼ã€‚</p>
<h3>Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h3>
<h4>@CrossOrigin</h4>
<p>Spring ä¸­ç¬¬ä¸€ç§å¤„ç†è·¨åŸŸçš„æ–¹å¼æ˜¯é€šè¿‡@CrossOrigin æ³¨è§£æ¥æ ‡è®°æ”¯æŒè·¨åŸŸï¼Œè¯¥æ³¨è§£å¯ä»¥æ·»åŠ åœ¨æ–¹æ³•ä¸Šï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ Controller ä¸Šã€‚å½“æ·»åŠ åœ¨ Controller ä¸Šæ—¶ï¼Œè¡¨ç¤º Controller ä¸­çš„æ‰€</p>
<p>æœ‰æ¥å£éƒ½æ”¯æŒè·¨åŸŸï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-less"><span class="hljs-variable">@RestController</span>
public Class HelloController{
	<span class="hljs-variable">@CrossOrigin</span> (origins =<span class="hljs-string">"http://localhost:8081"</span>)
	<span class="hljs-variable">@PostMapping</span> (<span class="hljs-string">"/post"</span>)
	public String post (){
		<span class="hljs-selector-tag">return</span> "<span class="hljs-selector-tag">hello</span> <span class="hljs-selector-tag">post</span>";
	}
}
</code></pre>
<p>@CrossOrigin æ³¨è§£å„å±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p>alowCredentialsï¼šæµè§ˆå™¨æ˜¯å¦åº”å½“å‘é€å‡­è¯ä¿¡æ¯ï¼Œå¦‚ Cookieã€‚</p>
</li>
<li>
<p>allowedHeadersï¼š è¯·æ±‚è¢«å…è®¸çš„è¯·æ±‚å¤´å­—æ®µï¼Œ<code>*</code>è¡¨ç¤ºæ‰€æœ‰å­—æ®µã€‚</p>
</li>
<li>
<p>exposedHeadersï¼šå“ªäº›å“åº”å¤´å¯ä»¥ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p>
<p><code>æ³¨æ„ï¼Œè¿™é‡Œåªå¯ä»¥ä¸€ä¸€åˆ—ä¸¾ï¼Œé€šé…ç¬¦ * åœ¨è¿™é‡Œæ˜¯æ— æ•ˆçš„ã€‚</code></p>
</li>
<li>
<p>maxAgeï¼šé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸå†…ä¸å¿…å†æ¬¡å‘é€é¢„æ£€è¯·æ±‚ï¼Œé»˜è®¤æ˜¯<code>1800</code> ç§’ã€‚</p>
</li>
<li>
<p>methodsï¼šå…è®¸çš„è¯·æ±‚æ–¹æ³•ï¼Œ<code>*</code> è¡¨ç¤ºå…è®¸æ‰€æœ‰æ–¹æ³•ã€‚</p>
</li>
<li>
<p>originsï¼šå…è®¸çš„åŸŸï¼Œ<code>*</code>è¡¨ç¤ºå…è®¸æ‰€æœ‰åŸŸã€‚</p>
</li>
</ul>
<h4>addCrosMapping</h4>
<p>@CrossOrigin æ³¨è§£éœ€è¦æ·»åŠ åœ¨ä¸åŒçš„ Controller ä¸Šã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ç§å…¨å±€é…ç½®æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡é‡å†™ WebMvcConfigurerComposite#addCorsMappingsæ–¹æ³•æ¥å®ç°ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-java">Configuration
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span>{
  Override
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span> <span class="hljs-params">(CorsRegistry registry)</span>{
    registry.addMapping(<span class="hljs-string">"/**"</span>) <span class="hljs-comment">//å¤„ç†çš„è¯·æ±‚åœ°å€</span>
    .allowedMethods (<span class="hljs-string">"*"</span>)
    â€¢allowedorigins(<span class="hljs-string">"*"</span>)
    .allowedHeaders (<span class="hljs-string">"*"</span>)
    .allowCredentials (<span class="hljs-literal">false</span>)
    â€¢exposedHeaders (<span class="hljs-string">""</span>)
    .maxAge (<span class="hljs-number">3600</span>) ;
  }
}
</code></pre>
<h4>CrosFilter</h4>
<p>Cosr Filter æ˜¯Spring Web ä¸­æä¾›çš„ä¸€ä¸ªå¤„ç†è·¨åŸŸçš„è¿‡æ»¤å™¨ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡è¯¥è¿‡è¯¥è¿‡æ»¤å™¨å¤„ç†è·¨åŸŸã€‚</p>
<pre><code class="hljs language-ini">@Configuration
public class WebMvcConfig {
    @Bean
    FilterRegistrationBean&#x3C;CorsFilter> corsFilter() {
        FilterRegistrationBean&#x3C;CorsFilter> <span class="hljs-attr">registrationBean</span> = new FilterRegistrationBean&#x3C;>()<span class="hljs-comment">;</span>
        CorsConfiguration <span class="hljs-attr">corsConfiguration</span> = new CorsConfiguration()<span class="hljs-comment">;</span>
        corsConfiguration.setAllowedHeaders(Arrays.asList("*"))<span class="hljs-comment">;</span>
        corsConfiguration.setAllowedMethods(Arrays.asList("*"))<span class="hljs-comment">;</span>
        corsConfiguration.setAllowedOrigins(Arrays.asList("*"))<span class="hljs-comment">;</span>
        corsConfiguration.setMaxAge(3600L)<span class="hljs-comment">;</span>
        UrlBasedCorsConfigurationSource <span class="hljs-attr">source</span> = new UrlBasedCorsConfigurationSource()<span class="hljs-comment">;</span>
        source.registerCorsConfiguration("/**", corsConfiguration)<span class="hljs-comment">;</span>
        registrationBean.setFilter(new CorsFilter(source))<span class="hljs-comment">;</span>
        registrationBean.setOrder(-1)<span class="hljs-comment">;//filter 0 1</span>
        return registrationBean<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3>Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h3>
<h4>åŸç†åˆ†æ</h4>
<p>å½“æˆ‘ä»¬ä¸ºé¡¹ç›®æ·»åŠ äº† Spring Security ä¾èµ–ä¹‹åï¼Œå‘ç°ä¸Šé¢ä¸‰ç§è·¨åŸŸæ–¹å¼æœ‰çš„å¤±æ•ˆäº†ï¼Œæœ‰<br>
åˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p>
<p>é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸï¼Œç»Ÿç»Ÿå¤±æ•ˆäº†ï¼Œé€š<br>
CorsFilter é…ç½®çš„è·¨åŸŸï¼Œæœ‰æ²¡æœ‰å¤±æ•ˆåˆ™è¦çœ‹è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº Sp<br>
Security è¿‡æ»¤å™¨ï¼Œå³å…ˆäº Spring Security è¿‡æ»¤å™¨æ‰§è¡Œï¼Œåˆ™ CorsFiter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†ä¾ç„¶æœ‰æ•ˆï¼›å¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§ä½äº Spring Security è¿‡æ»¤å™¨ï¼Œåˆ™ CorsFilter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†å°±ä¼šå¤±æ•ˆã€‚</p>
<p>ä¸ºäº†ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç®€ç•¥äº†è§£ä¸€ä¸‹ Filterã€DispatchserServlet ä»¥åŠInterceptor æ‰§è¡Œé¡ºåºã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/ae3bd2fdd428432487a8d1bd192dd8fa.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç†æ¸…æ¥šäº†æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬å†æ¥çœ‹è·¨åŸŸè¯·æ±‚è¿‡ç¨‹ã€‚ç”±äºéç®€å•è¯·æ±‚éƒ½è¦é¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚<br>
requestï¼‰ï¼Œè€Œé¢„æ£€è¯·æ±‚å¹¶ä¸ä¼šæºå¸¦è®¤è¯ä¿¡æ¯ï¼Œæ‰€ä»¥é¢„æ£€è¯·æ±‚å°±æœ‰è¢« Spring Security æ‹¦æˆªçš„å¯èƒ½ã€‚å› æ­¤é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸå°±ä¼šå¤±æ•ˆã€‚å¦‚æœä½¿ç”¨ CorsFilter é…ç½®çš„è·¨åŸŸï¼Œåªè¦è¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº SpringSecurity è¿‡æ»¤å™¨å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚åä¹‹åŒæ ·ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h4>è§£å†³æ–¹æ¡ˆ</h4>
<p>Spring Security ä¸­ä¹Ÿæä¾›äº†æ›´ä¸“ä¸šçš„æ–¹å¼æ¥è§£å†³é¢„æ£€è¯·æ±‚æ‰€é¢ä¸´çš„é—®é¢˜ã€‚å¦‚ï¼š</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
		<span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()<span class="hljs-selector-class">.anyRequest</span>()
                <span class="hljs-selector-class">.authenticated</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.formLogin</span>()
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.cors</span>() <span class="hljs-comment">//è·¨åŸŸå¤„ç†æ–¹æ¡ˆ</span>
                <span class="hljs-selector-class">.configurationSource</span>(configurationSource())
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
    }

    CorsConfigurationSource <span class="hljs-built_in">configurationSource</span>() {
        CorsConfiguration corsConfiguration = new <span class="hljs-built_in">CorsConfiguration</span>();
        corsConfiguration<span class="hljs-selector-class">.setAllowedHeaders</span>(Arrays.asList("*"));
        corsConfiguration<span class="hljs-selector-class">.setAllowedMethods</span>(Arrays.asList("*"));
        corsConfiguration<span class="hljs-selector-class">.setAllowedOrigins</span>(Arrays.asList("*"));
        corsConfiguration<span class="hljs-selector-class">.setMaxAge</span>(<span class="hljs-number">3600</span>L);
        UrlBasedCorsConfigurationSource <span class="hljs-selector-tag">source</span> = new <span class="hljs-built_in">UrlBasedCorsConfigurationSource</span>();
        <span class="hljs-selector-tag">source</span><span class="hljs-selector-class">.registerCorsConfiguration</span>("/**", corsConfiguration);
        return <span class="hljs-selector-tag">source</span>;
    }
}
</code></pre>
<h2>ç¬¬ä¹ç«  å¼‚å¸¸å¤„ç†</h2>
<ul>
<li>Spring Security å¼‚å¸¸ä½“ç³»</li>
<li>è‡ªå®šä¹‰å¼‚å¸¸é…ç½®</li>
</ul>
<h4>å¼‚å¸¸ä½“ç³»</h4>
<p>Spring Security ä¸­å¼‚å¸¸ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»:</p>
<ul>
<li>AuthenticationException: è®¤è¯å¼‚å¸¸</li>
<li>AccessDeniedException: æˆæƒå¼‚å¸¸</li>
</ul>
<p>å…¶ä¸­è®¤è¯æ‰€æ¶‰åŠå¼‚å¸¸ç±»å‹æ¯”è¾ƒå¤šï¼Œé»˜è®¤æä¾›çš„å¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/bafeb842d5e3468e8beb741861010713.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç›¸æ¯”äºè®¤è¯å¼‚å¸¸ï¼Œæƒé™å¼‚å¸¸ç±»å°±è¦å°‘äº†å¾ˆå¤šï¼Œé»˜è®¤æä¾›çš„æƒé™å¼‚å¸¸å¦‚ä¸‹ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/c9ad7346326a4f86915b2c8323db3021.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœé»˜è®¤æä¾›å¼‚å¸¸æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦æ ¹æ®å®é™…éœ€è¦æ¥è‡ªå®šä¹‰å¼‚å¸¸ç±»ã€‚</p>
<h4>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®</h4>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Configuration</span>
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    <span class="hljs-keyword">@Override</span>
    protected void configure(HttpSecurity http) throws Exception {
        http<span class="hljs-selector-class">.authorizeRequests</span>()<span class="hljs-selector-class">.anyRequest</span>()
                <span class="hljs-selector-class">.authenticated</span>()
          			<span class="hljs-comment">//.....</span>
                <span class="hljs-selector-class">.and</span>()
                <span class="hljs-selector-class">.exceptionHandling</span>()<span class="hljs-comment">//å¼‚å¸¸å¤„ç†</span>
                <span class="hljs-selector-class">.authenticationEntryPoint</span>((request, response, e) -> {
                  response<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
                  response<span class="hljs-selector-class">.setStatus</span>(HttpStatus.UNAUTHORIZED.value());
                  response<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.write</span>("å°šæœªè®¤è¯ï¼Œè¯·è¿›è¡Œè®¤è¯æ“ä½œï¼");
                })
                <span class="hljs-selector-class">.accessDeniedHandler</span>((request, response, e) -> {
                  response<span class="hljs-selector-class">.setContentType</span>("application/json;charset=UTF-<span class="hljs-number">8</span>");
                  response<span class="hljs-selector-class">.setStatus</span>(HttpStatus.FORBIDDEN.value());
                  response<span class="hljs-selector-class">.getWriter</span>()<span class="hljs-selector-class">.write</span>("æ— æƒè®¿é—®!");
                });
    }
}
</code></pre>
<h2>ç¬¬åç«  æˆæƒ</h2>
<ul>
<li>ä»€ä¹ˆæ˜¯æƒé™ç®¡ç†</li>
<li>æƒé™ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ</li>
<li>Spring Security æƒé™ç®¡ç†ç­–ç•¥</li>
<li>åŸºäº URL åœ°å€çš„æƒé™ç®¡ç†</li>
<li>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†</li>
<li>å®æˆ˜</li>
</ul>
<h4>æƒé™ç®¡ç†</h4>
<h5>è®¤è¯</h5>
<p><strong><code>èº«ä»½è®¤è¯</code></strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚Spring Security ä¸­æ”¯æŒå¤šç§ä¸åŒæ–¹å¼çš„è®¤è¯ï¼Œä½†æ˜¯æ— è®ºå¼€å‘è€…ä½¿ç”¨é‚£ç§æ–¹å¼è®¤è¯ï¼Œéƒ½ä¸ä¼šå½±å“æˆæƒåŠŸèƒ½ä½¿ç”¨ã€‚å› ä¸º Spring Security å¾ˆå¥½åšåˆ°äº†è®¤è¯å’Œæˆæƒè§£è€¦ã€‚</p>
<h5>æˆæƒ</h5>
<p><strong><code>æˆæƒ</code></strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ç®€å•çš„ç†è§£æˆæƒå°±æ˜¯æ ¹æ®ç³»ç»Ÿæå‰è®¾ç½®å¥½çš„è§„åˆ™ï¼Œç»™ç”¨æˆ·åˆ†é…å¯ä»¥è®¿é—®æŸä¸€ä¸ªèµ„æºçš„æƒé™ï¼Œç”¨æˆ·æ ¹æ®è‡ªå·±æ‰€å…·æœ‰æƒé™ï¼Œå»æ‰§è¡Œç›¸åº”æ“ä½œã€‚</p>
<h4>æˆæƒæ ¸å¿ƒæ¦‚å¿µ</h4>
<p>åœ¨å‰é¢å­¦ä¹ è®¤è¯è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥è®¤è¯æˆåŠŸä¹‹åä¼šå°†å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Authentication å¯¹è±¡ä¸­ï¼ŒAuthentication å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª getAuthorities() æ–¹æ³•ï¼Œç”¨æ¥è¿”å›å½“å‰ç™»å½•ç”¨æˆ·å…·å¤‡çš„æƒé™ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç”¨æˆ·å…·æœ‰æƒé™ä¿¡æ¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º Collection&#x3C;? extends GrantedAuthority>ï¼Œå½“éœ€è¦è¿›è¡Œæƒé™åˆ¤æ–­æ—¶ï¼Œå°±å›æ ¹æ®é›†åˆè¿”å›æƒé™ä¿¡æ¯è°ƒç”¨ç›¸åº”æ–¹æ³•è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/360962a66d1c412bb80c9f59d69db2ac.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé’ˆå¯¹äºè¿™ä¸ªè¿”å›å€¼ GrantedAuthority åº”è¯¥å¦‚ä½•ç†è§£å‘¢? æ˜¯è§’è‰²è¿˜æ˜¯æƒé™?</p>
<p>æˆ‘ä»¬é’ˆå¯¹äºæˆæƒå¯ä»¥æ˜¯<code>åŸºäºè§’è‰²æƒé™ç®¡ç†</code>å’Œ<code>åŸºäºèµ„æºæƒé™ç®¡ç†</code> ï¼Œä»è®¾è®¡å±‚é¢ä¸Šæ¥è¯´ï¼Œè§’è‰²å’Œæƒé™æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼šæƒé™æ˜¯ä¸€äº›å…·ä½“æ“ä½œï¼Œè§’è‰²åˆ™æ˜¯æŸäº›æƒé™é›†åˆã€‚å¦‚ï¼šREAD_BOOK å’Œ ROLE_ADMIN æ˜¯å®Œå…¨ä¸åŒçš„ã€‚å› æ­¤è‡³äºè¿”å›å€¼æ˜¯ä»€ä¹ˆå–å†³äºä½ çš„ä¸šåŠ¡è®¾è®¡æƒ…å†µï¼š</p>
<ul>
<li>
<p>åŸºäºè§’è‰²æƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&#x3C;=>è§’è‰²&#x3C;=>èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>è§’è‰²</code></p>
</li>
<li>
<p>åŸºäºèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&#x3C;=>æƒé™&#x3C;=>èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>æƒé™</code></p>
</li>
<li>
<p>åŸºäºè§’è‰²å’Œèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&#x3C;=>è§’è‰²&#x3C;=>æƒé™&#x3C;=>èµ„æº</code> è¿”å›ç»Ÿç§°ä¸ºç”¨æˆ·çš„<code>æƒé™</code></p>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆå¯ä»¥ç»Ÿç§°ä¸ºæƒé™ï¼Œå› ä¸ºä»ä»£ç å±‚é¢è§’è‰²å’Œæƒé™æ²¡æœ‰å¤ªå¤§ä¸åŒéƒ½æ˜¯æƒé™ï¼Œç‰¹åˆ«æ˜¯åœ¨ Spring Security ä¸­ï¼Œè§’è‰²å’Œæƒé™å¤„ç†æ–¹å¼åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€åŒºåˆ« SpringSecurity åœ¨å¾ˆå¤šæ—¶å€™ä¼šè‡ªåŠ¨ç»™è§’è‰²æ·»åŠ ä¸€ä¸ª<code>ROLE_</code>å‰ç¼€ï¼Œè€Œæƒé™åˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ ã€‚</p>
<h4>æƒé™ç®¡ç†ç­–ç•¥</h4>
<p>Spring Security ä¸­æä¾›çš„æƒé™ç®¡ç†ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ç±»å‹:</p>
<ul>
<li>
<p>åŸºäºè¿‡æ»¤å™¨(URL)çš„æƒé™ç®¡ç† (FilterSecurityInterceptor)</p>
<ul>
<li>åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥æ‹¦æˆª HTTP è¯·æ±‚ï¼Œæ‹¦æˆªä¸‹æ¥ä¹‹åï¼Œæ ¹æ® HTTP è¯·æ±‚åœ°å€è¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
</ul>
</li>
<li>
<p>åŸºäº AOP (æ–¹æ³•)çš„æƒé™ç®¡ç† (MethodSecurityInterceptor)</p>
<ul>
<li>åŸºäº AOP æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ–¹æ³•çº§åˆ«çš„æƒé™é—®é¢˜ã€‚å½“éœ€è¦è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œé€šè¿‡ AOP å°†æ“ä½œæ‹¦æˆªä¸‹æ¥ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸å…³çš„æƒé™ã€‚</li>
</ul>
</li>
</ul>
<h4>åŸºäº URL æƒé™ç®¡ç†</h4>
<ul>
<li>
<p>å¼€å‘ controller</p>
<p>@RestController
public class DemoController {</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/admin"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">admin</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"admin ok"</span>;
}

<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/user"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">user</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"user ok"</span>;
}

<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getInfo"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getInfo</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"info ok"</span>;
}
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½®æˆæƒ</p>
<p>package com.blr.config;</p>
<p>import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;</p>
<p>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {</p>
<pre><code class="hljs language-scss"><span class="hljs-comment">//åˆ›å»ºå†…å­˜æ•°æ®æº</span>
public UserDetailsService <span class="hljs-built_in">userDetailsService</span>() {
    InMemoryUserDetailsManager inMemoryUserDetailsManager = new <span class="hljs-built_in">InMemoryUserDetailsManager</span>();
    <span class="hljs-comment">//åŸºäºè§’è‰²</span>
    inMemoryUserDetailsManager<span class="hljs-selector-class">.createUser</span>(User.withUsername("root")<span class="hljs-selector-class">.password</span>("{noop}<span class="hljs-number">123</span>")<span class="hljs-selector-class">.roles</span>("ADMIN")<span class="hljs-selector-class">.build</span>());
    inMemoryUserDetailsManager<span class="hljs-selector-class">.createUser</span>(User.withUsername("win7")<span class="hljs-selector-class">.password</span>("{noop}<span class="hljs-number">123</span>")<span class="hljs-selector-class">.roles</span>("USER")<span class="hljs-selector-class">.build</span>());
    <span class="hljs-comment">//åŸºäºæƒé™</span>
    inMemoryUserDetailsManager<span class="hljs-selector-class">.createUser</span>(User.withUsername("lisi")<span class="hljs-selector-class">.password</span>("{noop}<span class="hljs-number">123</span>")<span class="hljs-selector-class">.authorities</span>("READ_BOOK")<span class="hljs-selector-class">.build</span>());
    return inMemoryUserDetailsManager;
}

<span class="hljs-keyword">@Override</span>
protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    auth<span class="hljs-selector-class">.userDetailsService</span>(userDetailsService());
}

<span class="hljs-keyword">@Override</span>
protected void configure(HttpSecurity http) throws Exception {
    http<span class="hljs-selector-class">.authorizeHttpRequests</span>()
        <span class="hljs-comment">//  /**:ä»£è¡¨é€šé…ç¬¦</span>
            <span class="hljs-selector-class">.antMatchers</span>("/admin/**")<span class="hljs-selector-class">.hasRole</span>("ADMIN")
            <span class="hljs-selector-class">.antMatchers</span>("/user/**")<span class="hljs-selector-class">.hasAnyRole</span>("USER", "ADMIN")
            <span class="hljs-selector-class">.antMatchers</span>("/getInfo")<span class="hljs-selector-class">.hasAuthority</span>("READ_BOOK")
            <span class="hljs-selector-class">.anyRequest</span>()<span class="hljs-selector-class">.authenticated</span>()
            <span class="hljs-selector-class">.and</span>()<span class="hljs-selector-class">.formLogin</span>()
            <span class="hljs-selector-class">.and</span>()<span class="hljs-selector-class">.csrf</span>()<span class="hljs-selector-class">.disable</span>();
}
</code></pre>
<p>}</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/c978a5a1723c481180e0b430d935ed45.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p><img src="https://img-blog.csdnimg.cn/666e7ea565524f8089f422961f77adf6.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>å¯åŠ¨é¡¹ç›®æµ‹è¯•</li>
</ul>
<h5>æƒé™è¡¨è¾¾å¼</h5>
<p><img src="https://img-blog.csdnimg.cn/28615043cfe14a0490c02854bd41863f.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>æ–¹æ³•</p>
<p>è¯´æ˜</p>
<p>hasAuthority(String authority)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™</p>
<p>hasAnyAuthority(Stringâ€¦ authorities)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™ä¸­ä»»æ„ä¸€ä¸ª</p>
<p>hasRole(String role)</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²</p>
<p>hasAnyRole(Stringâ€¦ roles);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²ä¸­ä»»æ„ä¸€ä¸ª</p>
<p>permitAll();</p>
<p>æ”¾è¡Œæ‰€æœ‰è¯·æ±‚/è°ƒç”¨</p>
<p>denyAll();</p>
<p>æ‹’ç»æ‰€æœ‰è¯·æ±‚/è°ƒç”¨</p>
<p>isAnonymous();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªåŒ¿åç”¨æˆ·</p>
<p>isAuthenticated();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è®¤è¯æˆåŠŸ</p>
<p>isRememberMe();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•</p>
<p>isFullyAuthenticated();</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦æ—¢ä¸æ˜¯åŒ¿åç”¨æˆ·åˆä¸æ˜¯é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•çš„</p>
<p>hasPermission(Object targetId, Object permission);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</p>
<p>hasPermission(Object targetId, String targetType, Object permission);</p>
<p>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</p>
<h5>antMatchersï¼ŒmvcMatchersï¼ŒregexMatchers çš„åŒºåˆ«ï¼š</h5>
<p><img src="https://img-blog.csdnimg.cn/3d53f9e569864db2bf3c3831898e6790.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>åŸºäº æ–¹æ³• æƒé™ç®¡ç†</h4>
<p>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯é€šè¿‡ A0P æ¥å®ç°çš„ï¼ŒSpring Security ä¸­é€šè¿‡ MethodSecurityInterceptor æ¥æä¾›ç›¸å…³çš„å®ç°ã€‚ä¸åŒåœ¨äº FilterSecurityInterceptor åªæ˜¯åœ¨è¯·æ±‚ä¹‹å‰è¿›è¡Œå‰ç½®å¤„ç†ï¼ŒMethodSecurityInterceptor é™¤äº†å‰ç½®å¤„ç†ä¹‹å¤–è¿˜å¯ä»¥è¿›è¡Œåç½®å¤„ç†ã€‚å‰ç½®å¤„ç†å°±æ˜¯åœ¨è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å…·å¤‡ç›¸åº”çš„æƒé™ï¼Œåç½®å¤„ç†åˆ™æ˜¯å¯¹æ–¹æ³•çš„æ‰§è¡Œç»“æœè¿›è¡ŒäºŒæ¬¡è¿‡æ»¤ã€‚å‰ç½®å¤„ç†å’Œåç½®å¤„ç†åˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„å®ç°ç±»ã€‚</p>
<h5>@EnableGlobalMethodSecurity</h5>
<p>EnableGlobalMethodSecurity è¯¥æ³¨è§£æ˜¯ç”¨æ¥å¼€å¯æƒé™æ³¨è§£ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableGlobalMethodSecurity</span>(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)
public class SecurityConfig extends WebsecurityConfigurerAdapter{}
</code></pre>
<ul>
<li>
<p><strong>perPostEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„å››ä¸ªæƒé™æ³¨è§£ï¼Œ@PostAuthorizeã€@PostFilterã€@PreAuthorize ä»¥åŠ@PreFilterã€‚</p>
</li>
<li>
<p><strong>securedEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„ @Secured æ³¨è§£æ”¯æŒï¼Œè¯¥æ³¨è§£ä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</p>
</li>
<li>
<p><strong>jsr250Enabled</strong>: å¼€å¯ JSR-250 æä¾›çš„æ³¨è§£ï¼Œä¸»è¦æ˜¯@DenyAllã€@PermitAllã€@RolesAll åŒæ ·è¿™äº›æ³¨è§£ä¹Ÿä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</p>
<h1>ä»¥ä¸Šæ³¨è§£å«ä¹‰å¦‚ä¸‹:</h1>
<ul>
<li>@PostAuthorizeï¼š åœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åè¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
<li>@PostFiterï¼š åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åå¯¹æ–¹æ³•çš„è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</li>
<li>@PreAuthorizeï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰è¿›è¡Œæƒé™æ ¡éªŒã€‚</li>
<li>@PreFiterï¼šåœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œè¿‡æ»¤ã€‚</li>
<li>@Securedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å„ç›¸åº”çš„è§’è‰²ã€‚</li>
<li>@DenyAllï¼šæ‹’ç»æ‰€æœ‰è®¿é—®ã€‚</li>
<li>@PermitAllï¼šå…è®¸æ‰€æœ‰è®¿é—®ã€‚</li>
<li>@RolesAllowedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å¤‡ç›¸åº”çš„è§’è‰²ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™äº›åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ç›¸å…³çš„æ³¨è§£ï¼Œä¸€èˆ¬æ¥è¯´åªè¦è®¾ç½® <strong><code>prePostEnabled=true</code></strong> å°±å¤Ÿç”¨äº†ã€‚</p>
<h5>åŸºæœ¬ç”¨æ³•</h5>
<ul>
<li>
<p>å¼€å¯æ³¨è§£ä½¿ç”¨</p>
<p>@Configuration
@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)
public class SecurityConfig extends WebsecurityConfigurerAdapter{}</p>
</li>
<li>
<p>ä½¿ç”¨æ³¨è§£</p>
<p>@RestController
@RequestMapping("/hello")
public class AuthorizeMethodController {</p>
<p>// @PreAuthorize("hasRole('ADMIN') and authentication.name=='root'")//åŸºäºè§’è‰²å’Œç”¨æˆ·å
@PreAuthorize("hasAuthority('READ_INFO'))//åŸºäºæƒé™
@GetMapping
public String hello() {
return "hello";
}</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"authentication.name==#name"</span>)
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/name"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> name</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"hello:"</span> + name;
}

<span class="hljs-meta">@PreFilter</span>(value = <span class="hljs-string">"filterObject.id%2!=0"</span>,filterTarget = <span class="hljs-string">"users"</span>)
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/users"</span>)  <span class="hljs-comment">//filterTarget å¿…é¡»æ˜¯ æ•°ç»„  é›†åˆ</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addUsers</span>(<span class="hljs-params"><span class="hljs-meta">@RequestBody</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">User</span>> users</span>) {
    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"users = "</span> + users);
}

<span class="hljs-meta">@PostAuthorize</span>(<span class="hljs-string">"returnObject.id==1"</span>)
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/userId"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"blr"</span>);
}

<span class="hljs-meta">@PostFilter</span>(<span class="hljs-string">"filterObject.id%2==0"</span>)
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/lists"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">User</span>> <span class="hljs-title function_">getAll</span>(<span class="hljs-params"></span>) {
    <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">User</span>> users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&#x3C;>();
    <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &#x3C; <span class="hljs-number">10</span>; i++) {
        users.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(i, <span class="hljs-string">"blr:"</span> + i));
    }
    <span class="hljs-keyword">return</span> users;
}

<span class="hljs-meta">@Secured</span>({<span class="hljs-string">"ROLE_USER"</span>}) <span class="hljs-comment">//åªèƒ½åˆ¤æ–­è§’è‰²</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/secured"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserByUsername</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">99</span>, <span class="hljs-string">"secured"</span>);
}

<span class="hljs-meta">@Secured</span>({<span class="hljs-string">"ROLE_ADMIN"</span>,<span class="hljs-string">"ROLE_USER"</span>}) <span class="hljs-comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªå³å¯</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/username"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUserByUsername2</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> username</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">99</span>, username);
}

<span class="hljs-meta">@PermitAll</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/permitAll"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">permitAll</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"PermitAll"</span>;
}

<span class="hljs-meta">@DenyAll</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/denyAll"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">denyAll</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"DenyAll"</span>;
}

<span class="hljs-meta">@RolesAllowed</span>({<span class="hljs-string">"ROLE_ADMIN"</span>,<span class="hljs-string">"ROLE_USER"</span>}) <span class="hljs-comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªè§’è‰²å³å¯</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/rolesAllowed"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">rolesAllowed</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"RolesAllowed"</span>;
}
</code></pre>
<p>}</p>
</li>
</ul>
<h3>åŸç†åˆ†æ</h3>
<p><img src="https://img-blog.csdnimg.cn/897707bd55e6425dbcf4d449f44dd026.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li><strong><code>ConfigAttribute</code></strong> åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ªèµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</li>
<li><strong><code>AccesDecisionVoter å’Œ AccessDecisionManager</code></strong> éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</li>
</ul>
<h3>å®æˆ˜</h3>
<p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ URL æ‹¦æˆªè§„åˆ™å’Œè¯·æ±‚ URL æ‰€éœ€è¦çš„æƒé™éƒ½æ˜¯é€šè¿‡ä»£ç æ¥é…ç½®çš„ï¼Œè¿™æ ·å°±æ¯”è¾ƒæ­»æ¿ï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è®¿é—®æŸä¸€ä¸ª URL æ‰€éœ€è¦çš„æƒé™ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚</p>
<p>åŠ¨æ€ç®¡ç†æƒé™è§„åˆ™å°±æ˜¯æˆ‘ä»¬å°† URL æ‹¦æˆªè§„åˆ™å’Œè®¿é—® URI æ‰€éœ€è¦çš„æƒé™éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè¿™æ ·ï¼Œåœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå°±å¯ä»¥å¯¹æƒé™è¿›è¡Œè°ƒæ•´ã€‚</p>
<p><code>ç”¨æˆ·&#x3C;--ä¸­é—´è¡¨--> è§’è‰² &#x3C;--ä¸­é—´è¡¨--> èœå•</code></p>
<h4>åº“è¡¨è®¾è®¡</h4>
<pre><code class="hljs language-sql"><span class="hljs-keyword">SET</span> NAMES utf8mb4;
<span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for menu</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `menu`;
<span class="hljs-keyword">CREATE TABLE</span> `menu` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT,
  `<span class="hljs-keyword">pattern</span>` <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY KEY</span> (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of menu</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'/admin/**'</span>);
<span class="hljs-keyword">INSERT INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'/user/**'</span>);
<span class="hljs-keyword">INSERT INTO</span> `menu` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'/guest/**'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for menu_role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `menu_role`;
<span class="hljs-keyword">CREATE TABLE</span> `menu_role` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT,
  `mid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY KEY</span> (`id`),
  KEY `mid` (`mid`),
  KEY `rid` (`rid`),
  <span class="hljs-keyword">CONSTRAINT</span> `menu_role_ibfk_1` <span class="hljs-keyword">FOREIGN KEY</span> (`mid`) <span class="hljs-keyword">REFERENCES</span> `menu` (`id`),
  <span class="hljs-keyword">CONSTRAINT</span> `menu_role_ibfk_2` <span class="hljs-keyword">FOREIGN KEY</span> (`rid`) <span class="hljs-keyword">REFERENCES</span> `role` (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of menu_role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">INSERT INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">INSERT INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
<span class="hljs-keyword">INSERT INTO</span> `menu_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `role`;
<span class="hljs-keyword">CREATE TABLE</span> `role` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `nameZh` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY KEY</span> (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'ROLE_ADMIN'</span>, <span class="hljs-string">'ç³»ç»Ÿç®¡ç†å‘˜'</span>);
<span class="hljs-keyword">INSERT INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'ROLE_USER'</span>, <span class="hljs-string">'æ™®é€šç”¨æˆ·'</span>);
<span class="hljs-keyword">INSERT INTO</span> `role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'ROLE_GUEST'</span>, <span class="hljs-string">'æ¸¸å®¢'</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for user</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;
<span class="hljs-keyword">CREATE TABLE</span> `<span class="hljs-keyword">user</span>` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT,
  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `enabled` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `locked` tinyint(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY KEY</span> (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of user</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'admin'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">INSERT INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'blr'</span>, <span class="hljs-string">'{noop}123'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Table structure for user_role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `user_role`;
<span class="hljs-keyword">CREATE TABLE</span> `user_role` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT NULL</span> AUTO_INCREMENT,
  `uid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `rid` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY KEY</span> (`id`),
  KEY `uid` (`uid`),
  KEY `rid` (`rid`),
  <span class="hljs-keyword">CONSTRAINT</span> `user_role_ibfk_1` <span class="hljs-keyword">FOREIGN KEY</span> (`uid`) <span class="hljs-keyword">REFERENCES</span> `<span class="hljs-keyword">user</span>` (`id`),
  <span class="hljs-keyword">CONSTRAINT</span> `user_role_ibfk_2` <span class="hljs-keyword">FOREIGN KEY</span> (`rid`) <span class="hljs-keyword">REFERENCES</span> `role` (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-comment">-- Records of user_role</span>
<span class="hljs-comment">-- ----------------------------</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">INSERT INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">INSERT INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">INSERT INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
<span class="hljs-keyword">INSERT INTO</span> `user_role` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<h4>åˆ›å»º springboot åº”ç”¨</h4>
<ul>
<li>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-security<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-web<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>mysql<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mysql-connector-java<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>5.1.38<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>com.alibaba<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>druid<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>1.2.8<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.mybatis.spring.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mybatis-spring-boot-starter<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>2.2.2<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
</li>
<li>
<p>é…ç½®é…ç½®æ–‡ä»¶</p>
<pre><code class="hljs language-ini"><span class="hljs-attr">server.port</span>=<span class="hljs-number">8080</span>
<span class="hljs-attr">spring.datasource.type</span>=com.alibaba.druid.pool.DruidDataSource
<span class="hljs-attr">spring.datasource.driver-class-name</span>=com.mysql.jdbc.Driver
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/security?characterEncoding=UTF-<span class="hljs-number">8</span>
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root
<span class="hljs-attr">mybatis.mapper-locations</span>=classpath:com/blr/mapper/*.xml
<span class="hljs-attr">mybatis.type-aliases-package</span>=com.blr.entity
</code></pre>
</li>
<li>
<p>åˆ›å»ºå®ä½“ç±»</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> password;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> username;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> enabled;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> locked;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&#x3C;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>> <span class="hljs-title function_">getAuthorities</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> roles.<span class="hljs-title function_">stream</span>().<span class="hljs-title function_">map</span>(r -> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(r.<span class="hljs-title function_">getName</span>())).<span class="hljs-title function_">collect</span>(<span class="hljs-title class_">Collectors</span>.<span class="hljs-title function_">toList</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPassword</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUsername</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> !locked;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isEnabled</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> enabled;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPassword</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> password</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUsername</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> username</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setEnabled</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> enabled</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span> = enabled;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setLocked</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> locked</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">locked</span> = locked;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setRoles</span>(<span class="hljs-params"><span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">roles</span> = roles;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> <span class="hljs-title function_">getRoles</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> roles;
    }
}


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Role</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> nameZh;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getNameZh</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> nameZh;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setNameZh</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> nameZh</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nameZh</span> = nameZh;
    }
}


<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Menu</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Integer</span> id;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> pattern;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> <span class="hljs-title function_">getRoles</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> roles;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setRoles</span>(<span class="hljs-params"><span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Role</span>> roles</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">roles</span> = roles;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">getId</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setId</span>(<span class="hljs-params"><span class="hljs-title class_">Integer</span> id</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPattern</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> pattern;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setPattern</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> pattern</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pattern</span> = pattern;
    }
}
</code></pre>
</li>
<li>
<p>åˆ›å»º mapper æ¥å£</p>
<pre><code class="hljs language-scss"><span class="hljs-keyword">@Mapper</span>
public interface UserMapper {
    List&#x3C;Role> <span class="hljs-built_in">getUserRoleByUid</span>(Integer uid);
    User <span class="hljs-built_in">loadUserByUsername</span>(String username);
}


<span class="hljs-keyword">@Mapper</span>
public interface MenuMapper {
    List&#x3C;<span class="hljs-selector-tag">Menu</span>> <span class="hljs-built_in">getAllMenu</span>();
}
</code></pre>
</li>
<li>
<p>åˆ›å»º mapper æ–‡ä»¶</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-keyword">mapper</span>
        <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
        <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.blr.mapper.UserMapper"</span>></span>

    <span class="hljs-tag">&#x3C;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"loadUserByUsername"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.blr.entity.User"</span>></span>
        select *
        from user
        where username = #{username};
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">select</span>></span>

    <span class="hljs-tag">&#x3C;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserRoleByUid"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.blr.entity.Role"</span>></span>
        select r.*
        from role r,
             user_role ur
        where ur.uid = #{uid}
          and ur.rid = r.id
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">select</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">mapper</span>></span>


<span class="hljs-tag">&#x3C;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.blr.mapper.MenuMapper"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"MenuResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.blr.entity.Menu"</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span>/></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pattern"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"pattern"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">result</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"roles"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.blr.entity.Role"</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"rid"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"rname"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span>/></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"rnameZh"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"nameZh"</span>/></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">collection</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">resultMap</span>></span>
  
    <span class="hljs-tag">&#x3C;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getAllMenu"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"MenuResultMap"</span>></span>
        select m.*, r.id as rid, r.name as rname, r.nameZh as rnameZh
        from menu m
                 left join menu_role mr on m.`id` = mr.`mid`
                 left join role r on r.`id` = mr.`rid`
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">select</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">mapper</span>></span>
</span></code></pre>
</li>
<li>
<p>åˆ›å»º service æ¥å£</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserMapper userMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserMapper userMapper)</span> {
        <span class="hljs-built_in">this</span>.userMapper = userMapper;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.loadUserByUsername(username);
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">"ç”¨æˆ·ä¸å­˜åœ¨"</span>);
        }
        user.setRoles(userMapper.getUserRoleByUid(user.getId()));
        <span class="hljs-keyword">return</span> user;
    }
}


<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MenuService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MenuMapper menuMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MenuService</span><span class="hljs-params">(MenuMapper menuMapper)</span> {
        <span class="hljs-built_in">this</span>.menuMapper = menuMapper;
    }

    <span class="hljs-keyword">public</span> List&#x3C;Menu> <span class="hljs-title function_">getAllMenu</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> menuMapper.getAllMenu();
    }
}
</code></pre>
</li>
<li>
<p>åˆ›å»ºæµ‹è¯• controller</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/admin/hello"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">admin</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello admin"</span>;
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/user/hello"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">user</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello user"</span>;
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/guest/hello"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">guest</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello guest"</span>;
    }

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/hello"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;
    }
}
</code></pre>
</li>
<li>
<p>åˆ›å»º CustomSecurityMetadataSource</p>
<pre><code class="hljs language-typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomSecurityMetadataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FilterInvocationSecurityMetadataSource</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">MenuService</span> menuService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CustomSecurityMetadataSource</span>(<span class="hljs-title class_">MenuService</span> menuService) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">menuService</span> = menuService;
    }

    <span class="hljs-title class_">AntPathMatcher</span> antPathMatcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&#x3C;<span class="hljs-title class_">ConfigAttribute</span>> <span class="hljs-title function_">getAttributes</span>(<span class="hljs-title class_">Object</span> <span class="hljs-built_in">object</span>) throws <span class="hljs-title class_">IllegalArgumentException</span> {
        <span class="hljs-title class_">String</span> requestURI = ((<span class="hljs-title class_">FilterInvocation</span>) <span class="hljs-built_in">object</span>).<span class="hljs-title function_">getRequest</span>().<span class="hljs-title function_">getRequestURI</span>();
        <span class="hljs-title class_">List</span>&#x3C;<span class="hljs-title class_">Menu</span>> allMenu = menuService.<span class="hljs-title function_">getAllMenu</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Menu</span> menu : allMenu) {
            <span class="hljs-keyword">if</span> (antPathMatcher.<span class="hljs-title function_">match</span>(menu.<span class="hljs-title function_">getPattern</span>(), requestURI)) {
                <span class="hljs-title class_">String</span>[] roles = menu.<span class="hljs-title function_">getRoles</span>().<span class="hljs-title function_">stream</span>().<span class="hljs-title function_">map</span>(r -> r.<span class="hljs-title function_">getName</span>()).<span class="hljs-title function_">toArray</span>(<span class="hljs-title class_">String</span>[]::<span class="hljs-keyword">new</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">SecurityConfig</span>.<span class="hljs-title function_">createList</span>(roles);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Collection</span>&#x3C;<span class="hljs-title class_">ConfigAttribute</span>> <span class="hljs-title function_">getAllConfigAttributes</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">supports</span>(<span class="hljs-params"><span class="hljs-title class_">Class</span>&#x3C;?> clazz</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">FilterInvocation</span>.<span class="hljs-property">class</span>.<span class="hljs-title function_">isAssignableFrom</span>(clazz);
    }
}
</code></pre>
</li>
<li>
<p>é…ç½® Security é…ç½®</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CustomSecurityMetadataSource customSecurityMetadataSource;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecurityConfig</span><span class="hljs-params">(CustomSecurityMetadataSource customSecurityMetadataSource, UserService userService)</span> {
        <span class="hljs-built_in">this</span>.customSecurityMetadataSource = customSecurityMetadataSource;
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userService);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
       <span class="hljs-comment">//1.è·å–å·¥å‚å¯¹è±¡</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> http.getSharedObject(ApplicationContext.class);
        <span class="hljs-comment">//2.è®¾ç½®è‡ªå®šä¹‰ url æƒé™å¤„ç†</span>
        http.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlAuthorizationConfigurer</span>&#x3C;>(applicationContext))
                .withObjectPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPostProcessor</span>&#x3C;FilterSecurityInterceptor>() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> &#x3C;O <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FilterSecurityInterceptor</span>> O <span class="hljs-title function_">postProcess</span><span class="hljs-params">(O object)</span> {
                        object.setSecurityMetadataSource(customSecurityMetadataSource);
                        <span class="hljs-comment">//æ˜¯å¦æ‹’ç»å…¬å…±èµ„æºè®¿é—®</span>
                        object.setRejectPublicInvocations(<span class="hljs-literal">false</span>);
                        <span class="hljs-keyword">return</span> object;
                    }
                });
        http.formLogin().and().csrf().disable();
    }
}
</code></pre>
</li>
<li>
<p>å¯åŠ¨å…¥å£ç±»è¿›è¡Œæµ‹è¯•</p>
</li>
</ul>
<h2>ç¬¬åä¸€ç«  OAuth2</h2>
<ul>
<li>OAuth2 ç®€ä»‹</li>
<li>å››ç§æˆæƒæ¨¡å¼</li>
<li>Spring Security OAuth2</li>
<li>GitHub æˆæƒç™»å½•</li>
<li>æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨</li>
<li>ä½¿ç”¨ JWT</li>
</ul>
<h3>OAuth2 ç®€ä»‹</h3>
<p>OAuth æ˜¯ä¸€ä¸ªå¼€æ”¾çš„éå¸¸é‡è¦çš„è®¤è¯æ ‡å‡†/åè®®ï¼Œè¯¥æ ‡å‡†å…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†èµ„æºï¼ˆå¦‚å¤´åƒã€ç…§ç‰‡ã€è§†é¢‘ç­‰ï¼‰ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— é¡»å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚é€šè¿‡ä»¤ç‰Œï¼ˆtokenï¼‰å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæ¯ä¸€ä¸ªä»¤ç‰Œæˆæƒä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™åœ¨ç‰¹å®šçš„æ—¶æ®µå†…å…è®¸å¯ç‰¹å®šçš„èµ„æºã€‚OAuth è®©ç”¨æˆ·å¯ä»¥æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™çµæ´»è®¿é—®å®ƒä»¬å­˜å‚¨åœ¨å¦å¤–ä¸€äº›èµ„æºæœåŠ¡å™¨ä¸Šçš„ç‰¹å®šä¿¡æ¯ï¼Œè€Œéæ‰€æœ‰å†…å®¹ã€‚å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨äº’è”ç½‘åº”ç”¨ä¸­æœ€å¸¸è§çš„ OAuth åº”ç”¨å°±æ˜¯å„ç§ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œä¾‹å¦‚QQæˆæƒç™»å½•ã€å¾®ä¿¡æˆæƒç™»å½•ã€å¾®åšæˆæƒç™»å½•ã€GitHub æˆæƒç™»å½•ç­‰ã€‚</p>
<p>ä¾‹å¦‚ç”¨æˆ·æƒ³ç™»å½• Ruby Chinaï¼Œä¼ ç»Ÿæ–¹å¼æ˜¯ä½¿ç”¨ç”¨æˆ·åå¯†ç ä½†æ˜¯è¿™æ ·å¹¶ä¸å®‰å…¨ï¼Œå› ä¸ºç½‘ç«™ä¼šå­˜å‚¨ä½ çš„ç”¨æˆ·åå¯†ç ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å¯†ç æ³„éœ²ã€‚è¿™ç§æˆæƒæ–¹å¼å®‰å…¨éšæ‚£å¾ˆå¤§ï¼Œå¦‚æœä½¿ç”¨ OAuth åè®®å°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/2f4b4c89b0784f858c19f40e820a3a13.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<blockquote>
<p>æ³¨æ„: OAuth2 æ˜¯OAuth åè®®çš„ä¸‹ä¸€ç‰ˆæœ¬ï¼Œä½†ä¸å…¼å®¹ OAuth 1.0ã€‚ OAuth2 å…³æ³¨å®¢æˆ·ç«¯å¼€å‘è€…çš„ç®€æ˜“æ€§ï¼ŒåŒæ—¶ä¸º Web åº”ç”¨ã€æ¡Œé¢åº”ç”¨ã€ç§»åŠ¨è®¾å¤‡ã€IoT è®¾å¤‡æä¾›ä¸“é—¨çš„è®¤è¯æµç¨‹ã€‚</p>
</blockquote>
<h3>OAuth2 æˆæƒæ€»ä½“æµç¨‹</h3>
<p>è§’è‰²æ¢³ç†: ç¬¬ä¸‰æ–¹åº”ç”¨ &#x3C;----> å­˜å‚¨ç”¨æˆ·ç§å¯†ä¿¡æ¯åº”ç”¨ ----> æˆæƒæœåŠ¡å™¨ ----> èµ„æºæœåŠ¡å™¨</p>
<p>æ•´ä½“æµç¨‹å¦‚ä¸‹:ï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/c8faee8ce3d7478e8d4b9cbd414f7b58.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-diff"><span class="hljs-deletion">- ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚</span>
<span class="hljs-deletion">- ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚</span>
<span class="hljs-deletion">- ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚</span>
<span class="hljs-deletion">- ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚</span>
<span class="hljs-deletion">- ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚</span>
<span class="hljs-deletion">- ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚</span>
</code></pre>
<p>ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…­ä¸ªæ­¥éª¤ä¹‹ä¸­ï¼ŒBæ˜¯å…³é”®ï¼Œå³ç”¨æˆ·æ€æ ·æ‰èƒ½ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚åŒæ—¶ä¼šå‘ç° OAuth2 ä¸­åŒ…å«å››ç§ä¸åŒçš„è§’è‰²ï¼š</p>
<ul>
<li>**Clientï¼š**ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</li>
<li><strong>Resource Owner</strong>ï¼šèµ„æºæ‰€æœ‰è€…ã€‚</li>
<li><strong>Authorization Server</strong> ï¼šæˆæƒæœåŠ¡å™¨ã€‚</li>
<li><strong>Resource Server</strong>ï¼š èµ„æºæœåŠ¡å™¨ã€‚</li>
</ul>
<h3>å››ç§æˆæƒæ¨¡å¼</h3>
<h4>æˆæƒç æ¨¡å¼</h4>
<p><strong>æˆæƒç æ¨¡å¼ï¼ˆ<code>Authorization Code</code>ï¼‰</strong> æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†ã€æœ€å®‰å…¨å¹¶ä¸”ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§OAuth2æˆæƒæ¨¡å¼ã€‚åŒæ—¶ä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ç§æˆæƒæ¨¡å¼ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸<code>æœåŠ¡æä¾›å•†</code>çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<ul>
<li>Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œç®€ç§°"å®¢æˆ·ç«¯"ï¼ˆclientï¼‰ï¼›</li>
<li>Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œç®€ç§°"ç”¨æˆ·"ï¼ˆuserï¼‰ï¼›</li>
<li>User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæ˜¯æŒ‡æµè§ˆå™¨ï¼›</li>
<li>Authorization Serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ï¼›</li>
<li>Resource Serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/62fd9b08d7d14541989987ec7e6e4960.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æµç¨‹å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡æµè§ˆå™¨å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚</p>
</li>
<li>
<p>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„"é‡å®šå‘URI"ï¼ˆredirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚</p>
</li>
<li>
<p>ï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„"é‡å®šå‘URI"ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚</p>
</li>
<li>
<p>ï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚</p>
</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code class="hljs language-bash">https://wx.com/oauth/authorize?response_type=code&#x26;client_id=CLIENT_ID&#x26;redirect_uri=http://www.baidu.com&#x26;scope=<span class="hljs-built_in">read</span>
</code></pre>
<p>å­—æ®µ</p>
<p>æè¿°</p>
<p>client_id</p>
<p>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</p>
<p>response_type</p>
<p>å¿…é¡» å›ºå®šå€¼ åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º code</p>
<p>redirect_uri</p>
<p>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</p>
<p>scope</p>
<p>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™ read åªè¯» all è¯»å†™</p>
<p>state</p>
<p>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</p>
<h4>ç®€åŒ–æ¨¡å¼</h4>
<p>**ç®€åŒ–æ¨¡å¼ï¼ˆ<code>implicit</code> grant typeï¼‰**ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†"æˆæƒç "è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/99ee2dfee0f94990b98f27579e0f7d04.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>ï¼ˆAï¼‰ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</li>
<li>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</li>
<li>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„"é‡å®šå‘URI"ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚#token</li>
<li>ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</li>
<li>ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</li>
<li>ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</li>
<li>ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code class="hljs language-bash">https://wx.com/oauth/authorize?response_type=token&#x26;client_id=CLIENT_ID&#x26;redirect_uri=http://www.baidu.com&#x26;scope=<span class="hljs-built_in">read</span>
</code></pre>
<p>å­—æ®µ</p>
<p>æè¿°</p>
<p>client_id</p>
<p>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</p>
<p>response_type</p>
<p>å¿…é¡» å›ºå®šå€¼ åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º token</p>
<p>redirect_uri</p>
<p>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</p>
<p>scope</p>
<p>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™</p>
<p>state</p>
<p>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</p>
<h4>å¯†ç æ¨¡å¼</h4>
<p>**å¯†ç æ¨¡å¼ï¼ˆResource Owner <code>Password</code> Credentials Grantï¼‰**ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘"æœåŠ¡å•†æä¾›å•†"ç´¢è¦æˆæƒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªç›¸åŒå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p>
<p><img src="https://img-blog.csdnimg.cn/34c3bd74b2314450bbb77d79b828e9fc.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚</p>
</li>
<li>
<p>ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p>
</li>
</ul>
<p>æ ¸å¿ƒå‚æ•°:</p>
<pre><code class="hljs language-ini">https://wx.com/token?<span class="hljs-attr">grant_type</span>=password&#x26;username=USERNAME&#x26;password=PASSWORD&#x26;client_id=CLIENT_ID
</code></pre>
<h4>å®¢æˆ·ç«¯æ¨¡å¼</h4>
<p>**å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆ<code>Client Credentials</code> Grantï¼‰**æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘"æœåŠ¡æä¾›å•†"è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚"æœåŠ¡æä¾›å•†"æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p>
<p><img src="https://img-blog.csdnimg.cn/5476095b062d4df68d2465b24346a863.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ul>
<li>
<p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</p>
</li>
<li>
<p>ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p>
<p><a href="https://wx.com/token?grant_type=client_credentials&#x26;client_id=CLIENT_ID&#x26;client_secret=CLIENT_SECRET">https://wx.com/token?grant_type=client_credentials&#x26;client_id=CLIENT_ID&#x26;client_secret=CLIENT_SECRET</a></p>
</li>
</ul>
<h3>OAuth2 æ ‡å‡†æ¥å£</h3>
<ul>
<li>
<p><code>/oauth/authorize</code>ï¼šæˆæƒç«¯ç‚¹</p>
</li>
<li>
<p><code>/oauth/token</code>ï¼šè·å–ä»¤ç‰Œç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/confirm_accessï¼šç”¨æˆ·ç¡®è®¤æˆæƒæäº¤ç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/errorï¼šæˆæƒæœåŠ¡é”™è¯¯ä¿¡æ¯ç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/check_tokenï¼šç”¨äºèµ„æºæœåŠ¡è®¿é—®çš„ä»¤ç‰Œè§£æç«¯ç‚¹</p>
</li>
<li>
<p>/oauth/token_keyï¼šæä¾›å…¬æœ‰å¯†åŒ™çš„ç«¯ç‚¹ï¼Œå¦‚æœä½¿ç”¨JWTä»¤ç‰Œçš„è¯</p>
</li>
</ul>
<h3>GitHub æˆæƒç™»å½•</h3>
<h4>åˆ›å»º OAuth åº”ç”¨</h4>
<p>è®¿é—® github å¹¶ç™»å½•ï¼Œåœ¨<a href="https://github.com/settings/profile">https://github.com/settings/profile</a>ä¸­æ‰¾åˆ° Developer Settings é€‰é¡¹</p>
<p><img src="https://img-blog.csdnimg.cn/1d761922aa2e4c4c8ce20923b6e931fd.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>åˆ›å»º OAuth Appå¹¶è¾“å…¥ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯:</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/1e6af95052954c43add556fcc3af9f65.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>æ³¨å†ŒæˆåŠŸåä¼šè·å–åˆ°å¯¹åº”çš„ Client ID å’Œ Client Secretã€‚</li>
</ul>
<h4>é¡¹ç›®å¼€å‘</h4>
<ul>
<li>
<p>åˆ›å»º springboot åº”ç”¨ï¼Œå¹¶å¼•å…¥ä¾èµ–</p>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
</dependency>
</li>
<li>
<p>åˆ›å»ºæµ‹è¯• controller</p>
<p>@RestController
public class HelloController {</p>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@GetMapping(<span class="hljs-string">"/hello"</span>)</span>
<span class="hljs-keyword">public</span> DefaultOAuth2User hello(){
    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"hello "</span>);
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    <span class="hljs-keyword">return</span> (DefaultOAuth2User) authentication.getPrincipal();
}
</code></pre>
<p>}</p>
</li>
<li>
<p>é…ç½® security</p>
<p>@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
@Override
protected void configure(HttpSecurity http) throws Exception {
http.authorizeRequests()
.anyRequest().authenticated()
.and()
.oauth2Login();
}
}</p>
</li>
<li>
<p>é…ç½®é…ç½®æ–‡ä»¶</p>
<p>server.port=8080</p>
<p>spring.security.oauth2.client.registration.github.client-id=d6ea299b9ade3cd3b97d
spring.security.oauth2.client.registration.github.client-secret=aaa44b2675a7b636b1b43371e509e88ee9013816</p>
<h1>ä¸€å®šè¦ä¸é‡å®šå‘å›è°ƒ URL ä¸€è‡´</h1>
<p>spring.security.oauth2.client.registration.github.redirect-uri=<a href="http://localhost:8080/login/oauth2/code/github">http://localhost:8080/login/oauth2/code/github</a></p>
</li>
<li>
<p>å¯åŠ¨æµ‹è¯•</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/6a7429b6673a4de9bffcad6e633c1ecb.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<ul>
<li>ç‚¹å‡» github ç™»å½•,ç‚¹å‡»æˆæƒ è®¿é—® hello æ¥å£</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/9371644d35fd4cb2978cc0c6004336f6.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3>Spring Security OAuth2</h3>
<p>Spring Security å¯¹ OAuth2 æä¾›äº†å¾ˆå¥½çš„æ”¯æŒï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨ Spring Securityä¸­ä½¿ç”¨ OAuth2 éå¸¸åœ°æ–¹ä¾¿ã€‚ç„¶è€Œç”±äºå†å²åŸå› ï¼ŒSpring Seaurityå¯¹ OAuth2 çš„æ”¯æŒæ¯”è¾ƒæ··ä¹±ï¼Œè¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹ã€‚</p>
<p>å¤§çº¦åå¹´å‰ï¼ŒSpring å¼•å…¥äº†ä¸€ä¸ªç¤¾åŒºé©±åŠ¨çš„å¼€æºé¡¹ç›® Spring Security OAuthï¼Œ å¹¶å°†å…¶çº³å…¥ Spring é¡¹ç›®ç»„åˆä¸­ã€‚åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œè¿™ä¸ªé¡¹ç›®å·±ç»å‘å±•æˆä¸ºä¸€ä¸ªæˆç†Ÿçš„é¡¹ç›®ï¼Œå¯ä»¥æ”¯æŒå¤§éƒ¨åˆ†OAuth è§„èŒƒï¼ŒåŒ…æ‹¬èµ„æºæœåŠ¡å™¨ã€ å®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨ç­‰ã€‚</p>
<p>ç„¶è€Œæ—©æœŸçš„é¡¹ç›®å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>
<p>OAuth æ˜¯åœ¨æ—©æœŸå®Œæˆçš„ï¼Œå¼€å‘è€…æ— æ³•é¢„æ–™æœªæ¥çš„å˜åŒ–ä»¥åŠè¿™äº›ä»£ç åˆ°åº•è¦è¢«æ€ä¹ˆä½¿ç”¨ï¼Œ</p>
<p>è¿™å¯¼è‡´å¾ˆå¤š Spring é¡¹ç›®æä¾›äº†è‡ªå·±çš„ OAuth æ”¯æŒï¼Œä¹Ÿå°±å¸¦æ¥äº† OAuth æ”¯æŒçš„ç¢ç‰‡åŒ–ã€‚</p>
</li>
<li>
<p>æœ€æ—©çš„OAuthé¡¹ç›®åŒæ—¶æ”¯ç‰¹ OAuth1.0 å’Œ OAuth2.0ï¼Œè€Œç°åœ¨OAuth1.0 æ—©å·²ç»ä¸å†ä½¿ç”¨ï¼Œ</p>
<p>å¯ä»¥æ”¾å¼ƒäº†ã€‚</p>
</li>
<li>
<p>ç°åœ¨æˆ‘ä»¬æœ‰æ›´å¤šçš„åº“å¯ä»¥é€‰æ‹©ï¼Œå¯ä»¥åœ¨è¿™äº›åº“çš„åŸºç¡€ä¸Šå»å¼€å‘ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒJWTç­‰æ–°æŠ€æœ¯ã€‚</p>
</li>
</ul>
<p>åŸºäºä»¥ä¸Šè¿™äº›åŸå› ï¼Œå®˜æ–¹å†³å®šé‡å†™ Spring Security OAuthï¼Œ ä»¥ä¾¿æ›´å¥½åœ°åè°ƒ Spring å’ŒOAuthï¼Œå¹¶ç®€åŒ–ä»£ç åº“ï¼Œä½¿Spring çš„ OAuth æ”¯æŒæ›´åŠ çµæ´»ã€‚ç„¶è€Œï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†ä¸å°‘æ³¢æŠ˜ã€‚</p>
<p>2018å¹´1æœˆ30æ—¥ï¼ŒSpring å®˜æ–¹å‘äº†ä¸€ä¸ªé€šçŸ¥ï¼Œè¡¨ç¤ºè¦é€æ¸åœæ­¢ç°æœ‰çš„ OAuth2æ”¯æŒï¼Œç„¶ååœ¨ Spring Security 5ä¸­æ„å»ºä¸‹ä¸€ä»£ OAuth2.0 æ”¯æŒã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸ºå½“æ—¶ OAuth2 çš„è½åœ°æ–¹æ¡ˆæ¯”è¾ƒæ··ä¹±ï¼Œåœ¨ Spring Security OAuthã€ Spring Cloud Securityã€Spring Boot 1.5.x ä»¥åŠå½“æ—¶æœ€æ–°çš„Spring Security 5.x ä¸­éƒ½æä¾›äº†å¯¹ OAuth2 çš„å®ç°ã€‚ä»¥è‡³äºå½“å¼€å‘è€…éœ€è¦ä½¿ç”¨ OAuth2 æ—¶ï¼Œä¸å¾—ä¸é—®ï¼Œåˆ°åº•é€‰å“ªä¸€ä¸ªä¾èµ–åˆé€‚å‘¢ï¼Ÿ</p>
<p>æ‰€ä»¥Spring å®˜æ–¹å†³å®šæœ‰å¿…è¦å°† OAuth2.0 çš„æ”¯æŒç»Ÿä¸€åˆ°ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œä»¥ä¾¿ä¸ºç”¨æˆ·æä¾›æ˜ç¡®çš„é€‰æ‹©ï¼Œå¹¶é¿å…ä»»ä½•æ½œåœ¨çš„æ··ä¹±ï¼ŒåŒæ—¶ OAuth2.0 çš„å¼€å‘æ–‡æ¡£ä¹Ÿè¦é‡æ–°ç¼–å†™ï¼Œä»¥æ–¹ä¾¿å¼€å‘äººå‘˜å­¦ä¹ ã€‚æ‰€æœ‰çš„å†³å®šå°†åœ¨ Spring Security 5 ä¸­å¼€å§‹ï¼Œæ„å»ºä¸‹ä¸€ä»£ OAuth2.0çš„æ”¯æŒã€‚ä»é‚£ä¸ªæ—¶å€™èµ·ï¼ŒSpring Security OAuth é¡¹ç›®å°±æ­£å¼å¤„äºç»´æŠ¤æ¨¡å¼ã€‚å®˜æ–¹å°†æä¾›è‡³å°‘ä¸€å¹´çš„é”™è¯†/å®‰å…¨ä¿®å¤ç¨‹åºï¼Œå¹¶ä¸”ä¼šè€ƒè™‘æ·»åŠ æ¬¡è¦åŠŸèƒ½ï¼Œä½†ä¸ä¼šæ·»åŠ ä¸»è¦åŠŸèƒ½ã€‚åŒæ—¶å°† Spring Security OAuthä¸­çš„æ‰€æœ‰åŠŸèƒ½é‡æ„åˆ° Spring Security 5.x ä¸­ã€‚</p>
<p>åˆ°äº†2019å¹´11æœˆ14æ—¥ï¼ŒSpring å®˜æ–¹åˆå‘å¸ƒä¸€ä¸ªé€šçŸ¥ï¼Œè¿™æ¬¡çš„é€šçŸ¥é¦–å…ˆè¡¨ç¤º Spring Security OAuth åœ¨è¿å¾€ Spring Security 5.x çš„è¿‡ç¨‹éå¸¸é¡ºåˆ©ï¼Œå¤§éƒ½åˆ†è¿ç¨‹å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°†åœ¨5.3 ç‰ˆæœ¬ä¸­å®Œæˆè¿ç§»ï¼Œåœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­è¿˜æ·»åŠ äº†è®¸å¤šæ–°åŠŸèƒ½ã€‚åŒ…æ‹¬å¯¹ OpenID Connect1.0 çš„æ”¯æŒã€‚åŒæ—¶è¿˜å®£å¸ƒå°†ä¸å†æ”¯æŒæˆæƒæœåŠ¡å™¨ï¼Œä¸æ”¯æŒçš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li><code>åœ¨2019å¹´ï¼Œå·²ç»æœ‰å¤§é‡çš„å•†ä¸šå’Œå¼€æºæˆæƒæœåŠ¡å™¨å¯ç”¨ã€‚</code></li>
<li><code>æˆæƒæœåŠ¡å™¨æ˜¯ä½¿ç”¨ä¸€ä¸ªåº“æ¥æ„å»ºäº§å“ï¼Œè€Œ Spring Security ä½œä¸ºæ¡†æ¶ï¼Œå¹¶ä¸é€‚åˆåšè¿™ä»¶äº‹æƒ…ã€‚</code></li>
</ol>
<p>ä¸€çŸ³æ¿€èµ·åƒå±‚æµªï¼Œè®¸å¤šå¼€å‘è€…è¡¨ç¤ºå¯¹æ­¤éš¾ä»¥æ¥å—ã€‚è¿™ä»¶äº‹ä¹Ÿåœ¨Spring ç¤¾åŒºå¼•å‘äº†æ¿€çƒˆçš„è®¨è®ºï¼Œå¥½åœ¨ Spring å®˜æ–¹æ„¿æ„å€¾å¬æ¥è‡ªç¤¾åŒºçš„å£°éŸ³ã€‚</p>
<p>åˆ°äº†2020å¹´4æœˆ15æ—¥ï¼ŒSpring å®˜æ–¹å®£å¸ƒå¯åŠ¨ Spring Authorization server é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ªç”± Spring Security å›¢é˜Ÿé¢†å¯¼çš„ç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®ï¼Œè‡´åŠ›äºå‘ Spring ç¤¾åŒºæä¾› Authorization Serveræ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒSpring åˆé‡æ–°æ”¯æŒæˆæƒæœåŠ¡å™¨äº†ã€‚</p>
<p>2020å¹´8æœˆ21æ—¥ï¼ŒSpring Authorization Server 0.0.1 æ­£å¼å‘å¸ƒï¼</p>
<p>è¿™å°±æ˜¯ OAuth2 åœ¨Spring å®¶æ—ä¸­çš„å‘å±•å†ç¨‹äº†ã€‚åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨éƒ½å°†é‡‡ç”¨æœ€æ–°çš„æ–¹å¼æ¥æ„å»ºï¼ŒæˆæƒæœåŠ¡å™¨ä¾ç„¶é‡‡ç”¨æ—§çš„æ–¹å¼æ¥æ„å»ºï¼Œå› ä¸ºç›®å‰çš„ Spring Authorization Server 0.0.1 åŠŸèƒ½è¾ƒå°‘ä¸” BUG è¾ƒå¤šã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ OAuth2 æ—¶ï¼Œéƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼ŒæˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨éƒ½æ˜¯ç”±å¤–éƒ¨æä¾›ã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³åœ¨è‡ªå·±æ­å»ºç½‘ç«™ä¸Šé›†æˆ GitHub ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œåªéœ€è¦å¼€å‘è‡ªå·±çš„å®¢æˆ·ç«¯å³å¯ï¼Œè®¤è¯æœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨éƒ½æ˜¯ç”± GitHub æä¾›çš„ã€‚</p>
<h3>æˆæƒã€èµ„æºæœåŠ¡å™¨</h3>
<p>å‰é¢çš„ GitHub æˆæƒç™»å½•ä¸»è¦å‘å¤§å®¶å±•ç¤ºäº† OAuth2 ä¸­å®¢æˆ·ç«¯çš„å·¥ä½œæ¨¡å¼ã€‚å¯¹äºå¤§éƒ¨åˆ†çš„å¼€å‘è€…è€Œè¨€ï¼Œæ—¥å¸¸æ¥è§¦åˆ°çš„ OAuth2 éƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚æ¥å…¥ QQ ç™»å½•ã€æ¥å…¥å¾®ä¿¡ç™»å½•ç­‰ã€‚ä¸è¿‡ä¹Ÿæœ‰å°‘é‡åœºæ™¯ï¼Œå¯èƒ½éœ€è¦å¼€å‘è€…æä¾›æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹æ¼”ç¤ºå¦‚ä½•æ­å»ºæˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ã€‚</p>
<p>æ­å»ºæˆæƒæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€äº›ç°æˆçš„å¼€æºé¡¹ç›®ï¼Œç›´æ¥è¿è¡Œå³å¯ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>Keycloakï¼š RedFat å…¬å¸æä¾›çš„å¼€æºå·¥å…·ï¼Œæä¾›äº†å¾ˆå¤šå®ç”¨åŠŸèƒ½ï¼Œå€’å¦‚å•ç‚¹ç™»å½•ã€æ”¯æŒOpenIDã€å¯è§†åŒ–åå°ç®¡ç†ç­‰ã€‚</li>
<li>Apache Oltu: Apache ä¸Šçš„å¼€æºé¡¹ç›®ï¼Œæœ€è¿‘å‡ å¹´æ²¡æ€ä¹ˆç»´æŠ¤äº†ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ­å»ºä¸€ä¸ªåŒ…å«æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯åœ¨å†…çš„ OAuth2 æ¡ˆä¾‹ã€‚</p>
<p>é¡¹ç›®è§„åˆ’é¦–å…ˆæŠŠé¡¹ç›®åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p>
<ul>
<li>æˆæƒæœåŠ¡å™¨ï¼šé‡‡ç”¨è¾ƒæ—©çš„ spring-cloud-starter-oauth2 æ¥æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚</li>
<li>èµ„æºæœåŠ¡å™¨ï¼šé‡‡ç”¨æœ€æ–°çš„ Spring Security 5.x æ­å»ºèµ„æºæœåŠ¡å™¨ï¼Œ</li>
<li>å®¢æˆ·ç«¯: é‡‡ç”¨æœ€æ–°çš„ Spring Security5.x æ­å»ºå®¢æˆ·ç«¯ã€‚</li>
</ul>
<h4>æˆæƒæœåŠ¡å™¨æ­å»º</h4>
<h5>1. åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h5>
<p>åˆ›å»º springboot åº”ç”¨,å¹¶å¼•å…¥ä¾èµ–</p>
<blockquote>
<p>æ³¨æ„: é™ä½ springboot ç‰ˆæœ¬ä¸º 2.2.5.RELEASE</p>
</blockquote>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-starter-oauth2<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>2.2.5.RELEASE<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-security<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
<p>ç¼–å†™é…ç½®ç±»,æ·»åŠ  security é…ç½®ç±»ä»¥åŠ oauth é…ç½®ç±»</p>
<blockquote>
<p>Spring Security é…ç½®ç±»:</p>
</blockquote>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">protected</span> AuthenticationManager <span class="hljs-title function_">authenticationManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManager();
    }
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        <span class="hljs-type">InMemoryUserDetailsManager</span> <span class="hljs-variable">inMemoryUserDetailsManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>();
        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"root"</span>).password(passwordEncoder().encode(<span class="hljs-string">"123"</span>)).roles(<span class="hljs-string">"ADMIN"</span>).build();
        inMemoryUserDetailsManager.createUser(user);
        <span class="hljs-keyword">return</span> inMemoryUserDetailsManager;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception {
        auth.userDetailsService(userDetailsService());
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.csrf().disable().formLogin();
    }
}
</code></pre>
<blockquote>
<p>Authorization Server é…ç½®ç±»:</p>
</blockquote>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAuthorizationServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizationServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> {
  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PasswordEncoder passwordEncoder;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDetailsService userDetailsService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AuthorizationServer</span><span class="hljs-params">(PasswordEncoder passwordEncoder, UserDetailsService userDetailsService)</span> {
        <span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;
        <span class="hljs-built_in">this</span>.userDetailsService = userDetailsService;
    }

    <span class="hljs-comment">/**
     * é…ç½®å®¢æˆ·ç«¯ç»†èŠ‚ å¦‚ å®¢æˆ·ç«¯ id ç§˜é’¥ é‡å®šå‘ url ç­‰
     *
     * <span class="hljs-doctag">@throws</span> Exception
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception {
        clients.inMemory().withClient(<span class="hljs-string">"client"</span>)
                .secret(passwordEncoder.encode(<span class="hljs-string">"secret"</span>))
                .redirectUris(<span class="hljs-string">"http://www.baidu.com"</span>)
                .scopes(<span class="hljs-string">"client:read,user:read"</span>)
                .authorizedGrantTypes(<span class="hljs-string">"authorization_code"</span>, <span class="hljs-string">"refresh_token"</span>,<span class="hljs-string">"implicit"</span>,<span class="hljs-string">"password"</span>,<span class="hljs-string">"client_credentials"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception {
        endpoints.userDetailsService(userDetailsService);<span class="hljs-comment">//å¼€å¯åˆ·æ–°ä»¤ç‰Œå¿…é¡»æŒ‡å®š</span>
    }
}
</code></pre>
<p>å¯åŠ¨æœåŠ¡,ç™»å½•ä¹‹åè¿›è¡Œæˆæƒç è·å–</p>
<p><img src="https://img-blog.csdnimg.cn/75927c831bae42498d90a86312ed0a23.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<pre><code class="hljs language-bash">http://localhost:8080/oauth/authorize?client_id=client&#x26;response_type=code&#x26;redirect_uri=http://www.baidu.com
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/6124083450bd432491402132cef23b31.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç‚¹å‡»æˆæƒè·å–æˆæƒç </p>
<p><img src="https://img-blog.csdnimg.cn/22470f48df724808b0d5c09df477c119.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>æ ¹æ®æˆæƒç ,ç”³è¯·ä»¤ç‰Œ</p>
<pre><code class="hljs language-perl">curl -X POST -H <span class="hljs-string">"Content-Type: application/x-www-form-urlencoded"</span> -d <span class="hljs-string">'grant_type=authorization_code&#x26;code=IwvCtx&#x26;redirect_uri=http://www.baidu.com'</span> <span class="hljs-string">"http://client:secret<span class="hljs-variable">@localhost</span>:8080/oauth/token"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/39c9e6f65fac457c958c88c7edb7754a.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>åˆ·æ–°ä»¤ç‰Œ</p>
<pre><code class="hljs language-perl">curl -X POST -H <span class="hljs-string">"Content-Type: application/x-www-form-urlencoded"</span> -d <span class="hljs-string">'grant_type=refresh_token&#x26;refresh_token=f6583d8a-598c-46bb-81d8-01fa6484cf05&#x26;client_id=client'</span> <span class="hljs-string">"http://client:secret<span class="hljs-variable">@localhost</span>:8080/oauth/token"</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/877fce07c30b4c22b154381375c38f95.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h5>2. åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h5>
<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼ŒTokenStore çš„é»˜è®¤å®ç°ä¸º InMemoryTokenStore å³å†…å­˜å­˜å‚¨ï¼Œå¯¹äº Client ä¿¡æ¯ï¼ŒClientDetailsService æ¥å£è´Ÿè´£ä»å­˜å‚¨ä»“åº“ä¸­è¯»å–æ•°æ®ï¼Œåœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­é»˜è®¤ä½¿ç”¨çš„ä¹Ÿæ˜¯ InMemoryClientDetailsService å®ç°ç±»ã€‚</p>
<p>å¦‚æœè¦æƒ³ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼Œåªè¦æä¾›è¿™äº›æ¥å£çš„å®ç°ç±»å³å¯ï¼Œè€Œæ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬å†™å¥½ JdbcTokenStore å’Œ JdbcClientDetailsService</p>
<p>å»ºè¡¨:</p>
<pre><code class="hljs language-scss">https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql
# æ³¨æ„: å¹¶ç”¨ BLOB æ›¿æ¢è¯­å¥ä¸­çš„ LONGVARBINARY ç±»å‹


SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = <span class="hljs-number">0</span>;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for clientdetails
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `clientdetails`;
CREATE <span class="hljs-selector-tag">TABLE</span> `clientdetails` (
  `appId` varchar(<span class="hljs-number">256</span>) NOT NULL,
  `resourceIds` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `appSecret` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `scope` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `grantTypes` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `redirectUrl` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `authorities` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `access_token_validity` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
  `refresh_token_validity` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
  `additionalInformation` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">4096</span>) DEFAULT NULL,
  `autoApproveScopes` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  PRIMARY KEY (`appId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_access_token
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_access_token`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_access_token` (
  `token_id` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,
  `token` blob,
  `authentication_id` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) NOT NULL,
  `user_name` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `client_id` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `authentication` blob,
  `refresh_token` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_approvals
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_approvals`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_approvals` (
  `userId` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,
  `clientId` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `scope` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `status` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">10</span>) DEFAULT NULL,
  `expiresAt` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `lastModifiedAt` date DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_client_details
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_client_details`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_client_details` (
  `client_id` varchar(<span class="hljs-number">256</span>) NOT NULL,
  `resource_ids` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `client_secret` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `scope` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `authorized_grant_types` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `web_server_redirect_uri` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `authorities` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `access_token_validity` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
  `refresh_token_validity` <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) DEFAULT NULL,
  `additional_information` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">4096</span>) DEFAULT NULL,
  `autoapprove` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  PRIMARY KEY (`client_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_client_token
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_client_token`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_client_token` (
  `token_id` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,
  `token` blob,
  `authentication_id` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) NOT NULL,
  `user_name` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  `client_id` <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) DEFAULT NULL,
  PRIMARY KEY (`authentication_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_code
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_code`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_code` (
  `code` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ----------------------------
-- <span class="hljs-selector-tag">Table</span> structure for oauth_refresh_token
-- ----------------------------
DROP <span class="hljs-selector-tag">TABLE</span> IF EXISTS `oauth_refresh_token`;
CREATE <span class="hljs-selector-tag">TABLE</span> `oauth_refresh_token` (
  `token_id` varchar(<span class="hljs-number">256</span>) DEFAULT NULL,
  `token` blob,
  `authentication` blob
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

SET FOREIGN_KEY_CHECKS = <span class="hljs-number">1</span>;

-- å†™å…¥å®¢æˆ·ç«¯ä¿¡æ¯
INSERT INTO `oauth_client_details` VALUES ('client', NULL, '$<span class="hljs-number">2</span>a$<span class="hljs-number">10</span>$QCsINtuRfP8kM112xRVdvuI58MrefLlEP2mM0kzB5KZCPhnOf4392', 'read', 'authorization_code,refresh_token', 'http://www.baidu.com', NULL, NULL, NULL, NULL, NULL);
</code></pre>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>mysql<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mysql-connector-java<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>runtime<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-jdbc<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
</span></code></pre>
<p>ç¼–å†™é…ç½®æ–‡ä»¶</p>
<pre><code class="hljs language-ini"><span class="hljs-attr">spring.datasource.driver-class-name</span>=com.mysql.jdbc.Driver
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/oauth?characterEncoding=UTF-<span class="hljs-number">8</span>
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root
</code></pre>
<p>ç¼–å†™æ•°æ®åº“ä¿¡æ¯å®ç°</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAuthorizationServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcAuthorizationServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthenticationManager authenticationManager;


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PasswordEncoder passwordEncoder;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;


    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdbcAuthorizationServer</span><span class="hljs-params">(AuthenticationManager authenticationManager, PasswordEncoder passwordEncoder, DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.authenticationManager = authenticationManager;
        <span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
    }

    <span class="hljs-meta">@Bean</span> <span class="hljs-comment">// å£°æ˜TokenStoreå®ç°</span>
    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTokenStore</span>(dataSource);
    }

    <span class="hljs-meta">@Bean</span> <span class="hljs-comment">// å£°æ˜ ClientDetailså®ç°</span>
    <span class="hljs-keyword">public</span> ClientDetailsService <span class="hljs-title function_">clientDetails</span><span class="hljs-params">()</span> {
        <span class="hljs-type">JdbcClientDetailsService</span> <span class="hljs-variable">jdbcClientDetailsService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcClientDetailsService</span>(dataSource);
        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);
        <span class="hljs-keyword">return</span> jdbcClientDetailsService;
    }

    <span class="hljs-meta">@Override</span> <span class="hljs-comment">//é…ç½®ä½¿ç”¨æ•°æ®åº“å®ç°</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception {
        endpoints.authenticationManager(authenticationManager);<span class="hljs-comment">//è®¤è¯ç®¡ç†å™¨</span>
        endpoints.tokenStore(tokenStore());<span class="hljs-comment">//é…ç½®ä»¤ç‰Œå­˜å‚¨ä¸ºæ•°æ®åº“å­˜å‚¨</span>

        <span class="hljs-comment">// é…ç½®TokenServiceså‚æ•°</span>
        <span class="hljs-type">DefaultTokenServices</span> <span class="hljs-variable">tokenServices</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTokenServices</span>();<span class="hljs-comment">//ä¿®æ”¹é»˜è®¤ä»¤ç‰Œç”ŸæˆæœåŠ¡</span>
        tokenServices.setTokenStore(endpoints.getTokenStore());<span class="hljs-comment">//åŸºäºæ•°æ®åº“ä»¤ç‰Œç”Ÿæˆ</span>
        tokenServices.setSupportRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//æ˜¯å¦æ”¯æŒåˆ·æ–°ä»¤ç‰Œ</span>
        tokenServices.setReuseRefreshToken(<span class="hljs-literal">true</span>);<span class="hljs-comment">//æ˜¯å¦é‡å¤ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼ˆç›´åˆ°è¿‡æœŸï¼‰</span>

        tokenServices.setClientDetailsService(endpoints.getClientDetailsService());<span class="hljs-comment">//è®¾ç½®å®¢æˆ·ç«¯ä¿¡æ¯</span>
        tokenServices.setTokenEnhancer(endpoints.getTokenEnhancer());<span class="hljs-comment">//ç”¨æ¥æ§åˆ¶ä»¤ç‰Œå­˜å‚¨å¢å¼ºç­–ç•¥</span>
        <span class="hljs-comment">//è®¿é—®ä»¤ç‰Œçš„é»˜è®¤æœ‰æ•ˆæœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚è¿‡æœŸçš„ä»¤ç‰Œä¸ºé›¶æˆ–è´Ÿæ•°ã€‚</span>
        tokenServices.setAccessTokenValiditySeconds((<span class="hljs-type">int</span>) TimeUnit.DAYS.toSeconds(<span class="hljs-number">30</span>)); <span class="hljs-comment">// 30å¤©</span>
        <span class="hljs-comment">//åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¦‚æœå°äºæˆ–ç­‰äºé›¶ï¼Œåˆ™ä»¤ç‰Œå°†ä¸ä¼šè¿‡æœŸ</span>
        tokenServices.setRefreshTokenValiditySeconds((<span class="hljs-type">int</span>) TimeUnit.DAYS.toSeconds(<span class="hljs-number">3</span>)); <span class="hljs-comment">//3å¤©</span>
        endpoints.tokenServices(tokenServices);<span class="hljs-comment">//ä½¿ç”¨é…ç½®ä»¤ç‰ŒæœåŠ¡</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception {
        clients.withClientDetails(clientDetails());<span class="hljs-comment">//ä½¿ç”¨ jdbcå­˜å‚¨</span>
    }
}
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,å‘ç°æ•°æ®åº“ä¸­å·²ç»å­˜å‚¨ç›¸å…³çš„ä»¤ç‰Œ</p>
<p><img src="https://img-blog.csdnimg.cn/f95214fcad2242528b33bc967d418380.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>èµ„æºæœåŠ¡å™¨æ­å»º</h4>
<p>å¼•å…¥ä¾èµ–</p>
<pre><code class="hljs language-php-template"><span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">properties</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">java.version</span>></span>1.8<span class="hljs-tag">&#x3C;/<span class="hljs-name">java.version</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">project.build.sourceEncoding</span>></span>UTF-8<span class="hljs-tag">&#x3C;/<span class="hljs-name">project.build.sourceEncoding</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">project.reporting.outputEncoding</span>></span>UTF-8<span class="hljs-tag">&#x3C;/<span class="hljs-name">project.reporting.outputEncoding</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">spring-boot.version</span>></span>2.2.5.RELEASE<span class="hljs-tag">&#x3C;/<span class="hljs-name">spring-boot.version</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">spring-cloud.version</span>></span>Hoxton.SR9<span class="hljs-tag">&#x3C;/<span class="hljs-name">spring-cloud.version</span>></span>

    <span class="hljs-tag">&#x3C;/<span class="hljs-name">properties</span>></span>

    <span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-security<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-web<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-starter-oauth2<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.security<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-security-oauth2-resource-server<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>


        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>mysql<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>mysql-connector-java<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>runtime<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-jdbc<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>

        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-starter-test<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>test<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">exclusions</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">exclusion</span>></span>
                    <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.junit.vintage<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
                    <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>junit-vintage-engine<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
                <span class="hljs-tag">&#x3C;/<span class="hljs-name">exclusion</span>></span>
            <span class="hljs-tag">&#x3C;/<span class="hljs-name">exclusions</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.security<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-security-test<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>test<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>

    <span class="hljs-tag">&#x3C;<span class="hljs-name">dependencyManagement</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">dependencies</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.cloud<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-cloud-dependencies<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>${spring-cloud.version}<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">type</span>></span>pom<span class="hljs-tag">&#x3C;/<span class="hljs-name">type</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>import<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
            <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
            <span class="hljs-tag">&#x3C;<span class="hljs-name">dependency</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">groupId</span>></span>org.springframework.boot<span class="hljs-tag">&#x3C;/<span class="hljs-name">groupId</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">artifactId</span>></span>spring-boot-dependencies<span class="hljs-tag">&#x3C;/<span class="hljs-name">artifactId</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">version</span>></span>${spring-boot.version}<span class="hljs-tag">&#x3C;/<span class="hljs-name">version</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">type</span>></span>pom<span class="hljs-tag">&#x3C;/<span class="hljs-name">type</span>></span>
                <span class="hljs-tag">&#x3C;<span class="hljs-name">scope</span>></span>import<span class="hljs-tag">&#x3C;/<span class="hljs-name">scope</span>></span>
            <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependency</span>></span>
        <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencies</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">dependencyManagement</span>></span>
</span></code></pre>
<p>åˆ›å»ºèµ„æº</p>
<pre><code class="hljs language-kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-keyword">public</span> String hello(){
        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello!"</span>;
    }
}
</code></pre>
<p>ç¼–å†™èµ„æºæœåŠ¡å™¨é…ç½®ç±»</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableResourceServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceServerConfig</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword">throws</span> Exception {
        resources.tokenStore(tokenStore());
    }
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTokenStore</span>(dataSource);
    }
}
</code></pre>
<p>ç¼–å†™é…ç½®æ–‡ä»¶</p>
<pre><code class="hljs language-ini"><span class="hljs-comment"># åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£</span>
<span class="hljs-attr">server.port</span>=<span class="hljs-number">8081</span>
<span class="hljs-attr">spring.datasource.driver-class-name</span>=com.mysql.jdbc.Driver
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://localhost:<span class="hljs-number">3306</span>/security?characterEncoding=UTF-<span class="hljs-number">8</span>
<span class="hljs-attr">spring.datasource.username</span>=root
<span class="hljs-attr">spring.datasource.password</span>=root
<span class="hljs-attr">logging.level.org.springframework.jdbc.core</span>=debug
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,ç”Ÿæˆä»¤ç‰Œä¹‹åå¸¦æœ‰ä»¤ç‰Œè®¿é—®:</p>
<pre><code class="hljs language-bash">curl -H <span class="hljs-string">"Authorization:Bearer dffa62d2-1078-457e-8a2b-4bd46fae0f47"</span> http://localhost:8081/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/ebce554c5c0c404b80d4af36d477b241.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h3>ä½¿ç”¨ JWT</h3>
<h4>æˆæƒæœåŠ¡å™¨é¢å‘ JWT ä»¤ç‰Œ</h4>
<p>é…ç½®é¢å‘ JWT ä»¤ç‰Œ</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAuthorizationServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizationServerConfigurerAdapter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PasswordEncoder passwordEncoder;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthenticationManager authenticationManager;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JwtAuthServerConfig</span><span class="hljs-params">(PasswordEncoder passwordEncoder, AuthenticationManager authenticationManager, DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.passwordEncoder = passwordEncoder;
        <span class="hljs-built_in">this</span>.authenticationManager = authenticationManager;
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
    }
    <span class="hljs-meta">@Override</span> <span class="hljs-comment">//é…ç½®ä½¿ç”¨ jwt æ–¹å¼é¢å‘ä»¤ç‰Œ,åŒæ—¶é…ç½® jwt è½¬æ¢å™¨</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception {
        endpoints.tokenStore(tokenStore())
                .accessTokenConverter(jwtAccessTokenConverter())
                .authenticationManager(authenticationManager);
    }
    <span class="hljs-meta">@Bean</span><span class="hljs-comment">//ä½¿ç”¨JWTæ–¹å¼ç”Ÿæˆä»¤ç‰Œ</span>
    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(jwtAccessTokenConverter());
    }
    <span class="hljs-meta">@Bean</span><span class="hljs-comment">//ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥æ¥ç¼–ç  JWT ä¸­çš„  OAuth2 ä»¤ç‰Œ</span>
    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">jwtAccessTokenConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();
        converter.setSigningKey(<span class="hljs-string">"123"</span>);<span class="hljs-comment">//å¯ä»¥é‡‡ç”¨å±æ€§æ³¨å…¥æ–¹å¼ ç”Ÿäº§ä¸­å»ºè®®åŠ å¯†</span>
        <span class="hljs-keyword">return</span> converter;
    }
    <span class="hljs-meta">@Bean</span> <span class="hljs-comment">// å£°æ˜ ClientDetailså®ç°</span>
    <span class="hljs-keyword">public</span> ClientDetailsService <span class="hljs-title function_">clientDetails</span><span class="hljs-params">()</span> {
        <span class="hljs-type">JdbcClientDetailsService</span> <span class="hljs-variable">jdbcClientDetailsService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcClientDetailsService</span>(dataSource);
        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);
        <span class="hljs-keyword">return</span> jdbcClientDetailsService;
    }
    <span class="hljs-meta">@Override</span><span class="hljs-comment">//ä½¿ç”¨æ•°æ®åº“æ–¹å¼å®¢æˆ·ç«¯å­˜å‚¨</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception {
        clients.withClientDetails(clientDetails());
    }
}
</code></pre>
<p>å¯åŠ¨æœåŠ¡,æ ¹æ®æˆæƒç è·å–ä»¤ç‰Œ</p>
<p><img src="https://img-blog.csdnimg.cn/b83b933ee774462b9b3e3ff8c72299f7.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<h4>ä½¿ç”¨ JWT ä»¤ç‰Œèµ„æºæœåŠ¡å™¨</h4>
<p>é…ç½®èµ„æºæœåŠ¡å™¨è§£æjwt</p>
<pre><code class="hljs language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableResourceServer</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ResourceServerConfigurerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(ResourceServerSecurityConfigurer resources)</span> <span class="hljs-keyword">throws</span> Exception {
        resources.tokenStore(tokenStore());
    }
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TokenStore <span class="hljs-title function_">tokenStore</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtTokenStore</span>(jwtAccessTokenConverter());
    }
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title function_">jwtAccessTokenConverter</span><span class="hljs-params">()</span> {
        <span class="hljs-type">JwtAccessTokenConverter</span> <span class="hljs-variable">jwtAccessTokenConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAccessTokenConverter</span>();
        jwtAccessTokenConverter.setSigningKey(<span class="hljs-string">"123"</span>);
        <span class="hljs-keyword">return</span> jwtAccessTokenConverter;
    }
}
</code></pre>
<p>å¯åŠ¨æµ‹è¯•,é€šè¿‡ jwt ä»¤ç‰Œè®¿é—®èµ„æº</p>
<pre><code class="hljs language-bash">curl -H <span class="hljs-string">"Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjAzMzM4MjgsInVzZXJfbmFtZSI6InJvb3QiLCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIl0sImp0aSI6ImJmZGVjMzg1LWQyYmYtNDc5Yi05YjhhLTgyZWE4YTRkNzgzMyIsImNsaWVudF9pZCI6ImNsaWVudCIsInNjb3BlIjpbImFwcDpyZWFkIl19.QlELW7LMLuD4OghbEFFzJpIxjW80hC3WHd3I0PiuI7Y"</span> http://localhost:8081/hello
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/eb993c7eb6b140dca2a889882c474b20.png#pic_center" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>5:["$","article",null,{"className":"max-w-2xl mx-auto px-5 py-10","children":[["$","header",null,{"className":"mb-8","children":[["$","h1",null,{"className":"font-mono text-xl font-semibold text-[var(--color-text)] leading-tight","children":"SpringSecurity æ€»ç»“"}],["$","div",null,{"className":"flex items-center gap-3 mt-2 text-xs text-[var(--color-text-tertiary)] font-mono","children":[["$","time",null,{"dateTime":"2024-03-28","children":"2024-03-28"}],["$","span",null,{"children":"Â·"}],["$","span",null,{"children":"152 min read"}]]}],["$","div",null,{"className":"flex flex-wrap gap-1.5 mt-3","children":[["$","$L2","flutter",{"href":"/tags/flutter","className":"text-xs font-mono text-[var(--color-text-tertiary)] hover:text-[var(--color-link)] transition-colors","children":["#","flutter"]}],["$","$L2","app",{"href":"/tags/app","className":"text-xs font-mono text-[var(--color-text-tertiary)] hover:text-[var(--color-link)] transition-colors","children":["#","app"]}]]}]]}],["$","div",null,{"className":"prose","dangerouslySetInnerHTML":{"__html":"$10"}}],"$L11","$L12"]}]
13:I[31175,["/_next/static/chunks/7c92e96509cd355e.js","/_next/static/chunks/9027c2a9ef8f11ae.js"],"default"]
11:["$","$L13",null,{}]
12:["$","footer",null,{"className":"mt-8 pt-4 border-t border-[var(--color-border)]","children":["$","$L2",null,{"href":"/","className":"text-sm text-[var(--color-link)] hover:underline","children":"â† è¿”å›"}]}]
d:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
14:I[27201,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"IconMark"]
b:null
f:[["$","title","0",{"children":"SpringSecurity æ€»ç»“ - ä¸€æ´¼ç»¿åœ°"}],["$","meta","1",{"name":"description","content":"SpringSecurity æ€»ç»“"}],["$","meta","2",{"name":"keywords","content":"javascript java php emacs spring linux flutter"}],["$","link","3",{"rel":"icon","href":"/img/avatar/favicon.png"}],["$","$L14","4",{}]]
