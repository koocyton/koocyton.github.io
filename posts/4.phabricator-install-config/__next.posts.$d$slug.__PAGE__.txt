1:"$Sreact.fragment"
2:I[22016,["/_next/static/chunks/7c92e96509cd355e.js","/_next/static/chunks/bbef3146f2d34722.js"],""]
8:I[31175,["/_next/static/chunks/7c92e96509cd355e.js","/_next/static/chunks/bbef3146f2d34722.js"],"default"]
9:I[97367,["/_next/static/chunks/ff1a16fafef87110.js","/_next/static/chunks/d2be314c3ece3fbe.js"],"OutletBoundary"]
a:"$Sreact.suspense"
3:T6c2f,<p><img src="/posts/4.phabricator-install-config/phabricator.jpg" alt="phabricator"></p>
<p><a href="https://www.jianshu.com/p/d7630e1fe4f9">Phabricator安装和配置过程记录 - 吴关山</a></p>
<h2>Quick Start</h2>
<h3>简介</h3>
<p>本文介绍Phabricator的安装和配置过程，转至 <a href="https://www.jianshu.com/p/d7630e1fe4f9">https://www.jianshu.com/p/d7630e1fe4f9</a> ，作者 吴关山</p>
<p>Phabricator的安装过程比较繁琐，为了保证得到可靠的过程，步骤在以下公有云平台：</p>
<pre><code class="hljs language-bash">微软Azure国内
阿里云国内
AWS首尔
</code></pre>
<p>分别做了测试。</p>
<p>安装环境为：</p>
<pre><code class="hljs language-bash">Ubuntu 16.04 Server
Nginx
PHP7.1
MySQL
</code></pre>
<p>以下分两个部分：</p>
<p>安装：Phabricator基本安装、运行和检验
配置：发邮件、基于SSH的Git仓库托管以及配置杂项等</p>
<h3>安装</h3>
<h5>clone Phabricator项目文件</h5>
<p>创建目录：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> /var/www/pha
</code></pre>
<p>clone相关项目：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> git <span class="hljs-built_in">clone</span> https://github.com/phacility/libphutil.git
<span class="hljs-built_in">sudo</span> git <span class="hljs-built_in">clone</span> https://github.com/phacility/arcanist.git
<span class="hljs-built_in">sudo</span> git <span class="hljs-built_in">clone</span> https://github.com/phacility/phabricator.git
</code></pre>
<p>修改目录所有者，用nginx进程的用户，www-data</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> -R www-data:www-data /var/www/pha
</code></pre>
<h5>安装Nginx</h5>
<p>使用Nginx官方源。命令如下：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> apt-get install software-properties-common
<span class="hljs-built_in">sudo</span> add-apt-repository ppa:nginx/stable
<span class="hljs-built_in">sudo</span> apt-get update
<span class="hljs-built_in">sudo</span> apt install -y nginx
</code></pre>
<p>安装后，Nginx应自动启动，检查80端口是否正常：</p>
<pre><code class="hljs language-bash">netstat -na | grep 80
</code></pre>
<p>应看到类似这样的结果：</p>
<pre><code class="hljs language-bash"> tcp6       0      0 :::80                   :::*                    LISTEN
</code></pre>
<p>如能找到，说明Nginx安装成功，如无法外网访问，检查防火墙设置。</p>
<p>有关防火墙的设置
后续安装配置，需要允许如下端口的外网访问：</p>
<p>22，将用于git ssh使用
80，默认http
443，https，phabricator正式环境端口
2222，ssh登录端口</p>
<h5>安装PHP环境</h5>
<p>Phabricator不支持PHP7.0版本，需要安装7.1版本：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> LC_ALL=en_US.UTF-8 add-apt-repository ppa:ondrej/php
<span class="hljs-built_in">sudo</span> apt-get update
<span class="hljs-built_in">sudo</span> apt-get -y install php7.1 php7.1-mysql php7.1-fpm php7.1-curl php7.1-xml php7.1-mcrypt php7.1-json php7.1-gd php7.1-mbstring
</code></pre>
<p>修改fpm的配置：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /etc/php/7.1/fpm/pool.d/www.conf
</code></pre>
<p>文件内容，在listen = /run/php/php7.1-fpm.sock之后加入2行：</p>
<pre><code class="hljs language-conf">; Note: This value is mandatory.
listen = /run/php/php7.1-fpm.sock
listen = 9000 # 增加
listen.allowed_clients = 127.0.0.1 # 增加
</code></pre>
<p>重启PHP：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> service php7.1-fpm stop
<span class="hljs-built_in">sudo</span> service php7.1-fpm start
</code></pre>
<p>测试配置是否生效：</p>
<pre><code class="hljs language-bash">netstat -na | grep 9000
</code></pre>
<p>如能显示，说明fpm正常启动：</p>
<pre><code class="hljs language-TXT">tcp6       0      0 :::9000                 :::*                    LISTEN
</code></pre>
<p>配置Nginx
域名比如是：p.mydomain.com，那么创建配置文件：/etc/nginx/conf.d/p.mydomain.com.conf，内容如下：</p>
<pre><code class="hljs language-bash">server {
  server_name p.mydomain.com; <span class="hljs-comment"># 配置域名</span>
  root        /var/www/pha/phabricator/webroot; <span class="hljs-comment"># 配置根目录</span>

  location / {
    index index.php;
    rewrite ^/(.*)$ /index.php?__path__=/<span class="hljs-variable">$1</span> last;
  }

  location /index.php {
    fastcgi_pass   localhost:9000;
    fastcgi_index   index.php;

    <span class="hljs-comment">#required if PHP was built with --enable-force-cgi-redirect</span>
    fastcgi_param  REDIRECT_STATUS    200;

    <span class="hljs-comment">#variables to make the $_SERVER populate in PHP</span>
    fastcgi_param  SCRIPT_FILENAME    $document_root<span class="hljs-variable">$fastcgi_script_name</span>;
    fastcgi_param  QUERY_STRING       <span class="hljs-variable">$query_string</span>;
    fastcgi_param  REQUEST_METHOD     <span class="hljs-variable">$request_method</span>;
    fastcgi_param  CONTENT_TYPE       <span class="hljs-variable">$content_type</span>;
    fastcgi_param  CONTENT_LENGTH     <span class="hljs-variable">$content_length</span>;

    fastcgi_param  SCRIPT_NAME        <span class="hljs-variable">$fastcgi_script_name</span>;

    fastcgi_param  GATEWAY_INTERFACE  CGI/1.1;
    fastcgi_param  SERVER_SOFTWARE    nginx/<span class="hljs-variable">$nginx_version</span>;

    fastcgi_param  REMOTE_ADDR        <span class="hljs-variable">$remote_addr</span>;
  }
}
</code></pre>
<h5>安装和配置MySQL</h5>
<h6>安装：</h6>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> apt install mysql-server
</code></pre>
<p>提示输入root用户密码，在本例中，密码是：password</p>
<p>在phabricator目录下（git clone <a href="https://github.com/phacility/phabricator.git">https://github.com/phacility/phabricator.git</a> 的那个目录）执行命令，将mysql密码设置到phabricator：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> mysql.pass <span class="hljs-string">'password'</span>
</code></pre>
<h6>为phabricator创建mysql相关数据表：</h6>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/storage upgrade
</code></pre>
<h5>设置和重启Nginx</h5>
<h6>设置下phabricator的url</h6>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span>  ./bin/config <span class="hljs-built_in">set</span> phabricator.base-uri <span class="hljs-string">'http://p.mydomain.com'</span>
</code></pre>
<h6>Nginx重新加载：</h6>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> service nginx reload
</code></pre>
<p>设置管理员和认证方式
这时，浏览器应该可以访问Phabricator了：<a href="http://p.mydomain.com">http://p.mydomain.com</a></p>
<p>作为第一个访问用户，可创建管理员账号。</p>
<p>注意，管理员不是标准用户。</p>
<p>如果能创建管理员，说明安装过程成功。</p>
<p>这时可以添加认证方式（Auth Provider）。phabricator提供了多种认证方式，其中最基本的是用户名／密码的provider。</p>
<p>作为管理员，访问Auth，选择Add Provider ，然后添加 Username/Password Provider即可。</p>
<p>安装过程到此基本结束，但还不能：</p>
<p>发送用户邀请邮件及其他通知邮件
创建git repository
下一部分将解决这些问题。</p>
<h6>配置</h6>
<p>发送邮件的基本配置
发送邮件的功能是必须配置的，否则无法创建用户，因为需要通过邮件发送邀请通知。</p>
<p>执行如下命令，设置发送邮件邮箱配置：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> metamta.default-address robot@mydomain.com
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> metamta.domain mydomain.com
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> metamta.can-send-as-user <span class="hljs-literal">false</span>
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> metamta.mail-adapter PhabricatorMailImplementationPHPMailerAdapter
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.mailer smtp
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.smtp-host smtp.exmail.qq.com
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.smtp-port 465
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.smtp-user robot@mydomain.com
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.smtp-password my_password
<span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phpmailer.smtp-protocol SSL
</code></pre>
<p>这里使用的是qq企业邮箱配置的。</p>
<p>设置完毕，检查是否可以发送邮件：</p>
<pre><code class="hljs language-bash">./bin/mail send-test --to myname@qq.com --subject hello &#x3C;README.md
</code></pre>
<p>如果能收到邮件，说明邮箱配置正确。</p>
<h5>配置和自启动守护进程</h5>
<p>phabricator有个任务队列，并运行一个守护进程，执行队列中的任务。可在 <a href="http://p.mydomain.com/daemon">http://p.mydomain.com/daemon</a> 中看到Active Daemons中还没有可用的守护进程。</p>
<p>phabricator守护进程，phd，主要负责：</p>
<p>git repository相关的操作
发送邮件
垃圾回收，如旧的日志和缓存
我们可以直接启动守护进程：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/phd start
</code></pre>
<p>但是有问题：</p>
<ul>
<li>当前用户权限过大</li>
<li>需要设置为自启动服务</li>
</ul>
<h5>创建phd用户</h5>
<p>创建phd用户：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> adduser phd --home /home/phd
</code></pre>
<p>使phd用户不可远程登录：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> usermod -p NP phd
</code></pre>
<h5>创建和启动phd自启动服务</h5>
<p>创建systemd service文件/tmp/service.file：</p>
<pre><code class="hljs language-bash">[Unit]
Description=phabricator-phd
After=syslog.target network.target mysql.service
Before=nginx.service

[Service]
Type=oneshot
User=phd
Group=phd
Enviroment=<span class="hljs-string">"PATH=/sbin:/usr/sbin:/usr/local/sbin:/usr/local/bin:/usr/bin:/bin"</span>
ExecStart=/var/www/pha/phabricator/bin/phd start
ExecStop=/var/www/pha/phabricator/bin/phd stop
RemainAfterExit=<span class="hljs-built_in">yes</span>

[Install]
WantedBy=multi-user.target
</code></pre>
<p>将服务加入到systemd目录：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> /tmp/service.file /lib/systemd/system/phabricator-phd.service
</code></pre>
<p>使phabricator-phd.service可用：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> phabricator-phd.service
</code></pre>
<p>启动phabricator-phd.service服务：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> systemctl start phabricator-phd
</code></pre>
<p>如没有报错，访问：<a href="http://p.mydomain.com/daemon/">http://p.mydomain.com/daemon/</a> 可以看到Active Daemons不为空了。</p>
<p>将phd用户设置为phd.user:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> phd.user phd
</code></pre>
<ul>
<li>注：其他用户如需操作git命令，需要sudo为phd用户，上面的设置就是告诉它们需要sudo的用户名。</li>
</ul>
<p>phd用户将守护进程跑起来后，就可以创建新用户了。通过管理员账号，选择people，添加standard用户。会收到邀请邮件，如果phd和邮箱配置都没问题的话。</p>
<p>用这个standard用户登录，并上传public key，后面要用到。</p>
<h5>www-data用户的配置</h5>
<p>如果将来要用到http git时，需要将www-data用户设置为可sudo为phd用户。</p>
<p>编辑/etc/sudoers，加入：</p>
<pre><code class="hljs language-conf">www-data ALL=(phd) SETENV: NOPASSWD: /usr/lib/git-core/git-http-backend
</code></pre>
<p>实际上，我们没有用到这个，我们用的是SSH Git。</p>
<h3>配置SSH Git托管</h3>
<h4>准备工作</h4>
<p>将当前SSH服务转移到2222端口，将来运行的Git SSH服务使用22端口。这是多次配置后，觉得后续比较方便的做法。否则，Git用户都要自定义端口，给开发／部署带来不必要的麻烦。</p>
<p>修改文件：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /etc/ssh/sshd_config
</code></pre>
<p>将Port改为2222后重启ssh服务：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> service ssh restart
</code></pre>
<p>用2222端口ssh重新登录服务器：</p>
<pre><code class="hljs language-bash">ssh -p2222 p.mydomain.com 
</code></pre>
<h5>创建git用户</h5>
<p>创建用户：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> adduser git
</code></pre>
<p>禁止登录：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> usermod -p NP git
</code></pre>
<p>设置git可以sudo为phd，修改/etc/sudoers，加入：</p>
<pre><code class="hljs language-bash">git ALL=(phd) SETENV: NOPASSWD: /usr/bin/git-upload-pack, /usr/bin/git-receive-pack
</code></pre>
<p>创建存放git repository的目录：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> /var/repo
</code></pre>
<p>改变目录所有者为phd：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> -R phd /var/repo
<span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chgrp</span> -R phd /var/repo
</code></pre>
<p>phabricator设置git-core路径：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> environment.append-paths <span class="hljs-string">'["/usr/lib/git-core"]'</span>
</code></pre>
<p>phabricator设置git用户：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> diffusion.ssh-user git
</code></pre>
<h5>创建git ssh hook配置文件</h5>
<p>phabricator项目中提供了模版文件，将这个文件复制到需要的地方：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> /var/www/pha/phabricator/resources/sshd/phabricator-ssh-hook.sh /usr/lib/phabricator-ssh-hook.sh
</code></pre>
<p>修改文件权限：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> 755 /usr/lib/phabricator-ssh-hook.sh
</code></pre>
<p>修改hook文件：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /usr/lib/phabricator-ssh-hook.sh
</code></pre>
<p>文件内容：</p>
<pre><code class="hljs language-bash"><span class="hljs-meta">#!/bin/sh</span>

<span class="hljs-comment"># NOTE: Replace this with the username that you expect users to connect with.</span>
VCSUSER=<span class="hljs-string">"git"</span>  <span class="hljs-comment"># 配置</span>

<span class="hljs-comment"># NOTE: Replace this with the path to your Phabricator directory.</span>
ROOT=<span class="hljs-string">"/var/www/pha/phabricator"</span> <span class="hljs-comment"># 配置</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> != <span class="hljs-string">"<span class="hljs-variable">$VCSUSER</span>"</span> ];
<span class="hljs-keyword">then</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exec</span> <span class="hljs-string">"<span class="hljs-variable">$ROOT</span>/bin/ssh-auth"</span> <span class="hljs-variable">$@</span>
</code></pre>
<h5>创建git ssh配置文件</h5>
<p>phabricator也提供了模版文件，复制到需要的地方：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> /var/www/pha/phabricator/resources/sshd/sshd_config.phabricator.example /etc/ssh/sshd_config.phabricator
</code></pre>
<p>修改sshd_config.phabricator文件：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /etc/ssh/sshd_config.phabricator
</code></pre>
<p>文件内容：</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># NOTE: You must have OpenSSHD 6.2 or newer; support for AuthorizedKeysCommand</span>
<span class="hljs-comment"># was added in this version.</span>

<span class="hljs-comment"># NOTE: Edit these to the correct values for your setup.</span>

AuthorizedKeysCommand /usr/lib/phabricator-ssh-hook.sh  <span class="hljs-comment"># 配置</span>
AuthorizedKeysCommandUser git <span class="hljs-comment"># 配置</span>
AllowUsers git <span class="hljs-comment"># 配置</span>

<span class="hljs-comment"># You may need to tweak these options, but mostly they just turn off everything</span>
<span class="hljs-comment"># dangerous.</span>

Port 22 <span class="hljs-comment"># 配置</span>
Protocol 2
PermitRootLogin no
AllowAgentForwarding no
AllowTcpForwarding no
PrintMotd no
PrintLastLog no
PasswordAuthentication no
AuthorizedKeysFile none

PidFile /var/run/sshd-phabricator.pid
</code></pre>
<h5>启动git ssh及测试</h5>
<p>这个步骤，是为了检查前面2个文件是否正确。正式启动git ssh需要后面使用systemd的自启动服务方式。</p>
<p>启动git ssh服务：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> /usr/sbin/sshd -f /etc/ssh/sshd_config.phabricator
</code></pre>
<p>在客户端终端命令行下：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">echo</span> {} | ssh git@p.mydomain.com conduit conduit.ping
</code></pre>
<p>如果出现：</p>
<pre><code class="hljs language-bash">{<span class="hljs-string">"result"</span>:<span class="hljs-string">"hello"</span>,<span class="hljs-string">"error_code"</span>:null,<span class="hljs-string">"error_info"</span>:null}
</code></pre>
<p>就说明成功了。</p>
<p>可能出现的错误：</p>
<p>没有将客户端的public key上传到phabricator，或者不匹配
各种服务器端配置问题，包括用户权限问题
针对服务器端配置问题，可这样启动git ssh服务，参照debug信息一般能找到问题：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> /usr/sbin/sshd -d -d -d -f /etc/ssh/sshd_config.phabricator
</code></pre>
<p>或者可阅读官方文档Diffusion User Guide: Repository Hosting的Troubleshooting SSH部分。</p>
<p>这时，需要杀掉当前启动的phd服务，因为后面要设置自动启动它。</p>
<h5>设置git ssh自启动服务</h5>
<p>复制ssh的服务文件，作为git ssh服务的模版：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> /lib/systemd/system/ssh.service /lib/systemd/system/phabricator-ssh.service
</code></pre>
<p>修改phabricator-ssh.service：</p>
<pre><code class="hljs language-conf">[Unit]
Description=OpenBSD Secure Shell server
After=network.target auditd.service
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run

[Service]
EnvironmentFile=-/etc/default/ssh
ExecStart=/usr/sbin/sshd -D $SSHD_OPTS -f /etc/ssh/sshd_config.phabricator # 修改
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartPreventExitStatus=255
Type=notify

[Install]
WantedBy=multi-user.target
</code></pre>
<p>即，修改1行（见代码注释），另外，删除最后一行Alias=sshd.service。</p>
<p>然后：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> phabricator-ssh
<span class="hljs-built_in">sudo</span> systemctl start phabricator-ssh
</code></pre>
<p>再次在客户端测试，如果没有问题，基本上就配置好了。</p>
<h5>配置杂项</h5>
<p>可以在：<a href="http://p.mydomain.com/config/issue/">http://p.mydomain.com/config/issue/</a> 查看配置上的问题，并根据建议做相应修改。</p>
<p>以下给出一些常用的配置情况。</p>
<h5>语法高亮</h5>
<p>安装pigment:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> apt install  -y python-pygments
</code></pre>
<p>phabricator打开pygments功能：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> pygments.enabled <span class="hljs-literal">true</span>
</code></pre>
<h5>最大下载文件限制</h5>
<p>编辑php配置文件：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /etc/php/7.1/fpm/php.ini
</code></pre>
<p>找到这行并改为：</p>
<pre><code class="hljs language-conf">post_max_size = 100M
</code></pre>
<p>修改Nginx配置文件：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> vim /etc/nginx/nginx.conf
</code></pre>
<p>在http块中加入：</p>
<pre><code class="hljs language-conf">client_max_body_size 100m;
</code></pre>
<p>因为默认使用mysql存储，还需要修改对mysql存储的限制，默认是1M，执行命令：</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">sudo</span> ./bin/config <span class="hljs-built_in">set</span> storage.mysql-engine.max-size 104857600
</code></pre>
<p>重启Nginx。</p>
<h5>增加邮件地址时的报错处理</h5>
<p>在添加邮件地址时出现了这样的报错：</p>
<pre><code class="hljs language-TXT">Unhandled Exception ("AphrontQueryException")   
#1055: Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'phabricator_system.system_actionlog.actorIdentity' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by
</code></pre>
<p>原因是sql_mode的限制，可连接msyql：</p>
<pre><code class="hljs language-bash">mysql -u root -ppassword
</code></pre>
<p>然后：</p>
<pre><code class="hljs language-SQL"><span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> sql_mode<span class="hljs-operator">=</span>(<span class="hljs-keyword">SELECT</span> REPLACE(@<span class="hljs-variable">@sql_mode</span>,<span class="hljs-string">'ONLY_FULL_GROUP_BY'</span>,<span class="hljs-string">''</span>));
</code></pre>
<p>这一问题，也可能会出现在有类似数据库操作的地方。</p>
<p>最后，贴一个配置</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"metamta.default-address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"send mail account"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"cluster.mailers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"email"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"smtp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"smtp host"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">465</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"send mail account"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"password"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"send mail password"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"protocol"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ssl"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"diffusion.allow-http-auth"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"false"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"diffusion.ssh-user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"environment.append-paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"/usr/lib/git-core"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"/usr/bin"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"/usr/local/bin"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"phd.user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"phd"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"phabricator.base-uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://domain.com/"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mysql.pass"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mysql password"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mysql.user"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mysql user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mysql.port"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mysql port"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mysql.host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"localhost"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"pygments.enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
<span class="hljs-punctuation">}</span>
</code></pre>0:{"buildId":"m6dvcxGAKwxohWcMVORjx","rsc":["$","$1","c",{"children":[["$","article",null,{"className":"max-w-2xl mx-auto px-5 py-10","children":[["$","header",null,{"className":"mb-8","children":[["$","h1",null,{"className":"font-mono text-xl font-semibold text-[var(--color-text)] leading-tight","children":"Phabricator安装和配置过程记录"}],["$","div",null,{"className":"flex items-center gap-3 mt-2 text-xs text-[var(--color-text-tertiary)] font-mono","children":[["$","time",null,{"dateTime":"2023-01-04","children":"2023-01-04"}],["$","span",null,{"children":"·"}],["$","span",null,{"children":"14 min read"}]]}],["$","div",null,{"className":"flex flex-wrap gap-1.5 mt-3","children":[["$","$L2","phabricator",{"href":"/tags/phabricator","className":"text-xs font-mono text-[var(--color-text-tertiary)] hover:text-[var(--color-link)] transition-colors","children":["#","phabricator"]}],["$","$L2","git server",{"href":"/tags/git%20server","className":"text-xs font-mono text-[var(--color-text-tertiary)] hover:text-[var(--color-link)] transition-colors","children":["#","git server"]}]]}]]}],["$","div",null,{"className":"prose","dangerouslySetInnerHTML":{"__html":"$3"}}],"$L4","$L5"]}],["$L6"],"$L7"]}],"loading":null,"isPartial":false}
4:["$","$L8",null,{}]
5:["$","footer",null,{"className":"mt-8 pt-4 border-t border-[var(--color-border)]","children":["$","$L2",null,{"href":"/","className":"text-sm text-[var(--color-link)] hover:underline","children":"← 返回"}]}]
6:["$","script","script-0",{"src":"/_next/static/chunks/bbef3146f2d34722.js","async":true}]
7:["$","$L9",null,{"children":["$","$a",null,{"name":"Next.MetadataOutlet","children":"$@b"}]}]
b:null
